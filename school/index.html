<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>School Demo</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="manifest" href="./manifest.webmanifest"/>
  <meta name="theme-color" content="#0b0f19"/>
</head>
<body class="dark">
  <div class="wrapper">

    <!-- Header -->
    <section class="accent-violet">
      <div class="glass header">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div class="h1">School PWA</div>
            <div class="text-dim">Neon Glass · Dark/Light</div>
          </div>
          <div class="row" style="gap:8px">
            <a class="btn" href="./login.html">Login</a>
            <a class="btn btn-outline" href="./signup.html">Sign up</a>
            <button class="btn" onclick="toggleTheme()">Theme</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Auth-aware status -->
    <section class="accent-slate">
      <div class="glass inner" id="auth-strip" hidden>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div class="h2" id="hello"></div>
            <div class="text-dim" id="roleLine"></div>
          </div>
          <a class="btn" href="./logout.html">Logout</a>
        </div>
      </div>
    </section>

    <!-- PIN (fallback router if not logged-in) -->
    <section class="accent-cyan" id="pin-section">
      <div class="glass inner">
        <div class="h1">Enter PIN</div>
        <p class="text-dim">You’ll be routed to your role automatically.</p>

        <form id="pin-form" class="form-grid mt-12">
          <input id="pin-input" class="input full" inputmode="numeric" maxlength="8"
                 placeholder="4–8 digit PIN" autocomplete="one-time-code"/>
          <button id="pin-go" class="btn btn-indigo" type="submit">Continue</button>
        </form>

        <div id="pin-msg" class="text-dim mt-12"></div>
        <div id="pin-info" class="mt-12 text-dim" style="font-size:12px"></div>
      </div>
    </section>

  </div>

  <!-- App scripts -->
  <script type="module">
    import { showLoadedPins } from './ui.js';     // also boots theme
    import { sb } from './js/supabase.js';        // Supabase client

    // ---- Register service worker (once) ----
    if ('serviceWorker' in navigator) {
      try { navigator.serviceWorker.register('./sw.js'); } catch {}
    }

    // ---- If logged-in, auto-route by Supabase profile role ----
    const { data: { user } } = await sb.auth.getUser();
    if (user) {
      // fetch profile to get role
      const { data: prof } = await sb.from('profiles').select('full_name, role').eq('user_id', user.id).single();
      const role = prof?.role;
      const name = prof?.full_name || user.email || 'User';

      // show strip
      const strip = document.getElementById('auth-strip');
      strip.hidden = false;
      document.getElementById('hello').textContent = `Hello, ${name}`;
      document.getElementById('roleLine').textContent = role ? `Signed in as ${role}` : 'Signed in';

      // hard-route if role is known
      const pageByRole = {
        parent: 'parents.html',
        teacher: 'teacher.html',
        coordinator: 'coordinator.html',
        admin: 'admin.html'
      };
      if (role && pageByRole[role]) {
        const theme = localStorage.getItem('theme') || 'dark';
        location.href = `${pageByRole[role]}?t=${Date.now()}&theme=${theme}`;
      } else {
        // keep page visible; PIN fallback still works
      }
    }

    // ---- PIN fallback (works even without auth) ----
    let pinMap = { "1111":"parents", "2222":"teacher", "3333":"coordinator", "4444":"admin" };
    try {
      const r = await fetch(new URL('pins.json', location.href), { cache:'no-store' });
      if (r.ok) {
        const j = await r.json();
        if (j && typeof j === 'object') pinMap = j;
      }
      showLoadedPins(Object.keys(pinMap));
    } catch {
      document.getElementById('pin-info').textContent = 'Using fallback PINs (pins.json not found).';
    }

    const $ = (id)=>document.getElementById(id);
    const input = $('pin-input');
    const msg   = $('pin-msg');
    const form  = $('pin-form');

    function route(e){
      e?.preventDefault();
      const pin = (input.value || '').trim();
      if (!pin) { msg.textContent = 'Enter a PIN.'; return; }
      const role = pinMap[pin];
      if (!role) { msg.textContent = 'Unknown PIN. Please try again.'; return; }
      const theme = localStorage.getItem('theme') || 'dark';
      const url = `${role}.html?t=${Date.now()}&theme=${theme}`;
      try { location.href = url; } catch { msg.textContent = 'Navigation blocked by browser.'; }
    }
    form.addEventListener('submit', route);
  </script>

  <script type="module" src="ui.js"></script>
</body>
</html>
