<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>School PWA</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="manifest" href="./manifest.webmanifest"/>
  <meta name="theme-color" content="#0b0f19"/>
</head>
<body class="dark">
<div class="wrapper">
  <section class="accent-violet">
    <div class="glass header">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="h1">School PWA</div>
          <div class="text-dim">Role-based demo</div>
        </div>
        <div class="row" style="gap:8px">
          <a class="btn" href="./login.html">Login</a>
          <a class="btn btn-outline" href="./signup.html">Sign up</a>
          <button class="btn" onclick="toggleTheme()">Theme</button>
        </div>
      </div>
    </div>
  </section>

  <section class="accent-slate">
    <div class="glass inner" id="auth-strip" hidden>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="h2" id="hello"></div>
          <div class="text-dim" id="roleLine"></div>
        </div>
        <a class="btn" href="./logout.html">Logout</a>
      </div>
    </div>
  </section>
</div>

<script type="module">
import { sb } from "./js/supabase.js";

// service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}
const { data: { user } } = await sb.auth.getUser();
if (user) {
  const { data: prof } = await sb.from('profiles')
    .select('full_name, role').eq('user_id', user.id).maybeSingle();

  const role = prof?.role || 'parent'; // fallback
  const name = prof?.full_name || user.email || 'User';

  const strip = document.getElementById('auth-strip');
  strip.hidden = false;
  document.getElementById('hello').textContent = `Hello, ${name}`;
  document.getElementById('roleLine').textContent = `Signed in as ${role}`;

  const roleMap = { parent:'parents.html', teacher:'teacher.html', coordinator:'coordinator.html', admin:'admin.html' };
  const theme = localStorage.getItem('theme') || 'dark';
  location.href = `${roleMap[role]}?theme=${theme}`;
}

}
</script>
<script type="module" src="ui.js"></script>
</body>
</html>
