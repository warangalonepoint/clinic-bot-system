<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Booking | Onestop C-Demo</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <img src="assets/banner.png" alt="Banner" class="banner" />
    <div class="header">
      <img src="assets/logo.png" alt="Logo" class="logo" />
      <h1 class="title">Onestop C-Demo</h1>
      <button id="toggleTheme" class="theme-toggle">ðŸŒ“</button>
    </div>

    <div class="card">
      <h2>WhatsApp Appointment</h2>
      <label for="dateSelect">Select Date:</label>
      <select id="dateSelect"></select>

      <label for="slotSelect">Select Time Slot:</label>
      <select id="slotSelect"></select>

      <label for="nameInput">Patient Name:</label>
      <input type="text" id="nameInput" placeholder="Enter patient name"/>

      <label for="reasonInput">Reason for Visit:</label>
      <input type="text" id="reasonInput" placeholder="Enter reason"/>

      <button id="bookBtn">Book on WhatsApp</button>
      <p id="tokenInfo" class="token-info"></p>
    </div>

    <footer>Powered by Onestop AI</footer>
  </div>

  <script>
    const airtableApiKey = localStorage.getItem('airtableApiKey');
    const baseId = 'app1T8WiRqZIR4xY';
    const slotsTable = 'AvailableSlots';
    const logsTable = 'BookingsLogs';
    const today = new Date().toISOString().split('T')[0];

    const dateSelect = document.getElementById('dateSelect');
    const slotSelect = document.getElementById('slotSelect');
    const nameInput = document.getElementById('nameInput');
    const reasonInput = document.getElementById('reasonInput');
    const bookBtn = document.getElementById('bookBtn');
    const tokenInfo = document.getElementById('tokenInfo');

    let allSlots = [];

    async function fetchSlots() {
      const url = `https://api.airtable.com/v0/${baseId}/${slotsTable}?pageSize=100&api_key=${airtableApiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      allSlots = data.records.map(r => ({
        date: r.fields['Date'],
        time: r.fields['Time Slot'],
        status: r.fields['Status']
      })).filter(r => r.status !== 'Booked');

      const futureDates = [...new Set(allSlots.map(s => s.date))].filter(d => d >= today);
      dateSelect.innerHTML = `<option value="">Select</option>` + futureDates.map(d => `<option>${d}</option>`).join('');
    }

    dateSelect.addEventListener('change', () => {
      const selectedDate = dateSelect.value;
      const filtered = allSlots.filter(s => s.date === selectedDate);
      slotSelect.innerHTML = `<option value="">Select</option>` + filtered.map(s => `<option>${s.time}</option>`).join('');
    });

    async function getTokenNumber(date) {
      const url = `https://api.airtable.com/v0/${baseId}/${logsTable}?filterByFormula=AND({Timestamp} >= '${date} 00:00:00', {Timestamp} <= '${date} 23:59:59')&api_key=${airtableApiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.records.length + 1;
    }

    bookBtn.addEventListener('click', async () => {
      const name = nameInput.value.trim();
      const reason = reasonInput.value.trim();
      const date = dateSelect.value;
      const slot = slotSelect.value;

      if (!name || !reason || !date || !slot) return alert('Fill all fields.');

      const token = await getTokenNumber(date);
      tokenInfo.innerText = `Assigned Token No: ${token}`;

      const whatsappMsg = `Appointment Booking:%0aName: ${name}%0aReason: ${reason}%0aDate: ${date}%0aTime: ${slot}%0aToken: ${token}`;
      const phone = '919390664577'; // Your clinic number here
      const link = `https://wa.me/${phone}?text=${whatsappMsg}`;
      window.open(link, '_blank');
    });

    // Theme toggle
    const toggleTheme = document.getElementById('toggleTheme');
    toggleTheme.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    });
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark');
    }

    fetchSlots();
  </script>
</body>
</html>
