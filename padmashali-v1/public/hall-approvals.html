<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hall Approvals</title>
<style>
:root{color-scheme:dark}
body{margin:0;font-family:system-ui,Inter,Arial;background:#0f1115;color:#e8eaed}
.wrap{max-width:1060px;margin:24px auto;padding:16px}
.bar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.btn{background:#2563eb;border:0;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
.ghost{background:#11141a;border:1px solid #1f2432}
.pill{display:inline-flex;align-items:center;background:#0f1218;border:1px solid #262b38;padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
.card{background:#171a21;border:1px solid #222736;border-radius:18px;padding:18px;margin-top:14px}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{padding:10px 12px;text-align:left}
tr{background:#11141a;border:1px solid #1f2432}
tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
.badge{background:#0f1218;border:1px solid #262b38;border-radius:999px;padding:3px 8px;font-size:12px}
.ok{color:#86efac}.warn{color:#fde68a}.err{color:#fca5a5}
.row{display:flex;gap:8px;flex-wrap:wrap}
footer{opacity:.7;font-size:13px;margin:18px 0;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <h2 style="margin:0">✅ Hall Approvals</h2>
    <div class="row">
      <span id="lang-pill" class="pill" onclick="setLang(getLang()==='te'?'en':'te')">English ☀️</span>
      <button class="btn ghost" onclick="history.back()">Back</button>
    </div>
  </div>

  <div class="card">
    <b>Pending Requests</b>
    <table class="table"><thead>
      <tr><th>Date</th><th>Hall</th><th>Time</th><th>Name</th><th>Phone</th><th>Purpose</th><th>Action</th></tr>
    </thead><tbody id="pending"></tbody></table>
  </div>

  <div class="card">
    <b>Approved / Rejected</b>
    <table class="table"><thead>
      <tr><th>Date</th><th>Hall</th><th>Time</th><th>Name</th><th>Phone</th><th>Purpose</th><th>Status</th></tr>
    </thead><tbody id="done"></tbody></table>
  </div>

  <footer>© Padmashali Community — V1</footer>
</div>

<script src="i18n.js"></script>
<script>
  // guard: only committee or admin
  const s = JSON.parse(localStorage.getItem("pc_session")||"null");
  if(!s || (s.role!=='committee' && s.role!=='admin')) location.href='index.html';

  const LSKEY='pc_hall_bookings';
  function getAll(){ return JSON.parse(localStorage.getItem(LSKEY)||'[]'); }
  function setAll(arr){ localStorage.setItem(LSKEY, JSON.stringify(arr)); }

  function render(){
    const list=getAll().sort((a,b)=>a.date.localeCompare(b.date)||a.hall.localeCompare(b.hall)||a.start.localeCompare(b.start));
    const pendingT=document.getElementById('pending'); pendingT.innerHTML='';
    const doneT=document.getElementById('done'); doneT.innerHTML='';
    list.forEach(x=>{
      const tr=document.createElement('tr');
      if(x.status==='Pending'){
        tr.innerHTML=`<td>${x.date}</td><td>${x.hall}</td><td>${x.start}–${x.end}</td>
                      <td>${x.name}</td><td>${x.phone}</td><td>${x.purpose}</td>
                      <td class="row">
                        <button class="btn" onclick="approve('${x.id}')">Approve</button>
                        <button class="btn ghost" onclick="reject('${x.id}')">Reject</button>
                      </td>`;
        pendingT.appendChild(tr);
      } else {
        tr.innerHTML=`<td>${x.date}</td><td>${x.hall}</td><td>${x.start}–${x.end}</td>
                      <td>${x.name}</td><td>${x.phone}</td><td>${x.purpose}</td>
                      <td><span class="badge ${x.status==='Approved'?'ok':'err'}">${x.status}</span></td>`;
        doneT.appendChild(tr);
      }
    });
  }

  function approve(id){
    const list=getAll();
    const i=list.findIndex(z=>z.id===id);
    if(i<0) return;
    // sanity: prevent approving overlapping Approved items
    const me=list[i];
    const toMin=t=>{const [h,m]=t.split(':').map(Number);return h*60+m;}
    const overlap=(a1,b1,a2,b2)=>a1<b2&&a2<b1;
    const clash=list.some(x=> x.id!==me.id && x.hall===me.hall && x.date===me.date && x.status==='Approved'
                    && overlap(toMin(me.start),toMin(me.end),toMin(x.start),toMin(x.end)));
    if(clash){ alert('Clashes with existing approved slot. Reject or change times.'); return; }
    list[i].status='Approved'; setAll(list); render();
  }
  function reject(id){
    const list=getAll(); const i=list.findIndex(z=>z.id===id);
    if(i<0) return; list[i].status='Rejected'; setAll(list); render();
  }

  applyI18n();
  render();
</script>
</body></html>
