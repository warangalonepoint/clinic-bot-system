<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Appointment</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      padding: 20px;
    }
    label, select, input, button {
      display: block;
      margin: 10px 0;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>üóì Book Your Slot</h1>

  <label for="date">Select Date:</label>
  <select id="date"></select>

  <label for="slot">Select Time Slot:</label>
  <select id="slot"></select>

  <label for="name">Patient Name:</label>
  <input type="text" id="name" placeholder="Enter name" />

  <label for="reason">Reason for Visit:</label>
  <input type="text" id="reason" placeholder="E.g. Fever, Checkup" />

  <button onclick="bookSlot()">Confirm & WhatsApp</button>

  <script>
    const clinicId = localStorage.getItem('clinic_id') || 'OneStop';
    const slotsPath = `slots/${clinicId}/Slots.csv`;
    const slotMap = {};

    fetch(slotsPath)
      .then(res => res.text())
      .then(csv => {
        const lines = csv.trim().split('\n').slice(1);
        lines.forEach(line => {
          const [date, time, status] = line.split(',');
          if (status !== 'Booked') {
            if (!slotMap[date]) slotMap[date] = [];
            slotMap[date].push(time);
          }
        });
        const dateSel = document.getElementById('date');
        Object.keys(slotMap).forEach(date => {
          const opt = document.createElement('option');
          opt.value = date;
          opt.textContent = date;
          dateSel.appendChild(opt);
        });
        dateSel.onchange = updateTimeSlots;
        updateTimeSlots();
      });

    function updateTimeSlots() {
      const date = document.getElementById('date').value;
      const slotSel = document.getElementById('slot');
      slotSel.innerHTML = '';
      (slotMap[date] || []).forEach(slot => {
        const opt = document.createElement('option');
        opt.value = slot;
        opt.textContent = slot;
        slotSel.appendChild(opt);
      });
    }

    function bookSlot() {
      const name = document.getElementById('name').value.trim();
      const reason = document.getElementById('reason').value.trim();
      const date = document.getElementById('date').value;
      const slot = document.getElementById('slot').value;
      if (!name || !reason || !date || !slot) return alert("Fill all fields");
      const msg = `Hi, I want to book an appointment.\nüìÖ Date: ${date}\n‚è∞ Time: ${slot}\nüßë‚Äç‚öïÔ∏è Name: ${name}\nüìã Reason: ${reason}`;
      window.location.href = `https://wa.me/919390664577?text=${encodeURIComponent(msg)}`;
    }
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js');
    }
  </script>

  <!-- Trial Lock Check -->
  <script>
    fetch('plans.json')
      .then(res => res.json())
      .then(data => {
        const plan = data[clinicId];
        if (!plan || !plan.isTrialActive || new Date() > new Date(plan.expiryDate)) {
          window.location.href = "trial-expired.html";
        }
      });
  </script>
</body>
</html>
