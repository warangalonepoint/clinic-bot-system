<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Doctor Panel · Onestop Clinic</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css?v=16">
  <style>
    /* tiny page-local helpers to avoid touching your global css */
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid rgba(17,24,39,.10);
      background:rgba(255,255,255,.8);backdrop-filter:blur(10px);cursor:pointer;font-weight:700}
    .chip:hover{transform:translateY(-1px)}
    .hint{font-size:.9rem;color:#5b6475;margin-top:6px}
    .warn{padding:10px 12px;border-radius:14px;background:#fff6e6;border:1px solid #facc15;color:#854d0e;font-weight:700}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="header">
      <div class="brand-logo"></div>
      <div><div class="title">Doctor Panel</div><div class="subtitle">Today’s Patients & Notes</div></div>
    </div>

    <!-- Controls -->
    <div class="section glass">
      <h2>Filter</h2>
      <div class="toolbar">
        <div style="flex:1;min-width:220px">
          <div class="row"><div class="label">Search</div>
            <input id="q" class="input" placeholder="Name / token / reason">
          </div>
        </div>
        <div style="width:220px">
          <div class="row"><div class="label">Status</div>
            <select id="fStatus" class="input">
              <option value="Pending" selected>Pending</option>
              <option value="Seen">Seen</option>
              <option value="all">All</option>
            </select>
          </div>
        </div>
        <div>
          <button class="btn btn-secondary" id="nextBtn" title="Jump to first pending">Next Pending</button>
        </div>
      </div>
      <div id="modeBanner" class="hint"></div>
    </div>

    <!-- List -->
    <div id="list"></div>

    <div class="footer">© 2025 Onestop Clinic</div>
  </div>

<script>
/* =========================
   Config / Backends
========================= */
let CFG=null, BACKEND='csv';
async function loadCfg(){
  try{
    const res = await fetch('./config.json?v=' + Date.now());
    if(!res.ok) throw 0;
    CFG = await res.json();
    BACKEND = (CFG.backend||'csv').toLowerCase();
  }catch{
    CFG = { backend:'csv', csv:{ logs:'./logs.csv' } };
    BACKEND = 'csv';
  }
  const banner = document.getElementById('modeBanner');
  if(BACKEND==='csv'){
    banner.innerHTML = `<span class="warn">CSV mode: read-only.</span> <span class="hint">Saving/marking needs Airtable credentials in <span class="mono">config.json</span>.</span>`;
  }else{
    banner.textContent = 'Airtable mode • changes are saved live.';
  }
}

/* Parse CSV robust(ish) */
function parseCSV(text){
  const rows=[]; let cur=[], str='', inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c=='"' ){ if(inQ && n=='"'){ str+='"'; i++; } else inQ = !inQ; }
    else if(c===',' && !inQ){ cur.push(str); str=''; }
    else if((c==='\n' || c==='\r') && !inQ){ if(str!==''||cur.length){ cur.push(str); rows.push(cur); cur=[]; str=''; } }
    else{ str+=c; }
  }
  if(str!==''||cur.length) { cur.push(str); rows.push(cur); }
  return rows;
}
function csvToObjs(text){
  const r=parseCSV(text).filter(a=>a.length && a.join('').trim()!=='');
  const headers=r.shift().map(h=>h.trim());
  return r.map(line=>{
    const o={}; headers.forEach((h,i)=>o[h]= (line[i]||'').trim()); return o;
  });
}
function toDateOnly(ts){ return (ts||'').slice(0,10); }

/* Airtable API */
const AT = {
  headers(){ return { Authorization: 'Bearer ' + CFG.airtable.apiKey, 'Content-Type':'application/json' }; },
  async today(){
    const d = new Date().toISOString().slice(0,10);
    const base = `https://api.airtable.com/v0/${CFG.airtable.baseId}/${encodeURIComponent(CFG.airtable.logsTable)}`;
    const url = `${base}?filterByFormula=${encodeURIComponent("DATETIME_FORMAT({Timestamp}, 'YYYY-MM-DD')='"+d+"'")}&sort[0][field]=Slot Time&sort[0][direction]=asc&pageSize=100`;
    const j = await (await fetch(url,{headers:this.headers()})).json();
    return (j.records||[]).map(r=>({id:r.id, ...r.fields}));
  },
  async update(id, fields){
    const url = `https://api.airtable.com/v0/${CFG.airtable.baseId}/${encodeURIComponent(CFG.airtable.logsTable)}`;
    const body = JSON.stringify({ records: [{ id, fields }] });
    const res = await fetch(url,{ method:'PATCH', headers:this.headers(), body });
    if(!res.ok) throw new Error('Update failed');
  }
};

/* Data load */
async function fetchRows(){
  if(BACKEND==='airtable') return await AT.today();
  // CSV fallback (read only)
  const url = (CFG.csv && CFG.csv.logs) ? CFG.csv.logs : './logs.csv';
  const txt = await (await fetch(url + '?v=' + Date.now())).text();
  const rows = csvToObjs(txt);
  const today = new Date().toISOString().slice(0,10);
  return rows
    .filter(r=> toDateOnly(r['Timestamp']) === today )
    .sort((a,b)=> (a['Slot Time']||'').localeCompare(b['Slot Time']||''))
    .map(r=>({ id: r['id']||'', ...r }));
}

/* =========================
   UI Render
========================= */
let ALL=[], FILTER_STATUS='Pending', QUERY='';
const listEl = document.getElementById('list');

function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function chip(label,val,cls=''){ return `<span class="chip ${cls}" data-val="${esc(val)}">${esc(label)}</span>`; }

function cardTpl(r,index){
  const status = r['Status'] || 'Pending';
  const fup = r['Follow Up'] ? String(r['Follow Up']).slice(0,10) : '';
  const name = r['Patient Name']||'';
  const token = r['Token']||'-';
  const slot = r['Slot Time']||'';
  const reason = r['Reason']||'-';
  const contact = r['Contact']||'';
  const diag = r['Diagnosis']||'';
  const rx = r['Prescription']||'';
  const notes = r['Doctor Notes']||'';

  return `
  <div class="section glass" data-id="${esc(r.id||'')}" data-idx="${index}">
    <h2>#${esc(token)} • ${esc(name)} <span class="muted">(${esc(slot)})</span></h2>

    <div class="row"><div class="label">Reason</div><div class="value">${esc(reason)}</div></div>
    <div class="row"><div class="label">Contact</div><div class="value">${esc(contact)}</div></div>

    <div class="row"><div class="label">Diagnosis</div>
      <input class="input diag" placeholder="e.g., Viral fever" value="${esc(diag)}">
    </div>

    <div class="row"><div class="label">Prescription</div>
      <textarea class="input rx" rows="3" placeholder="Rx...">${esc(rx)}</textarea>
    </div>

    <div class="chips">
      ${chip('Paracetamol 500mg b.i.d ×3d','Paracetamol 500mg — 1 tab twice daily for 3 days')}
      ${chip('Cetrizine 10mg o.d ×5d','Cetrizine 10mg — 1 tab at night for 5 days')}
      ${chip('ORS + Rest','ORS sachet with water; rest & fluids')}
      ${chip('Omeprazole 20mg o.d ×7d','Omeprazole 20mg — 1 cap empty stomach for 7 days')}
    </div>

    <div class="row"><div class="label">Doctor Notes</div>
      <textarea class="input note" rows="3" placeholder="Notes...">${esc(notes)}</textarea>
    </div>

    <div class="row"><div class="label">Follow Up</div>
      <input class="input fup" type="date" value="${esc(fup)}">
    </div>

    <div class="row"><div class="label">Status</div>
      <select class="input stat" style="max-width:220px">
        <option ${status==='Pending'?'selected':''}>Pending</option>
        <option ${status==='Seen'?'selected':''}>Seen</option>
      </select>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
      <button class="btn btn-primary save"${BACKEND==='csv'?' disabled':''}>Save</button>
      <button class="btn btn-secondary seen">${status==='Seen'?'Mark Pending':'Mark Seen'}</button>
      <button class="btn btn-secondary wa">WhatsApp Rx</button>
    </div>
    ${BACKEND==='csv'?'<div class="hint">CSV mode is read-only. Enable Airtable in <span class="mono">config.json</span> to save.</div>':''}
  </div>`;
}

function render(){
  const q = QUERY.trim().toLowerCase();
  const items = ALL.filter(r=>{
    const s = (r['Status']||'Pending');
    if(FILTER_STATUS!=='all' && s!==FILTER_STATUS) return false;
    if(!q) return true;
    const hay = [
      r['Patient Name'], r['Token'], r['Reason'], r['Slot Time'], r['Diagnosis'], r['Prescription']
    ].join(' ').toLowerCase();
    return hay.includes(q);
  });

  listEl.innerHTML = items.length
    ? items.map((r,i)=>cardTpl(r,i)).join('')
    : `<div class="section glass"><h2>No patients match.</h2></div>`;

  // bind actions per card
  Array.from(listEl.querySelectorAll('.section.glass')).forEach((sec, i)=>{
    const idx = Number(sec.dataset.idx);
    const rec = items[i];

    // quick chips -> append to Rx
    sec.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click',()=>{
        const rx = sec.querySelector('.rx');
        const add = ch.getAttribute('data-val');
        rx.value = (rx.value ? rx.value.trim() + '\n' : '') + add;
      });
    });

    // Save
    sec.querySelector('.save')?.addEventListener('click', async ()=>{
      const payload = {
        'Diagnosis': sec.querySelector('.diag').value.trim(),
        'Prescription': sec.querySelector('.rx').value.trim(),
        'Doctor Notes': sec.querySelector('.note').value.trim(),
        'Follow Up': sec.querySelector('.fup').value || null,
        'Status': sec.querySelector('.stat').value
      };
      try{
        await AT.update(rec.id, payload);
        toast('Saved');
        // also update local copy so filters keep working
        Object.assign(rec, payload);
      }catch{ toast('Save failed'); }
    });

    // Mark seen/pending
    sec.querySelector('.seen').addEventListener('click', async ()=>{
      const current = sec.querySelector('.stat').value;
      const next = current==='Seen' ? 'Pending' : 'Seen';
      try{
        if(BACKEND==='airtable') await AT.update(rec.id, { 'Status': next });
        sec.querySelector('.stat').value = next;
        rec['Status'] = next;
        sec.querySelector('.seen').textContent = next==='Seen'?'Mark Pending':'Mark Seen';
        toast('Status updated');
      }catch{ toast('Update failed'); }
    });

    // WhatsApp Rx
    sec.querySelector('.wa').addEventListener('click', ()=>{
      const msg = `Prescription for ${rec['Patient Name']||''}
Token: ${rec['Token']||''}
Time: ${rec['Slot Time']||''}
Diagnosis: ${sec.querySelector('.diag').value.trim()}
Rx:
${sec.querySelector('.rx').value.trim()}

Notes: ${sec.querySelector('.note').value.trim()}
Follow-up: ${sec.querySelector('.fup').value||'-'}`;
      const phone = (rec['Contact']||'').trim();
      const base = phone ? `https://wa.me/${encodeURIComponent(phone)}?text=` : `https://wa.me/?text=`;
      location.href = base + encodeURIComponent(msg);
    });
  });
}

function toast(t){
  let el=document.getElementById('toast');
  if(!el){ el=document.createElement('div'); el.id='toast'; el.className='debug-css'; document.body.appendChild(el); }
  el.textContent = '✅ ' + t;
  clearTimeout(el._t); el._t = setTimeout(()=>el.remove(), 2000);
}

/* =========================
   Boot
========================= */
(async ()=>{
  await loadCfg();
  try{
    ALL = await fetchRows();
  }catch(e){
    listEl.innerHTML = `<div class="section glass"><h2>Couldn’t load today’s list.</h2><p class="hint">Check <span class="mono">config.json</span> and data source.</p></div>`;
    return;
  }
  render();

  // Filters
  document.getElementById('fStatus').addEventListener('change', e=>{
    FILTER_STATUS = e.target.value; render();
  });
  document.getElementById('q').addEventListener('input', e=>{
    QUERY = e.target.value; render();
  });

  // Next pending
  document.getElementById('nextBtn').addEventListener('click', ()=>{
    QUERY=''; document.getElementById('q').value='';
    FILTER_STATUS='Pending'; document.getElementById('fStatus').value='Pending';
    render();
    const first = listEl.querySelector('.section.glass');
    if(first) first.scrollIntoView({behavior:'smooth', block:'start'});
  });

  // SW for PWA (safe no-op if absent)
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
})();
</script>
</body>
</html>
