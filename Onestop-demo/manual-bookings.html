<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manual Booking</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      background: #fff;
    }
    .container {
      max-width: 400px;
      margin: auto;
      text-align: center;
    }
    .banner {
      width: 100%;
      border-radius: 10px;
    }
    .clinic-title {
      font-size: 20px;
      font-weight: bold;
      margin: 15px 0;
    }
    label {
      text-align: left;
      display: block;
      margin-top: 10px;
      font-size: 15px;
    }
    select, input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .btn {
      background: black;
      color: white;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      margin-top: 10px;
    }
    .footer {
      text-align: center;
      margin-top: 25px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="assets/banner.png" class="banner" alt="Banner">
    <div class="clinic-title">Manual Patient Booking</div>

    <form id="bookingForm">
      <label>Select Date:</label>
      <select id="dateDropdown" required></select>

      <label>Select Time Slot:</label>
      <select id="slotDropdown" required></select>

      <label>Patient Name:</label>
      <input type="text" id="name" placeholder="Enter name" required />

      <label>Reason:</label>
      <input type="text" id="reason" placeholder="Enter reason" required />

      <label>Contact:</label>
      <input type="tel" id="contact" placeholder="Enter phone number" required />

      <button type="submit" class="btn">Confirm Booking</button>
    </form>

    <div class="footer">Powered by Onestop AI</div>
  </div>

  <script>
    const airtableApiKey = 'YOUR_API_KEY'; // 🔁 Replace this
    const baseId = 'app1T8WiRqZIR4xY';
    const availableTable = 'AvailableSlots';
    const logsTable = 'BookingsLogs';

    async function loadSlots() {
      const dateDropdown = document.getElementById('dateDropdown');
      const slotDropdown = document.getElementById('slotDropdown');

      dateDropdown.innerHTML = '';
      slotDropdown.innerHTML = '';

      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${availableTable}?maxRecords=100`, {
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      const data = await res.json();

      const grouped = {};
      data.records.forEach(record => {
        const date = record.fields['Date'];
        const time = record.fields['Time Slot'];
        const status = record.fields['Status'];
        if (status === 'Available') {
          if (!grouped[date]) grouped[date] = [];
          grouped[date].push({ time, id: record.id });
        }
      });

      Object.keys(grouped).forEach(date => {
        const opt = document.createElement('option');
        opt.value = date;
        opt.textContent = date;
        dateDropdown.appendChild(opt);
      });

      dateDropdown.addEventListener('change', () => {
        slotDropdown.innerHTML = '';
        const selected = grouped[dateDropdown.value] || [];
        selected.forEach(slot => {
          const opt = document.createElement('option');
          opt.value = slot.time;
          opt.textContent = slot.time;
          slotDropdown.appendChild(opt);
        });
      });

      if (dateDropdown.options.length > 0) {
        dateDropdown.dispatchEvent(new Event('change'));
      }
    }

    document.getElementById('bookingForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const name = document.getElementById('name').value;
      const reason = document.getElementById('reason').value;
      const contact = document.getElementById('contact').value;
      const date = document.getElementById('dateDropdown').value;
      const slot = document.getElementById('slotDropdown').value;

      // 1. Add to Logs
      await fetch(`https://api.airtable.com/v0/${baseId}/${logsTable}`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fields: {
            Timestamp: new Date().toLocaleString(),
            "Patient Name": name,
            "Slot Time": `${date} ${slot}`,
            Reason: reason,
            Contact: contact,
            Token: "",
            "Reminder Sent": ""
          }
        })
      });

      // 2. Mark Slot as Booked
      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${availableTable}?filterByFormula=AND({Date}='${date}',{Time Slot}='${slot}')`, {
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      const data = await res.json();
      const recordId = data.records[0]?.id;
      if (recordId) {
        await fetch(`https://api.airtable.com/v0/${baseId}/${availableTable}/${recordId}`, {
          method: 'PATCH',
          headers: {
            Authorization: `Bearer ${airtableApiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ fields: { Status: 'Booked' } })
        });
      }

      alert('Booking Confirmed!');
      window.location.href = 'index.html';
    });

    loadSlots();
  </script>
</body>
</html>
