<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Manage Directory</title>
<style>
:root{color-scheme:dark}
body{margin:0;font-family:system-ui,Inter,Arial;background:#0f1115;color:#e8eaed}
.wrap{max-width:1120px;margin:24px auto;padding:16px}
.bar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.btn{background:#2563eb;border:0;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
.ghost{background:#11141a;border:1px solid #1f2432}
.danger{background:#ef4444}
.pill{display:inline-flex;align-items:center;background:#0f1218;border:1px solid #262b38;padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
.card{background:#171a21;border:1px solid #222736;border-radius:18px;padding:18px;margin-top:14px}
.grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.tile{background:#11141a;border:1px solid #1f2432;border-radius:16px;padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.input, textarea, select{padding:12px;border-radius:12px;border:1px solid #262b38;background:#0f1218;color:#e8eaed;width:100%}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{padding:10px 12px;text-align:left}
tr{background:#11141a;border:1px solid #1f2432}
tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
.badge{background:#0f1218;border:1px solid #262b38;border-radius:999px;padding:3px 8px;font-size:12px}
footer{opacity:.7;font-size:13px;margin:18px 0;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <h2 style="margin:0">üóÇÔ∏è Manage Directory</h2>
    <div class="row">
      <span id="lang-pill" class="pill" onclick="setLang(getLang()==='te'?'en':'te')">English ‚òÄÔ∏è</span>
      <a class="btn ghost" href="directory.html">View Directory</a>
      <button class="btn ghost" onclick="history.back()">Back</button>
      <button class="btn ghost" id="exportBtn">Export CSV</button>
      <label class="btn" style="cursor:pointer">
        Import CSV<input id="csvFile" type="file" accept=".csv" style="display:none">
      </label>
    </div>
  </div>

  <div class="card">
    <b>Add / Edit Member</b>
    <div class="grid" style="margin-top:10px">
      <input id="name" class="input" placeholder="Full Name *">
      <input id="phone" class="input" placeholder="Phone *">
      <input id="email" class="input" placeholder="Email">
      <input id="area" class="input" placeholder="Area">
      <input id="seva" class="input" placeholder="Seva (e.g., Education)">
      <input id="family" class="input" placeholder="Family ID (optional)">
      <textarea id="notes" class="input" placeholder="Notes"></textarea>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="saveBtn">Save</button>
      <button class="btn ghost" id="clearBtn">Clear</button>
      <button class="btn danger" id="deleteBtn" style="display:none">Delete</button>
    </div>
  </div>

  <div class="card">
    <b>All Records</b>
    <div class="row" style="margin:10px 0">
      <input id="q" class="input" placeholder="Search‚Ä¶">
      <select id="filterArea" class="input"><option value="">Any Area</option></select>
      <select id="filterSeva" class="input"><option value="">Any Seva</option></select>
    </div>
    <table class="table">
      <thead><tr><th>Name</th><th>Area</th><th>Seva</th><th>Email</th><th>Phone</th><th>ID</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
    <p id="empty" class="muted" style="display:none">No records.</p>
  </div>

  <footer>¬© Padmashali Community ‚Äî V1</footer>
</div>

<script src="i18n.js"></script>
<script>
  // guard: committee or admin only
  const s = JSON.parse(localStorage.getItem("pc_session")||"null");
  if(!s || (s.role!=='committee' && s.role!=='admin')) location.href='index.html';

  const K='pc_directory';
  const f={name:$('#name'),phone:$('#phone'),email:$('#email'),area:$('#area'),seva:$('#seva'),family:$('#family'),notes:$('#notes')};
  const rows=$('#rows'), empty=$('#empty'), q=$('#q'), fArea=$('#filterArea'), fSeva=$('#filterSeva');
  const delBtn=$('#deleteBtn'); let editId=null;

  function $(sel){ return document.querySelector(sel); }
  function getAll(){ return JSON.parse(localStorage.getItem(K)||'[]'); }
  function setAll(v){ localStorage.setItem(K, JSON.stringify(v)); }
  function uid(){ return 'D'+Math.random().toString(36).slice(2,10); }
  function unique(vals){ return Array.from(new Set(vals.filter(Boolean))).sort(); }

  // Build filter dropdowns
  function buildFilters(){
    const list=getAll();
    fArea.innerHTML='<option value="">Any Area</option>'+unique(list.map(x=>x.area)).map(a=>`<option>${a}</option>`).join('');
    fSeva.innerHTML='<option value="">Any Seva</option>'+unique(list.map(x=>x.seva)).map(a=>`<option>${a}</option>`).join('');
  }

  // Render table
  function render(){
    const text=(q.value||'').toLowerCase(), a=fArea.value, s=fSeva.value;
    const list=getAll().filter(x=>{
      const okT=!text || `${x.name} ${x.area} ${x.seva} ${x.phone} ${x.email||''} ${x.family||''}`.toLowerCase().includes(text);
      const okA=!a || x.area===a; const okS=!s || x.seva===s; return okT && okA && okS;
    }).sort((m,n)=>m.name.localeCompare(n.name));
    rows.innerHTML=''; empty.style.display=list.length?'none':'block';
    list.forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><a href="#" onclick="edit('${x.id}');return false;">${x.name}</a></td>
        <td>${x.area||''}</td><td>${x.seva||''}</td><td>${x.email||'‚Äî'}</td><td>${x.phone||''}</td><td>${x.id}</td>`;
      rows.appendChild(tr);
    });
  }

  // Save or update
  $('#saveBtn').onclick=()=>{
    const name=(f.name.value||'').trim(), phone=(f.phone.value||'').trim();
    if(!name||!phone){ alert('Name & Phone required'); return; }
    const rec={ id: editId||uid(), name, phone,
      email:(f.email.value||'').trim(), area:(f.area.value||'').trim(), seva:(f.seva.value||'').trim(),
      family:(f.family.value||'').trim(), notes:(f.notes.value||'').trim(), ts:Date.now()
    };
    const list=getAll();
    const i=list.findIndex(x=>x.id===rec.id);
    if(i>=0) list[i]=rec; else list.push(rec);
    setAll(list); clearForm(); buildFilters(); render();
  };

  // Edit existing
  window.edit=(id)=>{
    const it=getAll().find(x=>x.id===id); if(!it) return;
    editId=id; f.name.value=it.name||''; f.phone.value=it.phone||''; f.email.value=it.email||'';
    f.area.value=it.area||''; f.seva.value=it.seva||''; f.family.value=it.family||''; f.notes.value=it.notes||'';
    delBtn.style.display='inline-block'; window.scrollTo({top:0,behavior:'smooth'});
  };

  // Delete
  delBtn.onclick=()=>{
    if(!editId) return;
    if(!confirm('Delete this member?')) return;
    const list=getAll().filter(x=>x.id!==editId);
    setAll(list); clearForm(); buildFilters(); render();
  };

  // Clear form
  $('#clearBtn').onclick=()=> clearForm();
  function clearForm(){
    editId=null; Object.values(f).forEach(x=>x.value=''); delBtn.style.display='none';
  }

  // Export CSV
  $('#exportBtn').onclick=()=>{
    const rows=[['ID','Name','Phone','Email','Area','Seva','FamilyID','Notes'],
      ...getAll().map(x=>[x.id,x.name||'',x.phone||'',x.email||'',x.area||'',x.seva||'',x.family||'',x.notes||''])];
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='directory.csv'; a.click(); URL.revokeObjectURL(url);
  };

  // Import CSV (columns: ID?, Name, Phone, Email, Area, Seva, FamilyID, Notes)
  $('#csvFile').onchange=(e)=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      const text=reader.result||''; const lines=text.split(/\r?\n/).filter(Boolean);
      if(lines.length<2){ alert('Empty CSV'); return; }
      const hdr=lines[0].split(',').map(s=>s.replace(/^"|"$/g,'').trim().toLowerCase());
      const idx=(k)=>hdr.indexOf(k);
      const list=getAll();
      for(let i=1;i<lines.length;i++){
        const cells=lines[i].match(/("([^"]|"")*"|[^,]+)/g)||[];
        const val=(j)=> (cells[j]||'').replace(/^"|"$/g,'').replace(/""/g,'"').trim();
        const rec={
          id: val(idx('id')) || uid(),
          name: val(idx('name')),
          phone: val(idx('phone')),
          email: val(idx('email')),
          area: val(idx('area')),
          seva: val(idx('seva')),
          family: val(idx('familyid')),
          notes: val(idx('notes'))
        };
        if(!rec.name && !rec.phone) continue;
        // merge by ID if exists, else by phone
        const j=list.findIndex(x=>x.id===rec.id || (rec.phone && x.phone===rec.phone));
        if(j>=0) list[j]={...list[j], ...rec, id:list[j].id}; else list.push(rec);
      }
      setAll(list); buildFilters(); render(); alert('Import complete.');
      e.target.value='';
    };
    reader.readAsText(file);
  };

  // search/filter listeners
  [q,fArea,fSeva].forEach(el=>el.addEventListener('input',render));

  applyI18n();
  buildFilters();
  render();
</script>
</body></html>
