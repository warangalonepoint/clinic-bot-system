<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Coordinator</title>
<link rel="stylesheet" href="styles.css"/>
<style>
  .note{padding:10px;margin:10px 0;border:1px solid #2a344a;border-radius:10px;background:#101623;color:#cbd5e1}
  .muted{opacity:.7}
  .card{background:#121826;border:1px solid #232a3a;border-radius:14px;padding:12px;margin:8px 0}
  .row{display:flex;justify-content:space-between;gap:12px;align-items:center}
</style>
</head>
<body class="dark">
<div class="wrapper">

  <section class="accent-cyan">
    <div class="glass header">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="eyebrow">Timetable & announcements</div>
          <div class="h1">Coordinator Panel</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" onclick="toggleTheme()">Theme</button>
          <button class="btn" onclick="resetApp()">Reset</button>
          <button class="btn" onclick="clearCache()">Clear Cache</button>
        </div>
      </div>
      <div class="tab-row" id="tabs">
        <button class="chip chip-indigo" data-tab="scope">Scope</button>
        <button class="chip chip-blue"   data-tab="timetable">Timetable</button>
        <button class="chip chip-fuchsia"data-tab="broadcast">Broadcast</button>
        <button class="chip chip-violet" data-tab="events">Events</button>
        <button class="chip chip-amber"  data-tab="complaints">Complaints</button>
        <button class="chip chip-teal"   data-tab="data">Data</button>
      </div>
    </div>
  </section>

  <section id="panel-scope" class="glass inner panel">
    <div class="h1">Choose Class Scope</div>
    <form id="scopeForm" class="form-grid mt-12">
      <input class="input full" placeholder="Class e.g., 5" name="class" required/>
      <input class="input full" placeholder="Section e.g., A" name="section" required/>
      <button class="btn btn-indigo">Save</button>
    </form>
    <div id="scopeInfo" class="muted mt-12"></div>
  </section>

  <section id="panel-timetable" class="glass inner panel" hidden>
    <div class="h1">Timetable</div>
    <form id="ttForm" class="form-grid mt-12">
      <select class="input" name="day" required>
        <option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option><option>Fri</option>
      </select>
      <input class="input" name="period" placeholder="Period # 1–12" type="number" required/>
      <input class="input" name="subject" placeholder="Subject" required/>
      <input class="input" name="teacher" placeholder="Teacher" required/>
      <input class="input" name="room" placeholder="Room (optional)"/>
      <button class="btn btn-blue">Add / Update</button>
    </form>
    <div id="ttMsg" class="note" hidden></div>
    <div id="ttList" class="mt-12"><div class="note">No entries yet.</div></div>
  </section>

  <section id="panel-broadcast" class="glass inner panel" hidden>
    <div class="h1">Broadcast Message</div>
    <form id="bcForm" class="form-grid mt-12">
      <textarea class="input full" name="msg" placeholder="Message…" required></textarea>
      <button class="btn btn-fuchsia">Send</button>
    </form>
    <div id="bcMsg" class="note" hidden></div>
    <div id="bcList" class="mt-12"><div class="note">No broadcasts yet.</div></div>
  </section>

  <section id="panel-events" class="glass inner panel" hidden>
    <div class="h1">Events</div>
    <form id="evForm" class="form-grid mt-12">
      <input class="input" name="title" placeholder="Event Title" required/>
      <input class="input" type="date" name="date" required/>
      <button class="btn btn-violet">Add</button>
    </form>
    <div id="evMsg" class="note" hidden></div>
    <div id="evList" class="mt-12"><div class="note">No events yet.</div></div>
  </section>

  <section id="panel-complaints" class="glass inner panel" hidden>
    <div class="h1">Complaints (placeholder)</div>
    <div class="note">Feature coming soon</div>
  </section>

  <section id="panel-data" class="glass inner panel" hidden>
    <div class="h1">Data Tools (placeholder)</div>
    <div class="note">Backup / restore to be added</div>
  </section>

</div>

<script type="module">
  import {initTabs} from './ui.js';
  initTabs(document);
</script>

<script type="module">
  import { sb } from "./js/supabase.js";
  window.clearCache = async function(){ try{ localStorage.clear(); if('caches'in window){const n=await caches.keys(); await Promise.all(n.map(x=>caches.delete(x)));} if('serviceWorker'in navigator){const r=await navigator.serviceWorker.getRegistrations(); for(const rr of r) await rr.unregister();} alert('✅ Cache cleared'); }catch(e){ alert('❌ '+e.message);} location.reload(true); };
  window.resetApp = function(){ try{ localStorage.removeItem('coord_scope'); localStorage.removeItem('admin_scope'); }catch{} location.href='index.html?t='+Date.now(); };

  const scopeKey='coord_scope';
  const scopeForm=document.getElementById('scopeForm'); const scopeInfo=document.getElementById('scopeInfo');
  const getScope=()=>JSON.parse(localStorage.getItem(scopeKey)||"{}");
  const setScope=(s)=>localStorage.setItem(scopeKey, JSON.stringify(s));
  function showScope(){ const s=getScope(); scopeInfo.textContent = s.class ? `Scope: Class ${s.class}-${s.section}` : 'No scope set.'; }
  showScope();
  scopeForm.addEventListener('submit', e=>{
    e.preventDefault();
    const fd=new FormData(scopeForm);
    setScope({class: fd.get('class'), section: fd.get('section')});
    showScope(); loadTimetable(); loadBroadcasts(); loadEvents();
  });

  async function loadTimetable(){
    const s=getScope(); const el=document.getElementById('ttList');
    if (!s.class){ el.innerHTML=`<div class="note">Set scope first.</div>`; return; }
    const { data, error } = await sb.from("timetable").select("*").eq("class",s.class).eq("section",s.section).order("day").order("period");
    if (error) { el.innerHTML = `<div class="note">Error loading timetable</div>`; return; }
    if (!data.length) { el.innerHTML = `<div class="note">No entries</div>`; return; }
    el.innerHTML = data.map(r=>`
      <div class="card">
        <div class="row"><b>${r.day} · Period ${r.period}</b><span class="muted">${r.room||''}</span></div>
        <div>${r.subject} — ${r.teacher}</div>
      </div>`).join("");
  }
  document.getElementById('ttForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const s=getScope(); const el=document.getElementById('ttMsg');
    if (!s.class){ el.hidden=false; el.textContent='❌ Set scope first.'; return; }
    const fd=new FormData(e.target);
    const { error } = await sb.from("timetable").upsert({
      class:s.class, section:s.section, day:fd.get('day'), period:parseInt(fd.get('period'),10),
      subject:fd.get('subject'), teacher:fd.get('teacher'), room:fd.get('room')||null
    }, { onConflict:'class,section,day,period' });
    el.hidden=false; el.textContent = error ? '❌ '+error.message : '✅ Saved';
    if (!error){ e.target.reset(); loadTimetable(); }
  });

  async function loadBroadcasts(){
    const { data, error } = await sb.from("announcements").select("*").order("created_at",{ascending:false}).limit(20);
    const el=document.getElementById('bcList');
    if (error) { el.innerHTML = `<div class="note">Error loading broadcasts</div>`; return; }
    if (!data.length) { el.innerHTML = `<div class="note">No broadcasts</div>`; return; }
    el.innerHTML = data.map(a=>`
      <div class="card">
        <div class="row"><b>Broadcast</b><span class="muted">${new Date(a.created_at).toLocaleString()}</span></div>
        <div>${a.body}</div>
      </div>`).join("");
  }
  document.getElementById('bcForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const { error } = await sb.from("announcements").insert({ body: fd.get('msg') });
    const el=document.getElementById('bcMsg'); el.hidden=false; el.textContent = error ? '❌ '+error.message : '✅ Sent';
    if (!error){ e.target.reset(); loadBroadcasts(); }
  });

  async function loadEvents(){
    const { data, error } = await sb.from("events").select("*").order("event_date",{ascending:true}).limit(20);
    const el=document.getElementById('evList');
    if (error) { el.innerHTML = `<div class="note">Error loading events</div>`; return; }
    if (!data.length) { el.innerHTML = `<div class="note">No events</div>`; return; }
    el.innerHTML = data.map(ev=>`
      <div class="card">
        <div class="row"><b>${ev.title}</b><span class="muted">${ev.event_date||''}</span></div>
      </div>`).join("");
  }
  document.getElementById('evForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const { error } = await sb.from("events").insert({ title: fd.get('title'), event_date: fd.get('date') });
    const el=document.getElementById('evMsg'); el.hidden=false; el.textContent = error ? '❌ '+error.message : '✅ Added';
    if (!error){ e.target.reset(); loadEvents(); }
  });

  loadTimetable(); loadBroadcasts(); loadEvents();
  sb.channel("coord-rt")
    .on("postgres_changes",{event:"*",schema:"public",table:"timetable"},loadTimetable)
    .on("postgres_changes",{event:"*",schema:"public",table:"announcements"},loadBroadcasts)
    .on("postgres_changes",{event:"*",schema:"public",table:"events"},loadEvents)
    .subscribe();
</script>

<script type="module" src="ui.js"></script>
</body>
</html>
