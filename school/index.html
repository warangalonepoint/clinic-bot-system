<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School PWA • PIN</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0b1020" />
</head>
<body>
  <main>
    <div class="topbar">
      <span class="badge">School PWA</span>
      <label title="Dark / Light">
        <input id="themeToggle" class="theme-toggle" type="checkbox" />
      </label>
    </div>

    <header class="hero panel" style="height:200px;">
      <div class="title">Welcome</div>
    </header>

    <div class="spacer"></div>

    <section class="panel">
      <h1>Enter PIN</h1>
      <p class="muted">You’ll be routed to your role automatically.</p>
      <form id="pinForm" class="card gradient-1">
        <label for="pin">4–8 digit PIN</label>
        <input id="pin" inputmode="numeric" placeholder="••••" autocomplete="one-time-code" />
        <div class="spacer"></div>
        <button class="btn block">Continue</button>
        <div id="msg" class="muted" style="margin-top:10px;"></div>
      </form>
    </section>
  </main>

  <script>
    // THEME
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('theme') || 'dark';
    root.setAttribute('data-theme', savedTheme);
    document.getElementById('themeToggle').checked = savedTheme === 'light';
    document.getElementById('themeToggle').addEventListener('change', e=>{
      const t = e.target.checked ? 'light' : 'dark';
      root.setAttribute('data-theme', t); localStorage.setItem('theme', t);
    });

    const rolePage = {
      coordinator: "./coordinator.html",
      teacher: "./teacher.html",
      parents: "./parents.html",
      admin: "./admin.html"
    };

    async function loadPins(){
      const r = await fetch("./pins.json", {cache:"no-store"});
      if(!r.ok) throw new Error("pins.json not found");
      return r.json(); // { "coordinator":"1111", "teacher":"2222", ... }
    }

    document.getElementById('pinForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const pin = (document.getElementById('pin').value || "").trim();
      const msg = document.getElementById('msg');
      if(pin.length < 4){ msg.textContent = "PIN must be 4+ digits."; return; }
      msg.textContent = "Checking…";
      try{
        const pins = await loadPins();
        let matchedRole = null;
        for(const [role,val] of Object.entries(pins)){
          if(String(val) === pin){ matchedRole = role; break; }
        }
        if(!matchedRole){ msg.textContent = "Invalid PIN"; return; }

        // Save login
        sessionStorage.setItem("sch_role", matchedRole);
        sessionStorage.setItem("sch_login_at", String(Date.now()));
        location.replace(rolePage[matchedRole] || "./index.html");
      }catch(err){
        msg.textContent = "Error loading configuration."; console.error(err);
      }
    });
  </script>
</body>
</html>
