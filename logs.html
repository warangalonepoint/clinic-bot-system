<script>
  const csvUrl = "logs.csv";
  let allData = [];

  function fetchData() {
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function (results) {
        const logData = results.data.filter(row => row.Date);
        allData = logData;
        updateSummary(logData);
        renderTable(logData);
      },
    });
  }

  function updateSummary(data) {
    const today = new Date().toISOString().split("T")[0];
    const todayCount = data.filter(r => r.Date === today).length;
    const todayTokens = data
      .filter(r => r.Date === today)
      .map(r => parseInt(r.Token))
      .filter(n => !isNaN(n));
    const nextToken = todayTokens.length > 0 ? Math.max(...todayTokens) + 1 : 1;
    document.getElementById("stats").textContent = `âœ… Bookings Today: ${todayCount} | Next Token: ${nextToken}`;
  }

  function renderTable(data) {
    const tbody = document.querySelector("#logTable tbody");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.Date}</td>
        <td>${row.Time}</td>
        <td>${row.Name}</td>
        <td>${row.Reason}</td>
        <td><a href="tel:${row.Contact}">${row.Contact}</a></td>
        <td>${row.Clinic}</td>
        <td>${row.Token}</td>
        <td>${row["Reminder Sent"] || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function exportCSV() {
    const csv = Papa.unparse(allData);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "AppointmentLogs.csv");
    link.click();
  }

  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const headers = [["Date", "Time", "Name", "Reason", "Contact", "Clinic", "Token", "Reminder"]];
    const rows = allData.map(r => [
      r.Date, r.Time, r.Name, r.Reason, r.Contact, r.Clinic, r.Token, r["Reminder Sent"] || ""
    ]);
    doc.autoTable({ head: headers, body: rows });
    doc.save("logs-export.pdf");
  }

  function filterDate(type) {
    let filtered = [];
    const today = new Date();
    if (type === "today") {
      const d = today.toISOString().split("T")[0];
      filtered = allData.filter(e => e.Date === d);
    } else if (type === "yesterday") {
      today.setDate(today.getDate() - 1);
      const d = today.toISOString().split("T")[0];
      filtered = allData.filter(e => e.Date === d);
    } else {
      const sd = document.getElementById("startDate").value;
      const ed = document.getElementById("endDate").value;
      if (!sd || !ed) return alert("Select valid date range");
      filtered = allData.filter(e => e.Date >= sd && e.Date <= ed);
    }
    updateSummary(filtered);
    renderTable(filtered);
  }

  fetchData();
</script>
