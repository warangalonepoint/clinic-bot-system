<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Loan Request</title>
<style>
:root{color-scheme:dark}
body{margin:0;font-family:system-ui,Inter,Arial;background:#0f1115;color:#e8eaed}
.wrap{max-width:980px;margin:24px auto;padding:16px}
.bar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.btn{background:#2563eb;border:0;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
.ghost{background:#11141a;border:1px solid #1f2432}
.danger{background:#ef4444}
.pill{display:inline-flex;align-items:center;background:#0f1218;border:1px solid #262b38;padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
.card{background:#171a21;border:1px solid #222736;border-radius:18px;padding:18px;margin-top:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.input, select, textarea{padding:12px;border-radius:12px;border:1px solid #262b38;background:#0f1218;color:#e8eaed}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{padding:10px 12px;text-align:left} tr{background:#11141a;border:1px solid #1f2432}
tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
.badge{background:#0f1218;border:1px solid #262b38;border-radius:999px;padding:3px 8px;font-size:12px}
.ok{color:#86efac}.warn{color:#fde68a}.err{color:#fca5a5}
.muted{opacity:.75}
footer{opacity:.7;font-size:13px;margin:18px 0;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <h2 style="margin:0">üí∏ <span data-i18n="loan_request">Loan Request</span></h2>
    <div class="row">
      <span id="lang-pill" class="pill" onclick="setLang(getLang()==='te'?'en':'te')">English ‚òÄÔ∏è</span>
      <button class="btn ghost" onclick="history.back()" data-i18n="home">Home</button>
      <button class="btn ghost" id="exportBtn">Export CSV</button>
    </div>
  </div>

  <div class="card">
    <b>New Request</b>
    <div class="row" style="margin-top:10px">
      <input id="name" class="input" style="min-width:220px" placeholder="Your Name">
      <input id="phone" class="input" style="min-width:180px" placeholder="Phone">
      <input id="amount" class="input" type="number" placeholder="Amount (‚Çπ)">
      <input id="purpose" class="input" style="flex:1" placeholder="Purpose (e.g., education)">
    </div>
    <div class="row" style="margin-top:6px">
      <input id="months" class="input" type="number" min="1" placeholder="Term (months)">
      <input id="rate" class="input" type="number" step="0.1" placeholder="Expected Rate % p.a. (optional)">
      <input id="collateral" class="input" placeholder="Collateral (optional)">
      <button class="btn" id="calcBtn">EMI Preview</button>
      <div id="emiBox" class="badge" style="display:none"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="submitBtn">Submit Request</button>
      <button class="btn ghost" id="clearDraft">Clear</button>
    </div>
  </div>

  <div class="card">
    <b>My Requests</b>
    <table class="table"><thead>
      <tr><th>Date</th><th>Amount</th><th>Term</th><th>Purpose</th><th>Status</th><th>Decision</th></tr>
    </thead><tbody id="mine"></tbody></table>
    <p class="muted" id="mineEmpty" style="display:none">No requests yet.</p>
  </div>

  <div class="card">
    <b>All Requests (read-only)</b>
    <table class="table"><thead>
      <tr><th>Date</th><th>Name</th><th>Phone</th><th>Amount</th><th>Term</th><th>Purpose</th><th>Status</th></tr>
    </thead><tbody id="all"></tbody></table>
  </div>

  <footer>¬© Padmashali Community ‚Äî V1</footer>
</div>

<script src="i18n.js"></script>
<script>
  // guard: any logged-in role can open
  const s = JSON.parse(localStorage.getItem("pc_session")||"null");
  if(!s){ location.href='index.html'; }
  if(!localStorage.getItem('pc_uid')) localStorage.setItem('pc_uid','U'+Math.random().toString(36).slice(2,10));
  const UID = localStorage.getItem('pc_uid');

  const K='pc_loans';
  const nameEl = document.getElementById('name');
  const phoneEl = document.getElementById('phone');
  const amountEl = document.getElementById('amount');
  const purposeEl = document.getElementById('purpose');
  const monthsEl = document.getElementById('months');
  const rateEl = document.getElementById('rate');
  const collEl = document.getElementById('collateral');
  const emiBox = document.getElementById('emiBox');

  // Prefill from last use
  nameEl.value = localStorage.getItem('pc_name')||'';
  phoneEl.value = localStorage.getItem('pc_phone')||'';

  function getAll(){ return JSON.parse(localStorage.getItem(K)||'[]'); }
  function setAll(v){ localStorage.setItem(K, JSON.stringify(v)); }

  function fmtMoney(x){ return '‚Çπ'+Number(x).toLocaleString('en-IN'); }
  function emi(p, annualRate, m){
    const r = annualRate/12/100;
    if(!r) return p/m;
    return p * r * Math.pow(1+r,m) / (Math.pow(1+r,m)-1);
  }

  document.getElementById('calcBtn').onclick=()=>{
    const p=Number(amountEl.value||0), m=Number(monthsEl.value||0), r=Number(rateEl.value||0||12);
    if(p<=0||m<=0){ alert('Enter amount & months'); return; }
    const e = Math.round(emi(p, r||12, m));
    emiBox.style.display='inline-block';
    emiBox.textContent = `Est. EMI: ${fmtMoney(e)} @ ${r||12}% p.a.`;
  };

  document.getElementById('submitBtn').onclick=()=>{
    const name=(nameEl.value||'').trim(), phone=(phoneEl.value||'').trim();
    const amount=Number(amountEl.value||0), purpose=(purposeEl.value||'').trim();
    const months=Number(monthsEl.value||0), rate=Number(rateEl.value||0), collateral=(collEl.value||'').trim();
    if(!name||!phone||!amount||!purpose||!months){ alert('Fill all required fields'); return; }
    localStorage.setItem('pc_name', name); localStorage.setItem('pc_phone', phone);
    const list=getAll();
    list.push({
      id:'L'+Date.now().toString(36),
      uid:UID, role:s.role,
      name, phone, amount, purpose, months, rate: rate||null, collateral,
      status:'Pending',
      decision:null,  // {approvedAmount, months, rate, emi}
      ts:Date.now()
    });
    setAll(list);
    alert('Request submitted. Status: Pending.');
    render();
  };

  document.getElementById('clearDraft').onclick=()=>{
    [amountEl,purposeEl,monthsEl,rateEl,collEl].forEach(el=>el.value='');
    emiBox.style.display='none';
  };

  document.getElementById('exportBtn').onclick=()=>{
    const rows=[['ID','Name','Phone','Amount','Months','ExpectedRate','Collateral','Status','Decision'],
      ...getAll().map(x=>[
        x.id,x.name,x.phone,x.amount,x.months,x.rate??'',x.collateral??'',
        x.status, x.decision? JSON.stringify(x.decision):''
      ])
    ];
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='loan_requests.csv'; a.click(); URL.revokeObjectURL(url);
  };

  function render(){
    const list=getAll();
    // my table
    const mineT=document.getElementById('mine'), mineEmpty=document.getElementById('mineEmpty');
    const mine=list.filter(x=>x.uid===UID).sort((a,b)=>b.ts-a.ts);
    mineT.innerHTML=''; mineEmpty.style.display = mine.length? 'none':'block';
    mine.forEach(x=>{
      const tr=document.createElement('tr');
      const dec = x.decision ? `‚Çπ${x.decision.approvedAmount} / ${x.decision.months}m @ ${x.decision.rate}% (EMI ‚Çπ${x.decision.emi})` : '‚Äî';
      tr.innerHTML=`<td>${new Date(x.ts).toLocaleDateString('en-IN')}</td>
        <td>${fmtMoney(x.amount)}</td><td>${x.months}m</td><td>${x.purpose}</td>
        <td><span class="badge ${x.status==='Approved'?'ok':x.status==='Pending'?'warn':'err'}">${x.status}</span></td>
        <td>${dec}</td>`;
      mineT.appendChild(tr);
    });
    // all table
    const allT=document.getElementById('all'); allT.innerHTML='';
    list.sort((a,b)=>b.ts-a.ts).forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${new Date(x.ts).toLocaleDateString('en-IN')}</td>
        <td>${x.name}</td><td>${x.phone}</td><td>${fmtMoney(x.amount)}</td>
        <td>${x.months}m</td><td>${x.purpose}</td>
        <td><span class="badge ${x.status==='Approved'?'ok':x.status==='Pending'?'warn':'err'}">${x.status}</span></td>`;
      allT.appendChild(tr);
    });
  }

  applyI18n();
  render();
</script>
</body></html>
