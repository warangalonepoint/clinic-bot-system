<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Apartments • PIN</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="./styles.css">
  <meta name="theme-color" content="#111"/>
</head>
<body class="bg">
  <!-- Language Toggle -->
  <button id="langToggle" class="lang-toggle" aria-label="Toggle language" title="తెలుగుకు మారండి">TE</button>

  <main class="wrap">
    <!-- Header -->
    <div class="card hero">
      <img class="banner" src="./assets/apartments_banner.png" alt="Apartments">
      <div class="hero-overlay">
        <img class="logo" src="./assets/logo.png" onerror="this.style.display='none'">
        <div class="hero-title">Onestop Apartments</div>
      </div>
    </div>

    <!-- PIN -->
    <div class="card mt">
      <h2 class="h2" data-i18n="Login PIN">Login PIN</h2>
      <p class="muted" data-i18n="Welcome">Welcome</p>
      <form id="pinForm">
        <input id="pin" type="password" inputmode="numeric" autocomplete="one-time-code"
               class="in"
               placeholder="Login PIN"
               data-i18n-placeholder="Login PIN">
        <button class="btn w100 mt8" type="submit" data-i18n="Submit">Submit</button>
      </form>
      <div id="msg" class="muted mt8"></div>
    </div>
  </main>

  <!-- i18n first (defer preserves order before inline script below) -->
  <script src="./lang.js" defer></script>

  <script defer>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }

    const rolePage = {
      residents : "./residents.html",
      guards    : "./guards.html",
      committee : "./committee.html",
      admin     : "./admin.html"
    };

    async function loadPins(){
      const r = await fetch("./pins.json",{cache:"no-store"});
      if(!r.ok) throw new Error("pins.json missing");
      return r.json();
    }

    // translator helper (works even if AppI18N not ready yet)
    function tr(key){
      if (window.AppI18N && typeof window.AppI18N.t === 'function') {
        return window.AppI18N.t(key);
      }
      return key; // fallback
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const form = document.getElementById("pinForm");
      const msg  = document.getElementById("msg");

      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        msg.textContent = tr("Checking…");
        try{
          const pin = document.getElementById("pin").value.trim();
          const pins = await loadPins();
          let matched = null;
          for(const [role,val] of Object.entries(pins)){
            if(String(val)===pin){ matched = role; break; }
          }
          if(!matched){
            msg.textContent = tr("Invalid PIN.");
            return;
          }
          sessionStorage.setItem("apt_role", matched);
          sessionStorage.setItem("apt_login_at", String(Date.now()));
          location.replace(rolePage[matched] || "./index.html");
        }catch(err){
          msg.textContent = tr("Error loading PINs.");
          console.error(err);
        }
      });
    });
  </script>
</body>
</html>
