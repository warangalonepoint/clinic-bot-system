<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Clinic • Booking</title>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="stylesheet" href="./styles.css">
<meta name="theme-color" content="#111"/>
<style>
  main{max-width:720px;margin:16px auto;padding:16px}
  /* Polished banner/header */
  .card{background:#fff;border-radius:18px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
  .hero{position:relative;padding:0;overflow:hidden;border-radius:18px}
  .banner{width:100%;height:180px;object-fit:cover;display:block}
  @media(max-width:560px){.banner{height:140px}}
  .hero-overlay{position:absolute;inset:0;display:flex;align-items:flex-end;padding:14px;background:linear-gradient(to bottom,rgba(0,0,0,0) 55%,rgba(0,0,0,.38))}
  .logo{position:absolute;top:12px;left:12px;width:56px;height:56px;border-radius:999px;background:#fff;padding:8px;box-shadow:0 6px 20px rgba(0,0,0,.18)}
  .hero-title{margin-left:80px;margin-bottom:6px;font-weight:800;font-size:20px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.35)}
  .hero,.logo,.hero-title{animation:fade .35s ease-out both}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  /* Form + buttons */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:560px){.grid{grid-template-columns:1fr}}
  input,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;font-size:15px}
  .btn{padding:12px 16px;border:0;border-radius:12px;font-weight:700;background:#111;color:#fff;cursor:pointer;width:100%;text-align:center;text-decoration:none}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .muted{color:#666}
  .ok{color:#0d7c66}

  /* Quick links: black buttons, two per row */
  .ql-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:360px){.ql-2{grid-template-columns:1fr 1fr}}
  .iconbtn{display:flex;align-items:center;gap:10px;justify-content:center}
  .iconbtn img{width:22px;height:22px;border-radius:6px}
</style>
</head><body>
<main>
  <!-- Polished banner -->
  <div class="card hero">
    <img class="banner" src="./assets/clinic_banner.png" alt="Clinic">
    <div class="hero-overlay">
      <img class="logo" src="./assets/logo.png" onerror="this.src='./assets/booking.png'">
      <div class="hero-title">Book an Appointment</div>
    </div>
  </div>

  <!-- Booking form -->
  <div class="card" style="margin-top:12px">
    <h2 style="margin:0 0 6px">Choose slot & confirm</h2>
    <p class="muted" style="margin-bottom:8px">Only free, open slots are shown. You’ll get a WhatsApp confirmation.</p>
    <div class="grid">
      <label>Date <input id="d" type="date"></label>
      <label>Time Slot <select id="t"></select></label>
      <label>Name <input id="n" placeholder="Full name"></label>
      <label>Phone <input id="p" inputmode="numeric" maxlength="10" placeholder="10-digit"></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="book">Confirm Booking</button>
    </div>
    <div id="ok" class="ok" style="margin-top:10px"></div>
    <div id="waWrap" class="row" style="margin-top:8px;display:none">
      <a id="waBtn" class="btn iconbtn" target="_blank" rel="noopener">
        <img src="./assets/booking.png" onerror="this.style.display='none'">Open WhatsApp
      </a>
    </div>
    <div id="hint" class="muted" style="margin-top:8px;display:none">
      Tip: Add this to Home Screen to book even faster next time.
    </div>
  </div>

  <!-- Tools -->
  <div class="card" style="margin-top:12px">
    <div class="ql-2">
      <a class="btn iconbtn" href="./index.html"><img src="./assets/admin.png" onerror="this.style.display='none'">Back to PIN</a>
      <a class="btn iconbtn" href="./doctor.html"><img src="./assets/doctor.png" onerror="this.style.display='none'">Doctor View</a>
    </div>
  </div>
</main>

<script>
// Register SW
if("serviceWorker" in navigator){navigator.serviceWorker.register("./sw.js").catch(()=>{});}

// ------- CONFIG -------
const CLINIC_WA_NUMBER = "918686019709"; // your number baked in

// ------- Storage & utils -------
const K={slots:"cl_slots", appts:"cl_a"};
const jget=k=>JSON.parse(localStorage.getItem(k)||"[]");
const jset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const today=()=>new Date().toISOString().slice(0,10);

function slKey(date){return `${K.slots}_${date}`;}
function loadSlots(date){const arr=jget(slKey(date)); return Array.isArray(arr)?arr:[];}
function saveSlots(date,rows){jset(slKey(date),rows);}

function fillTimeOptions(date){
  const sel=document.getElementById("t"); sel.innerHTML="";
  const slots=loadSlots(date).filter(s=>(s.status||"Open")!=="Closed");
  if(!slots.length){ sel.innerHTML = '<option value="">No slots for this date</option>'; return; }
  slots.forEach(s=>{
    const free=(s.booked||0) < Number(s.cap||1);
    const opt=document.createElement("option");
    opt.value=s.time;
    opt.textContent = free ? `${s.time} (free ${Number(s.cap)-(s.booked||0)})` : `${s.time} (full)`;
    if(!free) opt.disabled=true;
    sel.appendChild(opt);
  });
}

function init(){
  const d=document.getElementById("d");
  d.value=today();
  fillTimeOptions(d.value);
  d.addEventListener("change", ()=>fillTimeOptions(d.value));
}
init();

function waLink({date,time,name,phone}){
  if(!CLINIC_WA_NUMBER) return "";
  const txt = `Hi Clinic, I booked an appointment for ${date} at ${time}. Name: ${name}, Phone: ${phone}.`;
  return `https://wa.me/${CLINIC_WA_NUMBER}?text=${encodeURIComponent(txt)}`;
}

document.getElementById("book").onclick=()=>{
  const date=d.value, time=t.value, name=n.value.trim(), phone=p.value.trim();
  if(!date||!time||!name||phone.length!==10){ alert("Fill all fields (10-digit phone)."); return; }

  // capacity check + increment
  const key=slKey(date); let slots=jget(key); const i=slots.findIndex(s=>s.time===time);
  if(i>-1){
    const s=slots[i]; const cap=Number(s.cap||1), booked=Number(s.booked||0);
    if(booked>=cap){ alert("That slot just became full. Pick another."); fillTimeOptions(date); return; }
    slots[i]={...s, booked: booked+1}; jset(key,slots);
  }

  // save appointment (Doctor page will assign token automatically)
  const appts=jget(K.appts);
  appts.push({date,time,name,phone,status:"Booked",ts:Date.now()});
  jset(K.appts, appts);

  // UI feedback
  ok.textContent = `Booked ✅ ${date} @ ${time}. Show this at reception. Token will be assigned on arrival.`;
  hint.style.display = "block";

  // WhatsApp (optional)
  const link = waLink({date,time,name,phone});
  if(link){
    waWrap.style.display = "flex";
    waBtn.href = link;
  }else{
    waWrap.style.display = "none";
  }

  // Refresh time options with updated capacity
  fillTimeOptions(date);

  // Clear name field only
  n.value="";
};
</script>
</body></html>
