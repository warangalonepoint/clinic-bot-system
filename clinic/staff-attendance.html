<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Staff Attendance</title>
  <link rel="manifest" href="../manifest.json" />
  <link rel="icon" href="assets/clinic-logo.png" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      transition: 0.3s ease;
    }
    :root {
      --bg: #ffffff;
      --text: #000000;
      --card: #f0f0f0;
    }
    .dark {
      --bg: #121212;
      --text: #ffffff;
      --card: #1e1e1e;
    }
    header {
      background-color: #00796b;
      color: white;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header img {
      height: 32px;
      margin-right: 8px;
    }
    .toggle-theme {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .banner {
      width: 100%;
      height: 160px;
      object-fit: cover;
    }
    .container {
      padding: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background-color: var(--card);
    }
    th, td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: left;
    }
    .export-btn {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #000;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    footer {
      text-align: center;
      font-size: 12px;
      margin: 2rem 0;
      color: #777;
    }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center;">
      <img src="assets/clinic-logo.png" alt="Logo">
      <h2>Staff Attendance</h2>
    </div>
    <button class="toggle-theme" onclick="toggleTheme()">üåì</button>
  </header>

  <img src="assets/clinic-hero-banner.png" class="banner" alt="Banner"/>

  <div class="container">
    <h3>Onestop AI Clinic</h3>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Staff Name</th>
          <th>Status</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="4">Loading data...</td></tr>
      </tbody>
    </table>
    <button class="export-btn" onclick="exportCSV()">‚¨áÔ∏è Export</button>
  </div>

  <footer>Powered by Onestop AI</footer>

  <script>
    const tableBody = document.querySelector("#attendanceTable tbody");

    const API_KEY = "patLNwoJQKE3Tjb8J.c2a0db129111c610fae64a2c01e0a626f37bdb5992232eae6ebc644fa9073dfb3";
    const BASE_ID = "appgIT8WiqnZlR44Y";
    const TABLE_NAME = "StaffAttendance";
    const VIEW_NAME = "Grid%20view";

    const fetchURL = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}?view=${VIEW_NAME}`;

    async function fetchAttendance() {
      try {
        const response = await fetch(fetchURL, {
          headers: {
            Authorization: `Bearer ${API_KEY}`,
          },
        });
        const data = await response.json();

        if (!data.records) {
          throw new Error("No records found");
        }

        tableBody.innerHTML = "";
        data.records.forEach((record) => {
          const { Date, "Staff Name": staffName, Status, Notes } = record.fields;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${Date || ""}</td>
            <td>${staffName || ""}</td>
            <td>${Status || ""}</td>
            <td>${Notes || ""}</td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        tableBody.innerHTML = `<tr><td colspan="4">Error loading data</td></tr>`;
        console.error("Error fetching attendance:", error);
      }
    }

    function exportCSV() {
      const rows = [];
      document.querySelectorAll("#attendanceTable tr").forEach((tr) => {
        const cols = Array.from(tr.querySelectorAll("th, td")).map(td => td.innerText);
        rows.push(cols);
      });
      const csv = Papa.unparse(rows);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "StaffAttendance.csv";
      a.click();
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }

    (function loadTheme() {
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
      }
    })();

    fetchAttendance();
  </script>
</body>
</html>
