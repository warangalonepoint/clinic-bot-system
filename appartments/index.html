<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Onestop Apartments ‚Äî Sprint 0</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#111827" />
<style>
  :root{
    --bg:#f6f7fb;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--brand:#111827;
    --ok:#16a34a;--bad:#ef4444;--chip:#eef2ff;--line:#e5e7eb;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  body{margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:720px;margin:24px auto;padding:0 16px}
  .hero{background:linear-gradient(180deg,#f1f5ff,#fff);border:1px solid var(--line);
        border-radius:16px;padding:18px 16px;margin-bottom:16px}
  h1{margin:4px 0 8px;font-size:28px}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;
        background:var(--chip);border:1px solid var(--line);color:#3730a3;font-weight:600;font-size:13px}
  .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:14px 16px;
       border-radius:12px;border:1px solid #111827;background:var(--brand);color:#fff;font-weight:700;
       font-size:16px;cursor:pointer}
  .btn.secondary{background:#11182710;color:#111827;border-color:#cbd5e1}
  .btn.ghost{background:transparent;color:#111827;border-color:#cbd5e1}
  .btn.danger{background:var(--bad);border-color:var(--bad)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:16px 0}
  label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
  input,select{width:100%;padding:14px 12px;border:1px solid var(--line);border-radius:12px;
               font-size:16px;background:#fff;outline:none}
  .hint{color:var(--muted);font-size:13px}
  .book{display:flex;flex-direction:column;gap:12px}
  .item{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px 12px;
        display:grid;grid-template-columns:1fr auto;gap:8px}
  .meta{color:var(--muted);font-size:13px}
  .tok{font-weight:700;letter-spacing:.4px}
  a{text-decoration:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span class="pill">Sprint 0 ‚Äî Offline demo</span>
      <a class="btn secondary" href="./visitors.html">üë§ Visitor Pass</a>
    </div>
    <h1>Onestop Apartments</h1>
    <div class="hint">Book amenities. Install to Home Screen for a native feel.</div>
  </div>

  <!-- Booking form -->
  <div class="card">
    <h3 style="margin:0 0 8px">Book an Amenity</h3>
    <div class="book">
      <div>
        <label>Amenity</label>
        <select id="amenity">
          <option value="gym">Gym (30 min, cap 8)</option>
          <option value="tennis">Tennis Court (60 min, cap 4)</option>
          <option value="hall">Community Hall (120 min, cap 20)</option>
        </select>
      </div>
      <div class="row">
        <div>
          <label>Date</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>Time Slot</label>
          <select id="slot"></select>
        </div>
      </div>
      <div>
        <label>Resident Name</label>
        <input id="name" placeholder="Full name" />
      </div>
      <div>
        <label>Phone</label>
        <input id="phone" inputmode="numeric" maxlength="10" placeholder="10-digit number" />
      </div>
      <button id="confirm" class="btn" disabled>Confirm Booking</button>
      <div class="hint">Fully-booked slots are hidden automatically (this device only).</div>
    </div>
  </div>

  <!-- My bookings -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <h3 style="margin:0">My Bookings</h3>
      <div style="display:flex;gap:8px">
        <button id="exportCsv" class="btn ghost">‚¨áÔ∏è Export CSV</button>
        <button id="clearAll"  class="btn danger">Clear All</button>
      </div>
    </div>
    <div id="list" style="display:flex;flex-direction:column;gap:12px;margin-top:12px"></div>
    <div id="empty" class="hint">No bookings yet.</div>
  </div>

  <div class="hint" style="text-align:center;margin:12px 0 24px">
    Install: tap ‚Ä¢‚Ä¢‚Ä¢ ‚Üí <b>Add to Home screen</b>
  </div>
</div>

<script>
  // ------------------------------ PWA (register service worker) ------------------------------
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }

  // ------------------------------ Storage ------------------------------
  const KEY = 'onestop_apts_bookings_v1';

  function loadAll(){
    try { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
    catch { return []; }
  }
  function saveAll(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }

  // ------------------------------ Amenity rules ------------------------------
  const rules = {
    gym:    {label:'Gym',        interval:30,  start:6,  end:22, capacity:8},
    tennis: {label:'Tennis',     interval:60,  start:6,  end:22, capacity:4},
    hall:   {label:'Community',  interval:120, start:8,  end:20, capacity:20},
  };

  function pad(n){ return String(n).padStart(2,'0'); }
  function slotLabel(h,m){
    const d = new Date(); d.setHours(h,m,0,0);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
  function makeSlots(rule){
    const out=[];
    for(let h=rule.start; h<rule.end;){
      out.push({h, m:0}); // start on hour
      h += rule.interval/60;
      // for non-hour intervals, add :30 etc.
      // robust approach:
    }
    // Do precise stepping:
    out.length=0;
    let minutes = rule.start*60;
    const last = rule.end*60;
    while(minutes < last){
      const h = Math.floor(minutes/60), m = minutes%60;
      out.push({h,m});
      minutes += rule.interval;
    }
    return out;
  }

  function keyFor(a,date,slot){ return `${a}|${date}|${slot}`; }

  // Count bookings for a slot (this device only)
  function countFor(amenity,date,slot){
    return loadAll().filter(b => b.amenity===amenity && b.date===date && b.slot===slot).length;
  }

  // ------------------------------ UI elements ------------------------------
  const els = {
    amenity: document.getElementById('amenity'),
    date:    document.getElementById('date'),
    slot:    document.getElementById('slot'),
    name:    document.getElementById('name'),
    phone:   document.getElementById('phone'),
    confirm: document.getElementById('confirm'),
    list:    document.getElementById('list'),
    empty:   document.getElementById('empty'),
    export:  document.getElementById('exportCsv'),
    clear:   document.getElementById('clearAll'),
  };

  // defaults
  (function initDefaults(){
    const today = new Date();
    els.date.value = today.toISOString().slice(0,10);
    rebuildSlots();
    validateForm();
  })();

  function rebuildSlots(){
    const a = els.amenity.value;
    const rule = rules[a];
    const slots = makeSlots(rule);
    els.slot.innerHTML = '';
    const date = els.date.value;
    for(const s of slots){
      const value = `${pad(s.h)}:${pad(s.m)}`;
      const used = countFor(a,date,value);
      if(used >= rule.capacity) continue; // hide full ones
      const opt = new Option(slotLabel(s.h,s.m), value);
      els.slot.add(opt);
    }
    els.confirm.disabled = !els.slot.options.length;
  }

  els.amenity.addEventListener('change', rebuildSlots);
  els.date.addEventListener('change', rebuildSlots);

  // simple validation to enable button
  function validateForm(){
    const ok = els.name.value.trim() && /^\d{10}$/.test(els.phone.value.trim()) &&
               els.slot.value && els.date.value;
    els.confirm.disabled = !ok;
  }
  ['input','change'].forEach(ev=>{
    els.name.addEventListener(ev, validateForm);
    els.phone.addEventListener(ev, validateForm);
    els.slot.addEventListener(ev, validateForm);
    els.date.addEventListener(ev, validateForm);
  });

  // Token: index within the slot (count+1)
  function nextToken(amenity,date,slot){
    return countFor(amenity,date,slot) + 1;
  }

  els.confirm.addEventListener('click', ()=>{
    const amenity = els.amenity.value;
    const date = els.date.value;
    const slot = els.slot.value;
    const name = els.name.value.trim();
    const phone = els.phone.value.trim();
    const rule = rules[amenity];

    if(!name || !/^\d{10}$/.test(phone) || !slot){ alert('Please fill all fields correctly.'); return; }

    // capacity guard (just in case race on same device)
    if(countFor(amenity,date,slot) >= rule.capacity){ alert('That slot just filled. Pick another.'); rebuildSlots(); return; }

    const booking = {
      id: crypto.randomUUID(),
      amenity, date, slot, name, phone,
      token: nextToken(amenity,date,slot),
      createdAt: new Date().toISOString(),
    };
    const all = loadAll(); all.push(booking); saveAll(all);
    rebuildSlots();
    renderList();
    alert(`${rules[amenity].label} booked!\nDate: ${fmtDate(date)}\nTime: ${fmtTime(slot)}\nToken: ${booking.token}`);
    els.name.value=''; els.phone.value='';
    validateForm();
  });

  function fmtDate(d){
    try{
      const dt = new Date(d+'T00:00'); 
      return dt.toLocaleDateString(undefined,{weekday:'short', day:'numeric', month:'short', year:'numeric'});
    }catch{return d}
  }
  function fmtTime(t){
    try{
      const [h,m]=t.split(':').map(Number);
      const d=new Date(); d.setHours(h,m,0,0);
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }catch{return t}
  }

  function renderList(){
    const data = loadAll().sort((a,b)=>(a.date+a.slot).localeCompare(b.date+b.slot));
    els.list.innerHTML = '';
    els.empty.style.display = data.length ? 'none' : 'block';
    for(const b of data){
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div>
          <div style="font-weight:700">${rules[b.amenity].label} ‚Ä¢ <span class="tok">#${b.token}</span></div>
          <div class="meta">${fmtDate(b.date)} ‚Ä¢ ${fmtTime(b.slot)}</div>
          <div class="meta">${b.name} ‚Ä¢ ${b.phone}</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn secondary" data-copy="${b.id}">Copy</button>
          <button class="btn danger" data-del="${b.id}">Delete</button>
        </div>`;
      els.list.appendChild(div);
    }
  }
  renderList();

  els.list.addEventListener('click', async (e)=>{
    const idCopy = e.target.getAttribute('data-copy');
    const idDel  = e.target.getAttribute('data-del');
    if(idCopy){
      const b = loadAll().find(x=>x.id===idCopy);
      if(b){
        const text = `Amenity: ${rules[b.amenity].label}
Date: ${fmtDate(b.date)}
Time: ${fmtTime(b.slot)}
Token: ${b.token}
Name: ${b.name} (${b.phone})`;
        try{ await navigator.clipboard.writeText(text); alert('Booking copied'); }
        catch{ prompt('Copy booking:', text); }
      }
    }
    if(idDel){
      const left = loadAll().filter(x=>x.id!==idDel);
      saveAll(left);
      rebuildSlots();
      renderList();
    }
  });

  // CSV export
  els.export.addEventListener('click', ()=>{
    const rows = [['Amenity','Date','Time','Token','Name','Phone','Created At']];
    for(const b of loadAll()){
      rows.push([rules[b.amenity].label, b.date, b.slot, b.token, b.name, b.phone, b.createdAt]);
    }
    const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'apartment_bookings.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Clear all
  els.clear.addEventListener('click', ()=>{
    if(confirm('Clear ALL bookings on this device?')){
      localStorage.removeItem(KEY);
      rebuildSlots();
      renderList();
    }
  });
</script>
</body>
</html>
