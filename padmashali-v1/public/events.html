<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Events</title>
<style>
:root{color-scheme:dark}
body{margin:0;font-family:system-ui,Inter,Arial;background:#0f1115;color:#e8eaed}
.wrap{max-width:980px;margin:24px auto;padding:16px}
.bar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.btn{background:#2563eb;border:0;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
.ghost{background:#11141a;border:1px solid #1f2432}
.pill{display:inline-flex;align-items:center;background:#0f1218;border:1px solid #262b38;padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
.card{background:#171a21;border:1px solid #222736;border-radius:18px;padding:18px;margin-top:14px}
.grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.tile{background:#11141a;border:1px solid #1f2432;border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px}
.badge{background:#0f1218;border:1px solid #262b38;border-radius:999px;padding:4px 10px;font-size:12px}
.muted{opacity:.75}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
footer{opacity:.7;font-size:13px;margin:18px 0;text-align:center}
.sep{height:1px;background:#222736;margin:8px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <h2 style="margin:0">üéâ <span data-i18n="events">Events</span></h2>
    <div class="row">
      <span id="lang-pill" class="pill" onclick="setLang(getLang()==='te'?'en':'te')">English ‚òÄÔ∏è</span>
      <button class="btn ghost" onclick="history.back()" data-i18n="home">Home</button>
      <button class="btn ghost" id="exportRSVPs">Export RSVPs</button>
    </div>
  </div>

  <div class="card">
    <b>Upcoming Events</b>
    <div id="list" class="grid" style="margin-top:10px"></div>
    <p id="empty" class="muted" style="display:none">No upcoming events.</p>
  </div>

  <div class="card">
    <b>My RSVPs</b>
    <div id="mine" class="grid" style="margin-top:10px"></div>
    <p id="mineEmpty" class="muted" style="display:none">You haven‚Äôt RSVP‚Äôd yet.</p>
  </div>

  <footer>¬© Padmashali Community ‚Äî V1</footer>
</div>

<script src="i18n.js"></script>
<script>
  // any logged-in user can view
  const s = JSON.parse(localStorage.getItem("pc_session")||"null");
  if(!s){ location.href='index.html'; }
  // stable user id for RSVP tracking
  if(!localStorage.getItem('pc_uid')) localStorage.setItem('pc_uid', 'U'+Math.random().toString(36).slice(2,10));
  const UID = localStorage.getItem('pc_uid');

  const EV_KEY='pc_events';          // array of events
  const RSVP_KEY='pc_event_rsvps';   // { [eventId]: [{uid,name,resp,ts}] }

  function getEvents(){ return JSON.parse(localStorage.getItem(EV_KEY)||'[]'); }
  function setEvents(arr){ localStorage.setItem(EV_KEY, JSON.stringify(arr)); }
  function getRSVPs(){ return JSON.parse(localStorage.getItem(RSVP_KEY)||'{}'); }
  function setRSVPs(obj){ localStorage.setItem(RSVP_KEY, JSON.stringify(obj)); }

  // seed demo if empty
  if(getEvents().length===0){
    const now = new Date();
    const d1 = new Date(now.getFullYear(), now.getMonth(), now.getDate()+2);
    const d2 = new Date(now.getFullYear(), now.getMonth(), now.getDate()+10);
    const fmt=(d)=>d.toISOString().slice(0,10);
    setEvents([
      {id:'E'+Date.now().toString(36), title:'Community Seva Drive', date:fmt(d1), start:'09:00', end:'12:00', venue:'Hall A', desc:'Annadanam & health camp', published:true, ts:Date.now()},
      {id:'E'+(Date.now()+1).toString(36), title:'Cultural Night', date:fmt(d2), start:'18:00', end:'21:00', venue:'Community Lawn', desc:'Songs, dance & awards', published:true, ts:Date.now()}
    ]);
  }

  function upcoming(e){
    // show only published + today or future
    const today = new Date().toISOString().slice(0,10);
    return e.published && e.date >= today;
  }
  function timeRange(e){ return `${e.start}‚Äì${e.end}`; }

  function render(){
    const listDiv = document.getElementById('list');
    const empty = document.getElementById('empty');
    const mineDiv = document.getElementById('mine');
    const mineEmpty = document.getElementById('mineEmpty');

    const events = getEvents()
      .filter(upcoming)
      .sort((a,b)=>a.date.localeCompare(b.date)||a.start.localeCompare(b.start));

    listDiv.innerHTML='';
    if(events.length===0){ empty.style.display='block'; } else { empty.style.display='none'; }

    const rsvps = getRSVPs();

    events.forEach(ev=>{
      const me = (rsvps[ev.id]||[]).find(x=>x.uid===UID);
      const my = me ? me.resp : '‚Äî';
      const yesCount = (rsvps[ev.id]||[]).filter(x=>x.resp==='Yes').length;
      const maybeCount = (rsvps[ev.id]||[]).filter(x=>x.resp==='Maybe').length;

      const el=document.createElement('div');
      el.className='tile';
      el.innerHTML=`
        <div class="row"><span class="badge">${ev.date}</span><span class="badge">${ev.venue}</span></div>
        <div><b>${ev.title}</b></div>
        <div class="muted">${timeRange(ev)}</div>
        <div class="muted">${ev.desc||''}</div>
        <div class="row">
          <button class="btn" onclick="rsvp('${ev.id}','Yes')">Yes</button>
          <button class="btn ghost" onclick="rsvp('${ev.id}','Maybe')">Maybe</button>
          <button class="btn ghost" onclick="rsvp('${ev.id}','No')">No</button>
          <a class="btn ghost" href="${icsHref(ev)}">Add to Calendar</a>
        </div>
        <div class="sep"></div>
        <div class="row">
          <span class="muted">You: <b>${my}</b></span>
          <span class="badge">Yes: ${yesCount}</span>
          <span class="badge">Maybe: ${maybeCount}</span>
        </div>`;
      listDiv.appendChild(el);
    });

    // My RSVPs
    mineDiv.innerHTML='';
    const myList = Object.entries(rsvps).flatMap(([eid, arr])=>{
      const it = arr.find(x=>x.uid===UID);
      if(!it) return [];
      const ev = getEvents().find(z=>z.id===eid);
      return ev ? [{ev, resp: it.resp}] : [];
    }).sort((a,b)=>a.ev.date.localeCompare(b.ev.date));
    if(myList.length===0){ mineEmpty.style.display='block'; }
    else {
      mineEmpty.style.display='none';
      myList.forEach(x=>{
        const m=document.createElement('div'); m.className='tile';
        m.innerHTML=`<div class="row"><span class="badge">${x.ev.date}</span><span class="badge">${x.ev.venue}</span></div>
                     <div><b>${x.ev.title}</b></div>
                     <div class="muted">${timeRange(x.ev)}</div>
                     <div>Your RSVP: <b>${x.resp}</b></div>`;
        mineDiv.appendChild(m);
      });
    }
  }

  function rsvp(eventId, resp){
    const name = localStorage.getItem('pc_name') || prompt('Your name for RSVP?') || 'Member';
    localStorage.setItem('pc_name', name);
    const r = getRSVPs();
    r[eventId] = (r[eventId]||[]).filter(x=>x.uid!==UID);
    r[eventId].push({uid:UID, name, resp, ts:Date.now()});
    setRSVPs(r);
    render();
  }

  function icsHref(ev){
    // minimal .ics content via data URI
    const dt = (d,t)=> d.replace(/-/g,'') + 'T' + t.replace(':','') + '00';
    const ics = [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Padmashali//Events//EN',
      'BEGIN:VEVENT',
      'UID:'+ev.id+'@padmashali',
      'DTSTAMP:'+dt(new Date().toISOString().slice(0,10),'00:00'),
      'DTSTART:'+dt(ev.date, ev.start),
      'DTEND:'+dt(ev.date, ev.end),
      'SUMMARY:'+escapeICS(ev.title),
      'LOCATION:'+escapeICS(ev.venue||''),
      'DESCRIPTION:'+escapeICS(ev.desc||''),
      'END:VEVENT','END:VCALENDAR'
    ].join('\r\n');
    return 'data:text/calendar;charset=utf-8,'+encodeURIComponent(ics);
  }
  function escapeICS(s){ return String(s).replace(/[,;]/g,''); }

  // Export all RSVPs (debug/admin-lite)
  document.getElementById('exportRSVPs').onclick=()=>{
    const evs=getEvents(); const r=getRSVPs();
    const rows=[['EventID','Title','Date','Start','End','Venue','UID','Name','RSVP']];
    evs.forEach(ev=>{
      (r[ev.id]||[]).forEach(it=>{
        rows.push([ev.id,ev.title,ev.date,ev.start,ev.end,ev.venue,it.uid,it.name,it.resp]);
      });
    });
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='event_rsvps.csv'; a.click(); URL.revokeObjectURL(url);
  };

  applyI18n();
  render();
</script>
</body></html>
