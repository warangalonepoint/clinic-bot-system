<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Onestop Apartments • PIN</title>
  <meta name="theme-color" content="#ff7b5c"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="./styles.css">
  <style>
    /* small helpers for the top-right tool chips */
    .toolbar {position:absolute; right:14px; top:14px; display:flex; gap:8px; z-index:2}
    .chip {display:inline-flex; align-items:center; gap:8px; padding:10px 12px;
           border-radius:16px; background:rgba(255,255,255,.9); backdrop-filter:blur(8px);
           border:1px solid rgba(17,24,39,.08); box-shadow:0 8px 20px rgba(0,0,0,.12);
           font-weight:800; cursor:pointer; user-select:none}
    .chip.small{padding:8px 10px; font-weight:800}
    .chip.active{outline:2px solid rgba(84,209,169,.55)}
    .hero-title small{opacity:.85; font-weight:600}
    /* dark mode minimal */
    html[data-theme="dark"] body.bg{background:linear-gradient(180deg,#10131a,#121a19)}
    html[data-theme="dark"] .card{background:#0f172a;color:#e5e7eb;border-color:rgba(255,255,255,.06)}
    html[data-theme="dark"] .hero-overlay{background:linear-gradient(180deg,rgba(0,0,0,0) 40%, rgba(0,0,0,.55))}
    html[data-theme="dark"] .chip{background:rgba(26,32,44,.9); color:#e5e7eb}
  </style>
</head>
<body class="bg">
<main class="wrap">

  <!-- Hero -->
  <div class="card hero">
    <img class="banner" src="./assets/apartments_banner.png" alt="Apartments banner">
    <div class="hero-overlay">
      <img class="logo" src="./assets/logo.png" alt="Logo" onerror="this.style.display='none'">
      <div class="hero-title">Onestop Apartments <small id="app_subtitle"></small></div>

      <!-- top-right controls -->
      <div class="toolbar">
        <button id="themeBtn" class="chip" title="Toggle theme">🌙</button>
        <button id="langEN" class="chip small">EN</button>
        <button id="langTE" class="chip small">TE</button>
      </div>
    </div>
  </div>

  <!-- PIN Card -->
  <section class="card mt">
    <h2 class="h2" data-i18n="login_title">Login PIN</h2>
    <p class="muted" data-i18n="login_welcome">Welcome</p>
    <form id="pinForm" autocomplete="off">
      <input id="pin" type="password" inputmode="numeric" maxlength="8"
             placeholder="4–8 digit PIN" class="in" data-i18n-ph="pin_ph">
      <button class="btn w100 mt8" data-i18n="submit_btn">Submit</button>
    </form>
    <div id="msg" class="muted mt8" aria-live="polite"></div>
  </section>

  <!-- Short help -->
  <section class="card mt">
    <div class="row space">
      <div class="h2" style="margin:0" data-i18n="help_title">How it works</div>
    </div>
    <p class="muted" data-i18n="help_text">
      Enter the PIN provided for your role (Residents / Guards / Committee / Admin). You’ll be routed automatically.
    </p>
  </section>

</main>

<script>
/* -------------------------------
   Minimal i18n (EN / TE)
-------------------------------- */
const I18N = {
  en: {
    app_subtitle: "",
    login_title: "Login PIN",
    login_welcome: "Welcome",
    pin_ph: "4–8 digit PIN",
    submit_btn: "Submit",
    help_title: "How it works",
    help_text: "Enter the PIN provided for your role (Residents / Guards / Committee / Admin). You’ll be routed automatically.",
    err_loading: "Error loading PINs.",
    err_invalid: "Invalid PIN."
  },
  te: {
    app_subtitle: "",
    login_title: "లాగిన్ పిన్",
    login_welcome: "స్వాగతం",
    pin_ph: "4–8 అంకెల పిన్",
    submit_btn: "సబ్మిట్",
    help_title: "ఇలా పనిచేస్తుంది",
    help_text: "మీ పాత్రకు ఇచ్చిన పిన్ ని ఎంటర్ చేయండి (రెసిడెంట్స్ / గార్డ్స్ / కమిటీ / అడ్మిన్). సరైన పేజీకి వెళ్తారు.",
    err_loading: "పిన్ లను లోడ్ చేయడంలో సమస్య.",
    err_invalid: "తప్పుడు పిన్."
  }
};

function getLang(){ return localStorage.getItem("apt_lang") || "en"; }
function setLang(l){ localStorage.setItem("apt_lang", l); applyI18N(); }

function applyI18N(){
  const L = I18N[getLang()];
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    el.textContent = L[el.getAttribute("data-i18n")] || el.textContent;
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const key = el.getAttribute("data-i18n-ph");
    if(L[key]) el.placeholder = L[key];
  });
  document.getElementById("app_subtitle").textContent = L.app_subtitle || "";
  document.getElementById("langEN").classList.toggle("active", getLang()==="en");
  document.getElementById("langTE").classList.toggle("active", getLang()==="te");
}

/* -------------------------------
   Theme toggle (persist)
-------------------------------- */
(function initTheme(){
  const saved = localStorage.getItem("apt_theme") || "light";
  if(saved==="dark") document.documentElement.setAttribute("data-theme","dark");
  document.getElementById("themeBtn").textContent = saved==="dark" ? "☀️" : "🌙";
})();
document.getElementById("themeBtn").onclick = ()=>{
  const dark = document.documentElement.getAttribute("data-theme")==="dark";
  if(dark){ document.documentElement.removeAttribute("data-theme"); localStorage.setItem("apt_theme","light"); document.getElementById("themeBtn").textContent="🌙"; }
  else{ document.documentElement.setAttribute("data-theme","dark"); localStorage.setItem("apt_theme","dark"); document.getElementById("themeBtn").textContent="☀️"; }
};

/* Language buttons */
document.getElementById("langEN").onclick = ()=> setLang("en");
document.getElementById("langTE").onclick = ()=> setLang("te");
applyI18N();

/* -------------------------------
   PIN routing
-------------------------------- */
const rolePage = {
  residents : "./residents.html",
  guards    : "./guards.html",
  committee : "./committee.html",
  admin     : "./admin.html"
};

async function loadPins(){
  const r = await fetch("./pins.json?ts="+Date.now(), {cache:"no-store"});
  if(!r.ok) throw new Error("pins.json missing");
  return r.json();
}

document.getElementById("pinForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const pin = document.getElementById("pin").value.trim();
  const msg = document.getElementById("msg");
  msg.textContent = "…";
  try{
    const pins = await loadPins();   // e.g. { "residents":"1111", "guards":"2222", ... }
    let matched = null;
    for(const [role,val] of Object.entries(pins)){
      if(String(val)===pin){ matched = role; break; }
    }
    if(!matched){ msg.textContent = I18N[getLang()].err_invalid; return; }
    sessionStorage.setItem("apt_role", matched);
    sessionStorage.setItem("apt_login_at", String(Date.now()));
    location.replace(rolePage[matched] || "./index.html");
  }catch(err){
    console.error(err);
    msg.textContent = I18N[getLang()].err_loading;
  }
});

/* Register SW (optional, no error noise) */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
}
</script>
</body>
</html>
