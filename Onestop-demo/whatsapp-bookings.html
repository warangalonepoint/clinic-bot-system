<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Appointment</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <img src="assets/banner.png" class="banner" alt="Banner" />
  <div class="container">
    <h2>Onestop C-Demo</h2>
    <h3>WhatsApp Appointment</h3>
    <select id="dateDropdown"></select>
    <select id="slotDropdown"></select>
    <input type="text" id="patientName" placeholder="Enter patient name" />
    <input type="text" id="reason" placeholder="Enter reason" />
    <button onclick="bookOnWhatsApp()">Book on WhatsApp</button>
  </div>

  <script>
    const airtableApiKey = 'patLNwoJQKE3Tjb8J.c2a0db129111c610fae64a2c01e0a626f37bdb5992232ea6ebc644fa9073dfb3';
    const airtableBaseId = 'app1T8WiRqZIR4xY';
    const slotsTable = 'AvailableSlots';

    const dateDropdown = document.getElementById('dateDropdown');
    const slotDropdown = document.getElementById('slotDropdown');

    async function loadDates() {
      const res = await fetch(`https://api.airtable.com/v0/${airtableBaseId}/${slotsTable}?view=Grid%20view`, {
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      const data = await res.json();
      const futureDates = new Set();

      data.records.forEach(record => {
        const date = record.fields['Date'];
        const status = record.fields['Status'];
        if (date && status === 'Available') futureDates.add(date);
      });

      dateDropdown.innerHTML = '<option value="">Select Date</option>';
      [...futureDates].sort().forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        dateDropdown.appendChild(option);
      });
    }

    async function loadSlots(selectedDate) {
      const res = await fetch(`https://api.airtable.com/v0/${airtableBaseId}/${slotsTable}?view=Grid%20view`, {
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      const data = await res.json();
      const availableSlots = data.records.filter(record =>
        record.fields['Date'] === selectedDate &&
        record.fields['Status'] === 'Available'
      );

      slotDropdown.innerHTML = '<option value="">Select Time Slot</option>';
      availableSlots.forEach(record => {
        const option = document.createElement('option');
        option.value = record.fields['Time Slot'];
        option.textContent = record.fields['Time Slot'];
        slotDropdown.appendChild(option);
      });
    }

    dateDropdown.addEventListener('change', () => {
      const selectedDate = dateDropdown.value;
      loadSlots(selectedDate);
    });

    function bookOnWhatsApp() {
      const date = dateDropdown.value;
      const slot = slotDropdown.value;
      const name = document.getElementById('patientName').value;
      const reason = document.getElementById('reason').value;

      if (!date || !slot || !name || !reason) {
        alert("Please fill all fields.");
        return;
      }

      const message = `Hi, I would like to book an appointment:\n\nPatient: ${name}\nDate: ${date}\nTime: ${slot}\nReason: ${reason}`;
      const encodedMsg = encodeURIComponent(message);
      const whatsappLink = `https://wa.me/919000000000?text=${encodedMsg}`;
      window.open(whatsappLink, "_blank");
    }

    loadDates();
  </script>
</body>
</html>
