<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Booking | Onestop C-Demo</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .hidden { display: none; }
    #tokenDisplay {
      margin-top: 10px;
      font-weight: bold;
      color: green;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="assets/banner.png" class="banner" />
    <h2>Onestop C-Demo</h2>

    <input type="text" id="contact" placeholder="Contact Number" required />
    <input type="text" id="reason" placeholder="Reason for Visit" required />
    
    <select id="dateDropdown">
      <option value="">Select Date</option>
    </select>
    
    <select id="slotDropdown">
      <option value="">Select Slot</option>
    </select>

    <button id="bookBtn">Book on WhatsApp</button>

    <div id="tokenDisplay"></div>

    <p class="footer">Powered by Onestop AI</p>
  </div>

  <script>
    const airtableKey = "YOUR_API_KEY_HERE"; // Replace during final test
    const baseId = "appgplT8WiqnZlR44Y";
    const slotsTable = "AvailableSlots";
    const logsTable = "BookingsLogs";

    const dateDropdown = document.getElementById("dateDropdown");
    const slotDropdown = document.getElementById("slotDropdown");
    const contactInput = document.getElementById("contact");
    const reasonInput = document.getElementById("reason");
    const bookBtn = document.getElementById("bookBtn");
    const tokenDisplay = document.getElementById("tokenDisplay");

    const headers = {
      Authorization: `Bearer ${airtableKey}`
    };

    async function fetchSlots() {
      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${slotsTable}?view=Grid%20view`, { headers });
      const data = await res.json();
      const records = data.records.filter(r => r.fields.Status === "Available");

      const dateMap = {};
      records.forEach(record => {
        const date = record.fields.Date;
        const slot = record.fields["Time Slot"];
        if (!dateMap[date]) dateMap[date] = [];
        dateMap[date].push(slot);
      });

      // Populate unique future dates
      const today = new Date().toISOString().split("T")[0];
      Object.keys(dateMap).forEach(date => {
        if (date >= today) {
          const option = document.createElement("option");
          option.value = date;
          option.textContent = date;
          dateDropdown.appendChild(option);
        }
      });

      dateDropdown.addEventListener("change", () => {
        slotDropdown.innerHTML = '<option value="">Select Slot</option>';
        const slots = dateMap[dateDropdown.value] || [];
        slots.forEach(slot => {
          const option = document.createElement("option");
          option.value = slot;
          option.textContent = slot;
          slotDropdown.appendChild(option);
        });
      });
    }

    async function getTokenNumber(selectedDate) {
      const url = `https://api.airtable.com/v0/${baseId}/${logsTable}?filterByFormula=IS_SAME({Slot Time}, "${selectedDate}", 'day')`;
      const res = await fetch(url, { headers });
      const data = await res.json();
      return data.records.length + 1;
    }

    async function bookNow() {
      const contact = contactInput.value.trim();
      const reason = reasonInput.value.trim();
      const date = dateDropdown.value;
      const slot = slotDropdown.value;

      if (!contact || !reason || !date || !slot) {
        alert("Please fill all fields.");
        return;
      }

      const tokenNo = await getTokenNumber(date);

      // 1. Save booking
      await fetch(`https://api.airtable.com/v0/${baseId}/${logsTable}`, {
        method: "POST",
        headers: {
          ...headers,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fields: {
            "Patient Name": "WhatsApp Booking",
            "Slot Time": date + " " + slot,
            "Reason": reason,
            "Contact": contact,
            "Token": tokenNo
          }
        })
      });

      // 2. Mark slot as Booked
      const slotUrl = `https://api.airtable.com/v0/${baseId}/${slotsTable}?filterByFormula=AND({Date}="${date}", {Time Slot}="${slot}")`;
      const slotRes = await fetch(slotUrl, { headers });
      const slotData = await slotRes.json();
      const slotId = slotData.records[0]?.id;

      if (slotId) {
        await fetch(`https://api.airtable.com/v0/${baseId}/${slotsTable}/${slotId}`, {
          method: "PATCH",
          headers: {
            ...headers,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ fields: { Status: "Booked" } })
        });
      }

      // 3. Redirect to WhatsApp
      const msg = `Booking Confirmed\nDate: ${date}\nSlot: ${slot}\nToken: ${tokenNo}\nReason: ${reason}`;
      const whatsappURL = `https://wa.me/${contact.replace(/\D/g, "")}?text=${encodeURIComponent(msg)}`;

      tokenDisplay.textContent = `Token No: ${tokenNo}`;
      setTimeout(() => {
        window.location.href = whatsappURL;
      }, 1000);
    }

    bookBtn.addEventListener("click", bookNow);

    fetchSlots();
  </script>
</body>
</html>
