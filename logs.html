<script>
    const csvUrl = 'logs.csv';
    let allData = [];

    fetch(csvUrl)
      .then(res => res.text())
      .then(csv => {
        const parsed = Papa.parse(csv, { header: true });
        allData = parsed.data.filter(row => row.Date); // Skip empty rows
        updateSummary(allData);
        renderTable(allData);
      });

    function updateSummary(data) {
      const today = new Date().toISOString().split("T")[0];
      const todayCount = data.filter(r => r.Date === today).length;
      const todayTokens = data.filter(r => r.Date === today).map(r => parseInt(r.Token)).filter(n => !isNaN(n));
      const nextToken = todayTokens.length > 0 ? Math.max(...todayTokens) + 1 : 1;
      document.getElementById("stats").textContent = `✅ Bookings Today: ${todayCount} | Next Token: ${nextToken}`;
    }

    function renderTable(data) {
      const tbody = document.querySelector("#logTable tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.Date}</td>
          <td>${row.Time}</td>
          <td>${row.Name}</td>
          <td>${row.Reason}</td>
          <td>${row.Contact}</td>
          <td>${row.Clinic}</td>
          <td>${row.Token}</td>
          <td>${row["Reminder Sent"]}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterToday() {
      const today = new Date().toISOString().split("T")[0];
      const filtered = allData.filter(r => r.Date === today);
      renderTable(filtered);
    }

    function filterYesterday() {
      const y = new Date(Date.now() - 86400000).toISOString().split("T")[0];
      const filtered = allData.filter(r => r.Date === y);
      renderTable(filtered);
    }

    function filterDateRange() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const filtered = allData.filter(r => r.Date >= start && r.Date <= end);
      renderTable(filtered);
    }

    function exportCSV() {
      const csv = Papa.unparse(allData);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "AppointmentLogs.csv");
      link.click();
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Appointment Logs", 10, 10);
      let y = 20;
      allData.forEach(r => {
        const line = `${r.Date} | ${r.Time} | ${r.Name} | ${r.Reason} | ${r.Contact}`;
        doc.text(line, 10, y);
        y += 8;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });
      doc.save("AppointmentLogs.pdf");
    }
  </script>        y += 8;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });
      doc.save("AppointmentLogs.pdf");
    }
  </script>
</body>
</html>    function fetchData() {
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function(results) {
          logData = results.data.filter(row => row.Date); // skip empty
          allData = logData;
          updateSummary(logData);
          renderTable(logData);
        }
      });
    }

    function updateSummary(data) {
      const today = new Date().toISOString().split("T")[0];
      const todayCount = data.filter(r => r.Date === today).length;
      const todayTokens = data
        .filter(r => r.Date === today)
        .map(r => parseInt(r.Token))
        .filter(n => !isNaN(n));
      const nextToken = todayTokens.length > 0 ? Math.max(...todayTokens) + 1 : 1;
      document.getElementById("summary").textContent = `✅ Bookings Today: ${todayCount} | Next Token: ${nextToken}`;
    }

    function renderTable(data) {
      const tbody = document.querySelector("#logTable tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.Date}</td>
          <td>${row.Time}</td>
          <td>${row.Name}</td>
          <td>${row.Reason}</td>
          <td>${row.Contact}</td>
          <td>${row.Clinic}</td>
          <td>${row.Token}</td>
          <td>${row.Reminder || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function exportCSV() {
      const csv = Papa.unparse(allData);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "logs-export.csv");
      link.click();
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const headers = [["Date", "Time", "Name", "Reason", "Contact", "Clinic", "Token", "Reminder"]];
      const rows = allData.map(r => [r.Date, r.Time, r.Name, r.Reason, r.Contact, r.Clinic, r.Token, r.Reminder || ""]);
      doc.autoTable({ head: headers, body: rows });
      doc.save("logs-export.pdf");
    }

    function filterDate(type) {
      let filtered = [];
      const today = new Date();
      if (type === 'today') {
        const d = today.toISOString().split("T")[0];
        filtered = logData.filter(e => e.Date === d);
      } else if (type === 'yesterday') {
        today.setDate(today.getDate() - 1);
        const d = today.toISOString().split("T")[0];
        filtered = logData.filter(e => e.Date === d);
      } else {
        const sd = document.getElementById("startDate").value;
        const ed = document.getElementById("endDate").value;
        if (!sd || !ed) return alert("Select valid date range");
        filtered = logData.filter(e => e.Date >= sd && e.Date <= ed);
      }
      allData = filtered;
      updateSummary(filtered);
      renderTable(filtered);
    }

    fetchData();
  </script>

</body>
</html>
