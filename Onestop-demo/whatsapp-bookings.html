<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WhatsApp Booking | Onestop C-Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .form-box {
      padding: 20px;
      background: var(--card-bg);
      border-radius: 10px;
      margin-top: 20px;
    }
    label, select, input {
      display: block;
      margin: 10px 0;
      width: 100%;
    }
    button {
      width: 100%;
      padding: 10px;
      background: black;
      color: white;
      border: none;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="assets/banner.png" class="banner" />
    <h2>Book via WhatsApp</h2>

    <div class="form-box">
      <label for="bookingDate">Select Date:</label>
      <select id="bookingDate"></select>

      <label for="slotSelect">Select Time Slot:</label>
      <select id="slotSelect"></select>

      <label for="name">Your Name:</label>
      <input type="text" id="name" placeholder="Enter name"/>

      <label for="reason">Reason:</label>
      <input type="text" id="reason" placeholder="Enter reason"/>

      <button onclick="bookWhatsApp()">Confirm & Open WhatsApp</button>
    </div>

    <p class="footer">Powered by Onestop AI</p>
  </div>

  <script>
    const apiKey = "YOUR_API_KEY_HERE";
    const baseId = "appgplT8WiqnZlR44Y";
    const slotsTable = "AvailableSlots";
    const bookingsTable = "BookingsLogs";
    const headers = { Authorization: `Bearer ${apiKey}`, "Content-Type": "application/json" };

    async function loadDates() {
      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${slotsTable}?maxRecords=500`, { headers });
      const data = await res.json();
      const records = data.records;

      const futureDates = [...new Set(records.map(r => r.fields.Date))]
        .filter(d => new Date(d) >= new Date())
        .sort();

      const dateSelect = document.getElementById("bookingDate");
      dateSelect.innerHTML = "";
      futureDates.forEach(date => {
        const option = document.createElement("option");
        option.value = date;
        option.textContent = date;
        dateSelect.appendChild(option);
      });

      dateSelect.addEventListener("change", loadSlots);
      loadSlots();
    }

    async function loadSlots() {
      const selectedDate = document.getElementById("bookingDate").value;
      const slotSelect = document.getElementById("slotSelect");
      slotSelect.innerHTML = "";

      const url = `https://api.airtable.com/v0/${baseId}/${slotsTable}?filterByFormula=AND({Date}='${selectedDate}', {Status}='Available')`;
      const res = await fetch(url, { headers });
      const data = await res.json();

      data.records.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.fields["Time Slot"];
        opt.textContent = r.fields["Time Slot"];
        opt.dataset.recordId = r.id;
        slotSelect.appendChild(opt);
      });
    }

    async function getNextToken(date) {
      const url = `https://api.airtable.com/v0/${baseId}/${bookingsTable}?filterByFormula=SEARCH('${date}', {Slot Time})`;
      const res = await fetch(url, { headers });
      const data = await res.json();
      return (data.records.length || 0) + 1;
    }

    async function bookWhatsApp() {
      const date = document.getElementById("bookingDate").value;
      const slot = document.getElementById("slotSelect").value;
      const slotRecordId = document.querySelector("#slotSelect option:checked").dataset.recordId;
      const name = document.getElementById("name").value;
      const reason = document.getElementById("reason").value;

      if (!date || !slot || !name || !reason) {
        alert("Please fill all fields");
        return;
      }

      const token = await getNextToken(date);

      // Save to BookingsLogs
      await fetch(`https://api.airtable.com/v0/${baseId}/${bookingsTable}`, {
        method: "POST",
        headers,
        body: JSON.stringify({
          fields: {
            "Patient Name": name,
            "Slot Time": `${date} ${slot}`,
            "Reason": reason,
            "Token": token
          }
        })
      });

      // Mark slot as Booked
      await fetch(`https://api.airtable.com/v0/${baseId}/${slotsTable}/${slotRecordId}`, {
        method: "PATCH",
        headers,
        body: JSON.stringify({ fields: { "Status": "Booked" } })
      });

      const msg = `Hi, I would like to book an appointment.\nName: ${name}\nDate: ${date}\nTime: ${slot}\nReason: ${reason}\nToken No: ${token}`;
      const phone = "919390664577";
      const whatsappURL = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
      window.open(whatsappURL, "_blank");
    }

    loadDates();
  </script>
</body>
</html>
