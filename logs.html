<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìã Appointment Logs</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #fff;
      padding: 10px;
      color: #111;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #f0f0f0;
    }
    button {
      background: green;
      color: white;
      padding: 6px 12px;
      border: none;
      margin: 4px 2px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
    }
    input, select {
      padding: 5px;
      font-size: 14px;
      margin: 4px;
    }
    .highlight {
      background: #dff0d8;
    }
  </style>
</head>
<body>
  <h2>üìã Appointment Logs</h2>
  <div id="summary" style="font-weight:bold; margin-bottom:10px;"></div>
  <button onclick="filterDate('today')">Today</button>
  <button onclick="filterDate('yesterday')">Yesterday</button>
  <input type="date" id="startDate" />
  <input type="date" id="endDate" />
  <button onclick="filterDate('custom')">Apply</button>
  <button onclick="exportCSV()">üìÅ Export CSV</button>
  <button onclick="exportPDF()">üñ®Ô∏è Export PDF</button>

  <table id="logTable">
    <thead>
      <tr>
        <th>Date</th><th>Time</th><th>Name</th><th>Reason</th><th>Contact</th><th>Clinic</th><th>Token</th><th>Reminder</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let allData = [];

    function fetchData() {
      const csvUrl = "https://warangalonepoint.github.io/clinic-bot-system/logs.csv";
      fetch(csvUrl)
        .then(res => res.text())
        .then(csv => {
          const parsed = Papa.parse(csv, { header: true });
          allData = parsed.data.filter(row => row.Date && row.Time);
          renderTable(allData);
        });
    }

    function renderTable(data) {
      const tbody = document.querySelector("#logTable tbody");
      tbody.innerHTML = "";
      let tokenCount = 0;
      const today = new Date().toISOString().split("T")[0];
      let todayBookings = 0;

      data.forEach((row, index) => {
        const tr = document.createElement("tr");

        if (row.Date === today) {
          tokenCount = Math.max(tokenCount, parseInt(row.Token || "0"));
          todayBookings++;
        }

        tr.innerHTML = `
          <td>${row.Date}</td>
          <td>${row.Time}</td>
          <td>${row.Name}</td>
          <td>${row.Reason}</td>
          <td><a href="tel:${row.Contact}">${row.Contact}</a></td>
          <td>${row.Clinic || ""}</td>
          <td>${row.Token || ""}</td>
          <td>${row.Reminder || ""}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("summary").innerText = `‚úÖ Bookings Today: ${todayBookings} | Next Token: ${tokenCount + 1}`;
    }

    function filterDate(type) {
      let filtered = [];
      const today = new Date();
      if (type === "today") {
        const d = today.toISOString().split("T")[0];
        filtered = allData.filter(e => e.Date === d);
      } else if (type === "yesterday") {
        today.setDate(today.getDate() - 1);
        const d = today.toISOString().split("T")[0];
        filtered = allData.filter(e => e.Date === d);
      } else {
        const sd = document.getElementById("startDate").value;
        const ed = document.getElementById("endDate").value;
        filtered = allData.filter(e => e.Date >= sd && e.Date <= ed);
      }
      renderTable(filtered);
    }

    function exportCSV() {
      const csv = Papa.unparse(allData);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "logs-export.csv");
      link.click();
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const headers = [["Date", "Time", "Name", "Reason", "Contact", "Clinic", "Token", "Reminder"]];
      const rows = allData.map(r => [
        r.Date, r.Time, r.Name, r.Reason, r.Contact, r.Clinic, r.Token, r.Reminder
      ]);
      doc.autoTable({ head: headers, body: rows });
      doc.save("logs-export.pdf");
    }

    fetchData();
  </script>
</body>
</html>
    fetchData();
  </script>

</body>
</html>
