<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manual Bookings – Onestop C-Demo</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #fff;
      margin: 0;
      padding: 0;
      color: #000;
      text-align: center;
    }
    .container {
      padding: 20px;
      max-width: 480px;
      margin: auto;
    }
    img.banner {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    select, input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    .row {
      display: flex;
      gap: 10px;
    }
    .row input {
      flex: 1;
    }
    button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: none;
      background: #000;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .footer-note {
      font-size: 13px;
      margin-top: 14px;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="assets/banner.png" class="banner" alt="Clinic Banner">
    <h2>Manual Bookings – Onestop C-Demo</h2><select id="dateDropdown">
  <option value="">Select Date:</option>
</select>

<select id="slotDropdown">
  <option value="">Select Time Slot:</option>
</select>

<div class="row">
  <input type="text" id="nameInput" placeholder="Patient Name" required>
  <input type="text" id="reasonInput" placeholder="Reason for Visit" required>
</div>

<input type="tel" id="contactInput" placeholder="Contact Number" required>

<button onclick="submitBooking()">Confirm Booking</button>

<p class="footer-note">Booked slots will be hidden automatically.</p>

  </div>  <script>
    const apiKey = 'patLNwoJQKE3Tjb8J.c2a0db129111c610fae64a2c01e0a626f37bdb5992232ea6ebc644fa9073dfb3';
    const baseId = 'appgIT8WiqnZlR44Y';
    const slotsTable = 'AvailableSlots';

    async function loadAvailableSlots() {
      const url = `https://api.airtable.com/v0/${baseId}/${slotsTable}?view=Grid%20view`;
      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${apiKey}` }
      });
      const data = await res.json();

      const dateDropdown = document.getElementById('dateDropdown');
      const slotDropdown = document.getElementById('slotDropdown');

      const groupedSlots = {};
      data.records.forEach(record => {
        const date = record.fields['Date'];
        const slot = record.fields['Time Slot'];
        const status = record.fields['Status'];
        if (status === 'Available') {
          if (!groupedSlots[date]) groupedSlots[date] = [];
          groupedSlots[date].push(slot);
        }
      });

      // Populate date dropdown
      Object.keys(groupedSlots).sort().forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        dateDropdown.appendChild(option);
      });

      // Slot change on date select
      dateDropdown.addEventListener('change', () => {
        const selectedDate = dateDropdown.value;
        slotDropdown.innerHTML = '<option value="">Select Time Slot:</option>';
        if (groupedSlots[selectedDate]) {
          groupedSlots[selectedDate].forEach(slot => {
            const opt = document.createElement('option');
            opt.value = slot;
            opt.textContent = slot;
            slotDropdown.appendChild(opt);
          });
        }
      });
    }

    async function submitBooking() {
      const date = document.getElementById('dateDropdown').value;
      const slot = document.getElementById('slotDropdown').value;
      const name = document.getElementById('nameInput').value;
      const reason = document.getElementById('reasonInput').value;
      const contact = document.getElementById('contactInput').value;

      if (!date || !slot || !name || !reason || !contact) return alert('Please fill all fields');

      // Post booking to BookingsLogs
      const logUrl = `https://api.airtable.com/v0/${baseId}/BookingsLogs`;
      const tokenNumber = Math.floor(Math.random() * 1000); // Temporary logic

      await fetch(logUrl, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fields: {
            Timestamp: new Date().toISOString(),
            'Patient Name': name,
            'Slot Time': `${date} ${slot}`,
            Reason: reason,
            Contact: contact,
            Token: tokenNumber
          }
        })
      });

      // Update slot as Booked
      const slotUrl = `https://api.airtable.com/v0/${baseId}/${slotsTable}?filterByFormula=AND({Date}='${date}',{Time Slot}='${slot}')`;
      const slotRes = await fetch(slotUrl, {
        headers: { Authorization: `Bearer ${apiKey}` }
      });
      const slotData = await slotRes.json();
      const slotId = slotData.records[0]?.id;

      if (slotId) {
        await fetch(`https://api.airtable.com/v0/${baseId}/${slotsTable}/${slotId}`, {
          method: 'PATCH',
          headers: {
            Authorization: `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ fields: { Status: 'Booked' } })
        });
      }

      alert('Booking confirmed!');
      window.location.reload();
    }

    loadAvailableSlots();
  </script></body>
</html>
