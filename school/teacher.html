<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher · School PWA</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="dark">
  <div class="wrapper">

    <!-- HERO -->
    <section class="hero glass">
      <div class="hero-top">
        <div class="hero-eyebrow">Post diary & homework · mark attendance</div>
        <div class="hero-title">Teacher</div>
        <div class="hero-actions">
          <button class="chip chip-slate" id="pinBtn" title="Back to PIN">PIN</button>
          <button class="chip chip-blue" id="themeBtn">Theme</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabbar" data-tab-group>
        <button class="chip chip-indigo active" data-tab="tab-setup">Class Setup</button>
        <button class="chip chip-blue"   data-tab="tab-diary">Class Diary</button>
        <button class="chip chip-green"  data-tab="tab-hw">Homework</button>
        <button class="chip chip-orange" data-tab="tab-att">Attendance</button>
        <button class="chip chip-pink"   data-tab="tab-leaves">Leaves</button>
        <button class="chip chip-purple" data-tab="tab-requests">Requests</button>
      </div>
    </section>

    <!-- PANELS -->
    <section class="panel glass" id="tab-setup">
      <h2>My Class</h2>
      <div class="grid">
        <input id="t-class"   class="input" placeholder="Class e.g., 5" />
        <input id="t-section" class="input" placeholder="Section e.g., A" />
        <input id="t-name"    class="input" placeholder="Your Name" />
        <input id="t-subject" class="input" placeholder="Subject e.g., Maths" />
      </div>
      <div class="row-right">
        <button class="btn btn-primary" id="saveMeta">Save</button>
      </div>
    </section>

    <section class="panel glass hidden" id="tab-diary">
      <h2>Post to Class Diary</h2>
      <div class="grid">
        <input id="d-date" type="date" class="input" />
        <input id="d-subject" class="input" placeholder="Subject" />
        <textarea id="d-msg" rows="4" class="input" placeholder="What was taught / notes..."></textarea>
        <input id="d-link" class="input" placeholder="Optional link (https://…)" />
      </div>
      <div class="row-right">
        <button class="btn btn-primary" id="d-publish">Publish</button>
      </div>
      <h3 class="mt-16">Recent</h3>
      <div id="d-list" class="list"></div>
    </section>

    <section class="panel glass hidden" id="tab-hw">
      <h2>Create Homework</h2>
      <div class="grid">
        <input id="h-due" type="date" class="input" />
        <input id="h-subject" class="input" placeholder="Subject" />
        <input id="h-title" class="input" placeholder="Title, e.g., Exercise 5A" />
        <textarea id="h-details" rows="4" class="input" placeholder="Details…"></textarea>
      </div>
      <div class="row-right">
        <button class="btn btn-primary" id="h-publish">Publish</button>
      </div>
      <h3 class="mt-16">Assigned</h3>
      <div id="h-list" class="list"></div>
    </section>

    <section class="panel glass hidden" id="tab-att">
      <h2>Attendance</h2>
      <div class="grid">
        <input id="a-date" type="date" class="input" />
        <input id="a-present" class="input" placeholder="Present roll numbers (e.g., 1,2,4,6…)" />
        <input id="a-absent"  class="input" placeholder="Absent roll numbers (optional)" />
        <input id="a-notes"   class="input" placeholder="Notes (optional)" />
      </div>
      <div class="row-right">
        <button class="btn btn-primary" id="a-save">Save Attendance</button>
      </div>
      <h3 class="mt-16">History</h3>
      <div id="a-list" class="list"></div>
    </section>

    <section class="panel glass hidden" id="tab-leaves">
      <h2>Leave Requests (My Class)</h2>
      <div id="lv-list" class="list"></div>
    </section>

    <section class="panel glass hidden" id="tab-requests">
      <h2>Parent Requests (My Class)</h2>
      <div id="rq-list" class="list"></div>
    </section>

  </div>

  <script>
    /* ---------- tiny helpers ---------- */
    const q = s => document.querySelector(s);
    const qa = s => [...document.querySelectorAll(s)];
    const db = {
      get: (k, d=[]) => { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch{ return d } },
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
    };
    const today = () => new Date().toISOString().slice(0,10);
    const keyMeta = 'teacher_meta';
    const cid = () => {
      const m = db.get(keyMeta, {});
      return (m.class||'') + '_' + (m.section||'');
    };
    const tag = (name, attrs={}, html='')=>{
      const el = document.createElement(name);
      Object.entries(attrs).forEach(([k,v])=> el.setAttribute(k,v));
      el.innerHTML = html; return el;
    };

    /* ---------- theme & pin ---------- */
    function applyThemeFromURL(){
      const url = new URL(location.href);
      const t = url.searchParams.get('theme');
      const saved = localStorage.getItem('theme');
      const final = t || saved || 'dark';
      document.body.classList.toggle('dark', final==='dark');
      localStorage.setItem('theme', final);
    }
    function toggleTheme(){
      const next = document.body.classList.contains('dark') ? 'light' : 'dark';
      document.body.classList.toggle('dark', next==='dark');
      localStorage.setItem('theme', next);
      // keep ?theme in url updated
      const u = new URL(location.href); u.searchParams.set('theme', next); history.replaceState({},'',u);
    }
    applyThemeFromURL();
    q('#themeBtn').addEventListener('click', toggleTheme);
    q('#pinBtn').addEventListener('click', ()=> location.href='index.html?theme='+(localStorage.getItem('theme')||'dark'));

    /* ---------- tabs (self-contained) ---------- */
    (function initTabs(){
      const group = q('[data-tab-group]');
      const show = id => {
        qa('.panel').forEach(p=>p.classList.toggle('hidden', p.id!==id));
      };
      group.addEventListener('click', ev=>{
        const btn = ev.target.closest('[data-tab]'); if(!btn) return;
        group.querySelectorAll('[data-tab]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active'); show(btn.dataset.tab);
      });
      // initial
      show('tab-setup');
    })();

    /* ---------- meta ---------- */
    (function meta(){
      const meta = db.get(keyMeta, {});
      if(meta.class)   q('#t-class').value = meta.class;
      if(meta.section) q('#t-section').value = meta.section;
      if(meta.name)    q('#t-name').value = meta.name;
      if(meta.subject) q('#t-subject').value = meta.subject;

      q('#saveMeta').addEventListener('click', ()=>{
        const data = {
          class: q('#t-class').value.trim(),
          section: q('#t-section').value.trim(),
          name: q('#t-name').value.trim(),
          subject: q('#t-subject').value.trim()
        };
        db.set(keyMeta, data);
        alert('Saved ✅');
      });
    })();

    /* ---------- diary ---------- */
    (function diary(){
      q('#d-date').value = today();
      const key = ()=>'diary_'+cid();
      const render = ()=>{
        const list = db.get(key(), []);
        const box = q('#d-list'); box.innerHTML='';
        list.slice().reverse().forEach((it,i)=>{
          const row = tag('div', {class:'item'},
            `<div class="item-title"><b>${it.subject||'—'}</b> · ${it.date}</div>
             <div class="item-sub">${it.msg||''}</div>
             ${it.link?`<div class="item-link"><a href="${it.link}" target="_blank">${it.link}</a></div>`:''}`);
          box.appendChild(row);
        });
      };
      q('#d-publish').addEventListener('click', ()=>{
        const it = {
          date: q('#d-date').value || today(),
          subject: q('#d-subject').value.trim(),
          msg: q('#d-msg').value.trim(),
          link: q('#d-link').value.trim(),
          ts: Date.now()
        };
        if(!it.subject || !it.msg){ alert('Add subject & message.'); return; }
        const list = db.get(key(), []); list.push(it); db.set(key(), list);
        q('#d-msg').value=''; q('#d-link').value=''; render();
        alert('Posted ✅');
      });
      render();
    })();

    /* ---------- homework ---------- */
    (function homework(){
      q('#h-due').value = today();
      const key = ()=>'hw_'+cid();
      const render = ()=>{
        const list = db.get(key(), []);
        const box = q('#h-list'); box.innerHTML='';
        list.slice().reverse().forEach(it=>{
          const row = tag('div',{class:'item'},
            `<div class="item-title"><b>${it.subject||'—'}</b> · Due ${it.due}</div>
             <div class="item-sub">${it.title||''}</div>
             <div class="item-sub">${it.details||''}</div>`);
          box.appendChild(row);
        });
      };
      q('#h-publish').addEventListener('click', ()=>{
        const it = {
          due: q('#h-due').value || today(),
          subject: q('#h-subject').value.trim(),
          title: q('#h-title').value.trim(),
          details: q('#h-details').value.trim(),
          ts: Date.now()
        };
        if(!it.subject || !it.title){ alert('Add subject & title.'); return; }
        const list = db.get(key(), []); list.push(it); db.set(key(), list);
        q('#h-title').value=''; q('#h-details').value=''; render();
        alert('Homework added ✅');
      });
      render();
    })();

    /* ---------- attendance ---------- */
    (function attendance(){
      q('#a-date').value = today();
      const key = ()=>'att_'+cid();
      const render = ()=>{
        const list = db.get(key(), []);
        const box = q('#a-list'); box.innerHTML='';
        list.slice().reverse().forEach(it=>{
          const row = tag('div',{class:'item'},
            `<div class="item-title">${it.date} · Present: ${it.present?.length||0}${it.absent?.length?` · Absent: ${it.absent.length}`:''}</div>
             <div class="item-sub">${it.notes||''}</div>`);
          box.appendChild(row);
        });
      };
      q('#a-save').addEventListener('click', ()=>{
        const present = q('#a-present').value.split(',').map(s=>s.trim()).filter(Boolean);
        const absent  = q('#a-absent').value.split(',').map(s=>s.trim()).filter(Boolean);
        const it = { date:q('#a-date').value||today(), present, absent, notes:q('#a-notes').value.trim(), ts:Date.now() };
        const list = db.get(key(), []); list.push(it); db.set(key(), list);
        q('#a-present').value=''; q('#a-absent').value=''; q('#a-notes').value=''; render();
        alert('Attendance saved ✅');
      });
      render();
    })();

    /* ---------- leaves & requests (filtered to this class/section) ---------- */
    (function leavesAndRequests(){
      const meta = db.get(keyMeta,{});
      const sameClass = it => it.class===meta.class && it.section===meta.section;

      // Leaves
      const renderLeaves = ()=>{
        const all = db.get('leave_requests', []);
        const box = q('#lv-list'); box.innerHTML='';
        const list = all.filter(sameClass).sort((a,b)=>b.ts-a.ts);
        if(!list.length){ box.innerHTML = `<div class="empty">No leave requests.</div>`; return; }
        list.forEach(it=>{
          const row = tag('div',{class:'item'},
            `<div class="item-title"><b>${it.student||'Student'}</b> · ${it.from} → ${it.to} · <span class="badge ${it.status}">${it.status}</span></div>
             <div class="item-sub">${it.reason||''}</div>
             <div class="row gap-8 mt-8">
               <button class="btn btn-approve">Approve</button>
               <button class="btn btn-reject">Reject</button>
             </div>`);
          row.querySelector('.btn-approve').onclick = ()=>{
            it.status='approved'; db.set('leave_requests', all); renderLeaves();
          };
          row.querySelector('.btn-reject').onclick = ()=>{
            it.status='rejected'; db.set('leave_requests', all); renderLeaves();
          };
          box.appendChild(row);
        });
      };

      // Requests
      const renderReq = ()=>{
        const all = db.get('parent_requests', []);
        const box = q('#rq-list'); box.innerHTML='';
        const list = all.filter(sameClass).sort((a,b)=>b.ts-a.ts);
        if(!list.length){ box.innerHTML = `<div class="empty">No requests.</div>`; return; }
        list.forEach(it=>{
          const row = tag('div',{class:'item'},
            `<div class="item-title"><b>${it.student||'Parent'}</b> · <span class="badge ${it.status}">${it.status}</span></div>
             <div class="item-sub">${it.message||''}</div>
             <div class="row gap-8 mt-8">
               <button class="btn btn-approve">Mark Done</button>
               <button class="btn btn-reject">Dismiss</button>
             </div>`);
          row.querySelector('.btn-approve').onclick = ()=>{
            it.status='done'; db.set('parent_requests', all); renderReq();
          };
          row.querySelector('.btn-reject').onclick = ()=>{
            it.status='dismissed'; db.set('parent_requests', all); renderReq();
          };
          box.appendChild(row);
        });
      };

      renderLeaves(); renderReq();
    })();
  </script>
</body>
</html>
