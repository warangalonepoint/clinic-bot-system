<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Clinic • Doctor</title>
<link rel="manifest" href="./manifest.webmanifest"><link rel="stylesheet" href="./styles.css">
<meta name="theme-color" content="#111"/>
<style>
main{max-width:1100px;margin:16px auto;padding:16px}
.logout{position:fixed;right:14px;top:14px;z-index:9;padding:10px 14px;border:0;border-radius:12px;font-weight:700;background:#111;color:#fff}
.grid2{display:grid;grid-template-columns:2.1fr 1fr;gap:14px}@media(max-width:980px){.grid2{grid-template-columns:1fr}}
input,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;font-size:15px}
table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
.badge{display:inline-block;background:#111;color:#fff;border-radius:999px;padding:3px 8px;font-size:12px}
.pill{background:#eee;border-radius:999px;padding:4px 10px}
.btn{padding:10px 14px;border:0;border-radius:12px;font-weight:700;background:#111;color:#fff;cursor:pointer}
.rowbtn{display:inline-flex;gap:8px;flex-wrap:wrap}
.kv{display:flex;gap:10px;flex-wrap:wrap}
.kv span{background:#f5f5f5;border-radius:10px;padding:6px 10px}
.muted{color:#666}
</style></head><body>
<script>(function(){const r=sessionStorage.getItem("clinic_role");if(r!=="doctor")location.replace("./index.html");})();</script>
<button class="logout" onclick="sessionStorage.clear();location.href='./index.html'">Logout</button>

<main>
  <img class="banner" src="./assets/clinic_banner.png" alt="Clinic"/>

  <!-- Summary cards -->
  <div class="card" style="margin-top:12px">
    <h2 style="margin:0 0 10px">Today</h2>
    <div class="kv" id="summary">
      <span>Appointments: <b id="sum_ap">0</b></span>
      <span>Walk-ins: <b id="sum_q">0</b></span>
      <span>Seen: <b id="sum_done">0</b></span>
      <span>Pending: <b id="sum_pending">0</b></span>
    </div>
  </div>

  <div class="grid2">
    <!-- LEFT: Today’s list (appointments + walk-ins) -->
    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <h2 style="margin:0">Today’s Patients</h2>
        <input id="search" placeholder="Search name/phone" style="max-width:260px">
      </div>
      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead><tr>
            <th>#</th><th>Time</th><th>Token</th><th>Name</th><th>Phone</th><th>Type</th><th>Status</th><th>Actions</th>
          </tr></thead>
          <tbody id="list"></tbody>
        </table>
        <div id="empty" class="muted">No patients for today yet.</div>
      </div>
    </section>

    <!-- RIGHT: Patient pane (details + notes) -->
    <section class="card">
      <h2 style="margin:0 0 8px">Patient</h2>
      <div id="p_none" class="muted">Select a patient to view details and write a note.</div>
      <div id="pane" style="display:none">
        <div class="pill" id="p_token">Token —</div>
        <h3 id="p_name" style="margin:8px 0 4px">—</h3>
        <div class="muted" id="p_phone">—</div>
        <div class="muted" id="p_type" style="margin-top:6px">—</div>
        <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
        <label>Quick Note (doctor only)
          <textarea id="p_note" rows="6" placeholder="e.g., ‘URTI, start amox 500 bd x5d’"></textarea>
        </label>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn" id="save_note">Save Note</button>
          <button class="btn" id="mark_seen">Mark Seen</button>
        </div>
        <div id="p_msg" style="margin-top:8px;color:#0d7c66"></div>
      </div>
    </section>
  </div>
</main>

<script>
// PWA
if("serviceWorker" in navigator){navigator.serviceWorker.register("./sw.js").catch(()=>{});}

// Storage keys
const K={appts:"cl_a",queue:"cl_q",notes:"cl_notes",tokens:"cl_tok",seen:"cl_seen"};
const jget=k=>JSON.parse(localStorage.getItem(k)||"[]");
const jset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const today=()=>new Date().toISOString().slice(0,10);

// Token engine: assigns sequential tokens per day across both sources
function ensureTokens(rows){
  const d=today();
  const key=`${K.tokens}_${d}`;
  let map=jget(key); // array of [{id,token}]
  if(!Array.isArray(map)) map=[];
  let counter = map.reduce((m,o)=>Math.max(m, Number(o.token)), 0);

  rows.forEach(r=>{
    if(!r.token){
      // unique id per row for token map
      const uid = r.uid || (r.source+"|"+(r.date||d)+"|"+(r.time||"")+"|"+r.phone);
      const found = map.find(x=>x.id===uid);
      if(found){ r.token = found.token; }
      else{
        counter += 1;
        const tok = String(counter).padStart(3,"0");
        r.token = tok;
        map.push({id:uid,token:tok});
      }
      r.uid = uid;
    }
  });
  jset(key,map);
  return rows;
}

// Build today's list
function buildToday(){
  const d=today();
  const ap = jget(K.appts).filter(a=>a.date===d).map(a=>({
    source:"appt", date:a.date,time:a.time,name:a.name,phone:a.phone,status:a.status||"Booked"
  }));
  const q = jget(K.queue)
    .filter(x=>new Date(x.ts).toISOString().slice(0,10)===d)
    .map(x=>({source:"walkin", time:x.time||"", name:x.name, phone:x.phone, status:"Queued"}));
  let rows = ap.concat(q);
  rows = ensureTokens(rows);
  // seen map
  const seen = new Set(jget(`${K.seen}_${d}`));
  rows.forEach(r=>{ if(seen.has(r.token)) r.status="Seen"; });
  // sort time then token
  rows.sort((a,b)=>(a.time||"").localeCompare(b.time||"")||a.token.localeCompare(b.token));
  return rows;
}

let current=null; // currently selected row

function render(){
  const rows = buildToday();
  const tb = document.getElementById("list");
  tb.innerHTML="";
  const q = (document.getElementById("search").value||"").toLowerCase();

  const filtered = rows.filter(r =>
    r.name.toLowerCase().includes(q) || (r.phone||"").includes(q) || (r.token||"").includes(q)
  );

  if(!filtered.length){ document.getElementById("empty").style.display="block"; }
  else{ document.getElementById("empty").style.display="none"; }

  let seenCount=0;
  filtered.forEach((r,i)=>{
    if(r.status==="Seen") seenCount++;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${r.time||"—"}</td>
      <td><span class="badge">${r.token}</span></td>
      <td>${r.name}</td>
      <td>${r.phone||"—"}</td>
      <td>${r.source==="appt"?"Appointment":"Walk-in"}</td>
      <td>${r.status}</td>
      <td class="rowbtn">
        <button class="btn b-note" data-tok="${r.token}">Note</button>
        <button class="btn b-seen" data-tok="${r.token}">Seen</button>
      </td>`;
    tb.appendChild(tr);
  });

  // summary
  const all = buildToday();
  document.getElementById("sum_ap").textContent = all.filter(r=>r.source==="appt").length;
  document.getElementById("sum_q").textContent  = all.filter(r=>r.source!=="appt").length;
  document.getElementById("sum_done").textContent = all.filter(r=>r.status==="Seen").length;
  document.getElementById("sum_pending").textContent = all.filter(r=>r.status!=="Seen").length;

  // handlers
  tb.querySelectorAll(".b-note").forEach(b=>b.onclick=()=>openNote(b.dataset.tok));
  tb.querySelectorAll(".b-seen").forEach(b=>b.onclick=()=>markSeen(b.dataset.tok));
}

function openNote(token){
  const d=today();
  const key=`${K.notes}_${d}`;
  const notes=jget(key);
  const rows=buildToday();
  const r=rows.find(x=>x.token===token); if(!r) return;
  current=r;
  document.getElementById("p_none").style.display="none";
  document.getElementById("pane").style.display="block";
  document.getElementById("p_token").textContent="Token "+r.token;
  document.getElementById("p_name").textContent=r.name;
  document.getElementById("p_phone").textContent=r.phone||"—";
  document.getElementById("p_type").textContent=r.source==="appt"?"Appointment":"Walk-in";
  document.getElementById("p_note").value = (notes.find(n=>n.token===token)?.note)||"";
  document.getElementById("p_msg").textContent="";
}

function saveNote(){
  if(!current) return;
  const d=today();
  const key=`${K.notes}_${d}`;
  const arr=jget(key);
  const note=document.getElementById("p_note").value;
  const idx=arr.findIndex(n=>n.token===current.token);
  if(idx>-1) arr[idx].note=note; else arr.push({token:current.token,note});
  jset(key,arr);
  document.getElementById("p_msg").textContent="Note saved ✅";
  setTimeout(()=>document.getElementById("p_msg").textContent="",1200);
}

function markSeen(token){
  const d=today();
  const key=`${K.seen}_${d}`;
  const arr=new Set(jget(key));
  arr.add(token);
  jset(key,[...arr]);
  if(current && current.token===token){
    document.getElementById("p_msg").textContent="Marked seen ✅";
    setTimeout(()=>document.getElementById("p_msg").textContent="",1200);
  }
  render();
}

// UI binds
document.getElementById("search").addEventListener("input",render);
document.getElementById("save_note").onclick=saveNote;
document.getElementById("mark_seen").onclick=()=>current&&markSeen(current.token);

// first paint
render();
</script>
</body></html>
