<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teacher</title>
<link rel="stylesheet" href="styles.css"/>
<style>
  .note{padding:10px;margin:10px 0;border:1px solid #2a344a;border-radius:10px;background:#101623;color:#cbd5e1}
  .muted{opacity:.7}
  .card{background:#121826;border:1px solid #232a3a;border-radius:14px;padding:12px;margin:8px 0}
  .row{display:flex;justify-content:space-between;gap:12px;align-items:center}
</style>
</head>
<body class="dark">
<div class="wrapper">

  <section class="accent-teal">
    <div class="glass header">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="eyebrow">Class management</div>
          <div class="h1">Teacher Panel</div>
        </div>
        <div class="row" style="gap:8px">
          <a class="btn" href="./logout.html">Logout</a>
          <button class="btn" onclick="toggleTheme()">Theme</button>
        </div>
      </div>

      <div class="tab-row" id="tabs">
        <button class="chip chip-indigo" data-tab="diary">Diary</button>
        <button class="chip chip-blue"   data-tab="homework">Homework</button>
        <button class="chip chip-amber"  data-tab="attendance">Attendance</button>
        <button class="chip chip-cyan"   data-tab="marks">Marks</button>
        <button class="chip chip-fuchsia"data-tab="announcements">Announcements</button>
        <button class="chip chip-violet" data-tab="events">Events</button>
      </div>
    </div>
  </section>

  <!-- Diary -->
  <section id="panel-diary" class="glass inner panel">
    <div class="h1">Post Diary</div>
    <form id="diaryForm" class="form-grid mt-12">
      <input class="input" name="subject" placeholder="Subject" required/>
      <textarea class="input full" name="note" placeholder="What was taught…" required></textarea>
      <button class="btn btn-indigo">Post</button>
    </form>
    <div id="diaryMsg" class="note" hidden></div>
  </section>

  <!-- Homework -->
  <section id="panel-homework" class="glass inner panel" hidden>
    <div class="h1">Assign Homework</div>
    <form id="hwForm" class="form-grid mt-12">
      <input class="input" name="subject" placeholder="Subject" required/>
      <input class="input" type="date" name="due_date" required/>
      <textarea class="input full" name="task" placeholder="Homework task…" required></textarea>
      <button class="btn btn-blue">Assign</button>
    </form>
    <div id="hwMsg" class="note" hidden></div>
  </section>

  <!-- Attendance -->
  <section id="panel-attendance" class="glass inner panel" hidden>
    <div class="h1">Mark Attendance</div>
    <form id="attForm" class="form-grid mt-12">
      <input class="input" type="date" name="date" required/>
      <input class="input" name="student" placeholder="Roll / Name" required/>
      <select class="input" name="status" required>
        <option>Present</option><option>Absent</option><option>Late</option>
      </select>
      <button class="btn btn-amber">Save</button>
    </form>
    <div id="attMsg" class="note" hidden></div>
  </section>

  <!-- Marks -->
  <section id="panel-marks" class="glass inner panel" hidden>
    <div class="h1">Enter Marks</div>
    <form id="marksForm" class="form-grid mt-12">
      <input class="input" name="exam" placeholder="Exam (e.g., Unit Test 1)" required/>
      <input class="input" name="roll" placeholder="Roll No" required/>
      <input class="input" name="marks" type="number" placeholder="Marks / 100" required/>
      <button class="btn btn-cyan">Save</button>
    </form>
    <div id="marksMsg" class="note" hidden></div>
  </section>

  <!-- Announcements -->
  <section id="panel-announcements" class="glass inner panel" hidden>
    <div class="h1">Announcements</div>
    <div id="annList" class="mt-12"><div class="note">Loading…</div></div>
  </section>

  <!-- Events -->
  <section id="panel-events" class="glass inner panel" hidden>
    <div class="h1">Events</div>
    <div id="evList" class="mt-12"><div class="note">Loading…</div></div>
  </section>

</div>

<!-- Tabs -->
<script type="module">
  import {initTabs} from './ui.js';
  initTabs(document);
</script>

<!-- Supabase wiring -->
<script type="module">
  import { requireLogin, sb } from "./js/supabase.js";
  await requireLogin();

  // Diary
  const diaryForm = document.getElementById("diaryForm");
  const diaryMsg  = document.getElementById("diaryMsg");
  diaryForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const fd = new FormData(diaryForm);
    const { error } = await sb.from("diary").insert({
      subject: fd.get("subject"),
      note: fd.get("note"),
      date: new Date().toISOString().slice(0,10)
    });
    diaryMsg.hidden = false;
    diaryMsg.textContent = error ? "❌ "+error.message : "✅ Diary posted";
    if (!error) diaryForm.reset();
  });

  // Homework
  const hwForm = document.getElementById("hwForm");
  const hwMsg  = document.getElementById("hwMsg");
  hwForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const fd = new FormData(hwForm);
    const { error } = await sb.from("homework").insert({
      subject: fd.get("subject"),
      due_date: fd.get("due_date"),
      task: fd.get("task")
    });
    hwMsg.hidden = false;
    hwMsg.textContent = error ? "❌ "+error.message : "✅ Homework assigned";
    if (!error) hwForm.reset();
  });

  // Attendance
  const attForm = document.getElementById("attForm");
  const attMsg  = document.getElementById("attMsg");
  attForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const fd = new FormData(attForm);
    const { error } = await sb.from("attendance").insert({
      date: fd.get("date"),
      student: fd.get("student"),
      status: fd.get("status")
    });
    attMsg.hidden = false;
    attMsg.textContent = error ? "❌ "+error.message : "✅ Attendance saved";
    if (!error) attForm.reset();
  });

  // Marks
  const marksForm = document.getElementById("marksForm");
  const marksMsg  = document.getElementById("marksMsg");
  marksForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const fd = new FormData(marksForm);
    const { error } = await sb.from("marks").insert({
      exam: fd.get("exam"),
      roll: fd.get("roll"),
      marks: parseInt(fd.get("marks"),10)
    });
    marksMsg.hidden = false;
    marksMsg.textContent = error ? "❌ "+error.message : "✅ Marks saved";
    if (!error) marksForm.reset();
  });

  // Announcements (read-only)
  async function loadAnnouncements(){
    const { data, error } = await sb.from("announcements").select("*")
      .order("created_at",{ascending:false}).limit(20);
    const target = document.getElementById("annList");
    if (error) { target.innerHTML = `<div class="note">Error loading announcements</div>`; return; }
    if (!data.length) { target.innerHTML = `<div class="note">No announcements</div>`; return; }
    target.innerHTML = data.map(a=>`
      <div class="card">
        <div class="row"><b>Announcement</b><span class="muted">${new Date(a.created_at).toLocaleString()}</span></div>
        <div>${a.body}</div>
      </div>`).join("");
  }

  // Events (read-only)
  async function loadEvents(){
    const { data, error } = await sb.from("events").select("*")
      .order("event_date",{ascending:true}).limit(20);
    const target = document.getElementById("evList");
    if (error) { target.innerHTML = `<div class="note">Error loading events</div>`; return; }
    if (!data.length) { target.innerHTML = `<div class="note">No events</div>`; return; }
    target.innerHTML = data.map(ev=>`
      <div class="card">
        <div class="row"><b>${ev.title}</b><span class="muted">${ev.event_date||''}</span></div>
      </div>`).join("");
  }

  loadAnnouncements();
  loadEvents();

  sb.channel("teacher-rt")
    .on("postgres_changes",{event:"*",schema:"public",table:"announcements"},loadAnnouncements)
    .on("postgres_changes",{event:"*",schema:"public",table:"events"},loadEvents)
    .subscribe();
</script>
<script type="module" src="ui.js"></script>
</body>
</html>
