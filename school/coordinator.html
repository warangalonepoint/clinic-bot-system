<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coordinator · School PWA</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="dark">
  <div class="wrapper">

    <!-- HEADER -->
    <section class="hero glass">
      <div class="hero-top">
        <div class="hero-eyebrow">Manage timetable and broadcast</div>
        <div class="hero-title">Coordinator Panel</div>
        <div class="hero-actions">
          <button class="chip chip-slate" id="pinBtn">PIN</button>
          <button class="chip chip-blue" id="themeBtn">Theme</button>
        </div>
      </div>

      <div class="tabbar" data-tab-group>
        <button class="chip chip-indigo active" data-tab="ct-setup">Class Setup</button>
        <button class="chip chip-blue" data-tab="ct-tt">Timetable</button>
        <button class="chip chip-pink" data-tab="ct-bc">Broadcast</button>
        <button class="chip chip-green" data-tab="ct-data">Data</button>
        <button class="chip chip-purple" data-tab="ct-events">Events</button>
        <button class="chip chip-orange" data-tab="ct-complaints">Complaints</button>
      </div>
    </section>

    <!-- CLASS META -->
    <section class="panel glass" id="ct-setup">
      <h2>Choose Class</h2>
      <div class="grid">
        <input id="c-class" class="input" placeholder="Class e.g., 5" />
        <input id="c-section" class="input" placeholder="Section e.g., A" />
      </div>
      <div class="row-right">
        <button class="btn btn-primary" id="c-save-meta">Save Meta</button>
      </div>
    </section>

    <!-- TIMETABLE -->
    <section class="panel glass hidden" id="ct-tt">
      <h2>Add / Replace Period</h2>
      <div class="grid">
        <select id="tt-day" class="input">
          <option>Mon</option><option>Tue</option><option>Wed</option>
          <option>Thu</option><option>Fri</option><option>Sat</option>
        </select>
        <input id="tt-period" class="input" placeholder="Period # 1–12" />
        <input id="tt-subject" class="input" placeholder="Subject" />
        <input id="tt-teacher" class="input" placeholder="Teacher name" />
        <input id="tt-room" class="input" placeholder="Room (optional)" />
      </div>
      <div class="row-right">
        <button class="btn btn-primary" id="tt-add">Add / Update</button>
      </div>

      <h3 class="mt-16">Class Timetable</h3>
      <div id="tt-list" class="list"></div>
      <div class="row gap-8 mt-12">
        <button class="btn btn-secondary" id="tt-export">Export CSV</button>
        <button class="btn btn-danger" id="tt-clear">Clear Class Timetable</button>
      </div>
    </section>

    <!-- BROADCAST -->
    <section class="panel glass hidden" id="ct-bc">
      <h2>Broadcast to Parents</h2>
      <textarea id="bc-msg" rows="4" class="input" placeholder="Message..."></textarea>
      <div class="row-right">
        <button class="btn btn-primary" id="bc-send">Send</button>
      </div>
      <div id="bc-list" class="list mt-12"></div>
    </section>

    <!-- DATA -->
    <section class="panel glass hidden" id="ct-data">
      <h2>Data Tools</h2>
      <p class="text-dim">Local-only demo tools.</p>
      <div class="row gap-8 mt-8">
        <button class="btn btn-secondary" id="backup">Backup (JSON)</button>
        <label class="btn btn-secondary">
          Restore <input type="file" id="restoreFile" hidden />
        </label>
      </div>
    </section>

    <!-- EVENTS -->
    <section class="panel glass hidden" id="ct-events">
      <h2>Events & Exams</h2>
      <div class="grid">
        <input id="ev-title" class="input" placeholder="Title, e.g., Science Quiz" />
        <input id="ev-date" type="date" class="input" />
        <select id="ev-type" class="input">
          <option value="event">Event</option>
          <option value="exam">Exam</option>
          <option value="meeting">Meeting</option>
        </select>
        <input id="ev-notes" class="input" placeholder="Notes (optional)" />
      </div>
      <div class="row-right">
        <button class="btn btn-primary" id="ev-add">Add</button>
      </div>
      <div id="ev-list" class="list mt-12"></div>
    </section>

    <!-- COMPLAINTS -->
    <section class="panel glass hidden" id="ct-complaints">
      <h2>Complaints Inbox</h2>
      <div id="cp-list" class="list"></div>
    </section>

  </div>

  <script>
    const q = s => document.querySelector(s);
    const qa = s => [...document.querySelectorAll(s)];
    const db = {
      get: (k, d=[]) => { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch{ return d } },
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
    };
    const today = () => new Date().toISOString().slice(0,10);

    // theme + pin
    (function(){
      const url = new URL(location.href);
      const t = url.searchParams.get('theme') || localStorage.getItem('theme') || 'dark';
      document.body.classList.toggle('dark', t==='dark');
      localStorage.setItem('theme', t);
      q('#themeBtn').addEventListener('click', ()=>{
        const next = document.body.classList.contains('dark') ? 'light':'dark';
        document.body.classList.toggle('dark', next==='dark');
        localStorage.setItem('theme', next);
        const u=new URL(location.href);u.searchParams.set('theme', next);history.replaceState({},'',u);
      });
      q('#pinBtn').addEventListener('click', ()=> location.href='index.html?theme='+(localStorage.getItem('theme')||'dark'));
    })();

    // tabs
    (function(){
      const bar = q('[data-tab-group]');
      const show = id => qa('.panel').forEach(p=>p.classList.toggle('hidden', p.id!==id));
      bar.addEventListener('click', e=>{
        const b = e.target.closest('[data-tab]'); if(!b) return;
        bar.querySelectorAll('[data-tab]').forEach(x=>x.classList.remove('active'));
        b.classList.add('active'); show(b.dataset.tab);
      });
      show('ct-setup');
    })();

    // class meta
    (function(){
      const m = db.get('coord_meta', {});
      if(m.class) q('#c-class').value=m.class;
      if(m.section) q('#c-section').value=m.section;
      q('#c-save-meta').addEventListener('click', ()=>{
        db.set('coord_meta',{class:q('#c-class').value.trim(), section:q('#c-section').value.trim()});
        alert('Saved ✅');
      });
    })();

    const cid = ()=>{ const m=db.get('coord_meta',{}); return (m.class||'')+'_'+(m.section||''); };

    // timetable
    (function(){
      q('#tt-day').value='Mon'; q('#tt-period').value='';
      const key = ()=>'tt_'+cid();
      const render = ()=>{
        const box=q('#tt-list'); box.innerHTML='';
        const list=db.get(key(),[]);
        if(!list.length){ box.innerHTML='<div class="empty">No entries yet.</div>'; return; }
        list.sort((a,b)=> a.day.localeCompare(b.day)||a.period-b.period);
        list.forEach((it,i)=>{
          const row=document.createElement('div');row.className='item';
          row.innerHTML=`<div class="item-title"><b>${it.day}</b> · P${it.period} · ${it.subject||''}</div>
                         <div class="item-sub">${it.teacher||''}${it.room?(' · '+it.room):''}</div>`;
          box.appendChild(row);
        });
      };
      q('#tt-add').addEventListener('click', ()=>{
        const it={
          day:q('#tt-day').value, period:+q('#tt-period').value||1,
          subject:q('#tt-subject').value.trim(), teacher:q('#tt-teacher').value.trim(),
          room:q('#tt-room').value.trim()
        };
        if(!it.subject){ alert('Enter subject'); return; }
        const list=db.get(key(),[]);
        const idx=list.findIndex(x=>x.day===it.day&&x.period===it.period);
        if(idx>-1) list[idx]=it; else list.push(it);
        db.set(key(),list); render(); alert('Saved ✅');
      });
      q('#tt-clear').addEventListener('click', ()=>{ if(confirm('Clear this class timetable?')){ db.set(key(),[]); render(); }});
      q('#tt-export').addEventListener('click', ()=>{
        const list=db.get(key(),[]);
        const rows=[['day','period','subject','teacher','room'],...list.map(x=>[x.day,x.period,x.subject,x.teacher,x.room])];
        const csv=rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
        const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download='timetable.csv';a.click();
      });
      render();
    })();

    // broadcast
    (function(){
      const key='broadcasts';
      const render=()=>{
        const list=db.get(key,[]).slice(-20).reverse();
        const box=q('#bc-list'); box.innerHTML='';
        list.forEach(it=>{
          const row=document.createElement('div');row.className='item';
          row.innerHTML=`<div class="item-title">${new Date(it.ts).toLocaleString()}</div>
                         <div class="item-sub">${it.msg}</div>`;
          box.appendChild(row);
        });
      };
      q('#bc-send').addEventListener('click', ()=>{
        const msg=q('#bc-msg').value.trim(); if(!msg) return;
        const list=db.get(key,[]); list.push({msg,ts:Date.now()}); db.set(key,list); q('#bc-msg').value=''; render(); alert('Sent ✅');
      });
      render();
    })();

    // data backup/restore
    (function(){
      q('#backup').addEventListener('click', ()=>{
        const dump=JSON.stringify(localStorage,null,2);
        const a=document.createElement('a');
        a.href=URL.createObjectURL(new Blob([dump],{type:'application/json'}));
        a.download='school-backup.json'; a.click();
      });
      q('#restoreFile').addEventListener('change', e=>{
        const f=e.target.files[0]; if(!f) return;
        const r=new FileReader(); r.onload=()=>{
          try{ const map=JSON.parse(r.result); Object.keys(map).forEach(k=>localStorage.setItem(k,map[k])); alert('Restored ✅'); location.reload(); }
          catch{ alert('Invalid file'); }
        }; r.readAsText(f);
      });
    })();

    // events
    (function(){
      q('#ev-date').value=today();
      const key='school_events';
      const render=()=>{
        const list=db.get(key,[]).sort((a,b)=>a.date.localeCompare(b.date));
        const box=q('#ev-list'); box.innerHTML='';
        if(!list.length){ box.innerHTML='<div class="empty">No events.</div>'; return; }
        list.forEach((it,idx)=>{
          const row=document.createElement('div');row.className='item';
          row.innerHTML=`<div class="item-title"><b>${it.title}</b> · ${it.date} · <span class="badge ${it.type}">${it.type}</span></div>
                         <div class="item-sub">${it.notes||''}</div>
                         <div class="row-right"><button class="btn btn-danger">Delete</button></div>`;
          row.querySelector('button').onclick = ()=>{ const l=db.get(key,[]); l.splice(idx,1); db.set(key,l); render(); };
          box.appendChild(row);
        });
      };
      q('#ev-add').addEventListener('click', ()=>{
        const it={ title:q('#ev-title').value.trim(), date:q('#ev-date').value||today(), type:q('#ev-type').value, notes:q('#ev-notes').value.trim(), id:crypto.randomUUID(), ts:Date.now() };
        if(!it.title){ alert('Enter title'); return; }
        const list=db.get(key,[]); list.push(it); db.set(key,list);
        q('#ev-title').value=''; q('#ev-notes').value=''; render(); alert('Added ✅');
      });
      render();
    })();

    // complaints
    (function(){
      const key='school_complaints';
      const render=()=>{
        const list=db.get(key,[]).sort((a,b)=>b.ts-a.ts);
        const box=q('#cp-list'); box.innerHTML='';
        if(!list.length){ box.innerHTML='<div class="empty">No complaints.</div>'; return; }
        list.forEach((it)=>{
          const row=document.createElement('div');row.className='item';
          row.innerHTML=`<div class="item-title"><b>${it.category||'Complaint'}</b> · ${it.class||''}${it.section?('-'+it.section):''} · <span class="badge ${it.status}">${it.status}</span></div>
                         <div class="item-sub">${it.message||''}</div>
                         <div class="row gap-8 mt-8">
                           <button class="btn btn-secondary">In-Progress</button>
                           <button class="btn btn-approve">Resolve</button>
                         </div>`;
          row.querySelector('.btn-secondary').onclick=()=>{ it.status='in-progress'; const l=db.get(key,[]); db.set(key,l); render(); };
          row.querySelector('.btn-approve').onclick=()=>{ it.status='resolved';   const l=db.get(key,[]); db.set(key,l); render(); };
          box.appendChild(row);
        });
      };
      render();
    })();
  </script>
</body>
</html>
