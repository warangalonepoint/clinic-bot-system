<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Appointment Logs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #222;
    }
    th, td {
      padding: 10px;
      border: 1px solid #333;
      text-align: left;
    }
    th {
      background-color: #333;
    }
    select, input, button {
      padding: 10px;
      margin: 10px 5px;
    }
    .highlight {
      color: #4dc1ff;
    }
    .filter-bar {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1 class="highlight">📋 Appointment Logs</h1>

  <div class="filter-bar">
    <select id="dateFilter">
      <option value="all">All Dates</option>
      <option value="today">Today</option>
      <option value="yesterday">Yesterday</option>
    </select>
    <input type="date" id="fromDate" />
    <input type="date" id="toDate" />
    <button onclick="applyDateFilter()">Apply</button>
    <button onclick="exportToExcel()">📊 Export Excel</button>
    <button onclick="exportToPDF()">🧾 Export PDF</button>
  </div>

  <table id="logsTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Clinic</th>
        <th>Patient Name</th>
        <th>Time</th>
        <th>Reason</th>
        <th>Contact</th>
        <th>Reminder Sent</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let fullData = [];

    function loadLogs() {
      fetch('logs.csv')
        .then(res => res.text())
        .then(csv => {
          const lines = csv.trim().split('\n').slice(1);
          const tbody = document.querySelector('#logsTable tbody');
          tbody.innerHTML = '';
          fullData = [];

          lines.forEach(line => {
            const [date, clinic, name, time, reason, contact = '', reminder = ''] = line.split(',');
            fullData.push({ date, clinic, name, time, reason, contact, reminder });

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${date}</td>
              <td>${clinic}</td>
              <td>${name}</td>
              <td>${time}</td>
              <td>${reason}</td>
              <td><a href="tel:${contact.trim()}">${contact.trim()}</a></td>
              <td>${reminder}</td>
              <td><button onclick="sendReminder('${contact.trim()}', this)">🔔 Send Reminder</button></td>
            `;
            tbody.appendChild(tr);
          });
        });
    }

    function sendReminder(number, btn) {
      if (!number) return alert("No contact number.");
      const msg = encodeURIComponent("⏰ Reminder: You have an appointment booked.");
      const link = `https://wa.me/${number}?text=${msg}`;
      window.open(link, '_blank');
      btn.closest('tr').children[6].textContent = 'Yes';
    }

    function applyDateFilter() {
      const filter = document.getElementById('dateFilter').value;
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;

      const today = new Date();
      const yest = new Date(Date.now() - 86400000);
      const tbody = document.querySelector('#logsTable tbody');
      tbody.innerHTML = '';

      const filtered = fullData.filter(row => {
        const rowDate = new Date(row.date.split('-').reverse().join('-'));
        if (filter === 'today') return isSameDate(rowDate, today);
        if (filter === 'yesterday') return isSameDate(rowDate, yest);
        if (from && to) {
          const fromD = new Date(from);
          const toD = new Date(to);
          return rowDate >= fromD && rowDate <= toD;
        }
        return true;
      });

      filtered.forEach(({ date, clinic, name, time, reason, contact, reminder }) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${date}</td>
          <td>${clinic}</td>
          <td>${name}</td>
          <td>${time}</td>
          <td>${reason}</td>
          <td><a href="tel:${contact.trim()}">${contact.trim()}</a></td>
          <td>${reminder}</td>
          <td><button onclick="sendReminder('${contact.trim()}', this)">🔔 Send Reminder</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function isSameDate(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    function exportToExcel() {
      const ws = XLSX.utils.json_to_sheet(fullData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Logs");
      XLSX.writeFile(wb, "appointment_logs.xlsx");
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      fullData.forEach(({ date, clinic, name, time, reason, contact }) => {
        doc.text(`${date} | ${clinic} | ${name} | ${time} | ${reason} | ${contact}`, 10, y);
        y += 10;
        if (y > 270) {
          doc.addPage();
          y = 10;
        }
      });
      doc.save("appointment_logs.pdf");
    }

    loadLogs();
  </script>
</body>
</html>
