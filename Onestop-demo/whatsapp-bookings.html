<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WhatsApp Bookings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="styles.css">
  <style>
    #confirmation {
      display: none;
      margin-top: 20px;
      padding: 10px;
      background-color: #222;
      color: #fff;
      border-radius: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <img src="./assets/banner.png" alt="Banner" style="width:100%; max-height:120px; object-fit:cover;"/>
  <div class="form-container">
    <h2>Onestop C-Demo</h2>
    <p>WhatsApp Appointment</p>
    <select id="date"></select>
    <select id="slot"></select>
    <input type="text" id="name" placeholder="Enter patient name" />
    <input type="text" id="reason" placeholder="Enter reason" />
    <button onclick="submitBooking()">Book on WhatsApp</button>
    <div id="confirmation"></div>
  </div>

  <script>
    const airtableApiKey = 'patLNwoJQKE3Tjb8J.c2a0db129111c610fae64a2c01e0a626f37bdb5992232ea6ebc644fa9073dfb3';
    const airtableBaseId = 'app1T8WiRqZIR4xY';
    const logsTable = 'BookingsLogs';
    const slotsTable = 'AvailableSlots';

    async function loadDates() {
      const response = await fetch(`https://api.airtable.com/v0/${airtableBaseId}/${slotsTable}?api_key=${airtableApiKey}`);
      const data = await response.json();
      const dates = [...new Set(data.records.map(r => r.fields.Date))].sort();
      const dateSelect = document.getElementById('date');
      dates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        dateSelect.appendChild(option);
      });
      loadSlots(); // load slots on first date auto
    }

    async function loadSlots() {
      const selectedDate = document.getElementById('date').value;
      const response = await fetch(`https://api.airtable.com/v0/${airtableBaseId}/${slotsTable}?filterByFormula={Date}='${selectedDate}'&api_key=${airtableApiKey}`);
      const data = await response.json();
      const slotSelect = document.getElementById('slot');
      slotSelect.innerHTML = "";
      data.records
        .filter(r => r.fields.Status === 'Available')
        .forEach(r => {
          const option = document.createElement('option');
          option.value = r.fields["Time Slot"];
          option.textContent = r.fields["Time Slot"];
          slotSelect.appendChild(option);
        });
    }

    document.getElementById('date').addEventListener('change', loadSlots);

    async function submitBooking() {
      const date = document.getElementById('date').value;
      const slot = document.getElementById('slot').value;
      const name = document.getElementById('name').value;
      const reason = document.getElementById('reason').value;

      if (!date || !slot || !name || !reason) {
        alert('Please fill all fields');
        return;
      }

      const logsResponse = await fetch(`https://api.airtable.com/v0/${airtableBaseId}/${logsTable}?filterByFormula=AND({Timestamp}='${date}', {Slot Time}='${slot}')&api_key=${airtableApiKey}`);
      const logsData = await logsResponse.json();
      if (logsData.records.length > 0) {
        alert('This slot is already booked!');
        return;
      }

      const allBookingsResponse = await fetch(`https://api.airtable.com/v0/${airtableBaseId}/${logsTable}?filterByFormula={Timestamp}='${date}'&api_key=${airtableApiKey}`);
      const allBookings = await allBookingsResponse.json();
      const token = allBookings.records.length + 1;

      await fetch(`https://api.airtable.com/v0/${airtableBaseId}/${logsTable}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          fields: {
            "Timestamp": date,
            "Slot Time": slot,
            "Patient Name": name,
            "Reason": reason,
            "Contact": "", // Optional
            "Token": token,
            "Reminder Sent": ""
          }
        })
      });

      const message = `Hello, I booked an appointment on ${date} at ${slot}. Name: ${name}, Reason: ${reason}, Token No: ${token}`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;

      document.getElementById('confirmation').innerHTML =
        `<b>Booking Confirmed!</b><br>Token No: ${token}<br>Redirecting to WhatsApp...`;
      document.getElementById('confirmation').style.display = 'block';

      setTimeout(() => {
        window.location.href = whatsappUrl;
      }, 3000);
    }

    loadDates();
  </script>
</body>
</html>
