<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coordinator • School PWA</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <main>
    <div class="topbar">
      <span class="badge">Coordinator</span>
      <div style="display:flex; gap:8px; align-items:center">
        <label title="Dark / Light"><input id="themeToggle" class="theme-toggle" type="checkbox"/></label>
        <a class="btn ghost" href="./index.html">Logout</a>
      </div>
    </div>

    <header class="hero panel"><div class="title">Coordinator Panel</div></header>

    <section class="panel" style="margin-top:14px">
      <div class="tabs">
        <button class="tab active" data-t="scope">Class Scope</button>
        <button class="tab" data-t="tt">Timetable</button>
        <button class="tab" data-t="leaves">Leaves</button>
        <button class="tab" data-t="backup">Backup</button>
      </div>

      <!-- Scope -->
      <div id="sec-scope" class="section active">
        <div class="card gradient-1">
          <h2>Choose class/section & meta for actions</h2>
          <div class="row">
            <div>
              <label>Class</label><input id="s-class" placeholder="e.g., 5"/>
              <label>Section</label><input id="s-sec" placeholder="e.g., A"/>
            </div>
            <div>
              <label>Day</label>
              <select id="s-day"><option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option><option>Fri</option><option>Sat</option></select>
              <label>Period #</label><input id="s-p" placeholder="1–12"/>
            </div>
          </div>
          <label>Subject</label><input id="s-sub" placeholder="e.g., Maths"/>
          <div class="spacer"></div>
          <button class="btn" id="btnMeta">Save Meta</button>
        </div>
      </div>

      <!-- Timetable -->
      <div id="sec-tt" class="section">
        <div class="card gradient-3">
          <h2>Add / Replace period entry (for selected class)</h2>
          <label>Teacher name</label><input id="tt-teacher" placeholder="e.g., Ms. Priya"/>
          <label>Room (optional)</label><input id="tt-room" placeholder="e.g., 302"/>
          <div class="spacer"></div>
          <button class="btn" id="btnAdd">Add / Update</button>
        </div>

        <div class="card gradient-2">
          <h2>Class Timetable</h2>
          <table class="table" id="tblTt"><thead>
            <tr><th>#</th><th>Day</th><th>Period</th><th>Subject</th><th>Teacher</th><th>Room</th><th>Action</th></tr>
          </thead><tbody></tbody></table>
          <div class="spacer"></div>
          <button class="btn ghost" id="btnClear">Clear Class Timetable</button>
        </div>
      </div>

      <!-- Leaves -->
      <div id="sec-leaves" class="section">
        <div class="card gradient-4">
          <h2>Parent Leave Requests</h2>
          <table class="table" id="tblLeaves"><thead>
            <tr><th>Date</th><th>Reason</th><th>Status</th><th>Action</th></tr>
          </thead><tbody></tbody></table>
        </div>
      </div>

      <!-- Backup -->
      <div id="sec-backup" class="section">
        <div class="row">
          <div class="card gradient-1">
            <h2>Backup (local demo)</h2>
            <button class="btn" id="btnExport">Export JSON</button>
          </div>
          <div class="card gradient-2">
            <h2>Restore</h2>
            <input id="restoreFile" type="file" accept="application/json" />
            <div class="spacer"></div>
            <button class="btn warn" id="btnRestore">Restore JSON</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Theme
    const root=document.documentElement;
    const tSaved=localStorage.getItem('theme')||'dark';
    root.setAttribute('data-theme',tSaved);
    document.getElementById('themeToggle').checked=(tSaved==='light');
    document.getElementById('themeToggle').addEventListener('change',e=>{
      const t=e.target.checked?'light':'dark'; root.setAttribute('data-theme',t); localStorage.setItem('theme',t);
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));
        document.getElementById('sec-'+b.dataset.t).classList.add('active');
      });
    });

    // Data helpers
    const L={get:k=>JSON.parse(localStorage.getItem(k)||"[]"), set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
    const S={get:k=>localStorage.getItem(k)||"", set:(k,v)=>localStorage.setItem(k,v)};

    // Save meta
    document.getElementById('btnMeta').addEventListener('click', ()=>{
      S.set('meta_class', document.getElementById('s-class').value.trim());
      S.set('meta_sec',   document.getElementById('s-sec').value.trim());
      S.set('meta_day',   document.getElementById('s-day').value);
      S.set('meta_p',     document.getElementById('s-p').value.trim());
      S.set('meta_sub',   document.getElementById('s-sub').value.trim());
      alert('Meta saved.');
      renderTT();
    });

    // Timetable add
    document.getElementById('btnAdd').addEventListener('click', ()=>{
      const cls=S.get('meta_class'), sec=S.get('meta_sec'), day=S.get('meta_day'), p=S.get('meta_p'), sub=S.get('meta_sub');
      if(!cls||!sec||!day||!p||!sub) return alert("Save class meta first");
      const key=`tt_${cls}_${sec}`;
      const list=L.get(key);
      const idx=list.findIndex(x=>x.day===day && x.p===p);
      const rec={day,p,subject:sub,teacher:document.getElementById('tt-teacher').value.trim(),room:document.getElementById('tt-room').value.trim()};
      if(idx>=0) list[idx]=rec; else list.push(rec);
      L.set(key,list); renderTT(); alert('Timetable updated.');
    });

    function renderTT(){
      const cls=S.get('meta_class'), sec=S.get('meta_sec');
      const key=`tt_${cls}_${sec}`; const list=L.get(key);
      const tb=document.querySelector('#tblTt tbody'); tb.innerHTML="";
      list.forEach((r,i)=>tb.insertAdjacentHTML('beforeend',
        `<tr><td>${i+1}</td><td>${r.day}</td><td>${r.p}</td><td>${r.subject}</td><td>${r.teacher||''}</td><td>${r.room||''}</td>
         <td><button class="btn ghost" data-i="${i}">Delete</button></td></tr>`));
      tb.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>{
        const arr=L.get(key); arr.splice(Number(b.dataset.i),1); L.set(key,arr); renderTT();
      }));
    }
    renderTT();

    document.getElementById('btnClear').addEventListener('click', ()=>{
      const cls=S.get('meta_class'), sec=S.get('meta_sec'); if(!cls||!sec) return;
      localStorage.removeItem(`tt_${cls}_${sec}`); renderTT(); alert('Cleared.');
    });

    // Leave approvals
    function renderLeaves(){
      const tb=document.querySelector('#tblLeaves tbody'); tb.innerHTML="";
      const arr=L.get('leaves');
      arr.forEach((x,i)=>tb.insertAdjacentHTML('beforeend',
        `<tr><td>${x.date}</td><td>${x.reason}</td><td>${x.status||'Pending'}</td>
        <td>
          <button class="btn" data-a="Approve" data-i="${i}">Approve</button>
          <button class="btn warn" data-a="Reject" data-i="${i}">Reject</button>
        </td></tr>`
      ));
      tb.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>{
        const i=Number(b.dataset.i), action=b.dataset.a;
        const arr=L.get('leaves'); arr[i].status=action; L.set('leaves',arr); renderLeaves();
      }));
    }
    renderLeaves();

    // Backup / Restore
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const dump = JSON.stringify(localStorage, null, 2);
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([dump],{type:'application/json'}));
      a.download='school-local-backup.json'; a.click();
    });
    document.getElementById('btnRestore').addEventListener('click', ()=>{
      const f=document.getElementById('restoreFile').files[0]; if(!f) return alert('Pick a file');
      const reader=new FileReader(); reader.onload=()=>{
        try{
          const obj=JSON.parse(reader.result);
          Object.keys(obj).forEach(k=>localStorage.setItem(k, obj[k]));
          alert('Restored. Reloading…'); location.reload();
        }catch(e){ alert('Invalid file'); }
      }; reader.readAsText(f);
    });
  </script>
</body>
</html>
