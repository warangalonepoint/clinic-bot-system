<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Appointment - Clinic Bot</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #111; color: #fff; }
    h1 { color: #0ff; }
    select, input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; }
    button { padding: 10px 15px; border: none; background: #0f0; color: #000; border-radius: 5px; cursor: pointer; }
    .slot-btn { background: #0f0; color: #000; padding: 8px 12px; border-radius: 6px; margin: 5px; }
    #confirmForm { display: none; margin-top: 20px; background: #222; padding: 15px; border-radius: 8px; color: #fff; }
    #logLine { background: #222; padding: 10px; margin-top: 15px; border-radius: 5px; word-wrap: break-word; color: #0f0; font-family: monospace; }
  </style>
</head>
<body>
  <h1>ðŸ“… Book an Appointment</h1><label for="clinic">Select Clinic:</label> <select id="clinic"> <option>OneStop</option> <option>CityCare</option> <option>HopeWell</option> <option>LifePoint</option> </select>

<label for="date">Choose Date:</label> <input type="date" id="date" onchange="loadTimeSlots()">

  <div id="slots"></div>  <div id="confirmForm">
    <h3>Confirm Your Booking</h3>
    <p>Time: <strong id="selectedTime"></strong></p>
    <input type="text" id="patientName" placeholder="Your Name"><br>
    <input type="text" id="reason" placeholder="Reason for Visit"><br>
    <button onclick="submitBooking()">Confirm & Go to WhatsApp</button>
    <div id="logLine"></div>
    <button onclick="copyLogLine()">ðŸ“‹ Copy Log Line</button>
  </div>  <script>
    let selectedTime = "";
    let latestLogLine = "";

    async function loadTimeSlots() {
      const clinic = document.querySelector("#clinic").value;
      const date = document.querySelector("#date").value;
      const slotDiv = document.querySelector("#slots");
      slotDiv.innerHTML = "<p>Loading...</p>";

      const clinicPath = clinic.replace(/\s+/g, '');
      const notesURL = `https://warangalonepoint.github.io/clinic-bot-system/clinics/${clinicPath}/Notes.csv`;
      const logsURL = `https://warangalonepoint.github.io/clinic-bot-system/clinics/${clinicPath}/logs.csv`;

      try {
        const [notesRes, logsRes] = await Promise.all([
          fetch(notesURL),
          fetch(logsURL)
        ]);

        const notesCSV = await notesRes.text();
        const logsCSV = await logsRes.text();

        const notesRows = notesCSV.trim().split("\n").slice(1).map(r => r.split(","));
        const logsRows = logsCSV.trim().split("\n").slice(1).map(r => r.split(","));

        const bookedTimes = logsRows
          .filter(r => r[1] === date)
          .map(r => r[2]);

        const available = notesRows.filter(([d, t, s]) =>
          d === date && s === "Available" && !bookedTimes.includes(t)
        );

        if (available.length === 0) {
          slotDiv.innerHTML = "<p>No slots available.</p>";
          return;
        }

        slotDiv.innerHTML = available.map(([_, t]) =>
          `<button onclick="selectSlot('${t}')" class="slot-btn">${t}</button>`
        ).join("");

      } catch (e) {
        slotDiv.innerHTML = "<p>Error loading slots.</p>";
      }
    }

    function selectSlot(time) {
      selectedTime = time;
      document.querySelector("#selectedTime").innerText = time;
      document.querySelector("#confirmForm").style.display = "block";
    }

    function submitBooking() {
      const name = document.querySelector("#patientName").value;
      const reason = document.querySelector("#reason").value;
      const clinic = document.querySelector("#clinic").value;
      const date = document.querySelector("#date").value;

      if (!name || !reason || !selectedTime) {
        alert("Please fill all fields.");
        return;
      }

      const log = `${clinic},${date},${selectedTime},${name},${reason}`;
      latestLogLine = log;
      document.querySelector("#logLine").innerText = log;

      const logURL = `https://wa.me/919390664577?text=Hi,%20I%20want%20to%20book%20a%20slot%20on%20${date}%20at%20${selectedTime}%20for%20${name}.%20Reason:%20${reason}`;
      window.open(logURL, "_blank");
    }

    function copyLogLine() {
      navigator.clipboard.writeText(latestLogLine).then(() => {
        alert("Log line copied to clipboard! Paste into logs.csv");
      });
    }
  </script></body>
</html>
