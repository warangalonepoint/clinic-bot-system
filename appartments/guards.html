<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Guards — Onestop Apts</title>
<link rel="stylesheet" href="styles.css">
</head><body>
<div class="wrap">
  <div class="hero space">
    <div>
      <span class="pill">Guards</span>
      <h1>Attendance & Visitors</h1>
      <div class="sub">Mark attendance, check-in/out visitors</div>
    </div>
    <a class="btn secondary" href="./index.html">← Back</a>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Attendance</h3>
    <div class="flex">
      <button id="inBtn" class="btn">Check In</button>
      <button id="outBtn" class="btn ghost">Check Out</button>
    </div>
    <div class="list" id="attList"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Visitor Check-in</h3>
    <div class="row">
      <div><label>Pass/Phone</label><input id="q" placeholder="Token or 10-digit"/></div>
      <div><label>&nbsp;</label><button id="findBtn" class="btn">Find</button></div>
    </div>
    <div id="vResult" class="list"></div>
  </div>
</div>
<div id="toast" class="toast"></div>

<script src="storage.js"></script>
<script>
function renderAttendance(){
  const list=_get(DB.guardAttendance).sort((a,b)=> (b.ts||'').localeCompare(a.ts||''));
  const box=document.getElementById('attList'); box.innerHTML='';
  if(!list.length){ box.innerHTML='<div class="meta">No records.</div>'; return; }
  list.forEach(r=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div><b>${r.type.toUpperCase()}</b></div><div class="meta">${new Date(r.ts).toLocaleString()}</div>`;
    box.appendChild(div);
  });
}
inBtn.onclick=()=>{ put(DB.guardAttendance,{id:crypto.randomUUID(),type:'in',ts:new Date().toISOString()}); renderAttendance(); toast('Checked in'); }
outBtn.onclick=()=>{ put(DB.guardAttendance,{id:crypto.randomUUID(),type:'out',ts:new Date().toISOString()}); renderAttendance(); toast('Checked out'); }

function searchVisitors(query){
  const list=_get(DB.visitors);
  const q=query.trim().toLowerCase();
  return list.filter(v=>{
    return (v.token||'').toLowerCase().includes(q) ||
           (v.phone||'').toLowerCase().includes(q) ||
           (v.visitor||'').toLowerCase().includes(q);
  });
}
findBtn.onclick=()=>{
  const res=searchVisitors(q.value);
  const box=vResult; box.innerHTML='';
  if(!res.length){ box.innerHTML='<div class="meta">No match.</div>'; return; }
  res.forEach(v=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div><b>${v.visitor}</b><div class="meta">${v.resident} • ${v.phone}</div>
    <div class="meta">Token: <span class="tok">${v.token||'-'}</span> • ${v.date} ${v.time||''}</div></div>
    <div class="flex"><button class="btn" data-in="${v.id}">Arrived</button>
    <button class="btn ghost" data-out="${v.id}">Left</button>
    <button class="btn danger" data-del="${v.id}">Delete</button></div>`;
    box.appendChild(div);
  });
};
vResult.addEventListener('click',(e)=>{
  const id=e.target.getAttribute('data-in')||e.target.getAttribute('data-out')||e.target.getAttribute('data-del');
  if(!id) return;
  const list=_get(DB.visitors);
  const v=list.find(x=>x.id===id); if(!v) return;
  if(e.target.hasAttribute('data-in')) v.status='in';
  if(e.target.hasAttribute('data-out')) v.status='out';
  if(e.target.hasAttribute('data-del')) { del(DB.visitors, x=>x.id===id); toast('Deleted'); findBtn.click(); return; }
  _set(DB.visitors, list); toast('Updated'); findBtn.click();
});
renderAttendance();
</script>
</body></html>
