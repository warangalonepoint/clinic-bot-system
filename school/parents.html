<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Parents</title>
<link rel="stylesheet" href="styles.css"/>
<style>
  .note{padding:10px;margin:10px 0;border:1px solid #2a344a;border-radius:10px;background:#101623;color:#cbd5e1}
  .muted{opacity:.7}
  .card{background:#121826;border:1px solid #232a3a;border-radius:14px;padding:12px;margin:8px 0}
  .row{display:flex;justify-content:space-between;gap:12px;align-items:center}
</style>
</head>
<body class="dark">
<div class="wrapper">

  <section class="accent-indigo">
    <div class="glass header">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="eyebrow">Read-only updates</div>
          <div class="h1">Parent Dashboard</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" onclick="toggleTheme()">Theme</button>
          <button class="btn" onclick="resetApp()">Reset</button>
          <button class="btn" onclick="clearCache()">Clear Cache</button>
        </div>
      </div>
      <div class="tab-row" id="tabs">
        <button class="chip chip-blue" data-tab="diary">Diary</button>
        <button class="chip chip-teal" data-tab="homework">Homework</button>
        <button class="chip chip-fuchsia" data-tab="announcements">Announcements</button>
        <button class="chip chip-violet" data-tab="events">Events</button>
      </div>
    </div>
  </section>

  <section id="panel-diary" class="glass inner panel">
    <div class="h1">Class Diary</div>
    <div id="diaryList" class="mt-12"><div class="note">Loading…</div></div>
  </section>

  <section id="panel-homework" class="glass inner panel" hidden>
    <div class="h1">Homework</div>
    <div id="hwList" class="mt-12"><div class="note">Loading…</div></div>
  </section>

  <section id="panel-announcements" class="glass inner panel" hidden>
    <div class="h1">Announcements</div>
    <div id="annList" class="mt-12"><div class="note">Loading…</div></div>
  </section>

  <section id="panel-events" class="glass inner panel" hidden>
    <div class="h1">Events</div>
    <div id="evList" class="mt-12"><div class="note">Loading…</div></div>
  </section>

</div>

<script type="module">
  import {initTabs} from './ui.js';
  initTabs(document);
</script>

<script type="module">
  import { sb } from "./js/supabase.js";

  // Clear cache + reset
  window.clearCache = async function(){ try{ localStorage.clear(); if('caches'in window){const n=await caches.keys(); await Promise.all(n.map(x=>caches.delete(x)));} if('serviceWorker'in navigator){const r=await navigator.serviceWorker.getRegistrations(); for(const rr of r) await rr.unregister();} alert('✅ Cache cleared'); }catch(e){ alert('❌ '+e.message);} location.reload(true); };
  window.resetApp = function(){ try{ localStorage.removeItem('coord_scope'); localStorage.removeItem('admin_scope'); }catch{} location.href='index.html?t='+Date.now(); };

  async function loadDiary(){
    const { data, error } = await sb.from("diary").select("*").order("date",{ascending:false}).limit(20);
    const el = document.getElementById("diaryList");
    if (error) { el.innerHTML = `<div class="note">Error loading diary</div>`; return; }
    if (!data.length) { el.innerHTML = `<div class="note">No diary entries yet.</div>`; return; }
    el.innerHTML = data.map(d=>`
      <div class="card">
        <div class="row"><b>${d.subject}</b><span class="muted">${d.date}</span></div>
        <div>${d.note||''}</div>
      </div>`).join("");
  }

  async function loadHomework(){
    const { data, error } = await sb.from("homework").select("*").order("due_date",{ascending:true}).limit(20);
    const el = document.getElementById("hwList");
    if (error) { el.innerHTML = `<div class="note">Error loading homework</div>`; return; }
    if (!data.length) { el.innerHTML = `<div class="note">No homework found.</div>`; return; }
    el.innerHTML = data.map(h=>`
      <div class="card">
        <div class="row"><b>${h.subject}</b><span class="muted">${h.due_date||''}</span></div>
        <div>${h.task||''}</div>
      </div>`).join("");
  }

  async function loadAnnouncements(){
    const { data, error } = await sb.from("announcements").select("*").order("created_at",{ascending:false}).limit(20);
    const el = document.getElementById("annList");
    if (error) { el.innerHTML = `<div class="note">Error loading announcements</div>`; return; }
    if (!data.length) { el.innerHTML = `<div class="note">No announcements yet.</div>`; return; }
    el.innerHTML = data.map(a=>`
      <div class="card">
        <div class="row"><b>Announcement</b><span class="muted">${new Date(a.created_at).toLocaleString()}</span></div>
        <div>${a.body}</div>
      </div>`).join("");
  }

  async function loadEvents(){
    const { data, error } = await sb.from("events").select("*").order("event_date",{ascending:true}).limit(20);
    const el = document.getElementById("evList");
    if (error) { el.innerHTML = `<div class="note">Error loading events</div>`; return; }
    if (!data.length) { el.innerHTML = `<div class="note">No events yet.</div>`; return; }
    el.innerHTML = data.map(ev=>`
      <div class="card">
        <div class="row"><b>${ev.title}</b><span class="muted">${ev.event_date||''}</span></div>
      </div>`).join("");
  }

  loadDiary(); loadHomework(); loadAnnouncements(); loadEvents();

  sb.channel("parent-rt")
    .on("postgres_changes",{event:"*",schema:"public",table:"diary"},loadDiary)
    .on("postgres_changes",{event:"*",schema:"public",table:"homework"},loadHomework)
    .on("postgres_changes",{event:"*",schema:"public",table:"announcements"},loadAnnouncements)
    .on("postgres_changes",{event:"*",schema:"public",table:"events"},loadEvents)
    .subscribe();
</script>

<script type="module" src="ui.js"></script>
</body>
</html>
