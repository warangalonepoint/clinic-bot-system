<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manual Booking</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <img src="assets/banner.png" alt="Banner" class="banner" />
    <div class="clinic-title">Manual Patient Booking</div>

    <form id="bookingForm" class="form">
      <label>Select Date:</label>
      <select id="dateDropdown" required></select>

      <label>Select Time Slot:</label>
      <select id="slotDropdown" required></select>

      <label>Patient Name:</label>
      <input type="text" id="name" placeholder="Enter name" required />

      <label>Reason:</label>
      <input type="text" id="reason" placeholder="Enter reason" required />

      <label>Contact:</label>
      <input type="tel" id="contact" placeholder="Enter phone number" required />

      <button type="submit" class="btn">Confirm Booking</button>
    </form>

    <p style="text-align:center; margin-top: 20px;">Powered by Onestop AI</p>
  </div>

  <script>
    const airtableApiKey = 'YOUR_API_KEY'; // Replace later
    const baseId = 'appgPT8WiqnZlR44Y';
    const availableTable = 'AvailableSlots';
    const logsTable = 'BookingsLogs';

    async function loadSlots() {
      const dateDropdown = document.getElementById('dateDropdown');
      const slotDropdown = document.getElementById('slotDropdown');
      dateDropdown.innerHTML = '';
      slotDropdown.innerHTML = '';

      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${availableTable}`, {
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      const data = await res.json();

      const grouped = {};
      data.records.forEach(record => {
        const date = record.fields['Date'];
        const time = record.fields['Time Slot'];
        const status = record.fields['Status'];
        if (status === 'Available') {
          if (!grouped[date]) grouped[date] = [];
          grouped[date].push(time);
        }
      });

      Object.keys(grouped).forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        dateDropdown.appendChild(option);
      });

      dateDropdown.addEventListener('change', () => {
        slotDropdown.innerHTML = '';
        const selectedDate = dateDropdown.value;
        if (grouped[selectedDate]) {
          grouped[selectedDate].forEach(slot => {
            const opt = document.createElement('option');
            opt.value = slot;
            opt.textContent = slot;
            slotDropdown.appendChild(opt);
          });
        }
      });

      dateDropdown.dispatchEvent(new Event('change'));
    }

    document.getElementById('bookingForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const reason = document.getElementById('reason').value;
      const contact = document.getElementById('contact').value;
      const date = document.getElementById('dateDropdown').value;
      const slot = document.getElementById('slotDropdown').value;

      // 1. Save to BookingsLogs
      await fetch(`https://api.airtable.com/v0/${baseId}/${logsTable}`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fields: {
            Timestamp: new Date().toLocaleString(),
            "Patient Name": name,
            "Slot Time": `${date} ${slot}`,
            Reason: reason,
            Contact: contact,
            Token: "",
            "Reminder Sent": ""
          }
        })
      });

      // 2. Mark Slot as Booked
      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${availableTable}?filterByFormula=AND({Date}='${date}',{Time Slot}='${slot}')`, {
        headers: { Authorization: `Bearer ${airtableApiKey}` }
      });
      const data = await res.json();
      const recordId = data.records[0]?.id;
      if (recordId) {
        await fetch(`https://api.airtable.com/v0/${baseId}/${availableTable}/${recordId}`, {
          method: 'PATCH',
          headers: {
            Authorization: `Bearer ${airtableApiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ fields: { Status: 'Booked' } })
        });
      }

      alert('Booking confirmed!');
      window.location.href = 'index.html';
    });

    loadSlots();
  </script>
</body>
</html>
