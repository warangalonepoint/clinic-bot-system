<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hall Booking</title>
<style>
:root{color-scheme:dark}
body{margin:0;font-family:system-ui,Inter,Arial;background:#0f1115;color:#e8eaed}
.wrap{max-width:980px;margin:24px auto;padding:16px}
.bar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.btn{background:#2563eb;border:0;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
.ghost{background:#11141a;border:1px solid #1f2432}
.danger{background:#ef4444}
.pill{display:inline-flex;align-items:center;background:#0f1218;border:1px solid #262b38;padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
.card{background:#171a21;border:1px solid #222736;border-radius:18px;padding:18px;margin-top:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.input, select, textarea{padding:12px;border-radius:12px;border:1px solid #262b38;background:#0f1218;color:#e8eaed}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{padding:10px 12px;text-align:left}
tr{background:#11141a;border:1px solid #1f2432}
tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
.badge{background:#0f1218;border:1px solid #262b38;border-radius:999px;padding:3px 8px;font-size:12px}
.ok{color:#86efac}.warn{color:#fde68a}.err{color:#fca5a5}
footer{opacity:.7;font-size:13px;margin:18px 0;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <h2 style="margin:0">üèõÔ∏è <span data-i18n="book_halls">Book Halls</span></h2>
    <div class="row">
      <span id="lang-pill" class="pill" onclick="setLang(getLang()==='te'?'en':'te')">English ‚òÄÔ∏è</span>
      <button class="btn ghost" onclick="history.back()" data-i18n="home">Home</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label>Hall
        <select id="hall" class="input">
          <option>Hall A</option>
          <option>Hall B</option>
          <option>Community Lawn</option>
        </select>
      </label>
      <label>Date
        <input id="date" class="input" type="date">
      </label>
      <label>Start
        <input id="start" class="input" type="time">
      </label>
      <label>End
        <input id="end" class="input" type="time">
      </label>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="name" class="input" style="min-width:220px" placeholder="Your Name">
      <input id="phone" class="input" style="min-width:180px" placeholder="Phone">
      <input id="purpose" class="input" style="flex:1" placeholder="Purpose (e.g., Thread Ceremony)">
    </div>
    <p id="clashNote" class="warn" style="display:none;margin:10px 0">Slot clashes with an existing booking.</p>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="checkBtn">Check Availability</button>
      <button class="btn" id="submitBtn">Request Booking</button>
      <button class="btn ghost" id="exportBtn">Export CSV</button>
      <button class="btn danger" id="resetMine" title="Remove only your pending local entries">Clear My Pending</button>
    </div>
  </div>

  <div class="card">
    <b>My Requests</b>
    <table class="table"><thead>
      <tr><th>Date</th><th>Hall</th><th>Time</th><th>Purpose</th><th>Status</th></tr>
    </thead><tbody id="mine"></tbody></table>
  </div>

  <div class="card">
    <b>All Bookings (read-only)</b>
    <table class="table"><thead>
      <tr><th>Date</th><th>Hall</th><th>Time</th><th>Name</th><th>Phone</th><th>Purpose</th><th>Status</th></tr>
    </thead><tbody id="all"></tbody></table>
  </div>

  <footer>¬© Padmashali Community ‚Äî V1</footer>
</div>

<script src="i18n.js"></script>
<script>
  // guard: any logged-in role can use this page
  const s = JSON.parse(localStorage.getItem("pc_session")||"null");
  if(!s){ location.href='index.html'; }

  const LSKEY='pc_hall_bookings';
  const uidKey='pc_uid';
  if(!localStorage.getItem(uidKey)) localStorage.setItem(uidKey, 'U'+Math.random().toString(36).slice(2,10));
  const UID = localStorage.getItem(uidKey);

  const hall=document.getElementById('hall');
  const date=document.getElementById('date');
  const start=document.getElementById('start');
  const end=document.getElementById('end');
  const name=document.getElementById('name');
  const phone=document.getElementById('phone');
  const purpose=document.getElementById('purpose');
  const clashNote=document.getElementById('clashNote');

  // default date = today
  date.valueAsDate = new Date();

  function getAll(){ return JSON.parse(localStorage.getItem(LSKEY)||'[]'); }
  function setAll(arr){ localStorage.setItem(LSKEY, JSON.stringify(arr)); }
  function fmtTime(a,b){ return `${a}‚Äì${b}`; }
  function overlap(a1,b1,a2,b2){ return a1<b2 && a2<b1; } // half-open
  function toMin(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }

  function hasClash(list, hallV, dateV, sV, eV){
    const sMin=toMin(sV), eMin=toMin(eV);
    return list.some(x=> x.hall===hallV && x.date===dateV && overlap(sMin,eMin,toMin(x.start),toMin(x.end)) && x.status!=='Rejected');
  }

  function render(){
    const list=getAll();
    // my requests
    const mine=list.filter(x=>x.uid===UID).sort((a,b)=>a.date.localeCompare(b.date)||a.start.localeCompare(b.start));
    const mT=document.getElementById('mine'); mT.innerHTML='';
    mine.forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${x.date}</td><td>${x.hall}</td><td>${fmtTime(x.start,x.end)}</td><td>${x.purpose}</td>
                    <td><span class="badge ${x.status==='Approved'?'ok':x.status==='Pending'?'warn':'err'}">${x.status}</span></td>`;
      mT.appendChild(tr);
    });
    // all
    const allT=document.getElementById('all'); allT.innerHTML='';
    list.sort((a,b)=>a.date.localeCompare(b.date)||a.hall.localeCompare(b.hall)||a.start.localeCompare(b.start))
        .forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${x.date}</td><td>${x.hall}</td><td>${fmtTime(x.start,x.end)}</td>
                    <td>${x.name}</td><td>${x.phone}</td><td>${x.purpose}</td>
                    <td><span class="badge ${x.status==='Approved'?'ok':x.status==='Pending'?'warn':'err'}">${x.status}</span></td>`;
      allT.appendChild(tr);
    });
  }

  document.getElementById('checkBtn').onclick = ()=>{
    const list=getAll();
    const clash = hasClash(list, hall.value, date.value, start.value, end.value);
    clashNote.style.display = clash ? 'block':'none';
    if(!clash) alert('Available ‚úÖ');
  };

  document.getElementById('submitBtn').onclick = ()=>{
    if(!name.value||!phone.value||!purpose.value||!date.value||!start.value||!end.value){
      alert('Fill all fields'); return;
    }
    const list=getAll();
    if(hasClash(list, hall.value, date.value, start.value, end.value)){
      alert('Slot clashes. Pick a different time.'); return;
    }
    list.push({
      id:'B'+Date.now().toString(36),
      uid:UID,
      role:s.role,
      hall:hall.value,
      date:date.value,
      start:start.value,
      end:end.value,
      name:name.value.trim(),
      phone:phone.value.trim(),
      purpose:purpose.value.trim(),
      status:'Pending', // committee/admin will flip this in approvals page
      ts:Date.now()
    });
    setAll(list);
    alert('Request submitted. Status: Pending.');
    render();
  };

  document.getElementById('exportBtn').onclick=()=>{
    const data=getAll();
    const rows=[["ID","Date","Hall","Start","End","Name","Phone","Purpose","Status"],
      ...data.map(x=>[x.id,x.date,x.hall,x.start,x.end,x.name,x.phone,x.purpose,x.status])];
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='hall_bookings.csv'; a.click(); URL.revokeObjectURL(url);
  };

  document.getElementById('resetMine').onclick=()=>{
    const all=getAll().filter(x=>x.uid!==UID || x.status!=='Pending');
    setAll(all); render();
  };

  applyI18n();
  render();
</script>
</body></html>
