<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Manual Patient Booking — Local</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f1222; --muted:#6b7280; --brand:#111; --radius:18px; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:720px;margin:24px auto;padding:16px}
    .hero{background:#eaf4f6;border-radius:22px;padding:16px}
    .title{font-weight:800;font-size:28px;margin:18px 0 6px}
    .muted{color:var(--muted);font-size:14px;margin:6px 0 14px}
    .card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 10px 25px rgba(10,12,33,.06)}
    label{display:block;font-weight:700;margin:14px 0 6px}
    input,select,button{
      width:100%;padding:14px 14px;border:1px solid #e5e7eb;border-radius:14px;
      font-size:16px;background:#fff;outline:none
    }
    input:focus,select:focus{border-color:#111; box-shadow:0 0 0 3px rgba(17,17,17,.08)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .cta{margin-top:18px;background:#000;color:#fff;border:none;font-weight:800;cursor:pointer}
    .cta:disabled{opacity:.55;cursor:not-allowed}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;
           padding:12px 16px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.2);display:none}
    a.link{color:#6c3ad6;text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero"><img src="./assets/banner.png" alt="" style="width:100%;border-radius:16px"/></div>
    <div class="title">Manual Patient Booking</div>
    <p class="muted">Local demo — booked slots (this device) are hidden automatically.</p>

    <div class="card">
      <label for="name">Patient Name</label>
      <input id="name" placeholder="Enter full name" autocomplete="name"/>

      <label for="reason">Reason</label>
      <input id="reason" placeholder="e.g., Fever, Check-up"/>

      <label for="contact">Contact Number</label>
      <input id="contact" placeholder="10-digit number" inputmode="numeric" maxlength="10"/>

      <div class="row">
        <div>
          <label for="dateSelect">Select Date</label>
          <select id="dateSelect"><option>Loading dates…</option></select>
        </div>
        <div>
          <label for="slotSelect">Select Time Slot</label>
          <select id="slotSelect" disabled><option>Select a date first</option></select>
        </div>
      </div>

      <button id="confirmBtn" class="cta" disabled>Confirm Booking</button>
      <p class="muted" style="margin-top:10px">
        Admin view: <a class="link" href="./local-bookings.html">Local bookings →</a>
      </p>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- Config (local mode) ----------
    const LS_KEY = 'localBookings'; // <- matches local-bookings.html
    const SLOT_TIMES = [
      '10:00 AM','10:10 AM','10:20 AM','10:30 AM','10:40 AM','10:50 AM',
      '11:00 AM','11:10 AM','11:20 AM','11:30 AM','11:40 AM','11:50 AM'
    ];
    const DAYS_AHEAD = 7; // today + next 6 days

    // ---------- Utils ----------
    const $ = q => document.querySelector(q);
    const toast = (msg, ms=1600)=>{
      const el = $('#toast');
      el.textContent = msg; el.style.display='block';
      clearTimeout(window.__t); window.__t = setTimeout(()=> el.style.display='none', ms);
    };
    const toISO = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const pretty = iso => {
      const [y,m,d]=iso.split('-').map(Number);
      return new Date(y, m-1, d).toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});
    };

    function readAll(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }
      catch { return []; }
    }
    function writeAll(rows){ localStorage.setItem(LS_KEY, JSON.stringify(rows)); }

    // ---------- DOM refs ----------
    const nameEl = $('#name');
    const reasonEl = $('#reason');
    const contactEl = $('#contact');
    const dateEl = $('#dateSelect');
    const slotEl = $('#slotSelect');
    const btn = $('#confirmBtn');

    // ---------- Init ----------
    initDates();
    dateEl.addEventListener('change', refreshSlots);
    [nameEl, reasonEl, contactEl, slotEl].forEach(el => el.addEventListener('input', validate));
    btn.addEventListener('click', confirmBooking);

    function initDates(){
      const today = new Date();
      dateEl.innerHTML = '';
      for(let i=0;i<DAYS_AHEAD;i++){
        const d = new Date(today);
        d.setDate(today.getDate()+i);
        const iso = toISO(d);
        const opt = new Option(pretty(iso), iso);
        dateEl.add(opt);
      }
      refreshSlots();
    }

    function refreshSlots(){
      const iso = dateEl.value;
      const taken = new Set(readAll().filter(b => b.date === iso).map(b => b.slot));
      slotEl.innerHTML = '';
      let count = 0;
      for(const t of SLOT_TIMES){
        if(!taken.has(t)){
          slotEl.add(new Option(t, t));
          count++;
        }
      }
      if(count === 0){
        slotEl.add(new Option('No slots available', ''));
        slotEl.disabled = true;
      } else {
        slotEl.disabled = false;
      }
      validate();
    }

    function validate(){
      const ok =
        nameEl.value.trim().length >= 2 &&
        contactEl.value.trim().match(/^\d{10}$/) &&
        !!dateEl.value &&
        !!slotEl.value;
      btn.disabled = !ok;
    }

    function nextTokenForDate(iso){
      const sameDay = readAll().filter(b => b.date === iso);
      return sameDay.length + 1;
    }

    function confirmBooking(){
      const rec = {
        date: dateEl.value,
        slot: slotEl.value,
        name: nameEl.value.trim(),
        reason: reasonEl.value.trim(),
        contact: contactEl.value.trim(),
        token: nextTokenForDate(dateEl.value)
      };

      // double-check slot is still free
      const rows = readAll();
      if(rows.some(r => r.date === rec.date && r.slot === rec.slot)){
        toast('That slot just got booked. Pick another.'); refreshSlots(); return;
      }

      rows.push(rec);
      writeAll(rows);

      alert(
        `Booking confirmed!\n\n`+
        `Date: ${pretty(rec.date)}\n`+
        `Slot: ${rec.slot}\n`+
        `Token: ${rec.token}\n\n`+
        `(Saved locally on this device)`
      );

      // reset + refresh
      nameEl.value = '';
      reasonEl.value = '';
      contactEl.value = '';
      refreshSlots();
      validate();
    }
  </script>
</body>
</html>
