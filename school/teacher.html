<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Teacher · School PWA</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    /* harden tab visibility in case styles.css didn’t load yet */
    .panel{display:none}
    .panel.active{display:block}
  </style>
</head>
<body class="dark">
  <div class="wrapper">

    <!-- Header -->
    <section class="accent-indigo">
      <div class="glass header">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div>
            <div class="eyebrow">Post diary & homework · mark attendance</div>
            <div class="h1">Teacher</div>
          </div>
          <div class="row gap-8">
            <a class="chip chip-slate" href="index.html">PIN</a>
            <button id="themeToggle" class="chip chip-blue">Theme</button>
          </div>
        </div>

        <!-- Tabs -->
        <div id="teacher-tabs" class="tabs mt-12">
          <button class="chip chip-indigo tab" data-target="#panel-setup" aria-selected="true">Class Setup</button>
          <button class="chip chip-blue tab" data-target="#panel-diary">Class Diary</button>
          <button class="chip chip-teal tab" data-target="#panel-homework">Homework</button>
          <button class="chip chip-orange tab" data-target="#panel-attendance">Attendance</button>
        </div>
      </div>
    </section>

    <!-- Class Setup -->
    <section class="accent-slate">
      <div id="panel-setup" class="glass panel active">
        <div class="h2">My Class</div>
        <div class="grid mt-12">
          <input id="t-class" class="input" placeholder="Class e.g., 5"/>
          <input id="t-section" class="input" placeholder="Section e.g., A"/>
          <input id="t-name" class="input" placeholder="Your Name"/>
          <input id="t-subject" class="input" placeholder="Subject e.g., Maths"/>
        </div>
        <div class="row mt-12">
          <button id="saveMeta" class="btn btn-teal">Save</button>
        </div>
      </div>
    </section>

    <!-- Class Diary -->
    <section class="accent-blue">
      <div id="panel-diary" class="glass panel">
        <div class="h2">Post to Class Diary</div>
        <div class="grid mt-12">
          <select id="d-subject" class="input">
            <option value="" disabled selected>Subject</option>
          </select>
          <textarea id="d-message" class="input" rows="4" placeholder="What was taught / notes..."></textarea>
          <input id="d-link" class="input" placeholder="Optional Link (https://…)"/>
        </div>
        <div class="row mt-12">
          <button id="publishDiary" class="btn">Publish</button>
        </div>

        <div class="h3 mt-20">Recent</div>
        <div id="diaryList" class="list mt-8 text-dim">No entries.</div>
      </div>
    </section>

    <!-- Homework -->
    <section class="accent-teal">
      <div id="panel-homework" class="glass panel">
        <div class="h2">Create Homework</div>
        <div class="grid mt-12">
          <input id="h-due" class="input" type="date" />
          <select id="h-subject" class="input">
            <option value="" disabled selected>Subject</option>
          </select>
          <input id="h-title" class="input" placeholder="Title e.g., Exercise 5A"/>
          <textarea id="h-details" class="input" rows="4" placeholder="Details…"></textarea>
        </div>
        <div class="row mt-12">
          <button id="publishHomework" class="btn btn-indigo">Publish</button>
        </div>

        <div class="h3 mt-20">Recent</div>
        <div id="hwList" class="list mt-8 text-dim">No entries.</div>
      </div>
    </section>

    <!-- Attendance -->
    <section class="accent-orange">
      <div id="panel-attendance" class="glass panel">
        <div class="h2">Mark Attendance</div>
        <div class="eyebrow mt-4" id="attScope"></div>
        <div class="grid mt-12">
          <input id="att-date" class="input" type="date"/>
          <input id="att-count" class="input" inputmode="numeric" placeholder="Present count (optional)"/>
        </div>
        <div class="row mt-12">
          <button id="saveAttendance" class="btn btn-orange">Save Attendance</button>
        </div>

        <div class="h3 mt-20">Recent</div>
        <div id="attList" class="list mt-8 text-dim">No entries.</div>
      </div>
    </section>

  </div>

  <!-- Shared (ok if present) -->
  <script type="module" src="ui.js"></script>

  <!-- Page logic -->
  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const todayISO = () => new Date().toISOString().slice(0,10);
    const toast = (m)=>alert(m);

    /* --------- THEME (defensive) --------- */
    (function themeInit(){
      const btn = document.getElementById('themeToggle');
      const apply = t => document.body.className = (t==='light'?'light':'dark');
      apply(localStorage.getItem('theme') || 'dark');
      if(btn){ btn.addEventListener('click', ()=> {
        const next = localStorage.getItem('theme')==='light'?'dark':'light';
        localStorage.setItem('theme', next); apply(next);
      });}
    })();

    /* --------- TABS (robust, page-local) --------- */
    (function teacherTabs(){
      const scope = document.getElementById('teacher-tabs');
      if(!scope) return;
      const tabs = Array.from(scope.querySelectorAll('.tab'));
      const panels = Array.from(document.querySelectorAll('.panel'));
      function activate(id){
        panels.forEach(p => p.classList.toggle('active', '#'+p.id === id));
        tabs.forEach(t => t.setAttribute('aria-selected', t.dataset.target === id ? 'true':'false'));
        localStorage.setItem('teacherTab', id);
        // optional: reflect in hash
        if(location.hash !== id) history.replaceState(null,'',id);
      }
      tabs.forEach(t => t.addEventListener('click', () => activate(t.dataset.target)));
      // initial: hash > saved > first
      const first = tabs[0]?.dataset.target || '#panel-setup';
      const start = location.hash || localStorage.getItem('teacherTab') || first;
      activate(start);
    })();

    /* --------- STORAGE KEYS --------- */
    const K = {
      META: 'teacherMeta',
      DIARY: 'classDiary',
      HOMEWORK: 'homework',
      ATT: 'attendance'
    };

    /* --------- CLASS META --------- */
    const metaInputs = {
      cls: $('#t-class'),
      sec: $('#t-section'),
      name: $('#t-name'),
      subj: $('#t-subject')
    };

    function loadMeta(){
      try{
        const m = JSON.parse(localStorage.getItem(K.META) || '{}');
        if(m.cls) metaInputs.cls.value = m.cls;
        if(m.sec) metaInputs.sec.value = m.sec;
        if(m.name) metaInputs.name.value = m.name;
        if(m.subj) metaInputs.subj.value = m.subj;

        // Populate subject selects with saved subject (kept minimal for demo)
        const subs = Array.from(new Set([m.subj].filter(Boolean)));
        const seed = (sel)=> {
          sel.innerHTML = '<option value="" disabled selected>Subject</option>';
          subs.forEach(s=>{
            const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o);
          });
        };
        seed($('#d-subject')); seed($('#h-subject'));
        $('#attScope').textContent = (m.cls&&m.sec) ? `Class ${m.cls} • Section ${m.sec}` : '';
      }catch(e){}
    }
    loadMeta();

    $('#saveMeta').addEventListener('click', ()=>{
      const m = {
        cls: metaInputs.cls.value.trim(),
        sec: metaInputs.sec.value.trim(),
        name: metaInputs.name.value.trim(),
        subj: metaInputs.subj.value.trim()
      };
      if(!m.cls || !m.sec || !m.name || !m.subj){ toast('Please fill class, section, your name and subject.'); return; }
      localStorage.setItem(K.META, JSON.stringify(m));
      loadMeta();
      toast('Saved class meta.');
    });

    /* --------- DIARY --------- */
    const renderDiary = ()=>{
      const list = $('#diaryList');
      const meta = JSON.parse(localStorage.getItem(K.META) || '{}');
      const all = JSON.parse(localStorage.getItem(K.DIARY) || '[]')
         .filter(x=>x.cls===meta.cls && x.sec===meta.sec)
         .sort((a,b)=>(b.date||'').localeCompare(a.date));
      if(!all.length){ list.textContent='No entries.'; return; }
      list.innerHTML = all.map(x =>
        `<div class="row card-row">
           <div><b>${x.subject}</b> · ${x.date}<br>${x.message}${x.link?` — <a href="${x.link}" target="_blank">link</a>`:''}</div>
         </div>`).join('');
    };

    $('#publishDiary').addEventListener('click', ()=>{
      const m = JSON.parse(localStorage.getItem(K.META) || '{}');
      const subject = $('#d-subject').value || m.subj || '';
      const message = $('#d-message').value.trim();
      const link = $('#d-link').value.trim();
      if(!m.cls || !m.sec){ toast('Save class meta first.'); return; }
      if(!subject || !message){ toast('Subject and message are required.'); return; }
      const entry = { cls:m.cls, sec:m.sec, subject, message, link, date:new Date().toISOString().slice(0,10), teacher:m.name||'', ts:Date.now() };
      const all = JSON.parse(localStorage.getItem(K.DIARY) || '[]'); all.push(entry);
      localStorage.setItem(K.DIARY, JSON.stringify(all));
      $('#d-message').value=''; $('#d-link').value='';
      renderDiary(); toast('Diary posted.');
    });

    /* --------- HOMEWORK --------- */
    const renderHW = ()=>{
      const list = $('#hwList');
      const meta = JSON.parse(localStorage.getItem(K.META) || '{}');
      const all = JSON.parse(localStorage.getItem(K.HOMEWORK) || '[]')
         .filter(x=>x.cls===meta.cls && x.sec===meta.sec)
         .sort((a,b)=>(a.due||'').localeCompare(b.due));
      if(!all.length){ list.textContent='No entries.'; return; }
      list.innerHTML = all.map(x =>
        `<div class="row card-row">
           <div><b>${x.subject}</b> · Due ${x.due}<br>${x.title}${x.details?` — ${x.details}`:''}</div>
         </div>`).join('');
    };

    $('#publishHomework').addEventListener('click', ()=>{
      const m = JSON.parse(localStorage.getItem(K.META) || '{}');
      if(!m.cls || !m.sec){ toast('Save class meta first.'); return; }
      const due = $('#h-due').value || todayISO();
      const subject = $('#h-subject').value || m.subj || '';
      const title = $('#h-title').value.trim();
      const details = $('#h-details').value.trim();
      if(!subject || !title){ toast('Subject and title are required.'); return; }
      const item = { cls:m.cls, sec:m.sec, subject, title, details, due, ts:Date.now() };
      const all = JSON.parse(localStorage.getItem(K.HOMEWORK) || '[]'); all.push(item);
      localStorage.setItem(K.HOMEWORK, JSON.stringify(all));
      $('#h-title').value=''; $('#h-details').value='';
      renderHW(); toast('Homework published.');
    });

    /* --------- ATTENDANCE --------- */
    $('#att-date').value = todayISO();

    const renderAtt = ()=>{
      const list = $('#attList');
      const meta = JSON.parse(localStorage.getItem(K.META) || '{}');
      const all = JSON.parse(localStorage.getItem(K.ATT) || '[]')
         .filter(x=>x.cls===meta.cls && x.sec===meta.sec)
         .sort((a,b)=>(b.date||'').localeCompare(a.date));
      if(!all.length){ list.textContent='No entries.'; return; }
      list.innerHTML = all.map(x =>
        `<div class="row card-row"><div><b>${x.date}</b> · Present: ${x.present ?? '—'}</div></div>`
      ).join('');
    };

    $('#saveAttendance').addEventListener('click', ()=>{
      const m = JSON.parse(localStorage.getItem(K.META) || '{}');
      if(!m.cls || !m.sec){ toast('Save class meta first.'); return; }
      const entry = { cls:m.cls, sec:m.sec, date:($('#att-date').value||todayISO()), present:($('#att-count').value?Number($('#att-count').value):null), ts:Date.now() };
      const all = JSON.parse(localStorage.getItem(K.ATT) || '[]');
      const i = all.findIndex(x=>x.cls===entry.cls && x.sec===entry.sec && x.date===entry.date);
      if(i>=0) all[i]=entry; else all.push(entry);
      localStorage.setItem(K.ATT, JSON.stringify(all));
      renderAtt(); toast('Attendance saved.');
    });

    // initial renders
    renderDiary(); renderHW(); renderAtt();
  })();
  </script>
</body>
</html>
