<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manual Patient Booking – v3 (Airtable)</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#f6f7f9;color:#111}
    .wrap{max-width:760px;margin:24px auto;padding:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 28px rgba(0,0,0,.08);padding:18px 18px 22px}
    h1{font-size:28px;margin:18px 0 6px}
    .sub{color:#666;margin:0 0 14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-1{grid-template-columns:1fr}
    label{font-size:14px;color:#333;margin:10px 0 6px;display:block}
    input,select,button{width:100%;padding:14px 12px;border:1px solid #dde1e6;border-radius:12px;font-size:16px;background:#fff}
    select:disabled, input:disabled{background:#f1f3f5;color:#8a8f98}
    button.primary{background:#000;color:#fff;border:none;font-weight:600}
    button.primary:disabled{opacity:.5}
    .hint{color:#6b7280;margin-top:10px}
    .hero{width:100%;border-radius:14px;object-fit:cover;margin-bottom:14px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.3);display:none;z-index:9}
    .badge{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
  </style>

  <!-- Force-load KEY file from the exact repo path; bump v when you change it -->
  <script src="/clinic-bot-system/Onestop-demo/config.js?v=7"></script>
  <script>
    // Tiny guard so we fail loudly if key didn't load
    if (!window.AIRTABLE_API_KEY) {
      console.error("AIRTABLE_API_KEY missing – check config.js path");
    }
  </script>
</head>
<body>
  <div class="wrap">
    <img class="hero" src="assets/banner.png" alt="Clinic" />
    <h1>Manual Patient Booking <span class="badge">v3 — Airtable</span></h1>
    <p class="sub">Booked slots are hidden automatically.</p>

    <div class="card">
      <div class="row row-1">
        <div>
          <label>Patient Name</label>
          <input id="name" placeholder="Enter full name" />
        </div>
      </div>

      <div class="row row-1">
        <div>
          <label>Contact Number</label>
          <input id="phone" placeholder="10-digit number" inputmode="numeric" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Select Date</label>
          <select id="dateSelect" disabled>
            <option>Loading dates...</option>
          </select>
        </div>
        <div>
          <label>Select Time Slot</label>
          <select id="slotSelect" disabled>
            <option>Select a date first</option>
          </select>
        </div>
      </div>

      <div style="margin-top:14px">
        <button id="confirmBtn" class="primary" disabled>Confirm Booking</button>
        <p class="hint">Booked slots will be hidden automatically.</p>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- Config (edit these if your base/table names differ) ----------
    const BASE_ID         = "appgIT8WiqnZlR44Y";
    const TABLE_SLOTS     = "AvailableSlots";
    const TABLE_BOOKINGS  = "BookingsLogs";

    // ---------- Airtable helpers ----------
    function atHeaders() {
      const key = (window && window.AIRTABLE_API_KEY) || "";
      return {
        Authorization: "Bearer " + key,
        "Content-Type": "application/json"
      };
    }
    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3000);
    }

    // ---------- State & elements ----------
    let allSlots = [];               // [{id, dateStr, timeStr, fields}]
    let slotsByDate = {};            // { '2025-08-08': [records...] }
    let selectedSlotRecord = null;

    const els = {
      name:        document.getElementById('name'),
      phone:       document.getElementById('phone'),
      dateSelect:  document.getElementById('dateSelect'),
      slotSelect:  document.getElementById('slotSelect'),
      confirmBtn:  document.getElementById('confirmBtn')
    };

    // ---------- Load AvailableSlots (Status = "Available") ----------
    async function loadAvailableSlots() {
      try {
        if (!window.AIRTABLE_API_KEY) {
          throw new Error("Missing API key: ensure config.js is reachable and defines window.AIRTABLE_API_KEY");
        }

        const url = new URL(`https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_SLOTS)}`);
        url.searchParams.set("filterByFormula", `Status='Available'`);
        url.searchParams.set("sort[0][field]", "Date");
        url.searchParams.set("sort[0][direction]", "asc");
        url.searchParams.set("sort[1][field]", "Time Slot");
        url.searchParams.set("sort[1][direction]", "asc");
        url.searchParams.set("pageSize", "100");

        const res = await fetch(url.toString(), { headers: atHeaders() });
        if (!res.ok) {
          const j = await res.json().catch(()=> ({}));
          throw new Error(`Airtable GET ${TABLE_SLOTS} failed: ${res.status} ${JSON.stringify(j)}`);
        }
        const data = await res.json();

        // Flatten + normalize
        allSlots = (data.records || []).map(r => {
          const f = r.fields || {};
          let dateStr;
          // If Airtable Date field is treated as string already (yyyy-mm-dd) keep it,
          // else convert to yyyy-mm-dd safely.
          try {
            const d = new Date(f.Date);
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const dd= String(d.getDate()).padStart(2,'0');
            dateStr = `${y}-${m}-${dd}`;
          } catch {
            dateStr = String(f.Date || "");
          }
          const timeStr = String(f["Time Slot"] || "").trim();
          return { id: r.id, fields: f, dateStr, timeStr };
        });

        // Group by date
        slotsByDate = {};
        for (const rec of allSlots) {
          if (!slotsByDate[rec.dateStr]) slotsByDate[rec.dateStr] = [];
          slotsByDate[rec.dateStr].push(rec);
        }

        // Populate dates
        const dates = Object.keys(slotsByDate).sort();
        els.dateSelect.innerHTML = "";
        if (dates.length === 0) {
          els.dateSelect.innerHTML = `<option>No available dates</option>`;
          els.dateSelect.disabled = true;
          els.slotSelect.innerHTML = `<option>No slots</option>`;
          els.slotSelect.disabled = true;
          return;
        }
        for (const d of dates) {
          const opt = new Option(d, d);
          els.dateSelect.add(opt);
        }
        els.dateSelect.disabled = false;
        onDateChange(); // fill initial slots

      } catch (err) {
        console.error(err);
        els.dateSelect.innerHTML = `<option>Error loading dates</option>`;
        els.dateSelect.disabled = true;
        els.slotSelect.innerHTML = `<option>Select a date first</option>`;
        els.slotSelect.disabled = true;
        showToast(err.message || "Error loading Airtable data");
      }
    }

    // ---------- When date changes, populate that day’s slots ----------
    function onDateChange() {
      const d = els.dateSelect.value;
      const list = slotsByDate[d] || [];
      els.slotSelect.innerHTML = "";
      if (list.length === 0) {
        els.slotSelect.innerHTML = `<option>No slots</option>`;
        els.slotSelect.disabled = true;
        selectedSlotRecord = null;
      } else {
        for (const rec of list) {
          const label = rec.timeStr || rec.fields["Time Slot"] || "(time)";
          const opt = new Option(label, rec.id);
          els.slotSelect.add(opt);
        }
        els.slotSelect.disabled = false;
        selectedSlotRecord = list[0];
      }
      validateForm();
    }

    // ---------- Select slot handler ----------
    function onSlotChange() {
      const id = els.slotSelect.value;
      selectedSlotRecord = allSlots.find(r => r.id === id) || null;
      validateForm();
    }

    // ---------- Simple validation ----------
    function validateForm() {
      const ok = !!(els.name.value.trim() && els.phone.value.trim() && selectedSlotRecord);
      els.confirmBtn.disabled = !ok;
    }

    // ---------- Confirm booking ----------
    async function confirmBooking() {
      try {
        const name  = els.name.value.trim();
        const phone = els.phone.value.trim();
        const rec   = selectedSlotRecord;
        if (!name || !phone || !rec) return;

        // 1) Create a booking
        const bookURL = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_BOOKINGS)}`;
        const payload = {
          records: [{
            fields: {
              "Timestamp": new Date().toISOString(),
              "Patient Name": name,
              "Slot Time": `${rec.dateStr} ${rec.timeStr}`,
              "Reason": "",               // optional field
              "Contact": phone
            }
          }]
        };
        let res = await fetch(bookURL, {
          method: "POST",
          headers: atHeaders(),
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const j = await res.json().catch(()=> ({}));
          throw new Error(`Create booking failed: ${res.status} ${JSON.stringify(j)}`);
        }

        // 2) Mark slot as Booked
        const upURL = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_SLOTS)}`;
        const upBody = {
          records: [{ id: rec.id, fields: { Status: "Booked" } }]
        };
        res = await fetch(upURL, {
          method: "PATCH",
          headers: atHeaders(),
          body: JSON.stringify(upBody)
        });
        if (!res.ok) {
          const j = await res.json().catch(()=> ({}));
          throw new Error(`Update slot failed: ${res.status} ${JSON.stringify(j)}`);
        }

        alert(`Booking confirmed!\n\nDate: ${rec.dateStr}\nSlot: ${rec.timeStr}`);
        // Refresh lists to hide the booked slot
        await loadAvailableSlots();
        els.slotSelect.value = "";
        selectedSlotRecord = null;
        validateForm();

      } catch (err) {
        console.error(err);
        showToast(err.message || "Booking failed");
      }
    }

    // ---------- Wire up ----------
    els.name.addEventListener('input', validateForm);
    els.phone.addEventListener('input', validateForm);
    els.dateSelect.addEventListener('change', onDateChange);
    els.slotSelect.addEventListener('change', onSlotChange);
    els.confirmBtn.addEventListener('click', confirmBooking);

    // ---------- Boot ----------
    loadAvailableSlots();
  </script>
</body>
</html>
