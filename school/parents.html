<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Parents â€¢ School</title>
  <link rel="stylesheet" href="./styles.css">
  <style>
    .wrap{max-width:1000px;margin:20px auto;padding:12px}
    .hero{position:relative;border-radius:22px;overflow:hidden}
    .banner{width:100%;height:200px;object-fit:cover;display:block}
    .hero-overlay{position:absolute;inset:0;display:flex;align-items:flex-end;
      padding:14px 18px;background:linear-gradient(180deg,rgba(0,0,0,0) 40%,rgba(0,0,0,.55))}
    .hero-title{color:#fff;font-weight:800;font-size:22px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .tablewrap{overflow:auto;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
  </style>
</head>
<body class="bg">
<main class="wrap">
  <div class="card hero">
    <img class="banner" src="./assets/banner.png" alt="School Banner">
    <div class="hero-overlay">
      <div class="hero-title">Parents</div>
    </div>
  </div>

  <!-- My Child -->
  <div class="card">
    <h2 class="h2">My Child</h2>
    <div class="grid2">
      <label>Student Name <input id="p_name" class="in" placeholder="e.g., Arjun Reddy"></label>
      <label>Class <input id="p_class" class="in" placeholder="e.g., 5"></label>
      <label>Section <input id="p_section" class="in" placeholder="e.g., A"></label>
      <label>Roll <input id="p_roll" class="in" placeholder="e.g., 21"></label>
    </div>
    <button class="btn" id="p_save" style="margin-top:10px">Save</button>
    <span class="muted" id="p_msg" style="margin-left:8px"></span>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-t="#t_diary">Class Diary</button>
    <button class="tab" data-t="#t_hw">Homework</button>
    <button class="tab" data-t="#t_leaves">Leaves</button>
  </div>

  <!-- Class Diary -->
  <section class="card" id="t_diary">
    <div class="row space">
      <h2 class="h2">Daily Class Diary</h2>
      <input id="d_search" class="in" placeholder="Search message or subject" style="max-width:260px">
    </div>
    <div class="tablewrap">
      <table class="tbl">
        <thead><tr><th>Date</th><th>Subject</th><th>Teacher</th><th>Message</th><th>Link</th></tr></thead>
        <tbody id="d_tbody"></tbody>
      </table>
      <div id="d_empty" class="muted">No diary entries yet.</div>
    </div>
  </section>

  <!-- Homework -->
  <section class="card hidden" id="t_hw">
    <div class="row space">
      <h2 class="h2">Homework</h2>
      <input id="h_search" class="in" placeholder="Search subject or title" style="max-width:260px">
    </div>
    <div class="tablewrap">
      <table class="tbl">
        <thead><tr><th>Due</th><th>Subject</th><th>Title</th><th>Details</th><th>Teacher</th></tr></thead>
        <tbody id="h_tbody"></tbody>
      </table>
      <div id="h_empty" class="muted">No homework yet.</div>
    </div>
  </section>

  <!-- Leaves -->
  <section class="card hidden" id="t_leaves">
    <h2 class="h2">Leave Requests</h2>
    <div class="grid2">
      <label>Date <input id="l_date" class="in" type="date"></label>
      <label>Reason <input id="l_reason" class="in" placeholder="e.g., Fever"></label>
    </div>
    <button class="btn" id="l_submit" style="margin-top:10px">Request Leave</button>

    <div class="tablewrap" style="margin-top:12px">
      <table class="tbl">
        <thead><tr><th>Date</th><th>Reason</th><th>Status</th></tr></thead>
        <tbody id="l_tbody"></tbody>
      </table>
      <div id="l_empty" class="muted">No leaves yet.</div>
    </div>
  </section>

  <div class="card">
    <div class="row">
      <button class="btn" onclick="logout()" style="flex:1">Logout</button>
      <a class="btn" href="./index.html" style="flex:1">Back to PIN</a>
    </div>
  </div>
</main>

<script>
  // Role lock
  if(sessionStorage.getItem("school_role")!=="parents"){ location.replace("./index.html"); }

  const $ = s=>document.querySelector(s);
  const jget=k=>JSON.parse(localStorage.getItem(k)||"[]");
  const jset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

  // Tabs
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      ["t_diary","t_hw","t_leaves"].forEach(id=>document.getElementById(id).classList.add("hidden"));
      document.querySelector(t.getAttribute("data-t")).classList.remove("hidden");
    });
  });

  // My child save
  (function loadProfile(){
    const p=JSON.parse(localStorage.getItem("parent_profile")||"{}");
    ["name","class","section","roll"].forEach(f=>{
      const el=$("#p_"+f); if(el) el.value = p[f]||"";
    });
  })();
  $("#p_save").addEventListener("click", ()=>{
    const p={ name:$("#p_name").value.trim(), class:$("#p_class").value.trim(),
              section:$("#p_section").value.trim(), roll:$("#p_roll").value.trim() };
    localStorage.setItem("parent_profile", JSON.stringify(p));
    $("#p_msg").textContent="Saved.";
    setTimeout(()=>$("#p_msg").textContent="",1500);
    renderAll();
  });

  function matchClassSection(row){
    const p=JSON.parse(localStorage.getItem("parent_profile")||"{}");
    if(!p.class) return true;
    return String(row.class||"")==String(p.class||"") &&
           String(row.section||"")==String(p.section||"");
  }

  // Diary
  function renderDiary(){
    const q=($("#d_search").value||"").toLowerCase();
    const rows=jget("sch_class_diary").filter(r=>matchClassSection(r) &&
      ((r.text||"").toLowerCase().includes(q) || (r.subject||"").toLowerCase().includes(q)))
      .sort((a,b)=> (b.date||"").localeCompare(a.date||""));
    const tb=$("#d_tbody"); tb.innerHTML=""; $("#d_empty").style.display=rows.length?"none":"block";
    rows.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.date||""}</td><td>${r.subject||""}</td><td>${r.teacherName||""}</td>
                    <td>${r.text||""}</td><td>${r.link?`<a href="${r.link}" target="_blank">Open</a>`:""}</td>`;
      tb.appendChild(tr);
    });
  }
  $("#d_search").addEventListener("input", renderDiary);

  // Homework
  function renderHW(){
    const q=($("#h_search").value||"").toLowerCase();
    const rows=jget("sch_homework").filter(r=>matchClassSection(r) &&
      ((r.title||"").toLowerCase().includes(q) || (r.subject||"").toLowerCase().includes(q)))
      .sort((a,b)=> (a.due||"").localeCompare(b.due||""));
    const tb=$("#h_tbody"); tb.innerHTML=""; $("#h_empty").style.display=rows.length?"none":"block";
    rows.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.due||""}</td><td>${r.subject||""}</td><td>${r.title||""}</td>
                    <td>${r.details||""}</td><td>${r.teacherName||""}</td>`;
      tb.appendChild(tr);
    });
  }
  $("#h_search").addEventListener("input", renderHW);

  // Leaves
  function renderLeaves(){
    const p=JSON.parse(localStorage.getItem("parent_profile")||"{}");
    const all=jget("sch_leaves").filter(x=> (x.studentName||"")===(p.name||""));
    const tb=$("#l_tbody"); tb.innerHTML=""; $("#l_empty").style.display=all.length?"none":"block";
    all.sort((a,b)=> (a.date||"").localeCompare(b.date||"")).forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.date||""}</td><td>${r.reason||""}</td><td>${r.status||"Pending"}</td>`;
      tb.appendChild(tr);
    });
  }
  $("#l_submit").addEventListener("click", ()=>{
    const p=JSON.parse(localStorage.getItem("parent_profile")||"{}");
    if(!p.name){ alert("Save student profile first."); return; }
    const row={ id:crypto.randomUUID?crypto.randomUUID():Date.now()+"",
      date: $("#l_date").value, studentId:p.id||"", studentName:p.name||"",
      class:p.class||"", section:p.section||"", reason:$("#l_reason").value.trim(), status:"Pending" };
    if(!row.date || !row.reason){ alert("Pick date and reason."); return; }
    const arr=jget("sch_leaves"); arr.unshift(row); jset("sch_leaves",arr);
    $("#l_reason").value=""; renderLeaves(); alert("Leave requested.");
  });

  function renderAll(){ renderDiary(); renderHW(); renderLeaves(); }
  renderAll();

  function logout(){ sessionStorage.clear(); location.replace("./index.html"); }
</script>
</body>
</html>
