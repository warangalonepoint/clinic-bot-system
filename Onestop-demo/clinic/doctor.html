<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Doctor Panel · Onestop Clinic</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css?v=13">
</head>
<body>
  <div class="app-shell">
    <div class="header">
      <div class="brand-logo"></div>
      <div>
        <div class="title">Doctor Panel</div>
        <div class="subtitle">Today’s Patients & Notes</div>
      </div>
    </div>

    <!-- Filter -->
    <div class="section glass">
      <h2>Filter</h2>
      <div class="row">
        <div class="label">Show</div>
        <select id="fStatus" class="input" style="max-width:220px">
          <option value="all">All</option>
          <option value="Pending" selected>Pending</option>
          <option value="Seen">Seen</option>
        </select>
      </div>
    </div>

    <!-- List renders here -->
    <div id="list"></div>

    <div class="footer">© 2025 Onestop Clinic</div>
  </div>

<script>
/* expects config.json { airtable: { apiKey, baseId, logsTable } } */
let CFG=null;
async function loadCfg(){
  const r=await fetch('./config.json?v='+Date.now());
  if(!r.ok) throw new Error('config.json missing');
  CFG=await r.json();
}

const AT = {
  headers(){ return { Authorization:'Bearer '+CFG.airtable.apiKey, 'Content-Type':'application/json' } },
  async today(){
    const d=new Date().toISOString().slice(0,10);
    const url=`https://api.airtable.com/v0/${CFG.airtable.baseId}/${encodeURIComponent(CFG.airtable.logsTable)}`
      +`?filterByFormula=${encodeURIComponent("DATETIME_FORMAT({Timestamp}, 'YYYY-MM-DD')='"+d+"'")}`
      +`&sort[0][field]=Slot Time&sort[0][direction]=asc&pageSize=100`;
    const j=await (await fetch(url,{headers:this.headers()})).json();
    return (j.records||[]).map(x=>({id:x.id, ...x.fields}));
  },
  async update(id, fields){
    const url=`https://api.airtable.com/v0/${CFG.airtable.baseId}/${encodeURIComponent(CFG.airtable.logsTable)}`;
    const body=JSON.stringify({records:[{id,fields}]});
    const r=await fetch(url,{method:'PATCH',headers:this.headers(),body});
    if(!r.ok) throw 0;
  }
};

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function card(rec){
  const status=rec['Status']||'Pending';
  const fup=rec['Follow Up']?String(rec['Follow Up']).slice(0,10):'';
  return `
  <div class="section glass" data-id="${rec.id}">
    <h2>#${rec['Token']||'-'} • ${esc(rec['Patient Name'])} <span class="muted">(${esc(rec['Slot Time'])})</span></h2>

    <div class="row"><div class="label">Reason</div><div class="value">${esc(rec['Reason'])||'-'}</div></div>
    <div class="row"><div class="label">Contact</div><div class="value">${esc(rec['Contact'])||'-'}</div></div>

    <div class="row"><div class="label">Diagnosis</div>
      <input class="input diag" placeholder="e.g., Viral fever" value="${esc(rec['Diagnosis'])}">
    </div>

    <div class="row"><div class="label">Prescription</div>
      <textarea class="input rx" rows="3" placeholder="Rx...">${esc(rec['Prescription'])}</textarea>
    </div>

    <div class="row"><div class="label">Doctor Notes</div>
      <textarea class="input note" rows="3" placeholder="Notes...">${esc(rec['Doctor Notes'])}</textarea>
    </div>

    <div class="row"><div class="label">Follow Up</div>
      <input class="input fup" type="date" value="${fup}">
    </div>

    <div class="row"><div class="label">Status</div>
      <select class="input stat" style="max-width:220px">
        <option ${status==='Pending'?'selected':''}>Pending</option>
        <option ${status==='Seen'?'selected':''}>Seen</option>
      </select>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
      <button class="btn btn-primary save">Save</button>
      <button class="btn btn-secondary seen">${status==='Seen'?'Mark Pending':'Mark Seen'}</button>
      <button class="btn btn-secondary wa">WhatsApp Rx</button>
    </div>
  </div>`;
}

function bind(section, rec){
  const $=sel=>section.querySelector(sel);
  $('.save').onclick=async()=>{
    try{
      await AT.update(rec.id,{
        'Diagnosis': $('.diag').value.trim(),
        'Prescription': $('.rx').value.trim(),
        'Doctor Notes': $('.note').value.trim(),
        'Follow Up': $('.fup').value||null,
        'Status': $('.stat').value
      });
      toast('Saved');
    }catch{toast('Save failed');}
  };
  $('.seen').onclick=async()=>{
    try{
      const next=($('.stat').value==='Seen')?'Pending':'Seen';
      await AT.update(rec.id,{'Status':next});
      $('.stat').value=next;
      $('.seen').textContent=next==='Seen'?'Mark Pending':'Mark Seen';
      toast('Status updated');
    }catch{toast('Update failed');}
  };
  $('.wa').onclick=()=>{
    const msg=`Prescription for ${rec['Patient Name']||''}
Token: ${rec['Token']||''}
Diagnosis: ${$('.diag').value.trim()}
Rx: ${$('.rx').value.trim()}
Notes: ${$('.note').value.trim()}
Follow-up: ${$('.fup').value||'-'}`;
    const phone=(rec['Contact']||'').trim();
    const base=phone?`https://wa.me/${encodeURIComponent(phone)}?text=`:`https://wa.me/?text=`;
    location.href=base+encodeURIComponent(msg);
  };
}

function toast(t){
  let el=document.getElementById('toast');
  if(!el){el=document.createElement('div');el.id='toast';el.className='debug-css';document.body.appendChild(el);}
  el.textContent='✅ '+t; setTimeout(()=>el.remove(),2000);
}

let ALL=[];
async function boot(){
  await loadCfg();
  if(!CFG?.airtable?.apiKey){ alert('Add Airtable key/base/table in config.json'); return; }
  ALL=await AT.today();
  render();
  document.getElementById('fStatus').onchange=render;
}
function render(){
  const f=document.getElementById('fStatus').value;
  const root=document.getElementById('list');
  const items=ALL.filter(r=>f==='all'?true:(r['Status']||'Pending')===f);
  root.innerHTML = items.length? items.map(card).join('') : `<div class="section glass"><h2>No patients</h2></div>`;
  Array.from(root.querySelectorAll('.section.glass')).forEach((sec,i)=>bind(sec, items[i]));
}
boot();
</script>
</body>
</html>
