<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Doctor Panel · Onestop Clinic</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css?v=31">
  <style>
    /* page-local helpers, won’t fight your main css */
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid rgba(17,24,39,.10);
      background:rgba(255,255,255,.85);backdrop-filter:blur(10px);cursor:pointer;font-weight:700}
    .chip:hover{transform:translateY(-1px)}
    .hint{font-size:.9rem;color:#5b6475;margin-top:6px}
    .warn{padding:10px 12px;border-radius:14px;background:#fff6e6;border:1px solid #facc15;color:#854d0e;font-weight:700}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr}
    @media(min-width:900px){.two{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="header">
      <div class="brand-logo"></div>
      <div><div class="title">Doctor Panel</div><div class="subtitle">Today’s Patients, Notes & Rx</div></div>
    </div>

    <!-- Filters -->
    <div class="section glass">
      <h2>Filter</h2>
      <div class="toolbar">
        <select id="fDoctor" class="input" style="max-width:220px"></select>
        <select id="fStatus" class="input" style="max-width:180px">
          <option value="Pending" selected>Pending</option>
          <option value="Seen">Seen</option>
          <option value="all">All</option>
        </select>
        <input id="q" class="input" placeholder="Search name / reason / token" style="min-width:220px">
        <button class="btn btn-secondary" id="nextBtn" title="Jump to first pending">Next Pending</button>
      </div>
      <div id="modeBanner" class="hint"></div>
    </div>

    <!-- List -->
    <div id="list" class="grid two"></div>
    <div id="emptyState" class="section glass" style="display:none"><h2>No patients match.</h2></div>

    <div class="footer">© 2025 Onestop Clinic</div>
  </div>

<script>
/* =========================
   Config / Backends
========================= */
let CFG=null, BACKEND='csv', DOCTORS=[];
async function loadCfg(){
  try{
    const res = await fetch('./config.json?v=' + Date.now());
    if(!res.ok) throw 0;
    CFG = await res.json();
    BACKEND = (CFG.backend||'csv').toLowerCase();
    DOCTORS = CFG.doctors || [];
  }catch{
    CFG = { backend:'csv', csv:{ logs:'./logs.csv' } };
    BACKEND = 'csv';
    DOCTORS = [];
  }
  // banner
  const banner = document.getElementById('modeBanner');
  banner.innerHTML = (BACKEND==='airtable')
    ? 'Airtable mode • changes are saved live.'
    : `<span class="warn">CSV mode: read-only.</span> <span class="hint">Saving/marking needs Airtable in <span class="mono">config.json</span>.</span>`;

  // doctor filter
  const fDoc = document.getElementById('fDoctor');
  fDoc.innerHTML = '<option value="all">All Doctors</option>' + DOCTORS.map(d=>`<option>${d}</option>`).join('');
}

/* =========================
   Utilities
========================= */
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function DONLY(s){ return (s||'').slice(0,10); }
function slotBucket(t){
  const m=/(\d{1,2}):(\d{2})\s*(AM|PM)/i.exec(String(t)||''); if(!m) return 'all';
  let h=+m[1]%12; if(m[3].toUpperCase()==='PM') h+=12;
  if(h<12) return 'morning'; if(h<16) return 'afternoon'; return 'evening';
}

/* Robust-ish CSV parse */
function parseCSV(text){
  const rows=[]; let cur=[], str='', q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c=='"'){ if(q && n=='"'){ str+='"'; i++; } else q=!q; }
    else if(c==',' && !q){ cur.push(str); str=''; }
    else if((c=='\n'||c=='\r') && !q){ if(str!==''||cur.length){ cur.push(str); rows.push(cur); cur=[]; str=''; } }
    else { str+=c; }
  }
  if(str!==''||cur.length){ cur.push(str); rows.push(cur); }
  return rows;
}
function csvToObjs(text){
  const r=parseCSV(text).filter(a=>a.length && a.join('').trim()!=='');
  const h=r.shift().map(x=>x.trim());
  return r.map(line=>{const o={}; h.forEach((k,i)=>o[k]=(line[i]||'').trim()); return o;});
}

/* =========================
   Airtable API
========================= */
const AT = {
  headers(){ return { Authorization:'Bearer '+CFG.airtable.apiKey, 'Content-Type':'application/json' }; },
  async listToday(doctor='all'){
    const d = new Date().toISOString().slice(0,10);
    const base = `https://api.airtable.com/v0/${CFG.airtable.baseId}/${encodeURIComponent(CFG.airtable.logsTable||'BookingsLogs')}`;
    const filters = [`DATETIME_FORMAT({Timestamp}, 'YYYY-MM-DD')='${d}'`];
    if(doctor && doctor!=='all') filters.push(`{Doctor}='${doctor}'`);
    const formula = filters.length>1 ? `AND(${filters.join(',')})` : filters[0];
    const url = `${base}?filterByFormula=${encodeURIComponent(formula)}&sort[0][field]=Slot Time&sort[0][direction]=asc&pageSize=200`;
    const j = await (await fetch(url,{headers:this.headers()})).json();
    return (j.records||[]).map(r=>({id:r.id, ...r.fields}));
  },
  async update(id, fields){
    const url = `https://api.airtable.com/v0/${CFG.airtable.baseId}/${encodeURIComponent(CFG.airtable.logsTable||'BookingsLogs')}`;
    const body = JSON.stringify({ records: [{ id, fields }] });
    const r = await fetch(url,{ method:'PATCH', headers:this.headers(), body });
    if(!r.ok) throw new Error('Update failed');
  }
};

/* =========================
   Data Loader
========================= */
async function loadRows(){
  if(BACKEND==='airtable'){
    return await AT.listToday(document.getElementById('fDoctor').value);
  }
  // CSV fallback (read-only)
  const url = (CFG.csv && CFG.csv.logs) ? CFG.csv.logs : './logs.csv';
  const txt = await (await fetch(url + '?v=' + Date.now())).text();
  const rows = csvToObjs(txt);
  const today = new Date().toISOString().slice(0,10);
  return rows
    .filter(r=> DONLY(r['Timestamp'])===today )
    .sort((a,b)=> (a['Slot Time']||'').localeCompare(b['Slot Time']||''))
    .map(r=>({ id: r['id']||'', ...r }));
}

/* =========================
   UI Rendering
========================= */
let ALL=[], FILTER='Pending', QUERY='';
const listEl = document.getElementById('list');

function rxChip(label,val){ return `<span class="chip" data-val="${esc(val)}">${esc(label)}</span>`; }

function cardTpl(r){
  const status = r['Status']||'Pending';
  const fup    = r['Follow Up'] ? String(r['Follow Up']).slice(0,10) : '';
  const name   = r['Patient Name']||'';
  const token  = r['Token']||'-';
  const slot   = r['Slot Time']||'';
  const reason = r['Reason']||'-';
  const contact= r['Contact']||'';
  const diag   = r['Diagnosis']||'';
  const rx     = r['Prescription']||'';
  const notes  = r['Doctor Notes']||'';
  const doctor = r['Doctor']||'—';

  return `
  <div class="section glass" data-id="${esc(r.id||'')}">
    <h2>#${esc(token)} • ${esc(name)} <span class="muted">(${esc(slot)} · ${esc(doctor)})</span></h2>

    <div class="row"><div class="label">Reason</div><div class="value">${esc(reason)}</div></div>
    <div class="row"><div class="label">Contact</div><div class="value">${esc(contact)}</div></div>

    <div class="row"><div class="label">Diagnosis</div>
      <input class="input diag" placeholder="e.g., Viral fever" value="${esc(diag)}">
    </div>

    <div class="row"><div class="label">Prescription</div>
      <textarea class="input rx" rows="3" placeholder="Rx...">${esc(rx)}</textarea>
    </div>

    <div class="chips">
      ${rxChip('Paracetamol 500mg b.i.d ×3d','Paracetamol 500 mg — 1 tab twice daily for 3 days')}
      ${rxChip('Cetrizine 10mg o.d ×5d','Cetrizine 10 mg — 1 tab at night for 5 days')}
      ${rxChip('ORS + Rest','ORS sachet with water; rest & fluids')}
      ${rxChip('Omeprazole 20mg o.d ×7d','Omeprazole 20 mg — 1 cap empty stomach for 7 days')}
    </div>

    <div class="row"><div class="label">Doctor Notes</div>
      <textarea class="input note" rows="3" placeholder="Notes...">${esc(notes)}</textarea>
    </div>

    <div class="row"><div class="label">Follow Up</div>
      <input class="input fup" type="date" value="${esc(fup)}">
    </div>

    <div class="row"><div class="label">Status</div>
      <select class="input stat" style="max-width:220px">
        <option ${status==='Pending'?'selected':''}>Pending</option>
        <option ${status==='Seen'?'selected':''}>Seen</option>
      </select>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
      <button class="btn btn-primary save"${BACKEND==='csv'?' disabled':''}>Save</button>
      <button class="btn btn-secondary seen">${status==='Seen'?'Mark Pending':'Mark Seen'}</button>
      <button class="btn btn-secondary wa">WhatsApp Rx</button>
    </div>
    ${BACKEND==='csv'?'<div class="hint">CSV mode is read-only. Enable Airtable in <span class="mono">config.json</span> to save.</div>':''}
  </div>`;
}

function applyFilters(src){
  const fDoc = document.getElementById('fDoctor').value;
  return src.filter(r=>{
    const s = (r['Status']||'Pending');
    if(FILTER!=='all' && s!==FILTER) return false;
    if(fDoc!=='all' && (r['Doctor']||'')!==fDoc) return false;
    const hay = [r['Patient Name'], r['Reason'], r['Token'], r['Slot Time'], r['Diagnosis'], r['Prescription']]
                .join(' ').toLowerCase();
    return hay.includes(QUERY.trim().toLowerCase());
  });
}

function bindCardActions(el, rec){
  // chips append
  el.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click',()=>{
      const rx = el.querySelector('.rx');
      const add = ch.getAttribute('data-val');
      rx.value = (rx.value ? rx.value.trim() + '\n' : '') + add;
    });
  });

  // Save (Airtable only)
  el.querySelector('.save')?.addEventListener('click', async ()=>{
    const payload = {
      'Diagnosis': el.querySelector('.diag').value.trim(),
      'Prescription': el.querySelector('.rx').value.trim(),
      'Doctor Notes': el.querySelector('.note').value.trim(),
      'Follow Up': el.querySelector('.fup').value || null,
      'Status': el.querySelector('.stat').value
    };
    try{ await AT.update(rec.id, payload); Object.assign(rec, payload); toast('Saved'); }
    catch{ toast('Save failed'); }
  });

  // Mark seen/pending (Airtable updates if enabled)
  el.querySelector('.seen').addEventListener('click', async ()=>{
    const current = el.querySelector('.stat').value;
    const next = current==='Seen' ? 'Pending' : 'Seen';
    try{
      if(BACKEND==='airtable') await AT.update(rec.id, { 'Status': next });
      el.querySelector('.stat').value = next;
      rec['Status'] = next;
      el.querySelector('.seen').textContent = next==='Seen'?'Mark Pending':'Mark Seen';
      toast('Status updated');
    }catch{ toast('Update failed'); }
  });

  // WhatsApp Rx
  el.querySelector('.wa').addEventListener('click', ()=>{
    const msg = `Prescription for ${rec['Patient Name']||''}
Token: ${rec['Token']||''}
Time: ${rec['Slot Time']||''}
Diagnosis: ${el.querySelector('.diag').value.trim()}
Rx:
${el.querySelector('.rx').value.trim()}

Notes: ${el.querySelector('.note').value.trim()}
Follow-up: ${el.querySelector('.fup').value||'-'}`;
    const phone = (rec['Contact']||'').trim();
    const base = phone ? `https://wa.me/${encodeURIComponent(phone)}?text=` : `https://wa.me/?text=`;
    location.href = base + encodeURIComponent(msg);
  });
}

function render(){
  const items = applyFilters(ALL);
  if(!items.length){
    document.getElementById('list').innerHTML = '';
    document.getElementById('emptyState').style.display = 'block';
    return;
  }
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('list').innerHTML = items.map(cardTpl).join('');
  // bind
  Array.from(document.getElementById('list').querySelectorAll('.section.glass')).forEach((sec,i)=>{
    bindCardActions(sec, items[i]);
  });
}

function toast(t){
  let el=document.getElementById('toast');
  if(!el){ el=document.createElement('div'); el.id='toast'; el.className='debug-css'; document.body.appendChild(el); }
  el.textContent = '✅ ' + t; clearTimeout(el._t); el._t = setTimeout(()=>el.remove(), 2000);
}

/* =========================
   Boot
========================= */
(async ()=>{
  await loadCfg();
  try{
    ALL = await loadRows();
  }catch(e){
    document.getElementById('list').innerHTML = '';
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('emptyState').querySelector('h2').textContent = 'Couldn’t load today’s list.';
    document.getElementById('modeBanner').innerHTML += ' • Check <span class="mono">config.json</span>.';
    return;
  }
  render();

  // Filters
  document.getElementById('fStatus').addEventListener('change', e=>{ FILTER=e.target.value; render(); });
  document.getElementById('q').addEventListener('input', e=>{ QUERY=e.target.value; render(); });
  document.getElementById('fDoctor').addEventListener('change', async ()=>{
    // in Airtable mode, reload from backend for selected doctor (server side filter)
    if(BACKEND==='airtable'){ ALL = await loadRows(); }
    render();
  });

  // Next pending jump
  document.getElementById('nextBtn').addEventListener('click', ()=>{
    QUERY=''; document.getElementById('q').value='';
    FILTER='Pending'; document.getElementById('fStatus').value='Pending';
    render();
    const first = document.querySelector('#list .section.glass');
    if(first) first.scrollIntoView({behavior:'smooth', block:'start'});
  });

  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
})();
</script>
</body>
</html>
