<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Parents</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="wrapper">
    <!-- Header / Hero -->
    <section class="accent-indigo">
      <div class="glass header">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <div>
            <div class="eyebrow">View diary, homework, messages & leaves</div>
            <div class="h1">Parents</div>
          </div>
          <div class="row" style="gap:12px;">
            <a href="index.html" class="btn btn-ghost">PIN</a>
            <button class="btn" id="themeBtn">Theme</button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="row mt-16 wrap" id="tabs">
          <button class="chip chip-indigo active" data-tab="tab-diary">Class Diary</button>
          <button class="chip chip-blue"   data-tab="tab-homework">Homework</button>
          <button class="chip chip-pink"   data-tab="tab-messages">Messages</button>
          <button class="chip chip-green"  data-tab="tab-leaves">Leaves</button>
          <button class="chip chip-cyan"   data-tab="tab-attendance">Attendance</button>
          <button class="chip chip-purple" data-tab="tab-events">Events</button>
          <button class="chip chip-teal"   data-tab="tab-requests">Requests</button>
          <button class="chip chip-orange" data-tab="tab-complaints">Complaints</button>
        </div>
      </div>
    </section>

    <!-- Class Diary -->
    <section class="accent-indigo panel" id="tab-diary">
      <div class="glass">
        <div class="h2">Today’s Class Diary</div>
        <p class="text-dim">Teacher notes for the selected class.</p>
        <div id="diaryList" class="stack mt-12"></div>
      </div>
    </section>

    <!-- Homework -->
    <section class="accent-blue panel hidden" id="tab-homework">
      <div class="glass">
        <div class="h2">Homework</div>
        <div id="hwList" class="stack mt-12"></div>
      </div>
    </section>

    <!-- Messages -->
    <section class="accent-pink panel hidden" id="tab-messages">
      <div class="glass">
        <div class="h2">Messages from Teachers</div>
        <div id="msgList" class="stack mt-12"></div>
      </div>
    </section>

    <!-- Leaves -->
    <section class="accent-green panel hidden" id="tab-leaves">
      <div class="glass">
        <div class="h2">Apply Leave</div>
        <form id="leaveForm" class="grid" onsubmit="return false;">
          <div class="grid-2">
            <input class="input" type="date" id="lvFrom" />
            <input class="input" type="date" id="lvTo" />
          </div>
          <textarea class="input" id="lvReason" placeholder="Reason"></textarea>
          <div class="row">
            <button class="btn btn-green" id="lvSubmit">Submit</button>
          </div>
        </form>

        <div class="divider"></div>

        <div class="h3">My Leave Requests</div>
        <div id="lvList" class="stack mt-12"></div>
      </div>
    </section>

    <!-- Attendance -->
    <section class="accent-cyan panel hidden" id="tab-attendance">
      <div class="glass">
        <div class="h2">Attendance Summary</div>
        <p class="text-dim">Monthly presence and quick stats.</p>
        <div id="attSummary" class="stack mt-12"></div>
      </div>
    </section>

    <!-- Events -->
    <section class="accent-purple panel hidden" id="tab-events">
      <div class="glass">
        <div class="h2">Upcoming Events & Exams</div>
        <div id="evtList" class="stack mt-12"></div>
      </div>
    </section>

    <!-- Requests -->
    <section class="accent-teal panel hidden" id="tab-requests">
      <div class="glass">
        <div class="h2">Parent–Teacher Requests</div>
        <form id="reqForm" class="grid" onsubmit="return false;">
          <div class="grid-2">
            <select class="input" id="reqType">
              <option>Request Call</option>
              <option>Request Meeting</option>
              <option>Feedback</option>
            </select>
            <input class="input" id="reqPreferred" placeholder="Preferred time (optional)" />
          </div>
          <textarea class="input" id="reqMsg" placeholder="Write your request…"></textarea>
          <div class="row">
            <button class="btn btn-teal" id="reqSubmit">Send Request</button>
            <button class="btn btn-ghost" id="reqExport">Export CSV</button>
          </div>
        </form>

        <div class="divider"></div>
        <div class="h3">My Requests</div>
        <div id="reqList" class="stack mt-12"></div>
      </div>
    </section>

    <!-- Complaints -->
    <section class="accent-orange panel hidden" id="tab-complaints">
      <div class="glass">
        <div class="h2">Raise Complaint</div>
        <form id="cmpForm" class="grid" onsubmit="return false;">
          <div class="grid-2">
            <select class="input" id="cmpCat">
              <option>Transport</option>
              <option>Discipline</option>
              <option>Fees & Accounts</option>
              <option>Facility</option>
              <option>Other</option>
            </select>
            <input class="input" id="cmpSubject" placeholder="Short title" />
          </div>
          <textarea class="input" id="cmpMsg" placeholder="Describe the issue…"></textarea>
          <div class="row">
            <button class="btn btn-orange" id="cmpSubmit">Submit Complaint</button>
            <button class="btn btn-ghost" id="cmpExport">Export CSV</button>
          </div>
        </form>

        <div class="divider"></div>
        <div class="h3">My Complaints</div>
        <div id="cmpList" class="stack mt-12"></div>
      </div>
    </section>

  </div>

  <!-- Shared UI helpers (theme, small utilities) -->
  <script src="ui.js" type="module"></script>

  <script>
  // ---------------- Tabs (works even if ui.js is cached) ----------------
  const tabsEl = document.getElementById('tabs');
  const panels = [...document.querySelectorAll('.panel')];
  if (tabsEl) {
    tabsEl.addEventListener('click', (e) => {
      const btn = e.target.closest('.chip[data-tab]');
      if (!btn) return;
      const id = btn.dataset.tab;
      // chip states
      tabsEl.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      // panels
      panels.forEach(p => p.classList.toggle('hidden', p.id !== id));
      // remember last tab
      localStorage.setItem('parents:lastTab', id);
    });
    // restore last tab
    const last = localStorage.getItem('parents:lastTab');
    if (last && document.getElementById(last)) {
      tabsEl.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      const chip = tabsEl.querySelector(`.chip[data-tab="${last}"]`);
      if (chip) chip.classList.add('active');
      panels.forEach(p => p.classList.toggle('hidden', p.id !== last));
    }
  }

  // ---------------- Theme toggle button ----------------
  const themeBtn = document.getElementById('themeBtn');
  if (themeBtn) {
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const mode = document.body.classList.contains('dark') ? 'dark' : 'light';
      localStorage.setItem('theme', mode);
    });
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') document.body.classList.remove('dark');
  }

  // ---------------- Utilities ----------------
  const fmtDate = d => new Date(d).toISOString().slice(0,10);
  const el = (tag, cls, html) => {
    const n = document.createElement(tag);
    if (cls) n.className = cls;
    if (html) n.innerHTML = html;
    return n;
  };
  const saveArray = (key, arr) => localStorage.setItem(key, JSON.stringify(arr));
  const loadArray = (key, fallback=[]) => {
    try { return JSON.parse(localStorage.getItem(key)) || fallback; }
    catch { return fallback; }
  };
  const toCSV = (rows) => {
    if (!rows.length) return '';
    const headers = Object.keys(rows[0]);
    const esc = s => `"${String(s ?? '').replace(/"/g,'""')}"`;
    const lines = [headers.map(esc).join(',')];
    for (const r of rows) lines.push(headers.map(h => esc(r[h])).join(','));
    return lines.join('\n');
  };
  const download = (name, text) => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type:'text/csv'}));
    a.download = name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  };

  // ---------------- Seed demo data (only if empty) ----------------
  (function seed(){
    if (!localStorage.getItem('classDiary')) {
      saveArray('classDiary', [
        {subject:'Maths', date: fmtDate(new Date()), note:'Fractions & examples'},
        {subject:'Science', date: fmtDate(new Date()), note:'Plants and photosynthesis'}
      ]);
    }
    if (!localStorage.getItem('homework')) {
      saveArray('homework', [
        {subject:'Maths', due: fmtDate(Date.now()+86400000), title:'Exercise 5A', details:'Q1–10'},
        {subject:'English', due: fmtDate(Date.now()+2*86400000), title:'Read Ch.3', details:'Make notes'}
      ]);
    }
    if (!localStorage.getItem('messages')) {
      saveArray('messages', [
        {time: new Date().toLocaleString(), text:'PTM on Friday 4 PM.'}
      ]);
    }
    if (!localStorage.getItem('attendance')) {
      // last 15 school days, random presence
      const days = [];
      for (let i=15;i>=1;i--){
        const d = new Date(); d.setDate(d.getDate()-i);
        days.push({date: fmtDate(d), present: Math.random()>0.1});
      }
      saveArray('attendance', days);
    }
    if (!localStorage.getItem('events')) {
      saveArray('events', [
        {date: fmtDate(Date.now()+3*86400000), title:'Science Quiz'},
        {date: fmtDate(Date.now()+7*86400000), title:'Parent–Teacher Meeting'},
        {date: fmtDate(Date.now()+14*86400000), title:'Half-Yearly Exams Begin'}
      ]);
    }
  })();

  // ---------------- Renderers ----------------
  function renderDiary(){
    const list = loadArray('classDiary');
    const wrap = document.getElementById('diaryList'); wrap.innerHTML='';
    if (!list.length) { wrap.append(el('div','text-dim','No entries.')); return; }
    list.forEach((x)=>{
      const card = el('div','card item');
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div class="h3">${x.subject}</div>
          <div class="text-dim">${x.date}</div>
        </div>
        <div class="mt-8">${x.note}</div>`;
      wrap.append(card);
    });
  }

  function renderHW(){
    const list = loadArray('homework');
    const wrap = document.getElementById('hwList'); wrap.innerHTML='';
    if (!list.length) { wrap.append(el('div','text-dim','No homework.')); return; }
    list.forEach((x)=>{
      const card = el('div','card item');
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div class="h3">${x.subject}</div>
          <div class="text-dim">Due ${x.due}</div>
        </div>
        <div class="mt-8"><b>${x.title}</b> — ${x.details||''}</div>`;
      wrap.append(card);
    });
  }

  function renderMsgs(){
    const list = loadArray('messages');
    const wrap = document.getElementById('msgList'); wrap.innerHTML='';
    if (!list.length) { wrap.append(el('div','text-dim','No messages.')); return; }
    list.forEach((x)=>{
      const card = el('div','card item');
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div class="h3">Message</div>
          <div class="text-dim">${x.time}</div>
        </div>
        <div class="mt-8">${x.text}</div>`;
      wrap.append(card);
    });
  }

  function renderLeaves(){
    const my = loadArray('parentLeaves');
    const wrap = document.getElementById('lvList'); wrap.innerHTML='';
    if (!my.length) { wrap.append(el('div','text-dim','No leave requests.')); return; }
    my.forEach((x,i)=>{
      const card = el('div','card item');
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div class="h3">${x.from} → ${x.to}</div>
          <div class="badge">${x.status||'Pending'}</div>
        </div>
        <div class="mt-8 text-dim">${x.reason||''}</div>`;
      wrap.append(card);
    });
  }

  function renderAttendance(){
    const a = loadArray('attendance');
    const wrap = document.getElementById('attSummary'); wrap.innerHTML='';
    if (!a.length) { wrap.append(el('div','text-dim','No attendance data.')); return; }
    // current month
    const now = new Date();
    const ym = now.toISOString().slice(0,7);
    const m = a.filter(x => (x.date||'').startsWith(ym));
    const total = m.length || a.length;
    const present = m.length ? m.filter(x=>x.present).length : a.filter(x=>x.present).length;
    const pct = total ? Math.round(100*present/total) : 0;

    const card = el('div','card');
    card.innerHTML = `
      <div class="h3">This Month</div>
      <div class="mt-8">Present: <b>${present}</b> / ${total} days · <b>${pct}%</b></div>
      <div class="mt-12 text-dim">Last 5 days</div>
    `;
    const last5 = a.slice(-5);
    last5.forEach(x=>{
      const row = el('div','row mt-6');
      row.innerHTML = `<div class="text-dim" style="min-width:90px">${x.date}</div>
                       <div class="badge ${x.present?'badge-green':'badge-pink'}">${x.present?'Present':'Absent'}</div>`;
      card.append(row);
    });
    wrap.append(card);
  }

  function renderEvents(){
    const list = loadArray('events');
    const wrap = document.getElementById('evtList'); wrap.innerHTML='';
    if (!list.length) { wrap.append(el('div','text-dim','No upcoming events.')); return; }
    list.sort((a,b)=>String(a.date).localeCompare(String(b.date)));
    list.forEach(x=>{
      const card = el('div','card item');
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div class="h3">${x.title}</div>
          <div class="text-dim">${x.date}</div>
        </div>`;
      wrap.append(card);
    });
  }

  function renderRequests(){
    const list = loadArray('parentRequests');
    const wrap = document.getElementById('reqList'); wrap.innerHTML='';
    if (!list.length) { wrap.append(el('div','text-dim','No requests yet.')); return; }
    list.slice().reverse().forEach(x=>{
      const card = el('div','card item');
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div class="h3">${x.type}</div>
          <div class="text-dim">${x.time}</div>
        </div>
        <div class="mt-8">${x.msg}</div>
        <div class="mt-8 text-dim">${x.preferred ? 'Preferred: '+x.preferred : ''}</div>`;
      wrap.append(card);
    });
  }

  function renderComplaints(){
    const list = loadArray('parentComplaints');
    const wrap = document.getElementById('cmpList'); wrap.innerHTML='';
    if (!list.length) { wrap.append(el('div','text-dim','No complaints raised.')); return; }
    list.slice().reverse().forEach(x=>{
      const card = el('div','card item');
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div class="h3">${x.subject || x.category}</div>
          <div class="badge">${x.status || 'Open'}</div>
        </div>
        <div class="text-dim mt-6">${x.category}</div>
        <div class="mt-8">${x.msg}</div>
        <div class="text-dim mt-8">${x.time}</div>`;
      wrap.append(card);
    });
  }

  // ---------------- Form handlers ----------------
  document.getElementById('lvSubmit').addEventListener('click', ()=>{
    const from = document.getElementById('lvFrom').value;
    const to   = document.getElementById('lvTo').value;
    const reason = document.getElementById('lvReason').value.trim();
    if (!from || !to) return alert('Select from & to dates');
    const arr = loadArray('parentLeaves');
    arr.push({from, to, reason, status:'Pending', created:new Date().toISOString()});
    saveArray('parentLeaves', arr);
    document.getElementById('leaveForm').reset();
    renderLeaves();
  });

  document.getElementById('reqSubmit').addEventListener('click', ()=>{
    const type = document.getElementById('reqType').value;
    const preferred = document.getElementById('reqPreferred').value.trim();
    const msg = document.getElementById('reqMsg').value.trim();
    if (!msg) return alert('Please write your request.');
    const arr = loadArray('parentRequests');
    arr.push({type, preferred, msg, time:new Date().toLocaleString()});
    saveArray('parentRequests', arr);
    document.getElementById('reqForm').reset();
    renderRequests();
  });

  document.getElementById('reqExport').addEventListener('click', ()=>{
    const rows = loadArray('parentRequests');
    if (!rows.length) return alert('No data to export.');
    download('parent_requests.csv', toCSV(rows));
  });

  document.getElementById('cmpSubmit').addEventListener('click', ()=>{
    const category = document.getElementById('cmpCat').value;
    const subject  = document.getElementById('cmpSubject').value.trim();
    const msg      = document.getElementById('cmpMsg').value.trim();
    if (!msg) return alert('Please describe the issue.');
    const arr = loadArray('parentComplaints');
    arr.push({category, subject, msg, status:'Open', time:new Date().toLocaleString()});
    saveArray('parentComplaints', arr);
    document.getElementById('cmpForm').reset();
    renderComplaints();
  });

  document.getElementById('cmpExport').addEventListener('click', ()=>{
    const rows = loadArray('parentComplaints');
    if (!rows.length) return alert('No data to export.');
    download('parent_complaints.csv', toCSV(rows));
  });

  // ---------------- Initial renders ----------------
  renderDiary();
  renderHW();
  renderMsgs();
  renderLeaves();
  renderAttendance();
  renderEvents();
  renderRequests();
  renderComplaints();
  </script>
</body>
</html>
