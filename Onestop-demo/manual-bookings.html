<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manual Booking - Onestop C-Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <img src="assets/banner.png" class="banner" alt="Banner" />
    <h2 class="clinic-name">Onestop C-Demo</h2>

    <h3 class="section-title">Manual Booking</h3>
    <form id="bookingForm" class="form">

      <label>Patient Name:</label>
      <input type="text" id="name" required>

      <label>Contact Number:</label>
      <input type="tel" id="contact" required>

      <label>Reason for Visit:</label>
      <input type="text" id="reason" required>

      <label>Select Date:</label>
      <select id="dateDropdown" required></select>

      <label>Select Time Slot:</label>
      <select id="slotDropdown" required></select>

      <button type="submit" class="btn">Confirm Booking</button>
    </form>

    <div id="confirmation" style="display:none; text-align:center; margin-top:20px;"></div>

    <footer class="footer">
      <p>Powered by Onestop AI</p>
    </footer>
  </div>

  <script>
    const airtableApiKey = 'patLNwoJQKE3Tjb8J.c2a0db129111c610fae64a2c01e0a626f37bdb5992232ea6ebc644fa9073dfb3';
    const baseId = 'app1T8WiRqZIR4xY';
    const availableSlotsTable = 'AvailableSlots';
    const bookingsTable = 'BookingsLogs';

    const headers = { Authorization: `Bearer ${airtableApiKey}` };

    async function fetchAvailableDates() {
      const url = `https://api.airtable.com/v0/${baseId}/${availableSlotsTable}?pageSize=100&view=Grid%20view`;
      const res = await fetch(url, { headers });
      const data = await res.json();

      const today = new Date();
      const dates = [...new Set(data.records.map(r => r.fields.Date).filter(date => {
        const [dd, mm, yyyy] = date.split("-");
        return new Date(`${yyyy}-${mm}-${dd}`) >= today;
      }))];

      const dropdown = document.getElementById('dateDropdown');
      dropdown.innerHTML = '<option value="">--Select Date--</option>';
      dates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        dropdown.appendChild(option);
      });
    }

    async function fetchTimeSlots(selectedDate) {
      const url = `https://api.airtable.com/v0/${baseId}/${availableSlotsTable}?pageSize=100&view=Grid%20view&filterByFormula=AND(Date="${selectedDate}",Status="Available")`;
      const res = await fetch(url, { headers });
      const data = await res.json();

      const dropdown = document.getElementById('slotDropdown');
      dropdown.innerHTML = '<option value="">--Select Slot--</option>';
      data.records.forEach(record => {
        const opt = document.createElement('option');
        opt.value = record.fields['Slot Time'];
        opt.textContent = record.fields['Slot Time'];
        dropdown.appendChild(opt);
      });
    }

    async function getTokenNumber(date) {
      const url = `https://api.airtable.com/v0/${baseId}/${bookingsTable}?filterByFormula=Date="${date}"`;
      const res = await fetch(url, { headers });
      const data = await res.json();
      return data.records.length + 1;
    }

    async function submitBooking(event) {
      event.preventDefault();

      const name = document.getElementById('name').value.trim();
      const contact = document.getElementById('contact').value.trim();
      const reason = document.getElementById('reason').value.trim();
      const date = document.getElementById('dateDropdown').value;
      const slot = document.getElementById('slotDropdown').value;
      const token = await getTokenNumber(date);
      const timestamp = new Date().toLocaleString('en-IN');

      const body = JSON.stringify({
        records: [{
          fields: {
            'Timestamp': timestamp,
            'Patient Name': name,
            'Slot Time': slot,
            'Date': date,
            'Reason': reason,
            'Contact': contact,
            'Token': token,
            'Reminder Sent': ''
          }
        }]
      });

      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${bookingsTable}`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          'Content-Type': 'application/json'
        },
        body
      });

      if (res.ok) {
        document.getElementById('bookingForm').style.display = 'none';
        document.getElementById('confirmation').style.display = 'block';
        document.getElementById('confirmation').innerHTML = `
          <h3>âœ… Booking Confirmed!</h3>
          <p>Your Token Number is: <strong>#${token}</strong></p>
          <p>Date: ${date} | Slot: ${slot}</p>
        `;
      } else {
        alert("Failed to save. Try again.");
      }
    }

    document.getElementById('dateDropdown').addEventListener('change', function() {
      fetchTimeSlots(this.value);
    });

    document.getElementById('bookingForm').addEventListener('submit', submitBooking);
    document.addEventListener('DOMContentLoaded', fetchAvailableDates);
  </script>
</body>
</html>
