<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Apartments • Admin</title>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="stylesheet" href="./styles.css">
<meta name="theme-color" content="#111"/>
<style>
  :root{--max:1100px}
  body{background:#f8f9fa}
  main{max-width:var(--max);margin:16px auto;padding:16px}
  .logout{position:fixed;right:14px;top:14px;z-index:9;padding:10px 14px;border:0;border-radius:12px;font-weight:700;background:#111;color:#fff}

  /* Polished header */
  .card{background:#fff;border-radius:18px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
  .hero{position:relative;padding:0;overflow:hidden;border-radius:18px}
  .banner{width:100%;height:180px;object-fit:cover;display:block}
  @media(max-width:560px){.banner{height:140px}}
  .hero-overlay{position:absolute;inset:0;display:flex;align-items:flex-end;padding:14px;background:linear-gradient(to bottom,rgba(0,0,0,0) 55%,rgba(0,0,0,.38))}
  .logo{position:absolute;top:12px;left:12px;width:56px;height:56px;border-radius:999px;background:#fff;padding:8px;box-shadow:0 6px 20px rgba(0,0,0,.18)}
  .hero-title{margin-left:80px;margin-bottom:6px;font-weight:800;font-size:20px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.35)}
  .hero,.logo,.hero-title{animation:fade .35s ease-out both}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  .grid2{display:grid;grid-template-columns:1.2fr 1fr;gap:12px}
  @media(max-width:1000px){.grid2{grid-template-columns:1fr}}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:560px){.grid{grid-template-columns:1fr}}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .muted{color:#666}
  input,select,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;font-size:15px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px;vertical-align:top}
  .btn{padding:10px 14px;border:0;border-radius:12px;font-weight:700;background:#111;color:#fff;cursor:pointer;text-decoration:none;text-align:center}
  .pill{background:#eee;border-radius:999px;padding:4px 10px;display:inline-block}
</style>
</head><body>
<button class="logout" onclick="sessionStorage.clear();location.href='./index.html'">Logout</button>

<main>
  <div class="card hero">
    <img class="banner" src="./assets/apartments_banner.png" alt="Apartments">
    <div class="hero-overlay">
      <img class="logo" src="./assets/logo.png" onerror="this.src='./assets/admin.png'">
      <div class="hero-title">Admin Console</div>
    </div>
  </div>

  <!-- Quick Links -->
  <div class="card" style="margin-top:12px">
    <div class="grid">
      <a class="btn" href="./residents.html">Residents</a>
      <a class="btn" href="./guards.html">Guards</a>
      <a class="btn" href="./committee.html">Committee</a>
      <a class="btn" href="./reset.html">Reset / Cache Tools</a>
    </div>
  </div>

  <div class="grid2" style="margin-top:12px">
    <!-- LEFT: Complaints Ops -->
    <section class="card">
      <div class="row" style="align-items:center;justify-content:space-between">
        <h2 style="margin:0">Complaints Operations</h2>
        <div class="row">
          <select id="c_filter"><option value="">All</option><option>Open</option><option>In Progress</option><option>Closed</option></select>
          <input id="c_search" placeholder="Search flat/category/text" style="max-width:240px">
          <button class="btn" id="c_export">Export CSV</button>
        </div>
      </div>
      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead><tr><th>#</th><th>Flat</th><th>When</th><th>Category</th><th>Priority</th><th>Status</th><th>Assignee</th><th>Details</th><th>Actions</th></tr></thead>
          <tbody id="c_tbody"></tbody>
        </table>
        <div id="c_empty" class="muted">No complaints yet.</div>
      </div>
    </section>

    <!-- RIGHT: Post Notice / Stats -->
    <aside class="card">
      <h2 style="margin:0 0 8px">Quick Notice</h2>
      <div class="grid">
        <label>Title <input id="n_title" placeholder="e.g., Lift maintenance"></label>
        <label>Audience
          <select id="n_aud"><option value="All">All Residents</option><option>Block A</option><option>Block B</option><option>Block C</option></select>
        </label>
        <label style="grid-column:1/-1">Message
          <textarea id="n_msg" rows="4" placeholder="Short message..."></textarea>
        </label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="n_add">Publish</button>
        <button class="btn" id="n_export">Export Notices CSV</button>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:14px 0">

      <h2 style="margin:0 0 8px">Today Overview</h2>
      <div class="row" style="flex-wrap:wrap">
        <span class="pill">Visitors: <b id="s_vis">0</b></span>
        <span class="pill">Deliveries: <b id="s_del">0</b></span>
        <span class="pill">Open Complaints: <b id="s_open">0</b></span>
        <span class="pill">Notices Posted: <b id="s_not">0</b></span>
      </div>
    </aside>
  </div>

  <!-- Data Exports -->
  <div class="card" style="margin-top:12px">
    <h2 style="margin:0 0 8px">Export / Backup</h2>
    <div class="grid">
      <button class="btn" id="x_vis">Visitors (Today)</button>
      <button class="btn" id="x_del">Deliveries (All)</button>
      <button class="btn" id="x_compl">Complaints (All)</button>
      <button class="btn" id="x_not">Notices (All)</button>
    </div>
  </div>
</main>

<script>
const K={notices:"apt_notices", complaints:"apt_complaints", visits:"apt_visits", deliveries:"apt_deliveries"};
const $=id=>document.getElementById(id);
const jget=k=>JSON.parse(localStorage.getItem(k)||"[]");
const jset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const ymd=()=>new Date().toISOString().slice(0,10);
const csv=(rows,heads,name)=>{const out=[heads.join(",")];rows.forEach(r=>out.push(heads.map(h=>`"${String(r[h]??"").replace(/"/g,'""')}"`).join(",")));const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([out.join("\n")],{type:"text/csv"}));a.download=name;a.click();};
const uid=()=>Math.random().toString(36).slice(2,9);

// Complaints Ops
function renderComplaints(){
  const q=(c_search.value||"").toLowerCase(), f=c_filter.value||"";
  let rows=jget(K.complaints).slice().sort((a,b)=>b.ts-a.ts);
  if(f) rows=rows.filter(r=>r.status===f);
  rows=rows.filter(r=> (r.flat||"").toLowerCase().includes(q) || (r.cat||"").toLowerCase().includes(q) || (r.desc||"").toLowerCase().includes(q) );
  c_tbody.innerHTML=""; c_empty.style.display = rows.length? "none":"block";
  rows.forEach((r,i)=>{
    const t=new Date(r.ts).toLocaleString([], {month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${r.flat||"—"}</td>
      <td>${t}</td>
      <td>${r.cat}</td>
      <td>${r.priority}</td>
      <td><select onchange="setStatus('${r.id}',this.value)">
            <option${r.status==="Open"?" selected":""}>Open</option>
            <option${r.status==="In Progress"?" selected":""}>In Progress</option>
            <option${r.status==="Closed"?" selected":""}>Closed</option>
          </select></td>
      <td><input value="${r.assign||""}" onchange="setAssign('${r.id}',this.value)" placeholder="e.g., Vendor/Staff"/></td>
      <td>${r.desc||""}</td>
      <td class="row">
        <button class="btn" onclick="closeC('${r.id}')">Close</button>
        <button class="btn" onclick="delC('${r.id}')">Delete</button>
      </td>`;
    c_tbody.appendChild(tr);
  });
}
window.setStatus=(id,val)=>{ const arr=jget(K.complaints); const i=arr.findIndex(x=>x.id===id); if(i>-1){ arr[i].status=val; jset(K.complaints,arr); renderStats(); } };
window.setAssign=(id,val)=>{ const arr=jget(K.complaints); const i=arr.findIndex(x=>x.id===id); if(i>-1){ arr[i].assign=val; jset(K.complaints,arr); } };
window.closeC=(id)=>{ const arr=jget(K.complaints); const i=arr.findIndex(x=>x.id===id); if(i>-1){ arr[i].status="Closed"; jset(K.complaints,arr); renderComplaints(); renderStats(); } };
window.delC=(id)=>{ let arr=jget(K.complaints); arr=arr.filter(x=>x.id!==id); jset(K.complaints,arr); renderComplaints(); renderStats(); };
$("c_export").onclick=()=>{ const rows=jget(K.complaints); csv(rows,["id","flat","cat","priority","desc","status","assign","ts"],"Complaints.csv"); };
$("c_filter").addEventListener("change",renderComplaints);
$("c_search").addEventListener("input",renderComplaints);

// Notices
function renderNoticesCount(){ s_not.textContent = jget(K.notices).length; }
$("n_add").onclick=()=>{
  const title=n_title.value.trim(), msg=n_msg.value.trim(), aud=n_aud.value;
  if(!title||!msg){ alert("Title and Message required."); return; }
  const arr=jget(K.notices); arr.unshift({id:uid(),title,msg,aud,ts:Date.now()}); jset(K.notices,arr);
  n_title.value=n_msg.value=""; renderNoticesCount();
};
$("n_export").onclick=()=>{ const rows=jget(K.notices); csv(rows,["id","title","msg","aud","ts"],"Notices.csv"); };

// Stats + Exports
function renderStats(){
  const today = ymd();
  const vis = jget(K.visits).filter(v=>new Date(v.ts).toISOString().slice(0,10)===today).length;
  const del = jget(K.deliveries).filter(v=>new Date(v.ts).toISOString().slice(0,10)===today).length;
  const open = jget(K.complaints).filter(c=>c.status!=="Closed").length;
  s_vis.textContent=vis; s_del.textContent=del; s_open.textContent=open; renderNoticesCount();
}
$("x_vis").onclick=()=>{ const rows=jget(K.visits).filter(v=>new Date(v.ts).toISOString().slice(0,10)===ymd()).map(({photo,...x})=>x); csv(rows,["id","flat","name","phone","purpose","ts"],"Visitors_Today.csv"); };
$("x_del").onclick=()=>{ const rows=jget(K.deliveries).map(({photo,...x})=>x); csv(rows,["id","flat","from","ts","status"],"Deliveries_All.csv"); };
$("x_compl").onclick=()=>{ const rows=jget(K.complaints); csv(rows,["id","flat","cat","priority","desc","status","assign","ts"],"Complaints_All.csv"); };
$("x_not").onclick=()=>{ const rows=jget(K.notices); csv(rows,["id","title","msg","aud","ts"],"Notices_All.csv"); };

// Init
if("serviceWorker" in navigator){navigator.serviceWorker.register("./sw.js").catch(()=>{});}
renderComplaints(); renderStats();
</script>
</body></html>
