<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Coordinator · School Demo</title>
  <link rel="stylesheet" href="styles.css">
<script type="module" src="ui.js"></script>
</head>
<body class="dark">
  <div class="wrapper">
    <section class="accent-teal">
      <div class="glass header">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div class="h1">Coordinator Panel</div>
          <div class="row">
            <a class="btn" href="index.html">PIN</a>
            <button class="btn btn-gradient" onclick="toggleTheme()">Theme</button>
          </div>
        </div>
        <div class="text-dim">Manage timetable and broadcast</div>
      </div>
    </section>

    <div class="tabs mt-16">
      <div class="tab-list">
        <button class="tab-btn" data-tab="c-setup" aria-selected="true">Class Setup</button>
        <button class="tab-btn" data-tab="c-tt">Timetable</button>
        <button class="tab-btn" data-tab="c-bcast">Broadcast</button>
        <button class="tab-btn" data-tab="c-data">Data</button>
      </div>
    </div>

    <div class="tab-panels">
      <!-- Setup -->
      <div class="tab-panel active" id="c-setup">
        <section class="accent-violet">
          <div class="glass">
            <div class="h2">Choose Class</div>
            <div class="grid cols-2">
              <input id="cc-class" class="input" placeholder="Class e.g., 5">
              <input id="cc-sec" class="input" placeholder="Section e.g., A">
            </div>
            <div class="mt-12"><button class="btn btn-indigo" id="ccSave">Save Meta</button></div>
            <div id="ccMsg" class="text-dim mt-12"></div>
          </div>
        </section>
      </div>

      <!-- Timetable -->
      <div class="tab-panel" id="c-tt">
        <section class="accent-indigo">
          <div class="glass">
            <div class="h2">Add / Replace Period</div>
            <div class="grid cols-3">
              <select id="tt-day" class="input">
                <option>Mon</option><option>Tue</option><option>Wed</option>
                <option>Thu</option><option>Fri</option><option>Sat</option>
              </select>
              <input id="tt-period" class="input" placeholder="Period # 1–12">
              <input id="tt-subj" class="input" placeholder="Subject">
            </div>
            <input id="tt-teacher" class="input mt-12" placeholder="Teacher name">
            <input id="tt-room" class="input mt-12" placeholder="Room (optional)">
            <div class="mt-12"><button class="btn btn-indigo" id="ttAdd">Add / Update</button></div>

            <div class="h2 mt-16">Class Timetable</div>
            <div id="ttList" class="mt-12"></div>

            <div class="row mt-16">
              <button class="btn" id="ttExport">Export CSV</button>
              <button class="btn" id="ttClear">Clear Class Timetable</button>
            </div>
          </div>
        </section>
      </div>

      <!-- Broadcast -->
      <div class="tab-panel" id="c-bcast">
        <section class="accent-teal">
          <div class="glass">
            <div class="h2">Broadcast to Parents</div>
            <textarea id="bcText" class="input" placeholder="Message..."></textarea>
            <div class="mt-12"><button class="btn btn-teal" id="bcSend">Send</button></div>
            <div id="bcList" class="mt-12"></div>
          </div>
        </section>
      </div>

      <!-- Data -->
      <div class="tab-panel" id="c-data">
        <section class="accent-rose">
          <div class="glass">
            <div class="h2">Data Tools</div>
            <div class="text-dim">Local-only demo tools.</div>
            <div class="row mt-12">
              <button class="btn btn-rose" id="backup">Backup (JSON)</button>
              <button class="btn btn-rose" id="restore">Restore</button>
            </div>
            <input id="restoreFile" class="input mt-12" type="file" accept="application/json">
          </div>
        </section>
      </div>
    </div>
  </div>

  <script type="module" src="ui.js"></script>
  <script>
  const db = {
    get(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } },
    set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  };
  const scopeKey='coordScope';
  document.getElementById('ccSave').onclick = ()=>{
    const v={cls:cc('cc-class'), sec:cc('cc-sec')};
    db.set(scopeKey,v);
    gid('ccMsg').textContent='Saved.';
    renderTT();
  };
  function loadScope(){
    const v=db.get(scopeKey,{cls:'',sec:''});
    gid('cc-class').value=v.cls; gid('cc-sec').value=v.sec;
  }
  function keyTT(){ const s=db.get(scopeKey,{cls:'',sec:''}); return `tt:${s.cls}-${s.sec}`; }
  function gid(id){ return document.getElementById(id); }
  function cc(id){ return gid(id).value.trim(); }

  // Timetable
  function renderTT(){
    const arr = db.get(keyTT(),[]);
    gid('ttList').innerHTML = arr.map(t=>`<div class="glass"><b>${t.day} P${t.period}</b> · ${t.subject} — <span class="text-dim">${t.teacher}${t.room?(', Room '+t.room):''}</span></div>`).join('') || '<div class="text-dim">No entries yet.</div>';
  }
  gid('ttAdd').onclick = ()=>{
    if(!cc('cc-class')||!cc('cc-sec')){ alert('Save Class Setup first.'); return; }
    const rec={day:cc('tt-day'), period:cc('tt-period'), subject:cc('tt-subj'), teacher:cc('tt-teacher'), room:cc('tt-room')};
    const arr=db.get(keyTT(),[]);
    const idx=arr.findIndex(x=>x.day===rec.day && x.period===rec.period);
    if(idx>-1) arr[idx]=rec; else arr.push(rec);
    db.set(keyTT(),arr); renderTT();
  };
  gid('ttClear').onclick=()=>{ db.set(keyTT(),[]); renderTT(); };
  gid('ttExport').onclick=()=>{
    const arr=db.get(keyTT(),[]);
    let csv='Day,Period,Subject,Teacher,Room\n';
    arr.forEach(r=> csv+=`${r.day},${r.period},${r.subject},${r.teacher},${r.room||''}\n`);
    const blob = new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='timetable.csv'; a.click();
  };

  // Broadcast (demo)
  gid('bcSend').onclick=()=>{
    const txt=gid('bcText').value.trim(); if(!txt) return;
    const arr=db.get('broadcasts',[]); arr.unshift({time:Date.now(), text:txt}); db.set('broadcasts',arr);
    gid('bcText').value=''; renderBC();
  };
  function renderBC(){
    const arr=db.get('broadcasts',[]);
    gid('bcList').innerHTML = arr.map(b=>`<div class="glass"><span class="text-dim">${new Date(b.time).toLocaleString()}</span><div class="mt-8">${b.text}</div></div>`).join('') || '<div class="text-dim">No broadcasts.</div>';
  }

  // Backup/Restore
  gid('backup').onclick=()=>{
    const all={localStorage: {...localStorage}};
    const blob=new Blob([JSON.stringify(all,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='school-backup.json'; a.click();
  };
  gid('restore').onclick=()=> gid('restoreFile').click();
  gid('restoreFile').addEventListener('change', async (e)=>{
    const file=e.target.files?.[0]; if(!file) return;
    const text=await file.text();
    const json=JSON.parse(text);
    if(json.localStorage){
      Object.entries(json.localStorage).forEach(([k,v])=> localStorage.setItem(k,v));
      alert('Restore complete (local).');
      renderTT(); renderBC(); loadScope();
    }
  });

  loadScope(); renderTT(); renderBC();
  </script>
</body>
</html>
