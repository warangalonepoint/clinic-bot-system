<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Onestop Apartments</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#111111">
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --text:#0f122a; --muted:#6b7280; --accent:#111; --radius:18px;
  --shadow:0 10px 30px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 -apple-system,system-ui,Inter,Segoe UI,Roboto,Arial}
.wrap{max-width:780px;margin:0 auto;padding:18px 14px 64px}
.hero{background:#eaf2ff;border-radius:22px;padding:16px;box-shadow:inset 0 0 0 1px #dbe3ff}
h1{font-size:28px;margin:12px 0 6px}
.sub{color:var(--muted);margin:0 0 12px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-top:14px}
label{display:block;margin:10px 0 6px;font-weight:700;font-size:14px;color:#111827}
select,input,button{
  width:100%;padding:14px 12px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;font-size:16px;outline:none
}
select:focus,input:focus{border-color:#111;box-shadow:0 0 0 3px rgba(17,17,17,.08)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn{margin-top:14px;background:#111;color:#fff;border:0;border-radius:14px;padding:14px 12px;font-weight:800}
.btn:disabled{opacity:.5}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f4f4f5;border:1px solid #e4e4e7;padding:2px 6px;border-radius:8px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.2);display:none;z-index:9}
.list{margin-top:8px;border-radius:14px;overflow:hidden;box-shadow:var(--shadow);background:#fff}
.item{display:grid;grid-template-columns:1fr auto auto;gap:8px;padding:12px 14px;border-top:1px solid #f1f5f9}
.item:first-child{border-top:0}
.badge{font-size:12px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;border-radius:999px;padding:4px 8px}
.empty{color:var(--muted);text-align:center;padding:16px}
footer{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.8);backdrop-filter:blur(10px);border-top:1px solid #eee;padding:10px 14px}
.install{display:flex;gap:10px}
a{color:#6c3ad6;text-decoration:none;font-weight:600}
</style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Onestop Apartments</h1>
      <p class="sub">Sprint 0 — Offline demo. Book amenities. Install to Home Screen.</p>
    </div>

    <!-- Booking card -->
    <div class="card">
      <h3 style="margin:0 0 8px">Book an Amenity</h3>
      <label for="amenity">Amenity</label>
      <select id="amenity">
        <option value="gym">Gym (30 min, cap 8)</option>
        <option value="pool">Pool (1 hr, cap 15)</option>
        <option value="clubhouse">Clubhouse (2 hr block, cap 1)</option>
      </select>

      <div class="row">
        <div>
          <label for="date">Date</label>
          <select id="date"></select>
        </div>
        <div>
          <label for="slot">Time Slot</label>
          <select id="slot"><option>Select a date</option></select>
        </div>
      </div>

      <label for="name">Resident Name</label>
      <input id="name" placeholder="Full name" autocomplete="name"/>

      <label for="phone">Phone</label>
      <input id="phone" placeholder="10-digit number" inputmode="numeric" maxlength="10"/>

      <button id="confirm" class="btn" disabled>Confirm Booking</button>
      <div class="toast" id="toast"></div>
    </div>

    <!-- My bookings -->
    <div class="card">
      <h3 style="margin:0 0 8px">My Bookings</h3>
      <div id="myBookings" class="list"></div>
      <div class="empty" id="emptyMy">No bookings yet.</div>
      <div style="margin-top:10px">
        <button id="export" class="btn" style="background:#0f766e">Export CSV</button>
        <button id="clear" class="btn" style="background:#991b1b">Clear All</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="install">
      <div>Install: Tap <span class="kbd">⋮</span> → <b>Add to Home screen</b></div>
      <div style="margin-left:auto"><a href="#" id="reload">Refresh</a></div>
    </div>
  </footer>

<script>
// ---- Config (local demo) ----
const AMENITIES = {
  gym:       { label:"Gym",       interval:30, cap:8,  start:"06:00", end:"22:00" },
  pool:      { label:"Pool",      interval:60, cap:15, start:"07:00", end:"20:00" },
  clubhouse: { label:"Clubhouse", interval:120,cap:1,  start:"08:00", end:"22:00" },
};
const DAYS_AHEAD = 7; // today + next 6
const LS_KEY = 'apt_bookings_v1'; // local demo storage

// ---- Elements ----
const amenityEl = document.getElementById('amenity');
const dateEl    = document.getElementById('date');
const slotEl    = document.getElementById('slot');
const nameEl    = document.getElementById('name');
const phoneEl   = document.getElementById('phone');
const confirmEl = document.getElementById('confirm');
const toastEl   = document.getElementById('toast');
const myListEl  = document.getElementById('myBookings');
const emptyMyEl = document.getElementById('emptyMy');

document.getElementById('reload').onclick = ()=>location.reload();

// ---- Utils ----
const pad = n=> String(n).padStart(2,'0');
const toISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const pretty = iso => {
  const [y,m,d]=iso.split('-').map(Number);
  return new Date(y,m-1,d).toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});
};
const to12h = (h,m) => {
  let hh = h%12 || 12;
  const ampm = h<12 ? 'AM' : 'PM';
  return `${pad(hh)}:${pad(m)} ${ampm}`;
};
function showToast(msg, ms=1800){
  toastEl.textContent = msg; toastEl.style.display='block';
  clearTimeout(window.__t); window.__t = setTimeout(()=> toastEl.style.display='none', ms);
}
function readAll(){
  try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; }
}
function writeAll(rows){
  localStorage.setItem(LS_KEY, JSON.stringify(rows));
}
function nextToken(amenity, date){
  const rows = readAll().filter(r=>r.amenity===amenity && r.date===date);
  return rows.length + 1;
}

// ---- Build dates ----
(function initDates(){
  const today = new Date();
  dateEl.innerHTML = '';
  for(let i=0;i<DAYS_AHEAD;i++){
    const d = new Date(today); d.setDate(today.getDate()+i);
    const iso = toISO(d);
    dateEl.add(new Option(pretty(iso), iso));
  }
})();

// ---- Build slots based on amenity/date & current bookings ----
function buildSlots(){
  const a = AMENITIES[amenityEl.value];
  const date = dateEl.value;
  slotEl.innerHTML = '';
  if(!a || !date){ slotEl.add(new Option('Select a date', '')); slotEl.disabled = true; return; }

  const [sH,sM] = a.start.split(':').map(Number);
  const [eH,eM] = a.end.split(':').map(Number);
  const startMin = sH*60 + sM;
  const endMin   = eH*60 + eM;

  // count existing bookings per slot
  const rows = readAll().filter(r=>r.amenity===amenityEl.value && r.date===date);
  const countByTime = rows.reduce((m,r)=> (m[r.time]=(m[r.time]||0)+1, m), {});

  let added=0;
  for(let t=startMin; t<endMin; t += a.interval){
    const h = Math.floor(t/60), m = t%60;
    const label = to12h(h,m);
    const c = countByTime[label] || 0;
    if(c < a.cap){ // still capacity left
      const opt = new Option(label, label);
      slotEl.add(opt); added++;
    }
  }
  if(added===0){ slotEl.add(new Option('No slots available', '')); slotEl.disabled = true; }
  else { slotEl.disabled = false; }
  validate();
}

// ---- Validation ----
function validate(){
  const ok = nameEl.value.trim().length>=2 &&
             /^\d{10}$/.test(phoneEl.value.trim()) &&
             !!dateEl.value && !!slotEl.value;
  confirmEl.disabled = !ok;
}

// ---- Confirm booking ----
async function confirmBooking(){
  const amenity = amenityEl.value;
  const aInfo = AMENITIES[amenity];
  const rec = {
    amenity,
    amenityLabel: aInfo.label,
    date: dateEl.value,
    time: slotEl.value,
    name: nameEl.value.trim(),
    phone: phoneEl.value.trim(),
    token: nextToken(amenity, dateEl.value),
    ts: Date.now()
  };

  // ensure cap not exceeded (race-safe locally)
  const existing = readAll();
  const sameSlot = existing.filter(r=> r.amenity===rec.amenity && r.date===rec.date && r.time===rec.time);
  if(sameSlot.length >= aInfo.cap){
    showToast('That slot just filled. Pick another.'); buildSlots(); return;
  }

  existing.push(rec); writeAll(existing);
  alert(`Booking confirmed!\n\nAmenity: ${aInfo.label}\nDate: ${pretty(rec.date)}\nTime: ${rec.time}\nToken: ${rec.token}`);
  // reset + rebuild
  nameEl.value=''; phoneEl.value='';
  buildSlots(); validate(); renderMy();
}

// ---- My Bookings list ----
function renderMy(){
  const rows = readAll().sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));
  myListEl.innerHTML = '';
  if(rows.length===0){ emptyMyEl.style.display='block'; return; }
  emptyMyEl.style.display='none';
  for(const r of rows){
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `
      <div><b>${r.amenityLabel}</b><div class="sub" style="margin-top:4px">${pretty(r.date)} · ${r.time}</div></div>
      <div class="badge">Token ${r.token}</div>
      <div><button class="btn" style="padding:8px 10px;background:#ef4444" data-del="${r.ts}">Delete</button></div>
    `;
    myListEl.appendChild(div);
  }
  myListEl.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick = () => {
      const ts = Number(b.getAttribute('data-del'));
      writeAll(readAll().filter(x=>x.ts!==ts));
      buildSlots(); renderMy();
    };
  });
}

// ---- CSV export ----
function toCSV(rows){
  const header = ['amenity','date','time','token','name','phone'];
  const esc = s => /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  const lines = [header.join(',')];
  for(const r of rows){
    lines.push([r.amenityLabel, r.date, r.time, r.token, r.name, r.phone].map(v=>esc(String(v??''))).join(','));
  }
  return lines.join('\n');
}
function downloadCSV(){
  const rows = readAll();
  if(!rows.length){ showToast('Nothing to export'); return; }
  const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `apt_bookings_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// ---- Wire events ----
amenityEl.addEventListener('change', buildSlots);
dateEl.addEventListener('change', buildSlots);
slotEl.addEventListener('change', validate);
nameEl.addEventListener('input', validate);
phoneEl.addEventListener('input', validate);
confirmEl.addEventListener('click', confirmBooking);
document.getElementById('export').addEventListener('click', downloadCSV);
document.getElementById('clear').addEventListener('click', ()=>{
  if(confirm('Clear ALL local bookings on this device?')){ localStorage.removeItem(LS_KEY); buildSlots(); renderMy(); }
});

// ---- Init ----
buildSlots(); renderMy();

// ---- PWA: register service worker ----
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
