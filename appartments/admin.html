<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin • Onestop Apartments</title>
<link rel="manifest" href="./manifest.webmanifest"/><link rel="stylesheet" href="./styles.css"/>
<meta name="theme-color" content="#111"/>
<style>
  main{max-width:960px;margin:12px auto;padding:12px}
  .card{background:#fff;border-radius:18px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
  .banner{width:100%;border-radius:22px;display:block}
  .logout{position:fixed;right:14px;top:14px;z-index:9999;padding:10px 14px;border:0;border-radius:12px;font-weight:700;background:#111;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,.15)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px} @media(max-width:740px){.grid{grid-template-columns:1fr}}
  .btn{padding:12px 16px;border:0;border-radius:12px;font-weight:700;cursor:pointer}
  .btn-dark{background:#111;color:#fff}
  .btn-soft{background:#f3f3f3}
  code{background:#f5f5f5;padding:2px 6px;border-radius:8px}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px;vertical-align:top}
</style>
</head><body>
<script>(function(){const r=sessionStorage.getItem("apts_role");if(r!=="admin")location.replace("./index.html");})();</script>
<button class="logout" onclick="sessionStorage.clear();location.href='./index.html'">Logout</button>

<main>
  <img class="banner" src="./assets/banner.png" alt="Onestop Apartments"/>

  <!-- PINs -->
  <div class="card" style="margin-top:14px">
    <h2 style="margin:0 0 10px">Admin Panel</h2>
    <p style="margin:0 0 8px;color:#666">Current PINs from <code>pins.json</code>:</p>
    <div id="pins" style="font-family:ui-monospace,monospace"></div>
    <div class="grid" style="margin-top:12px">
      <a class="btn btn-dark" href="./residents.html">Open Residents</a>
      <a class="btn btn-dark" href="./guards.html">Open Guards</a>
      <a class="btn btn-dark" href="./committee.html">Open Committee</a>
      <a class="btn btn-soft" href="./index.html">Back to PIN Page</a>
    </div>
  </div>

  <!-- Backups / Exports -->
  <div class="card" style="margin-top:14px">
    <h2 style="margin:0 0 10px">Local Backup & Export</h2>
    <p style="color:#666;margin:0 0 10px">Exports data saved on this device (for demo/offline). Live version will export from Airtable.</p>
    <div class="grid">
      <button class="btn btn-soft" id="expVisitors">Export Visitor Log CSV</button>
      <button class="btn btn-soft" id="expBookings">Export Bookings CSV</button>
      <button class="btn btn-soft" id="expComplaints">Export Complaints CSV</button>
      <button class="btn btn-soft" id="expPre">Export Pre-Approvals CSV</button>
      <button class="btn btn-soft" id="expNotices">Export Notices CSV</button>
      <button class="btn btn-soft" id="clearAll">Clear ALL Local Data</button>
    </div>
  </div>

  <!-- Tools -->
  <div class="card" style="margin-top:14px">
    <h2 style="margin:0 0 10px">Tools</h2>
    <div class="grid">
      <a class="btn btn-soft" href="./reset.html">Reset Cache / SW</a>
      <button class="btn btn-soft" id="install">Install App (PWA)</button>
      <button class="btn btn-soft" id="version">Show Cache Version</button>
    </div>
    <div id="verOut" style="margin-top:8px;color:#666"></div>
  </div>
</main>

<script>
if("serviceWorker" in navigator){navigator.serviceWorker.register("./sw.js").catch(()=>{});}

/* ----- Load PINs ----- */
fetch("./pins.json",{cache:"no-store"}).then(r=>r.json()).then(p=>{
  const row=(k)=>`<div>${k.padEnd(10,' ')} : <strong>${p[k]}</strong></div>`;
  document.getElementById("pins").innerHTML = row("residents")+row("guards")+row("committee")+row("admin");
}).catch(()=>{document.getElementById("pins").textContent="Unable to load pins.json";});

/* ----- Export helpers ----- */
function dlCSV(rows, headers, fname){
  const out=[headers.join(",")];
  rows.forEach(r=>out.push(headers.map(h=>`"${String(r[h]??"").replace(/"/g,'""')}"`).join(",")));
  const blob=new Blob([out.join("\n")],{type:"text/csv"}), a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download=fname; a.click();
}
const get=(k)=>{try{return JSON.parse(localStorage.getItem(k)||"[]")}catch{return[]}};
const K={ visitors:"apts_visitors_v2", bookings:"apts_bookings", complaints:"apts_complaints", pre:"apts_pre", notices:"apts_committee_notices", polls:"apts_committee_polls" };

document.getElementById('expVisitors').onclick=()=>{
  const rows=get(K.visitors); if(!rows.length){alert("No visitor data");return;}
  dlCSV(rows.map(r=>({Time:new Date(r.ts).toLocaleString(),Type:r.type,Flat:r.flat,Name:r.name,Phone:r.phone,QR:r.qr||"",HasPhoto:r.photo?"YES":"NO"})),
        ["Time","Type","Flat","Name","Phone","QR","HasPhoto"], "Visitor-Log.csv");
};
document.getElementById('expBookings').onclick=()=>{
  const rows=get(K.bookings); if(!rows.length){alert("No bookings");return;}
  dlCSV(rows, ["date","slot","amenity","name","phone"], "Bookings.csv");
};
document.getElementById('expComplaints').onclick=()=>{
  const rows=get(K.complaints); if(!rows.length){alert("No complaints");return;}
  dlCSV(rows.map(r=>({Time:new Date(r.ts).toLocaleString(),Cat:r.cat,Pri:r.pri,Subject:r.sub,Status:r.status,Name:r.name})),
        ["Time","Cat","Pri","Subject","Status","Name"], "Complaints.csv");
};
document.getElementById('expPre').onclick=()=>{
  const rows=get(K.pre); if(!rows.length){alert("No pre-approvals");return;}
  dlCSV(rows, ["type","flat","name","phone","date","time","token","ts"], "PreApprovals.csv");
};
document.getElementById('expNotices').onclick=()=>{
  const rows=get(K.notices); if(!rows.length){alert("No notices");return;}
  dlCSV(rows.map(r=>({Title:r.title,Body:r.body,Audience:r.aud,Time:new Date(r.ts).toLocaleString()})),
        ["Title","Body","Audience","Time"], "Notices.csv");
};
document.getElementById('clearAll').onclick=()=>{
  if(confirm("Clear ALL local demo data on this device?")){
    [K.visitors,K.bookings,K.complaints,K.pre,K.notices,K.polls].forEach(k=>localStorage.removeItem(k));
    alert("Cleared.");
  }
};

/* ----- PWA install prompt ----- */
let deferred=null;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferred=e; });
document.getElementById('install').onclick=()=>{ if(deferred){ deferred.prompt(); deferred=null; } else { alert("Install prompt not available yet. Use browser menu → Add to Home screen."); } };

/* ----- Cache version (naive) ----- */
document.getElementById('version').onclick=async()=>{
  try{
    const sw = await navigator.serviceWorker?.getRegistration();
    const ver = (await caches.keys()).join(", ");
    document.getElementById('verOut').textContent = "SW: "+(sw?'active':'none')+" | Caches: "+ver;
  }catch{ document.getElementById('verOut').textContent="Version info not available"; }
};
</script>
</body></html>
