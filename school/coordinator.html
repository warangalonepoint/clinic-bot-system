<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Coordinator • School</title>
  <link rel="stylesheet" href="./styles.css">
  <style>
    .wrap{max-width:1100px;margin:20px auto;padding:12px}
    .hero{position:relative;border-radius:22px;overflow:hidden}
    .banner{width:100%;height:210px;object-fit:cover;display:block}
    .hero-overlay{position:absolute;inset:0;display:flex;align-items:flex-end;
      padding:14px 18px;background:linear-gradient(180deg,rgba(0,0,0,0) 40%,rgba(0,0,0,.55))}
    .hero-title{color:#fff;font-weight:800;font-size:24px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .tablewrap{overflow:auto;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
  </style>
</head>
<body class="bg">
<main class="wrap">
  <div class="card hero">
    <img class="banner" src="./assets/banner.png" alt="School Banner">
    <div class="hero-overlay"><div class="hero-title">Coordinator Panel</div></div>
  </div>

  <div class="tabs">
    <button class="tab active" data-t="#t_timetable">Timetable</button>
    <button class="tab" data-t="#t_events">Events & Exams</button>
    <button class="tab" data-t="#t_notices">Notices (Moderate)</button>
    <button class="tab" data-t="#t_rosters">Class Rosters</button>
  </div>

  <!-- Timetable -->
  <section class="card" id="t_timetable">
    <div class="grid2">
      <label>Class <input id="tt_class" class="in" placeholder="e.g., 5"></label>
      <label>Section <input id="tt_section" class="in" placeholder="e.g., A"></label>
      <label>Day
        <select id="tt_day" class="in"><option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option><option>Fri</option><option>Sat</option></select>
      </label>
      <label>Period # <input id="tt_period" class="in" type="number" min="1" max="12" placeholder="1-12"></label>
      <label>Subject <input id="tt_subject" class="in" placeholder="Maths"></label>
      <label>Teacher ID <input id="tt_teacher" class="in" placeholder="T-42"></label>
      <label>Room <input id="tt_room" class="in" placeholder="302"></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="tt_add">Add / Update</button>
      <button class="btn" id="tt_export">Export CSV</button>
    </div>
    <div class="tablewrap">
      <table class="tbl"><thead><tr><th>#</th><th>Class</th><th>Day</th><th>Period</th><th>Subject</th><th>Teacher</th><th>Room</th><th>Action</th></tr></thead>
        <tbody id="tt_tbody"></tbody></table>
      <div id="tt_empty" class="muted">No entries.</div>
    </div>
  </section>

  <!-- Events -->
  <section class="card hidden" id="t_events">
    <div class="grid2">
      <label>Type <select id="ev_type" class="in"><option>Event</option><option>Exam</option></select></label>
      <label>Title <input id="ev_title" class="in" placeholder="Sports Day"></label>
      <label>Start <input id="ev_start" class="in" type="date"></label>
      <label>End <input id="ev_end" class="in" type="date"></label>
      <label class="span2">Notes <textarea id="ev_notes" class="in" placeholder="Details…"></textarea></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="ev_add">Add</button>
      <button class="btn" id="ev_export">Export CSV</button>
    </div>
    <div class="tablewrap">
      <table class="tbl"><thead><tr><th>#</th><th>Type</th><th>Title</th><th>Start</th><th>End</th><th>Notes</th><th>Action</th></tr></thead>
        <tbody id="ev_tbody"></tbody></table>
      <div id="ev_empty" class="muted">No items.</div>
    </div>
  </section>

  <!-- Notices -->
  <section class="card hidden" id="t_notices">
    <div class="row space">
      <h2 class="h2">Moderate Notices</h2>
      <input id="n_search" class="in" placeholder="Search…" style="max-width:260px">
    </div>
    <div class="tablewrap">
      <table class="tbl"><thead><tr><th>#</th><th>When</th><th>Title</th><th>Message</th><th>Audience</th><th>Author</th><th>Action</th></tr></thead>
        <tbody id="n_tbody"></tbody></table>
      <div id="n_empty" class="muted">No notices.</div>
    </div>
  </section>

  <!-- Rosters -->
  <section class="card hidden" id="t_rosters">
    <div class="grid2">
      <label>Class <input id="ro_class" class="in" placeholder="e.g., 5"></label>
      <label>Section <input id="ro_section" class="in" placeholder="e.g., A"></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="ro_load">Load</button>
      <button class="btn" id="ro_export">Export This Class</button>
    </div>
    <div class="tablewrap">
      <table class="tbl"><thead><tr><th>#</th><th>Name</th><th>Roll</th><th>Parent</th><th>Phone</th></tr></thead>
        <tbody id="ro_tbody"></tbody></table>
      <div id="ro_empty" class="muted">No students.</div>
    </div>
  </section>

  <div class="card">
    <div class="row">
      <button class="btn" onclick="logout()" style="flex:1">Logout</button>
      <a class="btn" href="./index.html" style="flex:1">Back to PIN</a>
    </div>
  </div>
</main>

<script>
  if(sessionStorage.getItem("school_role")!=="coordinator"){ location.replace("./index.html"); }
  const $=s=>document.querySelector(s);
  const jget=k=>JSON.parse(localStorage.getItem(k)||"[]");
  const jset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const csv=(rows,heads,name)=>{const out=[heads.join(",")];rows.forEach(r=>out.push(heads.map(h=>`"${String((r||{})[h]??"").replace(/"/g,'""')}"`).join(",")));const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([out.join("\n")],{type:"text/csv"}));a.download=name;a.click();};
  const uid=()=>Math.random().toString(36).slice(2,9);
  document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click",()=>{document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));t.classList.add("active");["t_timetable","t_events","t_notices","t_rosters"].forEach(id=>document.getElementById(id).classList.add("hidden"));document.querySelector(t.getAttribute("data-t")).classList.remove("hidden");}));

  // Timetable
  function rTT(){const rows=jget("sch_timetable").slice().sort((a,b)=>a.class.localeCompare(b.class)||a.section.localeCompare(b.section)||a.day.localeCompare(b.day)||(a.period-b.period));const tb=$("#tt_tbody");tb.innerHTML="";$("#tt_empty").style.display=rows.length?"none":"block";rows.forEach((r,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${r.class}-${r.section}</td><td>${r.day}</td><td>${r.period}</td><td>${r.subject}</td><td>${r.teacherId||""}</td><td>${r.room||""}</td><td><button class="btn" data-del="${r.id}">Del</button></td>`;tb.appendChild(tr);});tb.querySelectorAll("[data-del]").forEach(b=>b.addEventListener("click",()=>{jset("sch_timetable",jget("sch_timetable").filter(x=>x.id!==b.getAttribute("data-del")));rTT();}));}
  $("#tt_add").addEventListener("click",()=>{const row={id:uid(),class:$("#tt_class").value.trim(),section:$("#tt_section").value.trim(),day:$("#tt_day").value,period:Number($("#tt_period").value||0),subject:$("#tt_subject").value.trim(),teacherId:$("#tt_teacher").value.trim(),room:$("#tt_room").value.trim(),ts:Date.now()};if(!row.class||!row.section||!row.day||!row.period||!row.subject){alert("Fill required fields.");return;}let arr=jget("sch_timetable");const i=arr.findIndex(x=>x.class===row.class&&x.section===row.section&&x.day===row.day&&Number(x.period)===row.period);if(i>-1)arr[i]={...arr[i],...row,id:arr[i].id,ts:Date.now()};else arr.unshift(row);jset("sch_timetable",arr);rTT();});
  $("#tt_export").addEventListener("click",()=>{const rows=jget("sch_timetable");if(!rows.length){alert("No data.");return;}csv(rows,["id","class","section","day","period","subject","teacherId","room","ts"],"timetable.csv");});

  // Events
  function rEV(){const rows=jget("sch_events").slice().sort((a,b)=> (a.start||"").localeCompare(b.start||"")).reverse();const tb=$("#ev_tbody");tb.innerHTML="";$("#ev_empty").style.display=rows.length?"none":"block";rows.forEach((r,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${r.type}</td><td>${r.title}</td><td>${r.start}</td><td>${r.end||""}</td><td>${r.notes||""}</td><td><button class="btn" data-delev="${r.id}">Del</button></td>`;tb.appendChild(tr);});tb.querySelectorAll("[data-delev]").forEach(b=>b.addEventListener("click",()=>{jset("sch_events",jget("sch_events").filter(x=>x.id!==b.getAttribute("data-delev")));rEV();}));}
  $("#ev_add").addEventListener("click",()=>{const row={id:uid(),type:$("#ev_type").value,title:$("#ev_title").value.trim(),start:$("#ev_start").value,end:$("#ev_end").value,notes:$("#ev_notes").value.trim(),ts:Date.now()};if(!row.title||!row.start){alert("Title + Start required");return;}const arr=jget("sch_events");arr.unshift(row);jset("sch_events",arr);$("#ev_title").value="";$("#ev_notes").value="";rEV();});
  $("#ev_export").addEventListener("click",()=>{const rows=jget("sch_events");if(!rows.length){alert("No data.");return;}csv(rows,["id","type","title","start","end","notes","ts"],"events.csv");});

  // Notices
  function audienceLabel(a){if(!a)return"All";if(a.type==="All")return"All";if(a.type==="Class")return`Class ${a.class}`;if(a.type==="Section")return`Class ${a.class}-${a.section}`;return"—";}
  function rN(){const q=($("#n_search").value||"").toLowerCase();const rows=jget("sch_notices").filter(n=>(n.title||"").toLowerCase().includes(q)||(n.body||"").toLowerCase().includes(q)).sort((a,b)=>b.ts-a.ts);const tb=$("#n_tbody");tb.innerHTML="";$("#n_empty").style.display=rows.length?"none":"block";rows.forEach((n,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${new Date(n.ts).toLocaleString()}</td><td>${n.title}</td><td>${n.body||""}</td><td>${audienceLabel(n.audience)}</td><td>${n.author||"—"}</td><td><button class="btn" data-deln="${n.id}">Del</button></td>`;tb.appendChild(tr);});tb.querySelectorAll("[data-deln]").forEach(b=>b.addEventListener("click",()=>{jset("sch_notices",jget("sch_notices").filter(x=>x.id!==b.getAttribute("data-deln")));rN();}));}
  $("#n_search").addEventListener("input", rN);

  // Rosters
  function rRoster(){const cls=$("#ro_class").value.trim(),sec=$("#ro_section").value.trim();const rows=jget("sch_students").filter(s=>String(s.class||"")==cls&&String(s.section||"")==sec).sort((a,b)=> (a.roll||"").localeCompare(b.roll||""));const tb=$("#ro_tbody");tb.innerHTML="";$("#ro_empty").style.display=rows.length?"none":"block";rows.forEach((s,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${s.name||""}</td><td>${s.roll||""}</td><td>${s.parentName||""}</td><td>${s.parentPhone||""}</td>`;tb.appendChild(tr);});}
  $("#ro_load").addEventListener("click", rRoster);
  $("#ro_export").addEventListener("click",()=>{const cls=$("#ro_class").value.trim(),sec=$("#ro_section").value.trim();const rows=jget("sch_students").filter(s=>String(s.class||"")==cls&&String(s.section||"")==sec);if(!rows.length){alert("No data.");return;}csv(rows,["id","name","roll","class","section","parentName","parentPhone"],`roster_${cls}-${sec}.csv`);});

  function logout(){ sessionStorage.clear(); location.replace("./index.html"); }
  function init(){ rTT(); rEV(); rN(); }
  init();
</script>
</body>
</html>
