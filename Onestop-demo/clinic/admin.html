<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Admin · Onestop Clinic</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css?v=15">
</head>
<body>
  <div class="app-shell">
    <div class="header">
      <div class="brand-logo"></div>
      <div><div class="title">Admin</div><div class="subtitle">Bookings • Slots • Reminders</div></div>
    </div>

    <!-- Quick Links -->
    <div class="section glass">
      <h2>Quick Links</h2>
      <div style="display:flex;flex-wrap:wrap;gap:10px">
        <button class="btn btn-primary" onclick="location.href='./booking.html'">New Booking</button>
        <button class="btn btn-secondary" onclick="location.href='./doctor.html'">Doctor Panel</button>
        <button class="btn btn-secondary" onclick="location.href='./staff.html'">Staff</button>
        <button class="btn btn-secondary" onclick="location.href='./index.html'">Dashboard</button>
      </div>
    </div>

    <!-- New Booking (writes to Airtable) -->
    <div class="section glass">
      <h2>New Booking (Admin)</h2>

      <div class="row"><div class="label">Date</div><input id="b_date" type="date" class="input"></div>
      <div class="row"><div class="label">Time Slot</div><input id="b_slot" class="input" placeholder="e.g., 09:20 AM"></div>
      <div class="row"><div class="label">Patient Name</div><input id="b_name" class="input" placeholder="Full name"></div>
      <div class="row"><div class="label">Reason</div><input id="b_reason" class="input" placeholder="Reason for visit"></div>
      <div class="row"><div class="label">Contact</div><input id="b_phone" class="input" placeholder="+91…"></div>

      <div class="row">
        <div class="label">Auto-mark slot as “Booked”</div>
        <label class="switch">
          <input id="b_autobook" type="checkbox" checked>
          <span class="knob"></span><span class="dot"></span>
        </label>
      </div>

      <div style="display:flex;gap:10px;margin-top:10px">
        <button id="b_btn" class="btn btn-primary">Create & WhatsApp</button>
        <button class="btn btn-secondary" onclick="location.href='./index.html'">Back</button>
      </div>
      <p id="b_status" class="muted" style="margin-top:10px"></p>
    </div>

    <!-- Quick WhatsApp -->
    <div class="section glass">
      <h2>Quick WhatsApp Reminder</h2>
      <div class="row"><div class="label">Contact</div><input id="r_phone" class="input" placeholder="+91…"></div>
      <div class="row"><div class="label">Message</div><input id="r_msg" class="input" value="Reminder: Your appointment is today."></div>
      <button class="btn btn-secondary" onclick="sendReminder()">Send</button>
    </div>

    <div class="footer">© 2025 Onestop Clinic</div>
  </div>

<script>
/* Requires /clinic/config.json like:
{
  "backend":"airtable",
  "capacityPerDay":50,
  "airtable":{"apiKey":"KEY","baseId":"BASE","logsTable":"BookingsLogs","slotsTable":"AvailableSlots"}
}
*/
let CFG=null;
async function loadCfg(){ const r=await fetch('./config.json?v='+Date.now()); if(!r.ok) throw 0; CFG=await r.json(); }

const AT = {
  headers(){ return { Authorization:'Bearer '+CFG.airtable.apiKey, 'Content-Type':'application/json' } },
  async listLogsByDate(date){
    const url=`https://api.airtable.com/v0/${CFG.airtable.baseId}/${encodeURIComponent(CFG.airtable.logsTable)}?filterByFormula=${encodeURIComponent("DATETIME_FORMAT({Timestamp}, 'YYYY-MM-DD')='"+date+"'")}&pageSize=100`;
    const j=await (await fetch(url,{headers:this.headers()})).json(); return j.records||[];
  },
  async createLog(fields){
    const url=`https://api.airtable.com/v0/${CFG.airtable.baseId}/${encodeURIComponent(CFG.airtable.logsTable)}`;
    const body=JSON.stringify({records:[{fields}]});
    const r=await fetch(url,{method:'POST',headers:this.headers(),body});
    if(!r.ok) throw new Error('Create failed');
  },
  async markSlotBooked(date,slot){
    if(!CFG.airtable.slotsTable) return;
    const list=`https://api.airtable.com/v0/${CFG.airtable.baseId}/${encodeURIComponent(CFG.airtable.slotsTable)}?filterByFormula=${encodeURIComponent(`AND({Date}='${date}', {Time Slot}='${slot}')`)}`;
    const lj=await (await fetch(list,{headers:this.headers()})).json();
    const rec=(lj.records||[])[0]; if(!rec) return;
    const upd=`https://api.airtable.com/v0/${CFG.airtable.baseId}/${encodeURIComponent(CFG.airtable.slotsTable)}`;
    const body=JSON.stringify({records:[{id:rec.id,fields:{Status:'Booked'}}]});
    await fetch(upd,{method:'PATCH',headers:this.headers(),body});
  }
};

function wa(urlText, phone=""){ const base=phone?`https://wa.me/${encodeURIComponent(phone)}?text=`:`https://wa.me/?text=`; location.href=base+encodeURIComponent(urlText); }
function status(t){ document.getElementById('b_status').textContent=t; }

async function createBooking(){
  const get=id=>document.getElementById(id).value.trim();
  const date=get('b_date'), slot=get('b_slot'), name=get('b_name'), reason=get('b_reason'), phone=get('b_phone');
  const autobook=document.getElementById('b_autobook').checked;
  if(!date||!slot||!name){ status('Enter date, slot, and name.'); return; }

  status('Assigning token…');
  const todays=await AT.listLogsByDate(date);
  const token=todays.length+1;

  status('Saving booking…');
  await AT.createLog({
    "Timestamp": new Date().toISOString(),
    "Patient Name": name, "Slot Time": slot, "Reason": reason, "Contact": phone,
    "Token": token, "Reminder Sent": "", "Status": "Pending"
  });

  if(autobook){ try{ await AT.markSlotBooked(date, slot); }catch(e){} }

  status(`Saved. Token #${token}. Opening WhatsApp…`);
  wa(`Appointment confirmed ✅\nPatient: ${name}\nWhen: ${date} ${slot}\nToken No: ${token}`, phone);
}

function sendReminder(){
  const p=document.getElementById('r_phone').value.trim();
  const m=document.getElementById('r_msg').value.trim();
  if(!p){ alert('Enter contact'); return; }
  location.href=`https://wa.me/${encodeURIComponent(p)}?text=${encodeURIComponent(m)}`;
}

(async()=>{
  try{
    await loadCfg();
    document.getElementById('b_btn').addEventListener('click', createBooking);
  }catch{ alert('config.json missing or invalid. Add your Airtable key/base.'); }
})();
</script>
</body>
</html>
