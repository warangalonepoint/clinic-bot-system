<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manual Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <img src="assets/banner.png" alt="Banner" class="banner" />
    <h2>Manual Patient Booking</h2>

    <label for="patientName">Patient Name:</label>
    <input type="text" id="patientName" placeholder="Enter patient name" required>

    <label for="reason">Reason for Visit:</label>
    <input type="text" id="reason" placeholder="e.g., Fever, Check-up" required>

    <label for="contact">Contact Number:</label>
    <input type="tel" id="contact" placeholder="10-digit number" required>

    <label for="dateSelect">Select Date:</label>
    <select id="dateSelect"></select>

    <label for="slotSelect">Select Time Slot:</label>
    <select id="slotSelect"></select>

    <button onclick="submitBooking()">Confirm Booking</button>

    <div id="status"></div>
  </div>

  <script>
    const airtableApiKey = 'patLNwoJQKE3Tjb8J.c2a0db129111c610fae64a2c01e0a626f37bdb5992232ea6ebc644fa9073dfb3';
    const baseId = 'app1T8WiRqZIR4xY';
    const availableSlotsTable = 'AvailableSlots';
    const bookingsLogsTable = 'BookingsLogs';

    const dateSelect = document.getElementById('dateSelect');
    const slotSelect = document.getElementById('slotSelect');

    const today = new Date().toISOString().split('T')[0];

    async function fetchDates() {
      const url = `https://api.airtable.com/v0/${baseId}/${availableSlotsTable}?maxRecords=1000&view=Grid%20view`;
      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${airtableApiKey}` },
      });
      const data = await res.json();
      const futureDates = new Set();
      data.records.forEach((record) => {
        const slotDate = record.fields.Date;
        if (slotDate >= today && record.fields.Status === 'Available') {
          futureDates.add(slotDate);
        }
      });
      dateSelect.innerHTML = '<option value="">-- Select Date --</option>';
      [...futureDates].sort().forEach((date) => {
        dateSelect.innerHTML += `<option value="${date}">${date}</option>`;
      });
    }

    async function fetchSlots(date) {
      const url = `https://api.airtable.com/v0/${baseId}/${availableSlotsTable}?maxRecords=1000&view=Grid%20view&filterByFormula=AND({Date}="${date}", {Status}="Available")`;
      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${airtableApiKey}` },
      });
      const data = await res.json();
      slotSelect.innerHTML = '<option value="">-- Select Time --</option>';
      data.records.forEach((record) => {
        if (record.fields['Time Slot']) {
          slotSelect.innerHTML += `<option value="${record.fields['Time Slot']}|${record.id}">${record.fields['Time Slot']}</option>`;
        }
      });
    }

    dateSelect.addEventListener('change', (e) => {
      const selectedDate = e.target.value;
      if (selectedDate) {
        fetchSlots(selectedDate);
      } else {
        slotSelect.innerHTML = '<option value="">-- Select Time --</option>';
      }
    });

    async function getTokenNumber(date) {
      const url = `https://api.airtable.com/v0/${baseId}/${bookingsLogsTable}?filterByFormula=SEARCH("${date}", {Timestamp})`;
      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${airtableApiKey}` },
      });
      const data = await res.json();
      return data.records.length + 1;
    }

    async function submitBooking() {
      const name = document.getElementById('patientName').value.trim();
      const reason = document.getElementById('reason').value.trim();
      const contact = document.getElementById('contact').value.trim();
      const selectedDate = dateSelect.value;
      const slotValue = slotSelect.value;

      if (!name || !reason || !contact || !selectedDate || !slotValue) {
        alert("Please fill in all fields.");
        return;
      }

      const [timeSlot, airtableSlotId] = slotValue.split('|');
      const token = await getTokenNumber(selectedDate);

      const bookingData = {
        records: [
          {
            fields: {
              "Timestamp": `${selectedDate}`,
              "Patient Name": name,
              "Slot Time": timeSlot,
              "Reason": reason,
              "Contact": contact,
              "Token": token,
              "Reminder Sent": ""
            }
          }
        ]
      };

      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${bookingsLogsTable}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(bookingData)
      });

      if (res.ok) {
        await markSlotAsBooked(airtableSlotId);
        document.getElementById("status").innerHTML = `✅ Booking Confirmed. Token #: ${token}`;
      } else {
        document.getElementById("status").innerHTML = "❌ Booking Failed.";
      }
    }

    async function markSlotAsBooked(recordId) {
      await fetch(`https://api.airtable.com/v0/${baseId}/${availableSlotsTable}/${recordId}`, {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fields: { Status: "Booked" }
        })
      });
    }

    fetchDates();
  </script>
</body>
</html>
