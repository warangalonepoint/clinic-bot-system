<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Directory</title>
<style>
:root{color-scheme:dark}
body{margin:0;font-family:system-ui,Inter,Arial;background:#0f1115;color:#e8eaed}
.wrap{max-width:1040px;margin:24px auto;padding:16px}
.bar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.btn{background:#2563eb;border:0;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
.ghost{background:#11141a;border:1px solid #1f2432}
.pill{display:inline-flex;align-items:center;background:#0f1218;border:1px solid #262b38;padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
.card{background:#171a21;border:1px solid #222736;border-radius:18px;padding:18px;margin-top:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.input, select{padding:12px;border-radius:12px;border:1px solid #262b38;background:#0f1218;color:#e8eaed}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{padding:10px 12px;text-align:left}
tr{background:#11141a;border:1px solid #1f2432}
tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
.badge{background:#0f1218;border:1px solid #262b38;border-radius:999px;padding:3px 8px;font-size:12px}
a.call{color:#a7f3d0;text-decoration:none}
footer{opacity:.7;font-size:13px;margin:18px 0;text-align:center}
.pager{display:flex;gap:6px;align-items:center}
.pager button{padding:8px 12px;border-radius:10px;border:1px solid #262b38;background:#11141a;color:#e8eaed;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <h2 style="margin:0" data-i18n="directory">Directory</h2>
    <div class="row">
      <span id="lang-pill" class="pill" onclick="setLang(getLang()==='te'?'en':'te')">English ☀️</span>
      <a class="btn ghost" href="directory-manage.html">Manage</a>
      <button class="btn ghost" onclick="history.back()" data-i18n="home">Home</button>
      <button class="btn" id="exportBtn" data-i18n="export_csv">Export CSV</button>
    </div>
  </div>

  <div class="card">
    <p class="muted" data-i18n="dir_sub">Search members & contacts</p>
    <div class="row" style="margin:8px 0 12px">
      <input id="q" class="input" style="min-width:240px" placeholder="Search…" data-i18n="search">
      <select id="area" class="input">
        <option value="" data-i18n="any">Any</option>
      </select>
      <select id="seva" class="input">
        <option value="" data-i18n="any">Any</option>
      </select>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Name</th><th data-i18n="area">Area</th><th data-i18n="seva">Seva</th><th>Email</th><th data-i18n="phone">Phone</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <p id="empty" style="display:none;opacity:.7" data-i18n="no_results">No results</p>

    <div class="row" style="justify-content:space-between;align-items:center;margin-top:10px">
      <div class="muted" id="countLabel"></div>
      <div class="pager">
        <button id="prev">‹ Prev</button>
        <span id="pageInfo" class="muted">1/1</span>
        <button id="next">Next ›</button>
      </div>
    </div>
  </div>

  <footer>© Padmashali Community — V1</footer>
</div>

<script src="i18n.js"></script>
<script>
  // anyone logged-in can view
  const s = JSON.parse(localStorage.getItem("pc_session")||"null");
  if(!s){ location.href='index.html'; }

  const K='pc_directory';
  const rows = document.getElementById('rows');
  const empty = document.getElementById('empty');
  const q = document.getElementById('q');
  const areaSel = document.getElementById('area');
  const sevaSel = document.getElementById('seva');
  const pageInfo = document.getElementById('pageInfo');
  const countLabel = document.getElementById('countLabel');
  const PAGE=12;
  let page=1, filtered=[];

  // Seed demo if empty
  function seed(){
    const sample=[
      {id:'D1',name:"G. Srinivas", area:"Warangal", seva:"Education", phone:"9390011111", email:"gs@example.com"},
      {id:'D2',name:"S. Laxmi", area:"Hanamkonda", seva:"Annadanam", phone:"9390022222", email:"sl@example.com"},
      {id:'D3',name:"K. Raju", area:"Kazipet", seva:"Health", phone:"9390033333", email:"kr@example.com"},
      {id:'D4',name:"M. Anitha", area:"Warangal", seva:"Education", phone:"9390044444", email:"ma@example.com"},
      {id:'D5',name:"D. Prasad", area:"Hanamkonda", seva:"Health", phone:"9390055555", email:"dp@example.com"},
    ];
    localStorage.setItem(K, JSON.stringify(sample));
  }
  if(!localStorage.getItem(K)) seed();

  function getAll(){ return JSON.parse(localStorage.getItem(K)||'[]'); }
  function unique(vals){ return Array.from(new Set(vals.filter(Boolean))).sort(); }

  function buildFilters(){
    const list=getAll();
    const areas=unique(list.map(x=>x.area));
    const sevas=unique(list.map(x=>x.seva));
    areaSel.innerHTML='<option value="">Any</option>'+areas.map(a=>`<option>${a}</option>`).join('');
    sevaSel.innerHTML='<option value="">Any</option>'+sevas.map(a=>`<option>${a}</option>`).join('');
  }

  function filter(){
    const list=getAll();
    const text=(q.value||"").toLowerCase();
    const a=areaSel.value, s=sevaSel.value;
    filtered = list.filter(x=>{
      const okT = !text || `${x.name} ${x.area} ${x.seva} ${x.phone} ${x.email||''}`.toLowerCase().includes(text);
      const okA = !a || x.area===a;
      const okS = !s || x.seva===s;
      return okT && okA && okS;
    }).sort((m,n)=>m.name.localeCompare(n.name));
    page=1; render();
  }

  function render(){
    const total=filtered.length;
    const pages=Math.max(1, Math.ceil(total/PAGE));
    page=Math.min(page,pages);
    const start=(page-1)*PAGE;
    const slice=filtered.slice(start,start+PAGE);

    rows.innerHTML='';
    if(!slice.length){ empty.style.display='block'; } else { empty.style.display='none'; }
    slice.forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><b>${x.name}</b></td>
        <td><span class="badge">${x.area||''}</span></td>
        <td><span class="badge">${x.seva||''}</span></td>
        <td>${x.email||'—'}</td>
        <td><a class="call" href="tel:${(x.phone||'').replace(/\s/g,'')}">${x.phone||''}</a></td>`;
      rows.appendChild(tr);
    });
    pageInfo.textContent=`${page}/${pages}`;
    countLabel.textContent = `${total} result${total===1?'':'s'}`;
  }

  [q,areaSel,sevaSel].forEach(el=>el.addEventListener('input',filter));
  document.getElementById('prev').onclick=()=>{ if(page>1){page--; render();} };
  document.getElementById('next').onclick=()=>{ const pages=Math.max(1,Math.ceil(filtered.length/PAGE)); if(page<pages){page++; render();} };

  // CSV export (current filtered, all rows)
  document.getElementById('exportBtn').onclick=()=>{
    const rows=[["ID","Name","Area","Seva","Phone","Email"],
      ...filtered.map(x=>[x.id||'',x.name||'',x.area||'',x.seva||'',x.phone||'',x.email||''])];
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv],{type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download="directory_export.csv"; a.click(); URL.revokeObjectURL(url);
  };

  applyI18n();
  buildFilters();
  filter();
</script>
</body></html>
