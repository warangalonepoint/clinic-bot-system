<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manual Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="styles.css" rel="stylesheet" />
</head>
<body>
  <div class="container">
    <img src="assets/banner.png" class="banner" />
    <h2>Onestop C-Demo</h2>
    <h3>Manual Booking</h3>

    <form id="bookingForm">
      <label>Patient Name:</label>
      <input type="text" id="name" required />

      <label>Contact:</label>
      <input type="tel" id="contact" required />

      <label>Select Date:</label>
      <input type="date" id="date" required />

      <label>Select Time Slot:</label>
      <select id="slot" required>
        <option value="">Loading...</option>
      </select>

      <button type="submit">Book Appointment</button>
    </form>

    <p id="statusMsg"></p>
  </div>

  <script>
    const apiKey = "patLNwoJQKE3Tjb8J.c2a0db129111c610fae64a2c01e0a626f37bdb5992232ea6ebc644fa9073dfb3";
    const baseId = "app1T8WiRqZIR4xY";
    const slotsTable = "AvailableSlots";
    const bookingsTable = "BookingsLogs";

    // Load available slots from Airtable
    async function loadSlots() {
      const date = document.getElementById("date").value;
      const slotSelect = document.getElementById("slot");
      slotSelect.innerHTML = `<option value="">Loading...</option>`;

      if (!date) return;

      const url = `https://api.airtable.com/v0/${baseId}/${slotsTable}?filterByFormula=AND({Date}='${date}', {Status}='Available')`;

      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${apiKey}` }
      });

      const data = await response.json();
      slotSelect.innerHTML = `<option value="">Select Slot</option>`;

      data.records.forEach(record => {
        const option = document.createElement("option");
        option.value = record.fields["Time Slot"];
        option.textContent = record.fields["Time Slot"];
        slotSelect.appendChild(option);
      });
    }

    document.getElementById("date").addEventListener("change", loadSlots);

    // Save booking to Airtable
    document.getElementById("bookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("name").value;
      const contact = document.getElementById("contact").value;
      const slotTime = document.getElementById("slot").value;

      const timestamp = new Date().toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata"
      });

      const payload = {
        fields: {
          "Timestamp": timestamp,
          "Patient Name": name,
          "Contact": contact,
          "Slot Time": slotTime
        }
      };

      const response = await fetch(`https://api.airtable.com/v0/${baseId}/${bookingsTable}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${apiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (result.id) {
        document.getElementById("statusMsg").innerText = "✅ Booking Saved Successfully!";
        document.getElementById("bookingForm").reset();
        document.getElementById("slot").innerHTML = "";
      } else {
        document.getElementById("statusMsg").innerText = "❌ Failed to save booking.";
      }
    });
  </script>
</body>
</html>
