<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin • School</title>
  <link rel="stylesheet" href="./styles.css">
  <style>
    .wrap{max-width:1000px;margin:20px auto;padding:12px}
    .hero{position:relative;border-radius:22px;overflow:hidden}
    .banner{width:100%;height:210px;object-fit:cover;display:block}
    .hero-overlay{position:absolute;inset:0;display:flex;align-items:flex-end;
      padding:14px 18px;background:linear-gradient(180deg,rgba(0,0,0,0) 40%,rgba(0,0,0,.55))}
    .logo{width:44px;height:44px;border-radius:12px;background:#fff;margin-right:10px;object-fit:cover;box-shadow:0 2px 8px rgba(0,0,0,.35)}
    .hero-title{color:#fff;font-weight:800;font-size:24px;text-shadow:0 1px 2px rgba(0,0,0,.6)}
    .card{background:#fff;border-radius:22px;box-shadow:0 6px 28px rgba(0,0,0,.06);padding:18px 18px;margin-top:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}
    .btn{background:#0b0b0c;color:#fff;border:none;border-radius:14px;height:50px;padding:0 18px;font-weight:700;text-align:center;display:inline-block;line-height:50px}
    .btn:active{transform:translateY(1px)}
    .in{width:100%;height:48px;border:1px solid #d1d5db;border-radius:14px;padding:0 14px;font-size:16px}
    textarea.in{height:auto;min-height:110px;padding:10px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px;text-align:left}
    th{background:#f5f5f5}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:#eee;border-radius:999px;padding:6px 12px;display:inline-block}
    .muted{color:#6b7280}
  </style>
</head>
<body class="bg">
<main class="wrap">
  <!-- Banner -->
  <div class="card hero">
    <img class="banner" src="./assets/banner.png" alt="School Banner">
    <div class="hero-overlay">
      <img class="logo" src="./assets/logo.png" alt="Logo" onerror="this.style.display='none'">
      <div class="hero-title">Admin Panel</div>
    </div>
  </div>

  <!-- Quick Links -->
  <div class="card">
    <h2>Quick Links</h2>
    <div class="row">
      <a class="btn" href="./parents.html" style="flex:1">Parents</a>
      <a class="btn" href="./teacher.html" style="flex:1">Teacher</a>
      <a class="btn" href="./coordinator.html" style="flex:1">Coordinator</a>
      <a class="btn" href="./index.html" style="flex:1">Back to PIN</a>
    </div>
  </div>

  <!-- Import / Export -->
  <div class="card">
    <h2>CSV Import / Export</h2>
    <p class="muted">MVP is local-only. Imports overwrite localStorage keys. Exports download current data as CSV.</p>
    <div class="grid">
      <div>
        <h3>Import CSV</h3>
        <select id="impKey" class="in">
          <option value="sch_students">Students</option>
          <option value="sch_teachers">Teachers</option>
          <option value="sch_classes">Classes</option>
          <option value="sch_fees">Fees</option>
          <option value="sch_timetable">Timetable</option>
        </select>
        <input id="impFile" class="in" type="file" accept=".csv" style="margin-top:8px">
        <button class="btn" style="width:100%;margin-top:10px" id="btnImport">Import CSV</button>
        <div id="impMsg" class="muted" style="margin-top:8px"></div>
      </div>
      <div>
        <h3>Export CSV</h3>
        <div class="row">
          <button class="btn" style="flex:1" data-exp="sch_students">Students</button>
          <button class="btn" style="flex:1" data-exp="sch_teachers">Teachers</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" style="flex:1" data-exp="sch_classes">Classes</button>
          <button class="btn" style="flex:1" data-exp="sch_fees">Fees</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" style="flex:1" data-exp="sch_attendance">Attendance</button>
          <button class="btn" style="flex:1" data-exp="sch_homework">Homework</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" style="flex:1" data-exp="sch_notices">Notices</button>
          <button class="btn" style="flex:1" data-exp="sch_leaves">Leaves</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" style="flex:1" data-exp="sch_class_diary">Class Diary</button>
          <button class="btn" style="flex:1" data-exp="sch_timetable">Timetable</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" style="flex:1" data-exp="sch_events">Events</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div class="card">
    <h2>Settings</h2>
    <div class="grid">
      <div>
        <h3>School Identity</h3>
        <input id="s_name" class="in" placeholder="School Name">
        <input id="s_session" class="in" style="margin-top:8px" placeholder="Academic Session (e.g., 2025-26)">
        <button class="btn" style="width:100%;margin-top:10px" id="s_save">Save</button>
        <div class="muted" id="s_msg" style="margin-top:8px"></div>
      </div>
      <div>
        <h3>Role PINs</h3>
        <p class="muted">Edits are stored locally as an override (`pins_override`).</p>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <input id="pin_coord" class="in" placeholder="Coordinator PIN">
          <input id="pin_par" class="in" placeholder="Parents PIN">
          <input id="pin_teacher" class="in" placeholder="Teacher PIN">
          <input id="pin_admin" class="in" placeholder="Admin PIN">
        </div>
        <button class="btn" style="width:100%;margin-top:10px" id="pin_save">Save PINs</button>
        <div class="muted" id="pin_msg" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- Overview -->
  <div class="card">
    <h2>Overview</h2>
    <div class="row" style="gap:12px;flex-wrap:wrap">
      <span class="pill">Students: <b id="count_students">0</b></span>
      <span class="pill">Teachers: <b id="count_teachers">0</b></span>
      <span class="pill">Classes: <b id="count_classes">0</b></span>
      <span class="pill">Notices: <b id="count_notices">0</b></span>
      <span class="pill">Homework: <b id="count_homework">0</b></span>
      <span class="pill">Leaves: <b id="count_leaves">0</b></span>
      <span class="pill">Attendance Entries: <b id="count_att">0</b></span>
      <span class="pill">Class Diary: <b id="count_diary">0</b></span>
    </div>
  </div>

  <!-- Utilities -->
  <div class="card">
    <h2>Utilities</h2>
    <div class="row">
      <button class="btn" style="flex:1" id="wipe_local">Local Reset (Danger)</button>
      <button class="btn" style="flex:1" id="reload_sw">Reload Service Worker</button>
      <button class="btn" style="flex:1" onclick="logout()">Logout</button>
    </div>
  </div>
</main>

<script>
  // Role lock
  if(sessionStorage.getItem("school_role") !== "admin"){
    location.replace("./index.html");
  }

  // Helpers
  const $ = sel => document.querySelector(sel);
  const jget = k => JSON.parse(localStorage.getItem(k) || "[]");
  const jset = (k,v) => localStorage.setItem(k, JSON.stringify(v));
  const csvExport = (rows, heads, name) => {
    const out=[heads.join(",")];
    rows.forEach(r=>out.push(heads.map(h=>`"${String((r||{})[h] ?? "").replace(/"/g,'""')}"`).join(",")));
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([out.join("\n")],{type:"text/csv"}));
    a.download=name; a.click();
  };

  // Counts
  function renderCounts(){
    $("#count_students").textContent = jget("sch_students").length;
    $("#count_teachers").textContent = jget("sch_teachers").length;
    $("#count_classes").textContent  = jget("sch_classes").length;
    $("#count_notices").textContent  = jget("sch_notices").length;
    $("#count_homework").textContent = jget("sch_homework").length;
    $("#count_leaves").textContent   = jget("sch_leaves").length;
    $("#count_att").textContent      = jget("sch_attendance").length;
    $("#count_diary").textContent    = jget("sch_class_diary").length;
  }

  // Import CSV (simple CSV → array of objects using first row as headers)
  $("#btnImport").addEventListener("click", async ()=>{
    const key = $("#impKey").value;
    const file = $("#impFile").files[0];
    const msg = $("#impMsg");
    if(!file){ msg.textContent="Choose a CSV file."; return; }
    const text = await file.text();
    const lines = text.trim().split(/\r?\n/);
    if(lines.length < 2){ msg.textContent="CSV seems empty."; return; }
    const headers = lines[0].split(",").map(h=>h.trim());
    const rows = lines.slice(1).map(line=>{
      // split by comma not inside quotes (MVP: naive split + dequote)
      const parts = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
      const obj = {};
      headers.forEach((h,i)=>{
        let v = (parts[i]||"").replace(/^"(.*)"$/,'$1').replace(/""/g,'"');
        obj[h] = v;
      });
      return obj;
    });
    jset(key, rows);
    msg.textContent = `Imported ${rows.length} rows into ${key}.`;
    renderCounts();
  });

  // Export buttons
  document.querySelectorAll('[data-exp]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-exp');
      const rows = jget(key);
      if(!rows.length){ alert("No data to export."); return; }
      const heads = Object.keys(rows[0]);
      csvExport(rows, heads, `${key}.csv`);
    });
  });

  // School identity
  (function loadSettings(){
    const s = JSON.parse(localStorage.getItem("sch_settings")||"{}");
    $("#s_name").value = s.name || "";
    $("#s_session").value = s.session || "";
  })();
  $("#s_save").addEventListener("click", ()=>{
    const s = { name: $("#s_name").value.trim(), session: $("#s_session").value.trim() };
    localStorage.setItem("sch_settings", JSON.stringify(s));
    $("#s_msg").textContent = "Saved.";
    setTimeout(()=>$("#s_msg").textContent="",1500);
  });

  // PINs (local override because we can’t write pins.json without a server)
  async function loadPinsBase(){
    try{
      const r = await fetch("./pins.json",{cache:"no-store"});
      if(!r.ok) throw 0;
      return await r.json();
    }catch{ return { coordinator:"1111", parents:"2222", teacher:"3333", admin:"4444" }; }
  }
  (async function initPins(){
    const base = await loadPinsBase();
    const ov = JSON.parse(localStorage.getItem("pins_override")||"{}");
    const pins = {...base, ...ov};
    $("#pin_coord").value = pins.coordinator || "";
    $("#pin_par").value   = pins.parents || "";
    $("#pin_teacher").value = pins.teacher || "";
    $("#pin_admin").value = pins.admin || "";
  })();
  $("#pin_save").addEventListener("click", ()=>{
    const ov = {
      coordinator: $("#pin_coord").value.trim(),
      parents: $("#pin_par").value.trim(),
      teacher: $("#pin_teacher").value.trim(),
      admin: $("#pin_admin").value.trim()
    };
    localStorage.setItem("pins_override", JSON.stringify(ov));
    $("#pin_msg").textContent = "Saved locally (pins_override).";
    setTimeout(()=>$("#pin_msg").textContent="",1500);
  });

  // Utilities
  $("#wipe_local").addEventListener("click", ()=>{
    if(!confirm("This will clear ALL local data (except service worker cache). Continue?")) return;
    const keep = ["pins_override","sch_settings"]; // keep these
    const saved = {};
    keep.forEach(k=>{saved[k]=localStorage.getItem(k)});
    localStorage.clear();
    keep.forEach(k=>{ if(saved[k]!=null) localStorage.setItem(k,saved[k]); });
    alert("Local data cleared.");
    renderCounts();
  });

  $("#reload_sw").addEventListener("click", async ()=>{
    if('serviceWorker' in navigator){
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const reg of regs){ await reg.update(); }
      alert("Service worker reloaded. Hard refresh recommended.");
    }
  });

  function logout(){ sessionStorage.clear(); location.replace("./index.html"); }

  renderCounts();
</script>
</body>
</html>
