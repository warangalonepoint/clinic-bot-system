<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Teacher • School</title>
  <link rel="stylesheet" href="./styles.css">
  <style>
    .wrap{max-width:1000px;margin:20px auto;padding:12px}
    .hero{position:relative;border-radius:22px;overflow:hidden}
    .banner{width:100%;height:200px;object-fit:cover;display:block}
    .hero-overlay{position:absolute;inset:0;display:flex;align-items:flex-end;
      padding:14px 18px;background:linear-gradient(180deg,rgba(0,0,0,0) 40%,rgba(0,0,0,.55))}
    .hero-title{color:#fff;font-weight:800;font-size:22px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
  </style>
</head>
<body class="bg">
<main class="wrap">
  <div class="card hero">
    <img class="banner" src="./assets/banner.png" alt="School Banner">
    <div class="hero-overlay"><div class="hero-title">Teacher</div></div>
  </div>

  <!-- Profile -->
  <div class="card">
    <h2 class="h2">My Class</h2>
    <div class="grid2">
      <label>Class <input id="t_class" class="in" placeholder="e.g., 5"></label>
      <label>Section <input id="t_section" class="in" placeholder="e.g., A"></label>
      <label>Your Name <input id="t_name" class="in" placeholder="e.g., Ms. Priya"></label>
      <label>Subject <input id="t_subject" class="in" placeholder="e.g., Maths"></label>
    </div>
    <button class="btn" id="t_save" style="margin-top:10px">Save</button>
    <span id="t_msg" class="muted" style="margin-left:8px"></span>
  </div>

  <div class="tabs">
    <button class="tab active" data-t="#t_diary">Class Diary</button>
    <button class="tab" data-t="#t_hw">Homework</button>
    <button class="tab" data-t="#t_att">Attendance</button>
  </div>

  <!-- Class Diary -->
  <section class="card" id="t_diary">
    <h2 class="h2">Post to Class Diary</h2>
    <div class="grid2">
      <label>Date <input id="d_date" class="in" type="date"></label>
      <label>Subject <input id="d_subject" class="in" placeholder="e.g., Maths"></label>
      <label class="span2">Message <textarea id="d_text" class="in" placeholder="What was taught / notes…"></textarea></label>
      <label class="span2">Optional Link <input id="d_link" class="in" placeholder="https://…"></label>
    </div>
    <button class="btn" id="d_post" style="margin-top:10px">Publish</button>

    <h3 class="h2" style="margin-top:16px">Recent</h3>
    <div class="tablewrap">
      <table class="tbl"><thead><tr><th>Date</th><th>Subject</th><th>Message</th><th>Link</th><th>Action</th></tr></thead>
        <tbody id="d_tbody"></tbody></table>
      <div id="d_empty" class="muted">No entries.</div>
    </div>
  </section>

  <!-- Homework -->
  <section class="card hidden" id="t_hw">
    <h2 class="h2">Create Homework</h2>
    <div class="grid2">
      <label>Due Date <input id="h_due" class="in" type="date"></label>
      <label>Subject <input id="h_subject" class="in" placeholder="e.g., Maths"></label>
      <label>Title <input id="h_title" class="in" placeholder="e.g., Exercise 5A"></label>
      <label class="span2">Details <textarea id="h_details" class="in" placeholder="Q1–10…"></textarea></label>
    </div>
    <button class="btn" id="h_post" style="margin-top:10px">Publish</button>

    <h3 class="h2" style="margin-top:16px">Upcoming</h3>
    <div class="tablewrap">
      <table class="tbl"><thead><tr><th>Due</th><th>Subject</th><th>Title</th><th>Details</th><th>Action</th></tr></thead>
        <tbody id="h_tbody"></tbody></table>
      <div id="h_empty" class="muted">No homework scheduled.</div>
    </div>
  </section>

  <!-- Attendance (quick demo) -->
  <section class="card hidden" id="t_att">
    <h2 class="h2">Attendance</h2>
    <div class="grid2">
      <label>Date <input id="a_date" class="in" type="date"></label>
      <label>Period <input id="a_period" class="in" type="number" min="1" max="10" placeholder="e.g., 1"></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="a_load">Load Roster</button>
      <button class="btn" id="a_save">Save Attendance</button>
    </div>
    <div class="tablewrap" style="margin-top:10px">
      <table class="tbl"><thead><tr><th>#</th><th>Roll</th><th>Name</th><th>Present</th></tr></thead>
        <tbody id="a_tbody"></tbody></table>
      <div id="a_empty" class="muted">Load roster to mark attendance.</div>
    </div>
  </section>

  <div class="card">
    <div class="row">
      <button class="btn" onclick="logout()" style="flex:1">Logout</button>
      <a class="btn" href="./index.html" style="flex:1">Back to PIN</a>
    </div>
  </div>
</main>

<script>
  if(sessionStorage.getItem("school_role")!=="teacher"){ location.replace("./index.html"); }

  const $=s=>document.querySelector(s);
  const jget=k=>JSON.parse(localStorage.getItem(k)||"[]");
  const jset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

  // Tabs
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      ["t_diary","t_hw","t_att"].forEach(id=>document.getElementById(id).classList.add("hidden"));
      document.querySelector(t.getAttribute("data-t")).classList.remove("hidden");
    });
  });

  // Profile
  (function loadProfile(){
    const p=JSON.parse(localStorage.getItem("teacher_profile")||"{}");
    $("#t_class").value=p.class||""; $("#t_section").value=p.section||"";
    $("#t_name").value=p.name||""; $("#t_subject").value=p.subject||"";
  })();
  $("#t_save").addEventListener("click", ()=>{
    const p={class:$("#t_class").value.trim(), section:$("#t_section").value.trim(),
             name:$("#t_name").value.trim(), subject:$("#t_subject").value.trim()};
    localStorage.setItem("teacher_profile", JSON.stringify(p));
    $("#t_msg").textContent="Saved."; setTimeout(()=>$("#t_msg").textContent="",1500);
    renderAll();
  });

  function clsMatch(r){
    const p=JSON.parse(localStorage.getItem("teacher_profile")||"{}");
    return String(r.class||"")===(p.class||"") && String(r.section||"")===(p.section||"");
  }

  // Diary
  function renderDiary(){
    const rows=jget("sch_class_diary").filter(clsMatch).sort((a,b)=>(b.date||"").localeCompare(a.date||""));
    const tb=$("#d_tbody"); tb.innerHTML=""; $("#d_empty").style.display=rows.length?"none":"block";
    rows.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.date||""}</td><td>${r.subject||""}</td><td>${r.text||""}</td>
                    <td>${r.link?`<a href="${r.link}" target="_blank">Open</a>`:""}</td>
                    <td><button class="btn" data-del="${r.id}">Delete</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const arr=jget("sch_class_diary").filter(x=>x.id!==b.getAttribute("data-del"));
        jset("sch_class_diary",arr); renderDiary();
      });
    });
  }
  $("#d_post").addEventListener("click", ()=>{
    const p=JSON.parse(localStorage.getItem("teacher_profile")||"{}");
    const row={ id:crypto.randomUUID?crypto.randomUUID():Date.now()+"",
      class:p.class||"", section:p.section||"", date:$("#d_date").value,
      subject:$("#d_subject").value||p.subject||"", text:$("#d_text").value.trim(),
      link:$("#d_link").value.trim(), teacherId:p.id||"", teacherName:p.name||"", ts:Date.now() };
    if(!row.class||!row.section||!row.date||!row.subject||!row.text){ alert("Fill class/section, date, subject, message."); return; }
    const arr=jget("sch_class_diary"); arr.unshift(row); jset("sch_class_diary",arr);
    $("#d_text").value=""; $("#d_link").value=""; renderDiary(); alert("Published.");
  });

  // Homework
  function renderHW(){
    const rows=jget("sch_homework").filter(clsMatch).sort((a,b)=>(a.due||"").localeCompare(b.due||""));
    const tb=$("#h_tbody"); tb.innerHTML=""; $("#h_empty").style.display=rows.length?"none":"block";
    rows.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.due||""}</td><td>${r.subject||""}</td><td>${r.title||""}</td>
                    <td>${r.details||""}</td>
                    <td><button class="btn" data-delh="${r.id}">Delete</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll("[data-delh]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const arr=jget("sch_homework").filter(x=>x.id!==b.getAttribute("data-delh"));
        jset("sch_homework",arr); renderHW();
      });
    });
  }
  $("#h_post").addEventListener("click", ()=>{
    const p=JSON.parse(localStorage.getItem("teacher_profile")||"{}");
    const row={ id:crypto.randomUUID?crypto.randomUUID():Date.now()+"",
      class:p.class||"", section:p.section||"", subject:$("#h_subject").value||p.subject||"",
      title:$("#h_title").value.trim(), details:$("#h_details").value.trim(),
      due:$("#h_due").value, teacherId:p.id||"", teacherName:p.name||"", ts:Date.now() };
    if(!row.class||!row.section||!row.subject||!row.title||!row.due){ alert("Fill class/section, subject, title, due date."); return; }
    const arr=jget("sch_homework"); arr.unshift(row); jset("sch_homework",arr);
    $("#h_title").value=""; $("#h_details").value=""; renderHW(); alert("Homework published.");
  });

  // Attendance demo
  function renderRoster(){
    const p=JSON.parse(localStorage.getItem("teacher_profile")||"{}");
    const rows=jget("sch_students").filter(s=>String(s.class||"")===(p.class||"") && String(s.section||"")===(p.section||""))
                 .sort((a,b)=> (a.roll||"").localeCompare(b.roll||""));
    const tb=$("#a_tbody"); tb.innerHTML=""; $("#a_empty").style.display=rows.length?"none":"block";
    rows.forEach((s,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i+1}</td><td>${s.roll||""}</td><td>${s.name||""}</td>
                    <td><input type="checkbox" data-sid="${s.id||s.roll||s.name}"></td>`;
      tb.appendChild(tr);
    });
  }
  $("#a_load").addEventListener("click", renderRoster);
  $("#a_save").addEventListener("click", ()=>{
    const p=JSON.parse(localStorage.getItem("teacher_profile")||"{}");
    const date=$("#a_date").value, period=$("#a_period").value;
    if(!date||!period){ alert("Pick date & period."); return; }
    const checks=[...document.querySelectorAll("[data-sid]")].map(c=>({sid:c.getAttribute("data-sid"), present:c.checked}));
    const rec={ id:crypto.randomUUID?crypto.randomUUID():Date.now()+"", class:p.class||"", section:p.section||"",
      date, period, entries:checks, ts:Date.now() };
    const arr=jget("sch_attendance"); arr.unshift(rec); jset("sch_attendance",arr);
    alert("Attendance saved.");
  });

  function renderAll(){ renderDiary(); renderHW(); }
  renderAll();

  function logout(){ sessionStorage.clear(); location.replace("./index.html"); }
</script>
</body>
</html>
