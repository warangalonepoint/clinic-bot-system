<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Booking Logs | Onestop C-Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="styles.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
    }
    .search-box {
      margin: 10px 0;
    }
    .search-box input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
    }
    button {
      padding: 6px 12px;
      background: black;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="assets/banner.png" class="banner" />
    <h2>Booking Logs</h2>

    <div class="search-box">
      <input type="text" id="search" placeholder="Search by name, reason or contact">
    </div>

    <button onclick="downloadCSV()">Export CSV</button>
    <div style="overflow-x:auto;">
      <table id="logsTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Patient</th>
            <th>Slot</th>
            <th>Reason</th>
            <th>Contact</th>
            <th>Token</th>
            <th>Reminder</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="footer">Powered by Onestop AI</p>
  </div>

  <script>
    const apiKey = "YOUR_API_KEY_HERE";
    const baseId = "appgplT8WiqnZlR44Y";
    const bookingsTable = "BookingsLogs";
    const headers = { Authorization: `Bearer ${apiKey}`, "Content-Type": "application/json" };
    let logsData = [];

    async function loadLogs() {
      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${bookingsTable}?maxRecords=500&sort[0][field]=Timestamp&sort[0][direction]=desc`, { headers });
      const data = await res.json();
      logsData = data.records;
      renderLogs(logsData);
    }

    function renderLogs(data) {
      const tbody = document.querySelector("#logsTable tbody");
      tbody.innerHTML = "";
      data.forEach(record => {
        const f = record.fields;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${(f["Slot Time"] || "").split(" ")[0]}</td>
          <td>${f["Patient Name"] || ""}</td>
          <td>${(f["Slot Time"] || "").split(" ")[1]}</td>
          <td>${f["Reason"] || ""}</td>
          <td><a href="tel:${f["Contact"] || ""}">${f["Contact"] || ""}</a></td>
          <td>${f["Token"] || ""}</td>
          <td>
            ${f["Reminder Sent"] === "✔️" ? "✔️" : `<button onclick="sendReminder('${record.id}', '${f["Contact"]}', '${f["Patient Name"]}', '${f["Slot Time"]}', '${f["Reason"]}', '${f["Token"]}')">Send</button>`}
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function sendReminder(id, contact, name, slot, reason, token) {
      const msg = `Hello ${name},\nThis is a reminder for your appointment on ${slot} for "${reason}".\nToken No: ${token}\n- Onestop Clinic`;
      const url = `https://wa.me/91${contact}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");

      await fetch(`https://api.airtable.com/v0/${baseId}/${bookingsTable}/${id}`, {
        method: "PATCH",
        headers,
        body: JSON.stringify({ fields: { "Reminder Sent": "✔️" } })
      });

      loadLogs();
    }

    function downloadCSV() {
      let csv = "Date,Patient,Slot,Reason,Contact,Token,Reminder Sent\n";
      logsData.forEach(record => {
        const f = record.fields;
        csv += [
          (f["Slot Time"] || "").split(" ")[0],
          `"${f["Patient Name"] || ""}"`,
          (f["Slot Time"] || "").split(" ")[1],
          `"${f["Reason"] || ""}"`,
          f["Contact"] || "",
          f["Token"] || "",
          f["Reminder Sent"] || ""
        ].join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "booking-logs.csv";
      link.click();
    }

    document.getElementById("search").addEventListener("input", (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = logsData.filter(r =>
        (r.fields["Patient Name"] || "").toLowerCase().includes(term) ||
        (r.fields["Reason"] || "").toLowerCase().includes(term) ||
        (r.fields["Contact"] || "").toLowerCase().includes(term)
      );
      renderLogs(filtered);
    });

    loadLogs();
  </script>
</body>
</html>
