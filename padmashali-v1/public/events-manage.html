<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Manage Events</title>
<style>
:root{color-scheme:dark}
body{margin:0;font-family:system-ui,Inter,Arial;background:#0f1115;color:#e8eaed}
.wrap{max-width:1080px;margin:24px auto;padding:16px}
.bar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.btn{background:#2563eb;border:0;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
.ghost{background:#11141a;border:1px solid #1f2432}
.danger{background:#ef4444}
.pill{display:inline-flex;align-items:center;background:#0f1218;border:1px solid #262b38;padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer}
.card{background:#171a21;border:1px solid #222736;border-radius:18px;padding:18px;margin-top:14px}
.grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
.tile{background:#11141a;border:1px solid #1f2432;border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px}
.input, textarea{padding:12px;border-radius:12px;border:1px solid #262b38;background:#0f1218;color:#e8eaed;width:100%}
.row{display:flex;gap:8px;flex-wrap:wrap}
.badge{background:#0f1218;border:1px solid #262b38;border-radius:999px;padding:4px 10px;font-size:12px}
.muted{opacity:.75}
footer{opacity:.7;font-size:13px;margin:18px 0;text-align:center}
.sep{height:1px;background:#222736;margin:8px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <h2 style="margin:0">üóìÔ∏è Manage Events</h2>
    <div class="row">
      <span id="lang-pill" class="pill" onclick="setLang(getLang()==='te'?'en':'te')">English ‚òÄÔ∏è</span>
      <a class="btn ghost" href="events.html">View Events</a>
      <button class="btn ghost" onclick="history.back()">Back</button>
    </div>
  </div>

  <div class="card">
    <b>Create / Edit</b>
    <div class="row" style="margin-top:10px">
      <input id="title" class="input" placeholder="Title">
      <input id="date" class="input" type="date">
      <input id="start" class="input" type="time">
      <input id="end" class="input" type="time">
      <input id="venue" class="input" placeholder="Venue">
      <textarea id="desc" class="input" placeholder="Description"></textarea>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="saveBtn">Save Event</button>
      <button class="btn ghost" id="clearBtn">Clear Form</button>
      <button class="btn ghost" id="exportBtn">Export Events CSV</button>
    </div>
  </div>

  <div class="card">
    <b>All Events</b>
    <div id="list" class="grid" style="margin-top:10px"></div>
    <p id="empty" class="muted" style="display:none">No events yet.</p>
  </div>

  <footer>¬© Padmashali Community ‚Äî V1</footer>
</div>

<script src="i18n.js"></script>
<script>
  // guard: committee or admin
  const s = JSON.parse(localStorage.getItem("pc_session")||"null");
  if(!s || (s.role!=='committee' && s.role!=='admin')) location.href='index.html';

  const EV_KEY='pc_events';
  const RSVP_KEY='pc_event_rsvps';

  function getEvents(){ return JSON.parse(localStorage.getItem(EV_KEY)||'[]'); }
  function setEvents(arr){ localStorage.setItem(EV_KEY, JSON.stringify(arr)); }
  function getRSVPs(){ return JSON.parse(localStorage.getItem(RSVP_KEY)||'{}'); }

  const f = {
    title:document.getElementById('title'),
    date:document.getElementById('date'),
    start:document.getElementById('start'),
    end:document.getElementById('end'),
    venue:document.getElementById('venue'),
    desc:document.getElementById('desc')
  };
  let editId = null;

  document.getElementById('saveBtn').onclick=()=>{
    if(!f.title.value||!f.date.value||!f.start.value||!f.end.value){ alert('Fill title/date/time'); return; }
    const evs=getEvents();
    if(editId){
      const i=evs.findIndex(e=>e.id===editId); if(i<0){ editId=null; return; }
      evs[i]={...evs[i], title:f.title.value.trim(), date:f.date.value, start:f.start.value, end:f.end.value,
              venue:f.venue.value.trim(), desc:f.desc.value.trim()};
      setEvents(evs);
      alert('Event updated');
    } else {
      evs.push({id:'E'+Date.now().toString(36), title:f.title.value.trim(), date:f.date.value,
                start:f.start.value, end:f.end.value, venue:f.venue.value.trim(),
                desc:f.desc.value.trim(), published:true, ts:Date.now()});
      setEvents(evs);
      alert('Event created');
    }
    clearForm(); render();
  };
  document.getElementById('clearBtn').onclick=()=>{ clearForm(); };
  document.getElementById('exportBtn').onclick=()=>{
    const evs=getEvents().sort((a,b)=>a.date.localeCompare(b.date)||a.start.localeCompare(b.start));
    const rows=[['ID','Title','Date','Start','End','Venue','Published']];
    evs.forEach(e=>rows.push([e.id,e.title,e.date,e.start,e.end,e.venue,e.published?'Yes':'No']));
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='events.csv'; a.click(); URL.revokeObjectURL(url);
  };

  function clearForm(){ editId=null; Object.values(f).forEach(x=>x.value=''); }

  function render(){
    const listDiv=document.getElementById('list');
    const empty=document.getElementById('empty');
    const evs=getEvents().sort((a,b)=>a.date.localeCompare(b.date)||a.start.localeCompare(b.start));
    listDiv.innerHTML='';
    if(evs.length===0){ empty.style.display='block'; return; } else empty.style.display='none';

    const r = getRSVPs();
    evs.forEach(e=>{
      const yes = (r[e.id]||[]).filter(x=>x.resp==='Yes').length;
      const maybe = (r[e.id]||[]).filter(x=>x.resp==='Maybe').length;
      const tile=document.createElement('div'); tile.className='tile';
      tile.innerHTML=`
        <div class="row"><span class="badge">${e.date}</span><span class="badge">${e.venue||''}</span>
          <span class="badge">${e.published?'Published':'Hidden'}</span></div>
        <div><b>${e.title}</b></div>
        <div class="muted">${e.start}‚Äì${e.end}</div>
        <div class="muted">${e.desc||''}</div>
        <div class="sep"></div>
        <div class="row">
          <button class="btn" onclick="edit('${e.id}')">Edit</button>
          <button class="btn ghost" onclick="toggle('${e.id}')">${e.published?'Hide':'Publish'}</button>
          <button class="btn danger" onclick="del('${e.id}')">Delete</button>
          <a class="btn ghost" href="events.html">Open in Events</a>
        </div>
        <div class="row">
          <span class="badge">Yes: ${yes}</span>
          <span class="badge">Maybe: ${maybe}</span>
          <button class="btn ghost" onclick="exportRSVP('${e.id}')">Export RSVPs</button>
        </div>`;
      listDiv.appendChild(tile);
    });
  }

  window.edit=(id)=>{
    const e=getEvents().find(x=>x.id===id); if(!e) return;
    editId=id; f.title.value=e.title; f.date.value=e.date; f.start.value=e.start; f.end.value=e.end;
    f.venue.value=e.venue||''; f.desc.value=e.desc||'';
    window.scrollTo({top:0,behavior:'smooth'});
  };
  window.toggle=(id)=>{
    const evs=getEvents(); const i=evs.findIndex(x=>x.id===id); if(i<0) return;
    evs[i].published=!evs[i].published; setEvents(evs); render();
  };
  window.del=(id)=>{
    if(!confirm('Delete this event?')) return;
    const evs=getEvents().filter(x=>x.id!==id); setEvents(evs);
    const r=JSON.parse(localStorage.getItem('pc_event_rsvps')||'{}'); delete r[id]; localStorage.setItem('pc_event_rsvps',JSON.stringify(r));
    render();
  };
  window.exportRSVP=(id)=>{
    const e=getEvents().find(x=>x.id===id); const arr=(JSON.parse(localStorage.getItem('pc_event_rsvps')||'{}')[id])||[];
    const rows=[['EventID','Title','Date','Start','End','Venue','UID','Name','RSVP']];
    arr.forEach(it=>rows.push([e.id,e.title,e.date,e.start,e.end,e.venue||'',it.uid,it.name,it.resp]));
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`rsvps_${e.id}.csv`; a.click(); URL.revokeObjectURL(url);
  };

  applyI18n();
  render();
</script>
</body></html>
