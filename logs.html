<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ“‹ Appointment Logs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 24px; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 14px; }
    th { background-color: #f2f2f2; }
    .btn { background-color: green; color: white; padding: 6px 12px; border: none; margin-right: 10px; cursor: pointer; }
    .btn:hover { opacity: 0.9; }
    select, input[type="date"] { padding: 5px; font-size: 14px; }
  </style>
</head>
<body>

  <h1>ðŸ“‹ Appointment Logs</h1>
  <div>
    âœ… <strong>Bookings Today:</strong> <span id="todayCount">0</span>
    | <strong>Next Token:</strong> <span id="nextToken">1</span>
  </div><br>

  <button class="btn" onclick="filterByToday()">Today</button>
  <button class="btn" onclick="filterByYesterday()">Yesterday</button>
  <input type="date" id="dateFilter" />
  <button class="btn" onclick="applyCustomDate()">Apply</button>
  <button class="btn" onclick="exportCSV()">ðŸ“„ Export CSV</button>
  <button class="btn" onclick="exportPDF()">ðŸ–¨ Export PDF</button>

  <table id="logTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Name</th>
        <th>Reason</th>
        <th>Contact</th>
        <th>Clinic</th>
        <th>Token</th>
        <th>Reminder</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const CSV_URL = "https://warangalonepoint.github.io/clinic-bot-system/logs.csv";
    let allData = [];

    async function fetchData() {
      const res = await fetch(CSV_URL);
      const csvText = await res.text();
      const parsed = Papa.parse(csvText.trim(), { header: true });
      allData = parsed.data;
      renderTable(allData);
    }

    function renderTable(data) {
      const tbody = document.querySelector("#logTable tbody");
      tbody.innerHTML = "";

      const today = new Date().toISOString().split("T")[0];
      let todayCount = 0;
      let maxToken = 0;

      data.forEach(row => {
        const rowDate = formatDate(row.Date);
        if (rowDate === today) todayCount++;
        if (!isNaN(parseInt(row.Token))) {
          maxToken = Math.max(maxToken, parseInt(row.Token));
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.Date}</td>
          <td>${row.Time}</td>
          <td>${row.Name}</td>
          <td>${row.Reason}</td>
          <td><a href="tel:${row.Contact}">${row.Contact}</a></td>
          <td>${row.Clinic}</td>
          <td>${row.Token}</td>
          <td>${row.Reminder}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("todayCount").textContent = todayCount;
      document.getElementById("nextToken").textContent = maxToken + 1;
    }

    function filterByToday() {
      const today = formatDisplayDate(new Date());
      const filtered = allData.filter(row => row.Date === today);
      renderTable(filtered);
    }

    function filterByYesterday() {
      const d = new Date();
      d.setDate(d.getDate() - 1);
      const yesterday = formatDisplayDate(d);
      const filtered = allData.filter(row => row.Date === yesterday);
      renderTable(filtered);
    }

    function applyCustomDate() {
      const d = document.getElementById("dateFilter").value;
      const filtered = allData.filter(row => row.Date === d);
      renderTable(filtered);
    }

    function exportCSV() {
      const csv = Papa.unparse(allData);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "logs-export.csv");
      link.click();
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const headers = [["Date", "Time", "Name", "Reason", "Contact", "Clinic", "Token", "Reminder"]];
      const rows = allData.map(r => [
        r.Date, r.Time, r.Name, r.Reason, r.Contact, r.Clinic, r.Token, r.Reminder
      ]);
      doc.autoTable({ head: headers, body: rows });
      doc.save("logs-export.pdf");
    }

    function formatDisplayDate(d) {
      return d.toISOString().split("T")[0];
    }

    function formatDate(str) {
      const parts = str.split("-");
      return `${parts[2]}-${parts[1]}-${parts[0]}` === new Date().toISOString().split("T")[0] ? new Date().toISOString().split("T")[0] : str;
    }

    fetchData();
  </script>

</body>
</html>      fetch(csvUrl).then(res => res.text()).then(text => {
        const blob = new Blob([text], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "AppointmentLogs.csv";
        a.click();
      });
    }

    function filterDate(type) {
      let filtered = [];
      const today = new Date();
      if (type === 'today') {
        const d = today.toISOString().split("T")[0];
        filtered = logData.filter(e => e.Date === d);
      } else if (type === 'yesterday') {
        today.setDate(today.getDate() - 1);
        const d = today.toISOString().split("T")[0];
        filtered = logData.filter(e => e.Date === d);
      } else {
        const sd = document.getElementById('startDate').value;
        const ed = document.getElementById('endDate').value;
        filtered = logData.filter(e => e.Date >= sd && e.Date <= ed);
      }
      renderTable(filtered);
    }

    function getPIN() {
      const params = new URLSearchParams(window.location.search);
      return params.get("pin");
    }

    const pin = getPIN();
    if (pin) loadPlansJson(pin);
    else alert("PIN missing from URL");
  </script>
</body>
</html>
