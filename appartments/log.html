<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booking Logs - Onestop C-Demo</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" type="image/png" href="assets/logo.png" />
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <img src="assets/logo.png" alt="Clinic Logo" class="logo" />
    <h1 class="clinic-name">Onestop C-Demo</h1>
    <img src="assets/banner.png" alt="Clinic Banner" class="banner" />
    <button id="themeToggle" class="theme-toggle">🌙</button>
  </header>

  <!-- Filters -->
  <section class="filters">
    <input type="date" id="dateFilter" />
    <input type="text" id="searchName" placeholder="Search by Name" />
    <input type="text" id="searchReason" placeholder="Search by Reason" />
    <button id="exportBtn" class="nav-btn">Export CSV</button>
  </section>

  <!-- Table -->
  <section class="logs-table">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Patient Name</th>
          <th>Slot Time</th>
          <th>Reason</th>
          <th>Contact</th>
          <th>Token</th>
          <th>Reminder Sent</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="logsBody">
        <tr><td colspan="8">Loading...</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Footer -->
  <footer class="app-footer">
    <p>Powered by Onestop AI</p>
  </footer>

  <script>
    const API_KEY = "YOUR_API_KEY";
    const BASE_ID = "app1T8WiRqZIR4xY";
    const TABLE_NAME = "BookingsLogs";

    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-theme');
      localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
    });
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-theme');
    }

    async function fetchLogs() {
      const res = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}?maxRecords=200&view=Grid%20view`, {
        headers: { Authorization: `Bearer ${API_KEY}` }
      });
      const data = await res.json();
      displayLogs(data.records);
    }

    function displayLogs(records) {
      const tbody = document.getElementById('logsBody');
      tbody.innerHTML = '';
      records.forEach(rec => {
        const f = rec.fields;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.Timestamp || ''}</td>
          <td>${f['Patient Name'] || ''}</td>
          <td>${f['Slot Time'] || ''}</td>
          <td>${f.Reason || ''}</td>
          <td><a href="tel:${f.Contact || ''}">${f.Contact || ''}</a></td>
          <td>${f.Token || ''}</td>
          <td>${f['Reminder Sent'] || ''}</td>
          <td>
            <button onclick="sendReminder('${f.Contact}', '${f['Patient Name']}', '${f['Slot Time']}', '${rec.id}')">📩</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function sendReminder(phone, name, slot, recordId) {
      const msg = `Hello ${name}, this is a reminder for your appointment at ${slot} today. - Onestop C-Demo`;
      window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');

      await fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${recordId}`, {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${API_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ fields: { "Reminder Sent": "✔️" } })
      });
      fetchLogs();
    }

    document.getElementById('exportBtn').addEventListener('click', () => {
      const rows = document.querySelectorAll("table tr");
      let csv = [];
      rows.forEach(row => {
        let cols = row.querySelectorAll("td, th");
        let rowData = [];
        cols.forEach(col => rowData.push(col.innerText));
        csv.push(rowData.join(","));
      });
      const blob = new Blob([csv.join("\n")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "booking_logs.csv";
      a.click();
    });

    fetchLogs();
  </script>
</body>
</html>
