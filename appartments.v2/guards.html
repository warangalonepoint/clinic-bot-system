<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Apartments • Guards</title>
<link rel="stylesheet" href="./styles.css">
<meta name="theme-color" content="#111"/>
</head>
<body class="bg">
  <!-- Language Toggle -->
  <button id="langToggle" class="lang-toggle" aria-label="Toggle language" title="తెలుగుకు మారండి">TE</button>

  <button class="logout" onclick="sessionStorage.clear();location.href='./index.html'" data-i18n="Logout">Logout</button>

  <main class="wrap">
    <div class="card hero">
      <img class="banner" src="./assets/apartments_banner.png" alt="Apartments">
      <div class="hero-overlay">
        <img class="logo" src="./assets/logo.png" onerror="this.style.display='none'">
        <div class="hero-title" data-i18n="Guard Console">Guard Console</div>
      </div>
    </div>

    <div class="grid2 mt">
      <!-- Pre-Approved Visitors -->
      <section class="card">
        <div class="row space">
          <h2 class="h2" data-i18n="Pre-Approved Visitors">Pre-Approved Visitors</h2>
          <input id="pa_search" class="in" style="max-width:260px"
                 placeholder="Search name/flat/purpose"
                 data-i18n-placeholder="Search name/flat/purpose">
        </div>
        <p class="muted" data-i18n="From residents’ pre-approvals. Verify ID → tap Check-In.">From residents’ pre-approvals. Verify ID → tap <b>Check-In</b>.</p>
        <div class="tablewrap">
          <table class="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th data-i18n="Flat">Flat</th>
                <th data-i18n="Name">Name</th>
                <th data-i18n="Date">Date</th>
                <th data-i18n="Purpose">Purpose</th>
                <th data-i18n="Action">Action</th>
              </tr>
            </thead>
            <tbody id="pa_tbody"></tbody>
          </table>
          <div id="pa_empty" class="muted" data-i18n="No pre-approvals found.">No pre-approvals found.</div>
        </div>
      </section>

      <!-- Walk-in Visitor -->
      <section class="card">
        <h2 class="h2" data-i18n="Walk-in Visitor">Walk-in Visitor</h2>
        <div class="grid2">
          <label data-i18n="Flat / Unit">Flat / Unit
            <input id="w_flat" class="in" placeholder="e.g., A-302" data-i18n-placeholder="e.g., A-302">
          </label>
          <label data-i18n="Name">Name
            <input id="w_name" class="in" placeholder="Visitor name" data-i18n-placeholder="Visitor name">
          </label>
          <label data-i18n="Phone">Phone
            <input id="w_phone" class="in" inputmode="numeric" maxlength="10" placeholder="optional" data-i18n-placeholder="optional">
          </label>
          <label data-i18n="Purpose">Purpose
            <input id="w_purpose" class="in" placeholder="guest/maintenance" data-i18n-placeholder="guest/maintenance">
          </label>
        </div>
        <div class="cam mt8">
          <div>
            <video id="cam" playsinline autoplay muted></video>
            <canvas id="snap" style="display:none"></canvas>
          </div>
          <div>
            <button class="btn" id="cam_start" data-i18n="Open Camera">Open Camera</button>
            <button class="btn mt8" id="cam_capture" data-i18n="Capture Photo">Capture Photo</button>
            <img id="preview" class="snap" alt="Snapshot" style="display:none"/>
          </div>
        </div>
        <div class="row mt8">
          <button class="btn" id="w_checkin" data-i18n="Check-In">Check-In</button>
          <button class="btn" id="w_clear" data-i18n="Clear">Clear</button>
        </div>
      </section>
    </div>

    <!-- Couriers / Deliveries -->
    <div class="card mt">
      <h2 class="h2" data-i18n="Couriers / Deliveries">Couriers / Deliveries</h2>
      <div class="grid2">
        <label data-i18n="Flat / Unit">Flat / Unit
          <input id="d_flat" class="in" placeholder="A-302" data-i18n-placeholder="A-302">
        </label>
        <label data-i18n="From / Courier">From / Courier
          <input id="d_from" class="in" placeholder="Amazon / Swiggy" data-i18n-placeholder="Amazon / Swiggy">
        </label>
      </div>
      <div class="cam mt8">
        <div>
          <video id="cam2" playsinline autoplay muted></video>
          <canvas id="snap2" style="display:none"></canvas>
        </div>
        <div>
          <button class="btn" id="cam2_start" data-i18n="Open Camera">Open Camera</button>
          <button class="btn mt8" id="cam2_capture" data-i18n="Capture Parcel">Capture Parcel</button>
          <img id="preview2" class="snap" alt="Parcel" style="display:none"/>
        </div>
      </div>
      <div class="row mt8">
        <button class="btn" id="d_add" data-i18n="Add Delivery">Add Delivery</button>
        <button class="btn" id="d_export" data-i18n="Export Deliveries CSV">Export Deliveries CSV</button>
      </div>
      <div class="tablewrap">
        <table class="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th data-i18n="Flat">Flat</th>
              <th data-i18n="From">From</th>
              <th data-i18n="Time">Time</th>
              <th data-i18n="Photo">Photo</th>
              <th data-i18n="Status">Status</th>
              <th data-i18n="Action">Action</th>
            </tr>
          </thead>
          <tbody id="d_tbody"></tbody>
        </table>
        <div id="d_empty" class="muted" data-i18n="No deliveries yet.">No deliveries yet.</div>
      </div>
    </div>

    <!-- Visitor History -->
    <div class="card mt">
      <div class="row space">
        <h2 class="h2" data-i18n="Visitor History (Today)">Visitor History (Today)</h2>
        <div class="row">
          <input id="vh_search" class="in" style="max-width:260px"
                 placeholder="Search name/flat/purpose"
                 data-i18n-placeholder="Search name/flat/purpose">
          <button class="btn" id="vh_export" data-i18n="Export Visitors CSV">Export Visitors CSV</button>
        </div>
      </div>
      <div class="tablewrap">
        <table class="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th data-i18n="Flat">Flat</th>
              <th data-i18n="Name">Name</th>
              <th data-i18n="Purpose">Purpose</th>
              <th data-i18n="Time">Time</th>
              <th data-i18n="Photo">Photo</th>
            </tr>
          </thead>
          <tbody id="vh_tbody"></tbody>
        </table>
        <div id="vh_empty" class="muted" data-i18n="No visitors checked in today.">No visitors checked in today.</div>
      </div>
    </div>

    <div class="card mt">
      <div class="grid2">
        <a class="btn" href="./index.html" data-i18n="Back to PIN">Back to PIN</a>
        <a class="btn" href="./reset.html" data-i18n="Reset / Cache Tools">Reset / Cache Tools</a>
      </div>
    </div>
  </main>

  <!-- i18n -->
  <script src="./lang.js" defer></script>

  <script>
  // translator helper
  function tr(key){ return (window.AppI18N && AppI18N.t) ? AppI18N.t(key) : key; }

  const K={preapprove:"apt_preapprove", visits:"apt_visits", deliveries:"apt_deliveries"};
  const $=id=>document.getElementById(id);
  const jget=k=>JSON.parse(localStorage.getItem(k)||"[]");
  const jset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const uid=()=>Math.random().toString(36).slice(2,9);
  const todayYMD=()=>new Date().toISOString().slice(0,10);
  const csv=(rows,heads,name)=>{const out=[heads.join(",")];rows.forEach(r=>out.push(heads.map(h=>`"${String(r[h]??"").replace(/"/g,'""')}"`).join(",")));const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([out.join("\n")],{type:"text/csv"}));a.download=name;a.click();};

  // camera
  async function openCam(videoEl){
    if(!navigator.mediaDevices?.getUserMedia){ alert(tr("Camera not supported")); return null; }
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false});
    videoEl.srcObject=s; return s;
  }
  function capture(videoEl,canvasEl){
    const vw=videoEl.videoWidth||640,vh=videoEl.videoHeight||480;
    canvasEl.width=vw; canvasEl.height=vh;
    const ctx=canvasEl.getContext("2d"); ctx.drawImage(videoEl,0,0,vw,vh);
    return canvasEl.toDataURL("image/jpeg",0.7);
  }
  function stopStream(s){ try{s.getTracks().forEach(t=>t.stop());}catch{} }

  // pre-approvals
  function renderPreApprovals(){
    const q=(pa_search.value||"").toLowerCase();
    const rows=jget(K.preapprove).filter(x=>String(x.date||"").slice(0,10)>=todayYMD()).sort((a,b)=>(a.date||"").localeCompare(b.date||""));
    const filtered=rows.filter(r=>(r.flat||"").toLowerCase().includes(q)||(r.name||"").toLowerCase().includes(q)||(r.purpose||"").toLowerCase().includes(q));
    pa_tbody.innerHTML=""; pa_empty.style.display=filtered.length?"none":"block";
    filtered.forEach((r,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i+1}</td><td>${r.flat}</td><td>${r.name}</td><td>${r.date||"—"}</td><td>${r.purpose||"—"}</td>
        <td><button class="btn" onclick="checkIn('${r.flat}','${r.name}','${r.phone||""}','${(r.purpose||"guest").replace(/"/g,'&quot;')}')" data-i18n="Check-In">${tr("Check-In")}</button></td>`;
      pa_tbody.appendChild(tr);
    });
  }
  pa_search.addEventListener("input",renderPreApprovals);

  // walk-in
  let cam1=null,cam2=null;
  cam_start.onclick=async()=>{ cam1=await openCam(cam); };
  cam_capture.onclick=()=>{ if(!cam1){alert(tr("Open camera first"));return} const d=capture(cam,snap); preview.src=d; preview.style.display="block"; };
  w_clear.onclick=()=>{ w_flat.value=w_name.value=w_phone.value=w_purpose.value=""; preview.src=""; preview.style.display="none"; if(cam1) stopStream(cam1); cam1=null; };

  window.checkIn=(flat,name,phone,purpose)=>{ w_flat.value=flat; w_name.value=name; w_phone.value=phone||""; w_purpose.value=purpose||"guest"; window.scrollTo({top:0,behavior:"smooth"}); };

  w_checkin.onclick=()=>{
    const flat=w_flat.value.trim(), name=w_name.value.trim(), phone=w_phone.value.trim(), purpose=w_purpose.value.trim()||"guest";
    if(!flat||!name){ alert(tr("Flat and Name required")); return; }
    const photo = preview.src && preview.style.display!=="none" ? preview.src : "";
    const arr=jget(K.visits); arr.unshift({id:uid(),flat,name,phone,purpose,ts:Date.now(),photo});
    jset(K.visits,arr);
    // mark PA used if matches (today)
    let pre=jget(K.preapprove);
    pre = pre.map(p=> (p.flat===flat && p.name===name && p.date===todayYMD()) ? {...p, status:"Checked-In"} : p);
    jset(K.preapprove,pre);
    w_name.value=w_phone.value=w_purpose.value=""; preview.src=""; preview.style.display="none";
    renderPreApprovals(); renderVisitorsHistory();
  };

  // deliveries
  cam2_start.onclick=async()=>{ cam2=await openCam(cam2); };
  cam2_capture.onclick=()=>{ if(!cam2){alert(tr("Open camera first"));return} const d=capture(cam2,snap2); preview2.src=d; preview2.style.display="block"; };

  d_add.onclick=()=>{
    const flat=d_flat.value.trim(), from=d_from.value.trim();
    if(!flat||!from){ alert(tr("Flat and From required")); return; }
    const photo = preview2.src && preview2.style.display!=="none" ? preview2.src : "";
    const arr=jget(K.deliveries); arr.unshift({id:uid(),flat,from,ts:Date.now(),status:"At Gate",photo});
    jset(K.deliveries,arr);
    d_from.value=""; preview2.src=""; preview2.style.display="none";
    renderDeliveries();
  };

  function renderDeliveries(){
    const rows=jget(K.deliveries).sort((a,b)=>b.ts-a.ts);
    d_tbody.innerHTML=""; d_empty.style.display=rows.length?"none":"block";
    rows.forEach((r,i)=>{
      const t=new Date(r.ts).toLocaleString([], {month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
      const img=r.photo?`<img src="${r.photo}" style="width:70px;height:50px;object-fit:cover;border-radius:8px">`:"—";
      const btn=r.status==="At Gate"
        ? `<button class="btn" onclick="dispatchDel('${r.id}')" data-i18n="Dispatch">${tr("Dispatch")}</button>`
        : `<span class="muted">${tr(r.status)}</span>`;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i+1}</td><td>${r.flat}</td><td>${r.from}</td><td>${t}</td><td>${img}</td><td>${tr(r.status)}</td><td>${btn}</td>`;
      d_tbody.appendChild(tr);
    });
  }
  window.dispatchDel=(id)=>{ const arr=jget(K.deliveries); const i=arr.findIndex(x=>x.id===id); if(i>-1){ arr[i].status="Dispatched"; jset(K.deliveries,arr); renderDeliveries(); } };
  d_export.onclick=()=>{ const rows=jget(K.deliveries).map(({photo,...x})=>x); csv(rows,["id","flat","from","ts","status"],"Deliveries.csv"); };

  // visitors history
  function renderVisitorsHistory(){
    const q=(vh_search.value||"").toLowerCase();
    const rows=jget(K.visits).filter(v=>new Date(v.ts).toISOString().slice(0,10)===todayYMD())
      .filter(r=>(r.flat||"").toLowerCase().includes(q)||(r.name||"").toLowerCase().includes(q)||(r.purpose||"").toLowerCase().includes(q));
    vh_tbody.innerHTML=""; vh_empty.style.display=rows.length?"none":"block";
    rows.forEach((r,i)=>{
      const t=new Date(r.ts).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
      const img=r.photo?`<img src="${r.photo}" style="width:70px;height:50px;object-fit:cover;border-radius:8px">`:"—";
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i+1}</td><td>${r.flat}</td><td>${r.name}</td><td>${r.purpose}</td><td>${t}</td><td>${img}</td>`;
      vh_tbody.appendChild(tr);
    });
  }
  vh_search.addEventListener("input",renderVisitorsHistory);
  vh_export.onclick=()=>{ const rows=jget(K.visits).filter(v=>new Date(v.ts).toISOString().slice(0,10)===todayYMD()).map(({photo,...x})=>x); csv(rows,["id","flat","name","phone","purpose","ts"],"Visitors_Today.csv"); };

  if("serviceWorker" in navigator){navigator.serviceWorker.register("./sw.js").catch(()=>{});}
  renderPreApprovals(); renderDeliveries(); renderVisitorsHistory();
  window.addEventListener("beforeunload",()=>{ if(cam1) stopStream(cam1); if(cam2) stopStream(cam2); });
  </script>
</body>
</html>
