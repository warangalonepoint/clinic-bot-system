<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Appointment Logs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 10px;
    }
    h2 {
      text-align: center;
      color: #4fc3f7;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #444;
      text-align: left;
    }
    th {
      background: #222;
      color: #f0ad4e;
    }
    button {
      background: #4fc3f7;
      color: #000;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    #filters {
      margin: 10px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    #filters input, #filters select {
      padding: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h2>üìã Appointment Logs ‚Äî Loading...</h2>

<div id="filters">
  <label>
    Date Filter:
    <select id="dateFilter">
      <option value="today">Today</option>
      <option value="yesterday">Yesterday</option>
      <option value="custom">Custom Range</option>
      <option value="all">All</option>
    </select>
  </label>
  <input type="date" id="startDate" style="display:none;" />
  <input type="date" id="endDate" style="display:none;" />
  <button onclick="applyFilter()">Apply</button>
  <button onclick="exportCSV()">‚¨á Export CSV</button>
</div>

<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Time</th>
      <th>Name</th>
      <th>Reason</th>
      <th>Contact</th>
      <th>Token</th>
      <th>Reminder</th>
      <th>Reminder Sent</th>
      <th>Send</th>
    </tr>
  </thead>
  <tbody id="logBody"></tbody>
</table>

<script>
let logData = [];
let clinic = "default";

// Get PIN from URL
const params = new URLSearchParams(window.location.search);
const pin = params.get("pin");

// Fetch plan and clinic info
fetch("plans.json")
  .then(res => res.json())
  .then(plans => {
    const found = plans.find(p => p.pin === pin);
    if (!found) return alert("Invalid PIN.");
    clinic = found.clinic;
    document.title = `Appointment Logs ‚Äì ${clinic}`;
    loadLogs(`clinic-${clinic}-logs.csv`);
  });

function loadLogs(csvPath) {
  fetch(csvPath)
    .then(r => r.text())
    .then(csv => {
      const lines = csv.trim().split("\n");
      const headers = lines[0].split(",");
      logData = lines.slice(1).map(line => {
        const values = line.split(",");
        const entry = {};
        headers.forEach((h, i) => entry[h.trim()] = values[i]?.trim() || "");
        return entry;
      });
      renderTable(logData);
    });
}

function renderTable(data) {
  const tbody = document.getElementById("logBody");
  tbody.innerHTML = "";
  data.forEach(entry => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${entry.Date}</td>
      <td>${entry.Time}</td>
      <td>${entry.Name}</td>
      <td>${entry.Reason}</td>
      <td><a href="tel:${entry.Contact}" style="color:#4fc3f7;">${entry.Contact}</a></td>
      <td>${entry.Token || '-'}</td>
      <td>${entry.Reminder || '-'}</td>
      <td>${entry["Reminder Sent"] || '‚ùå'}</td>
      <td><button onclick="sendReminder('${entry.Contact}','${entry.Time}','${entry.Token || ''}')">Send</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function sendReminder(contact, time, token) {
  const msg = `Reminder: Your appointment is at ${time}. Token No: ${token}`;
  const link = `https://wa.me/${contact}?text=${encodeURIComponent(msg)}`;
  window.open(link, "_blank");
}

function applyFilter() {
  const type = document.getElementById("dateFilter").value;
  let filtered = logData;

  if (type === "today" || type === "yesterday") {
    const today = new Date();
    const target = new Date(today);
    if (type === "yesterday") target.setDate(today.getDate() - 1);
    const dateStr = target.toISOString().split("T")[0];
    filtered = logData.filter(e => e.Date === dateStr);
  } else if (type === "custom") {
    const sd = document.getElementById("startDate").value;
    const ed = document.getElementById("endDate").value;
    filtered = logData.filter(e => e.Date >= sd && e.Date <= ed);
  }

  renderTable(filtered);
}

function exportCSV() {
  const headers = ["Date","Time","Name","Reason","Contact","Token","Reminder","Reminder Sent"];
  const rows = logData.map(e => headers.map(h => `"${e[h] || ''}"`).join(","));
  const csv = [headers.join(","), ...rows].join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `clinic-${clinic}-logs.csv`;
  a.click();
}

document.getElementById("dateFilter").addEventListener("change", () => {
  const type = document.getElementById("dateFilter").value;
  const showCustom = type === "custom";
  document.getElementById("startDate").style.display = showCustom ? "inline" : "none";
  document.getElementById("endDate").style.display = showCustom ? "inline" : "none";
});
</script>

</body>
</html>
