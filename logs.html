<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Appointment Logs</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    #summary {
      text-align: center;
      font-weight: bold;
      color: green;
      margin-bottom: 20px;
    }
    .filters {
      text-align: center;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      text-align: center;
    }
    .export-btns {
      text-align: center;
      margin-top: 10px;
    }
    button {
      margin: 4px;
      padding: 8px 16px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üìã Appointment Logs</h1>
  <div id="summary">Loading...</div>

  <div class="filters">
    <button onclick="filterDate('today')">Today</button>
    <button onclick="filterDate('yesterday')">Yesterday</button>
    <br><br>
    <input type="date" id="startDate"> to
    <input type="date" id="endDate">
    <button onclick="filterDate('custom')">Apply</button>
  </div>

  <div class="export-btns">
    <button onclick="exportCSV()">üìÅ Export CSV</button>
    <button onclick="exportPDF()">üßæ Export PDF</button>
  </div>

  <table id="logTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Name</th>
        <th>Reason</th>
        <th>Contact</th>
        <th>Clinic</th>
        <th>Token</th>
        <th>Reminder</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const csvUrl = "logs.csv";
    let allData = [];

    function fetchData() {
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function(results) {
          const logData = results.data.filter(row => row.Date);
          allData = logData;
          updateSummary(logData);
          renderTable(logData);
        }
      });
    }

    function updateSummary(data) {
      const today = new Date().toISOString().split("T")[0];
      const todayCount = data.filter(r => r.Date === today).length;
      const todayTokens = data.filter(r => r.Date === today)
                              .map(r => parseInt(r.Token)).filter(n => !isNaN(n));
      const nextToken = todayTokens.length > 0 ? Math.max(...todayTokens) + 1 : 1;
      document.getElementById("summary").textContent =
        `‚úÖ Bookings Today: ${todayCount} | Next Token: ${nextToken}`;
    }

    function renderTable(data) {
      const tbody = document.querySelector("#logTable tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.Date}</td>
          <td>${row.Time}</td>
          <td>${row.Name}</td>
          <td>${row.Reason}</td>
          <td><a href="tel:${row.Contact}">${row.Contact}</a></td>
          <td>${row.Clinic}</td>
          <td>${row.Token}</td>
          <td>${row["Reminder Sent"] || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function exportCSV() {
      const csv = Papa.unparse(allData);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "AppointmentLogs.csv");
      link.click();
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const headers = [["Date", "Time", "Name", "Reason", "Contact", "Clinic", "Token", "Reminder"]];
      const rows = allData.map(r => [
        r.Date, r.Time, r.Name, r.Reason, r.Contact, r.Clinic, r.Token, r["Reminder Sent"] || ""
      ]);
      doc.autoTable({ head: headers, body: rows });
      doc.save("logs-export.pdf");
    }

    function filterDate(type) {
      let filtered = [];
      const today = new Date();
      if (type === 'today') {
        const d = today.toISOString().split("T")[0];
        filtered = allData.filter(e => e.Date === d);
      } else if (type === 'yesterday') {
        today.setDate(today.getDate() - 1);
        const d = today.toISOString().split("T")[0];
        filtered = allData.filter(e => e.Date === d);
      } else {
        const sd = document.getElementById("startDate").value;
        const ed = document.getElementById("endDate").value;
        if (!sd || !ed) return alert("Select valid date range");
        filtered = allData.filter(e => e.Date >= sd && e.Date <= ed);
      }
      updateSummary(filtered);
      renderTable(filtered);
    }

    fetchData();
  </script>
</body>
</html>
