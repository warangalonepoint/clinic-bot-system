<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Apartments • Residents</title>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="stylesheet" href="./styles.css">
<meta name="theme-color" content="#111"/>
<style>
  :root{--max:1000px}
  body{background:#f8f9fa}
  main{max-width:var(--max);margin:16px auto;padding:16px}
  .logout{position:fixed;right:14px;top:14px;z-index:9;padding:10px 14px;border:0;border-radius:12px;font-weight:700;background:#111;color:#fff}
  /* Polished banner/header */
  .card{background:#fff;border-radius:18px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
  .hero{position:relative;padding:0;overflow:hidden;border-radius:18px}
  .banner{width:100%;height:180px;object-fit:cover;display:block}
  @media(max-width:560px){.banner{height:140px}}
  .hero-overlay{position:absolute;inset:0;display:flex;align-items:flex-end;padding:14px;background:linear-gradient(to bottom,rgba(0,0,0,0) 55%,rgba(0,0,0,.38))}
  .logo{position:absolute;top:12px;left:12px;width:56px;height:56px;border-radius:999px;background:#fff;padding:8px;box-shadow:0 6px 20px rgba(0,0,0,.18)}
  .hero-title{margin-left:80px;margin-bottom:6px;font-weight:800;font-size:20px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.35)}
  .hero,.logo,.hero-title{animation:fade .35s ease-out both}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  /* Layout helpers */
  .grid2{display:grid;grid-template-columns:1.1fr 1fr;gap:12px}
  @media(max-width:980px){.grid2{grid-template-columns:1fr}}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:560px){.grid{grid-template-columns:1fr}}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .muted{color:#666}

  /* Inputs & table */
  input,select,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;font-size:15px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
  .pill{background:#eee;border-radius:999px;padding:4px 10px;display:inline-block}
  .ok{color:#0d7c66}
  .warn{color:#b00020}

  /* Buttons */
  .btn{padding:10px 14px;border:0;border-radius:12px;font-weight:700;background:#111;color:#fff;cursor:pointer;text-decoration:none;text-align:center}
  .iconbtn{display:inline-flex;align-items:center;gap:10px;justify-content:center}
  .iconbtn img{width:18px;height:18px;border-radius:4px}
</style>
</head><body>
<button class="logout" onclick="sessionStorage.clear();location.href='./index.html'">Logout</button>

<main>
  <!-- Header -->
  <div class="card hero">
    <img class="banner" src="./assets/apartments_banner.png" alt="Apartments">
    <div class="hero-overlay">
      <img class="logo" src="./assets/logo.png" onerror="this.src='./assets/admin.png'">
      <div class="hero-title">Resident Console</div>
    </div>
  </div>

  <!-- Profile / My Home -->
  <div class="card" style="margin-top:12px">
    <h2 style="margin:0 0 8px">My Home</h2>
    <p class="muted" style="margin:0 0 8px">Set your flat once. All lists are auto-filtered to your flat.</p>
    <div class="grid">
      <label>Flat / Unit <input id="r_flat" placeholder="e.g., A-302"></label>
      <label>Your Name <input id="r_name" placeholder="e.g., Chaitanya"></label>
      <label>Phone <input id="r_phone" inputmode="numeric" maxlength="10" placeholder="10-digit"></label>
      <label>Block / Tower (optional) <input id="r_block" placeholder="e.g., A Tower"></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="save_profile">Save</button>
      <span id="prof_msg" class="ok"></span>
    </div>
  </div>

  <div class="grid2" style="margin-top:12px">
    <!-- LEFT: Visitors & Deliveries -->
    <section class="card">
      <h2 style="margin:0 0 8px">Visitors (Pre-Approve)</h2>
      <div class="grid">
        <label>Name <input id="v_name" placeholder="e.g., Courier / Friend"></label>
        <label>Phone <input id="v_phone" inputmode="numeric" maxlength="10" placeholder="optional"></label>
        <label>Visit Date <input id="v_date" type="date"></label>
        <label>Purpose <input id="v_purpose" placeholder="delivery/guest/maintenance"></label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="v_add">Pre-Approve</button>
      </div>
      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead><tr><th>#</th><th>Name</th><th>Date</th><th>Purpose</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="v_tbody"></tbody>
        </table>
        <div id="v_empty" class="muted">No pre-approvals yet.</div>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:14px 0">

      <h2 style="margin:0 0 8px">Couriers / Deliveries</h2>
      <p class="muted" style="margin:0 0 8px">Added by guards at the gate. You can acknowledge here.</p>
      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead><tr><th>#</th><th>From</th><th>Time</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="d_tbody"></tbody>
        </table>
        <div id="d_empty" class="muted">No deliveries recorded for your flat yet.</div>
      </div>
    </section>

    <!-- RIGHT: Complaints & Notices -->
    <aside class="card">
      <h2 style="margin:0 0 8px">Raise Complaint</h2>
      <div class="grid">
        <label>Category
          <select id="c_cat">
            <option>Plumbing</option><option>Electrical</option><option>Security</option>
            <option>Housekeeping</option><option>Other</option>
          </select>
        </label>
        <label>Urgency
          <select id="c_priority"><option>Normal</option><option>High</option><option>Critical</option></select>
        </label>
        <label style="grid-column:1/-1">Details
          <textarea id="c_desc" rows="4" placeholder="Describe the issue"></textarea>
        </label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="c_add">Submit</button>
        <button class="btn" id="c_export">Export My Complaints</button>
      </div>

      <div style="margin-top:12px;overflow:auto">
        <table>
          <thead><tr><th>#</th><th>When</th><th>Category</th><th>Priority</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="c_tbody"></tbody>
        </table>
        <div id="c_empty" class="muted">No complaints yet.</div>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:14px 0">

      <h2 style="margin:0 0 8px">Society Notices</h2>
      <p class="muted" style="margin:0 0 6px">Posted by Committee/Admin.</p>
      <div style="margin-top:6px;overflow:auto">
        <table>
          <thead><tr><th>#</th><th>Notice</th><th>Time</th><th>Action</th></tr></thead>
          <tbody id="n_tbody"></tbody>
        </table>
        <div id="n_empty" class="muted">No notices yet.</div>
      </div>
    </aside>
  </div>

  <!-- Tools -->
  <div class="card" style="margin-top:12px">
    <div class="grid">
      <a class="btn iconbtn" href="./index.html"><img src="./assets/admin.png" onerror="this.style.display='none'">Back to PIN</a>
      <a class="btn iconbtn" href="./reset.html"><img src="./assets/reset.png" onerror="this.style.display='none'">Reset / Cache Tools</a>
    </div>
  </div>
</main>

<script>
// --- Keys / Utils ---
const K={
  profile:"apt_profile",           // {flat,name,phone,block}
  preapprove:"apt_preapprove",     // [{id,flat,name,phone,date,purpose,status,ts}]
  deliveries:"apt_deliveries",     // [{id,flat,from,ts,status}]  (guards will add)
  complaints:"apt_complaints",     // [{id,flat,cat,priority,desc,status,ts}]
  notices:"apt_notices"            // [{id,msg,ts}]
};
const $=id=>document.getElementById(id);
const jget=k=>JSON.parse(localStorage.getItem(k)||"[]");
const jset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const now=()=>new Date().toLocaleString([], {hour:"2-digit",minute:"2-digit"});
const ymd=()=>new Date().toISOString().slice(0,10);
const csv=(rows,heads,name)=>{const out=[heads.join(",")];rows.forEach(r=>out.push(heads.map(h=>`"${String(r[h]??"").replace(/"/g,'""')}"`).join(",")));const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([out.join("\n")],{type:"text/csv"}));a.download=name;a.click();};
const uid=()=>Math.random().toString(36).slice(2,9);

// --- Profile ---
function loadProfile(){
  const p=JSON.parse(localStorage.getItem(K.profile)||"{}");
  r_flat.value=p.flat||""; r_name.value=p.name||""; r_phone.value=p.phone||""; r_block.value=p.block||"";
  return p;
}
function saveProfile(){
  const flat=r_flat.value.trim(), name=r_name.value.trim(), phone=r_phone.value.trim(), block=r_block.value.trim();
  if(!flat||!name){ prof_msg.textContent="Flat & Name required."; prof_msg.className="warn"; return false; }
  localStorage.setItem(K.profile, JSON.stringify({flat,name,phone,block}));
  prof_msg.textContent="Saved ✅"; prof_msg.className="ok";
  setTimeout(()=>prof_msg.textContent="",1200);
  renderAll();
  return true;
}
$("save_profile").onclick=saveProfile;

// --- Visitors (pre-approve) ---
function renderVisitors(){
  const p=loadProfile(); if(!p.flat){ v_empty.style.display="block"; v_tbody.innerHTML=""; return; }
  const rows=jget(K.preapprove).filter(x=>x.flat===p.flat).sort((a,b)=>String(a.date).localeCompare(b.date));
  v_tbody.innerHTML=""; v_empty.style.display = rows.length? "none":"block";
  rows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${r.name}</td><td>${r.date||"—"}</td><td>${r.purpose||"—"}</td><td>${r.status||"Approved"}</td>
      <td class="row"><button class="btn" onclick="cancelPre('${r.id}')">Cancel</button></td>`;
    v_tbody.appendChild(tr);
  });
}
window.cancelPre=(id)=>{
  let arr=jget(K.preapprove); const p=loadProfile();
  arr=arr.filter(x=>!(x.id===id && x.flat===p.flat));
  jset(K.preapprove,arr); renderVisitors();
};
$("v_add").onclick=()=>{
  const p=loadProfile(); if(!p.flat){alert("Save your flat first.");return}
  const name=v_name.value.trim(), phone=v_phone.value.trim(), date=v_date.value, purpose=v_purpose.value.trim();
  if(!name||!date){alert("Enter name & date.");return}
  const arr=jget(K.preapprove); arr.push({id:uid(),flat:p.flat,name,phone,date,purpose,status:"Approved",ts:Date.now()});
  jset(K.preapprove,arr);
  v_name.value=v_phone.value=v_purpose.value=""; renderVisitors();
};

// --- Deliveries ---
function renderDeliveries(){
  const p=loadProfile(); if(!p.flat){ d_empty.style.display="block"; d_tbody.innerHTML=""; return; }
  const rows=jget(K.deliveries).filter(x=>x.flat===p.flat).sort((a,b)=>b.ts-a.ts);
  d_tbody.innerHTML=""; d_empty.style.display = rows.length? "none":"block";
  rows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    const t = new Date(r.ts||Date.now()).toLocaleString([], {month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    tr.innerHTML=`<td>${i+1}</td><td>${r.from||"Courier"}</td><td>${t}</td><td>${r.status||"At Gate"}</td>
      <td class="row">
        <button class="btn" onclick="ackDel('${r.id}')">Mark Received</button>
      </td>`;
    d_tbody.appendChild(tr);
  });
}
window.ackDel=(id)=>{
  const arr=jget(K.deliveries); const i=arr.findIndex(x=>x.id===id);
  if(i>-1){ arr[i].status="Received by Resident"; jset(K.deliveries,arr); renderDeliveries(); }
};

// --- Complaints ---
function renderComplaints(){
  const p=loadProfile(); if(!p.flat){ c_empty.style.display="block"; c_tbody.innerHTML=""; return; }
  const rows=jget(K.complaints).filter(x=>x.flat===p.flat).sort((a,b)=>b.ts-a.ts);
  c_tbody.innerHTML=""; c_empty.style.display = rows.length? "none":"block";
  rows.forEach((r,i)=>{
    const t=new Date(r.ts).toLocaleString([], {month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    const canClose = r.status!=="Closed";
    const actBtn = canClose? `<button class="btn" onclick="closeComplaint('${r.id}')">Mark Resolved</button>` : `<span class="pill">Closed</span>`;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${t}</td><td>${r.cat}</td><td>${r.priority}</td><td>${r.status}</td><td>${actBtn}</td>`;
    c_tbody.appendChild(tr);
  });
}
$("c_add").onclick=()=>{
  const p=loadProfile(); if(!p.flat){alert("Save your flat first.");return}
  const cat=c_cat.value, priority=c_priority.value, desc=c_desc.value.trim();
  if(!desc){alert("Add a short description.");return}
  const arr=jget(K.complaints); arr.push({id:uid(),flat:p.flat,cat,priority,desc,status:"Open",ts:Date.now()});
  jset(K.complaints,arr); c_desc.value=""; renderComplaints();
};
$("c_export").onclick=()=>{
  const p=loadProfile(); const mine=jget(K.complaints).filter(x=>x.flat===(p.flat||""));
  csv(mine,["id","flat","cat","priority","desc","status","ts"],"My_Complaints.csv");
};
window.closeComplaint=(id)=>{
  const arr=jget(K.complaints); const i=arr.findIndex(x=>x.id===id);
  if(i>-1){ arr[i].status="Closed"; jset(K.complaints,arr); renderComplaints(); }
};

// --- Notices ---
function renderNotices(){
  const rows=jget(K.notices).sort((a,b)=>b.ts-a.ts);
  n_tbody.innerHTML=""; n_empty.style.display = rows.length? "none":"block";
  // Per-resident read receipts
  const flat=(JSON.parse(localStorage.getItem(K.profile)||"{}").flat)||"";
  const READ_KEY = `apt_notices_read_${flat}`;
  const seen = new Set(JSON.parse(localStorage.getItem(READ_KEY)||"[]"));

  rows.forEach((r,i)=>{
    const text = r.msg||""; const t=new Date(r.ts).toLocaleString([], {month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    const read = seen.has(r.id);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${text}</td><td>${t}</td>
      <td>${read?'<span class="pill">Read</span>':`<button class="btn" onclick="markNotice('${r.id}')">Mark Read</button>`}</td>`;
    n_tbody.appendChild(tr);
  });

  window.markNotice=(id)=>{
    seen.add(id);
    localStorage.setItem(READ_KEY, JSON.stringify([...seen]));
    renderNotices();
  };
}

// --- Render all ---
function renderAll(){ renderVisitors(); renderDeliveries(); renderComplaints(); renderNotices(); }

// Init
loadProfile(); renderAll();
if("serviceWorker" in navigator){navigator.serviceWorker.register("./sw.js").catch(()=>{});}
</script>
</body></html>
