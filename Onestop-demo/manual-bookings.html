<!-- Step-by-step implementation begins here --><!-- This file is: manual-bookings.html --><!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manual Booking | Onestop C-Demo</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    header, footer { background: #000; color: #fff; text-align: center; padding: 10px; }
    .container { padding: 20px; }
    input, select { padding: 6px; margin: 5px; width: 95%; max-width: 300px; }
    button { padding: 10px 15px; background: black; color: white; border: none; cursor: pointer; }
    .form-group { margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>
    <img src="assets/banner.png" alt="Banner" style="max-width: 100%; height: auto;">
    <h2>Onestop C-Demo</h2>
    <h3>Manual Booking</h3>
  </header>  <div class="container">
    <div class="form-group">
      <input type="text" id="name" placeholder="Patient Name">
    </div>
    <div class="form-group">
      <input type="text" id="contact" placeholder="Contact Number">
    </div>
    <div class="form-group">
      <input type="text" id="reason" placeholder="Reason for Visit">
    </div>
    <div class="form-group">
      <select id="dateDropdown">
        <option selected disabled>Select Date</option>
      </select>
    </div>
    <div class="form-group">
      <select id="slotDropdown">
        <option selected disabled>Select Time Slot</option>
      </select>
    </div>
    <div class="form-group">
      <button onclick="submitBooking()">Confirm Booking</button>
    </div>
    <div id="confirmation" style="margin-top: 10px;"></div>
  </div>  <footer>Powered by Onestop AI</footer>  <script>
    const apiKey = 'YOUR_API_KEY';
    const baseId = 'app1T8WiRqZIR4xY';
    const slotsTable = 'AvailableSlots';
    const logsTable = 'BookingsLogs';

    async function fetchAvailableSlots() {
      const url = `https://api.airtable.com/v0/${baseId}/${slotsTable}?view=Grid%20view`;
      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${apiKey}` }
      });
      const data = await response.json();
      const records = data.records;

      const dates = [...new Set(records.map(r => r.fields.Date))].sort();
      const dateDropdown = document.getElementById('dateDropdown');
      dates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        dateDropdown.appendChild(option);
      });

      dateDropdown.addEventListener('change', () => {
        const selectedDate = dateDropdown.value;
        const slots = records.filter(r => r.fields.Date === selectedDate && r.fields.Status !== 'Booked');
        const slotDropdown = document.getElementById('slotDropdown');
        slotDropdown.innerHTML = '<option selected disabled>Select Time Slot</option>';
        slots.forEach(slot => {
          const option = document.createElement('option');
          option.value = slot.fields['Time Slot'];
          option.textContent = slot.fields['Time Slot'];
          option.setAttribute('data-record-id', slot.id);
          slotDropdown.appendChild(option);
        });
      });
    }

    async function submitBooking() {
      const name = document.getElementById('name').value.trim();
      const contact = document.getElementById('contact').value.trim();
      const reason = document.getElementById('reason').value.trim();
      const date = document.getElementById('dateDropdown').value;
      const slot = document.getElementById('slotDropdown').value;
      const slotId = document.querySelector(`#slotDropdown option[value='${slot}']`).dataset.recordId;

      if (!name || !contact || !reason || !date || !slotId) {
        alert('All fields are required.');
        return;
      }

      // 1. Fetch token count for the day
      const tokenResponse = await fetch(`https://api.airtable.com/v0/${baseId}/${logsTable}?filterByFormula={Timestamp}='${date}'`, {
        headers: { Authorization: `Bearer ${apiKey}` }
      });
      const tokenData = await tokenResponse.json();
      const token = tokenData.records.length + 1;

      // 2. Save to BookingsLogs
      await fetch(`https://api.airtable.com/v0/${baseId}/${logsTable}`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fields: {
            Timestamp: date,
            'Patient Name': name,
            'Slot Time': slot,
            Reason: reason,
            Contact: contact,
            Token: token
          }
        })
      });

      // 3. Mark slot as booked
      await fetch(`https://api.airtable.com/v0/${baseId}/${slotsTable}/${slotId}`, {
        method: 'PATCH',
        headers: {
          Authorization: `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fields: { Status: 'Booked' }
        })
      });

      document.getElementById('confirmation').innerHTML = `✅ Booking Confirmed! Token #${token}`;
    }

    fetchAvailableSlots();
  </script></body>
</html>            'Slot Time': slot,
            'Date': date,
            'Reason': reason,
            'Contact': contact,
            'Token': token,
            'Reminder Sent': ''
          }
        }]
      });

      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${bookingsTable}`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          'Content-Type': 'application/json'
        },
        body
      });

      if (res.ok) {
        document.getElementById('bookingForm').style.display = 'none';
        document.getElementById('confirmation').style.display = 'block';
        document.getElementById('confirmation').innerHTML = `
          <h3>✅ Booking Confirmed!</h3>
          <p>Your Token Number is: <strong>#${token}</strong></p>
          <p>Date: ${date} | Slot: ${slot}</p>
        `;
      } else {
        alert("Failed to save. Try again.");
      }
    }

    document.getElementById('dateDropdown').addEventListener('change', function() {
      fetchTimeSlots(this.value);
    });

    document.getElementById('bookingForm').addEventListener('submit', submitBooking);
    document.addEventListener('DOMContentLoaded', fetchAvailableDates);
  </script>
</body>
</html>
