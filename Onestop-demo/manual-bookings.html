<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manual Bookings – Onestop C-Demo</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .container { max-width: 500px; margin: auto; padding: 20px; }
    select, input, button {
      width: 100%; padding: 12px; margin: 8px 0;
      border: 1px solid #ccc; border-radius: 5px;
    }
    button { background: black; color: white; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <img src="assets/banner.png" style="width:100%; margin-bottom:10px;" />
    <h2>Manual Bookings – Onestop C-Demo</h2>
    
    <select id="dateDropdown"></select>
    <select id="slotDropdown"><option>Select Slot</option></select>
    
    <input type="text" id="patientName" placeholder="Patient Name">
    <input type="text" id="reason" placeholder="Reason">
    <input type="text" id="contact" placeholder="Contact">

    <button onclick="confirmBooking()">Confirm Booking</button>

    <p id="statusMsg" style="text-align:center; margin-top:10px;"></p>
    <p style="text-align:center;"><a href="index.html">← Back to Dashboard</a></p>
  </div>

  <script>
    const apiKey = "patLNwoJQKE3Tjb8J.c2a0db129111c610fae64a2c01e0a626f37bdb5992232ea6ebc644fa9073dfb3";
    const baseId = "app1T8WiRqZIR4xY";
    const slotsTable = "AvailableSlots";
    const bookingsTable = "BookingsLogs";

    const headers = { Authorization: "Bearer " + apiKey };

    async function loadDates() {
      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${slotsTable}?pageSize=100`, { headers });
      const data = await res.json();
      const futureDates = [...new Set(data.records
        .map(r => r.fields.Date)
        .filter(d => new Date(d) >= new Date())
      )];
      const dropdown = document.getElementById("dateDropdown");
      futureDates.sort().forEach(date => {
        const opt = document.createElement("option");
        opt.value = date; opt.text = date;
        dropdown.appendChild(opt);
      });
    }

    document.getElementById("dateDropdown").addEventListener("change", async function () {
      const selectedDate = this.value;
      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${slotsTable}?filterByFormula=AND({Date}='${selectedDate}',{Status}='Available')`, { headers });
      const data = await res.json();
      const dropdown = document.getElementById("slotDropdown");
      dropdown.innerHTML = "<option>Select Slot</option>";
      data.records.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.fields["Time Slot"];
        opt.text = r.fields["Time Slot"];
        opt.dataset.recordId = r.id;
        dropdown.appendChild(opt);
      });
    });

    async function getNextToken(date) {
      const res = await fetch(`https://api.airtable.com/v0/${baseId}/${bookingsTable}?filterByFormula={Timestamp}='${date}'`, { headers });
      const data = await res.json();
      return data.records.length + 1;
    }

    async function confirmBooking() {
      const date = document.getElementById("dateDropdown").value;
      const slot = document.getElementById("slotDropdown").value;
      const patientName = document.getElementById("patientName").value;
      const reason = document.getElementById("reason").value;
      const contact = document.getElementById("contact").value;
      const slotOption = document.querySelector(`#slotDropdown option[value="${slot}"]`);
      const slotRecordId = slotOption?.dataset?.recordId;

      if (!date || !slot || !patientName || !contact) {
        alert("Please fill all fields");
        return;
      }

      const token = await getNextToken(date);

      // Save Booking
      await fetch(`https://api.airtable.com/v0/${baseId}/${bookingsTable}`, {
        method: "POST",
        headers: { ...headers, "Content-Type": "application/json" },
        body: JSON.stringify({
          fields: {
            "Timestamp": date,
            "Slot Time": slot,
            "Patient Name": patientName,
            "Reason": reason,
            "Contact": contact,
            "Token": token
          }
        })
      });

      // Mark Slot as Booked
      if (slotRecordId) {
        await fetch(`https://api.airtable.com/v0/${baseId}/${slotsTable}/${slotRecordId}`, {
          method: "PATCH",
          headers: { ...headers, "Content-Type": "application/json" },
          body: JSON.stringify({ fields: { Status: "Booked" } })
        });
      }

      document.getElementById("statusMsg").innerText = "✅ Booking Confirmed!";
      setTimeout(() => location.reload(), 1500);
    }

    loadDates();
  </script>
</body>
</html>
