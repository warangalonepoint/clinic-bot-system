<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Apartments â€¢ Residents</title>
<link rel="stylesheet" href="./styles.css">
<meta name="theme-color" content="#111"/>
</head>
<body class="bg">

<button class="logout" onclick="sessionStorage.clear();location.href='./index.html'">Logout</button>

<main class="wrap">
  <!-- HERO -->
  <div class="card hero">
    <img class="banner" src="./assets/apartments_banner.png" alt="Apartments">
    <div class="hero-overlay">
      <img class="logo" src="./assets/logo.png" onerror="this.style.display='none'">
      <div class="hero-title" data-i18n="residents_title">Residents</div>
      <div class="toolbar" style="position:absolute;right:14px;top:14px;display:flex;gap:8px">
        <button id="themeBtn" class="chip" title="Toggle theme">ðŸŒ™</button>
        <button id="langEN" class="chip small">EN</button>
        <button id="langTE" class="chip small">TE</button>
      </div>
    </div>
  </div>

  <!-- Tabs header -->
  <div class="card mt">
    <div class="tabs">
      <button class="tab active" data-t="#t_dash" data-i18n="tab_dashboard">Dashboard</button>
      <button class="tab" data-t="#t_book" data-i18n="tab_bookings">Bookings</button>
      <button class="tab" data-t="#t_comp" data-i18n="tab_complaints">Complaints</button>
      <button class="tab" data-t="#t_not"  data-i18n="tab_notices">Notices</button>
      <button class="tab" data-t="#t_log"  data-i18n="tab_log">Visitor Log</button>
      <button class="tab" data-t="#t_pre"  data-i18n="tab_pre">Pre-Approve a Visitor</button>
    </div>
  </div>

  <!-- DASHBOARD / PROFILE -->
  <section class="card" id="t_dash">
    <h2 class="h2" data-i18n="residents_title">Residents</h2>
    <div class="grid2">
      <label><span data-i18n="flat_number">Flat Number</span>
        <input id="p_flat" class="in" placeholder="A-302"></label>
      <label><span data-i18n="name">Name</span>
        <input id="p_name" class="in" placeholder="Your name"></label>
      <label><span data-i18n="phone">Phone</span>
        <input id="p_phone" class="in" inputmode="numeric" maxlength="10" placeholder="10-digit"></label>
      <label><span data-i18n="block">Block</span>
        <input id="p_block" class="in" placeholder="A / B / C"></label>
    </div>
    <button class="btn mt8" id="p_save" data-i18n="save">Save</button>
    <div id="p_msg" class="muted mt8" data-i18n="welcome">Welcome</div>
  </section>

  <!-- BOOKINGS -->
  <section class="card hidden" id="t_book">
    <h2 class="h2" data-i18n="bookings_title">Bookings</h2>
    <div class="grid2">
      <label>Amenity <input id="b_amen" class="in" placeholder="Clubhouse / Hall"></label>
      <label>Date <input id="b_date" class="in" type="date"></label>
      <label>Time <input id="b_time" class="in" placeholder="5â€“6 PM"></label>
    </div>
    <div class="row mt8">
      <button class="btn" id="b_add">Add</button>
      <button class="btn" id="b_export">Export CSV</button>
      <button class="btn" id="b_clear">Clear My Bookings</button>
    </div>
    <div class="tablewrap">
      <table class="tbl">
        <thead><tr><th>#</th><th>Amenity</th><th>Date</th><th>Time</th><th>Flat</th><th>Action</th></tr></thead>
        <tbody id="b_tbody"></tbody>
      </table>
      <div id="b_empty" class="muted">No bookings yet.</div>
    </div>
  </section>

  <!-- COMPLAINTS -->
  <section class="card hidden" id="t_comp">
    <h2 class="h2" data-i18n="complaints_title">Complaints</h2>
    <div class="grid2">
      <label>Category
        <select id="c_cat" class="in">
          <option>Plumbing</option><option>Electrical</option><option>Housekeeping</option><option>Security</option>
        </select>
      </label>
      <label>Priority
        <select id="c_pri" class="in"><option>Low</option><option>Medium</option><option>High</option></select>
      </label>
      <label class="span2">Description
        <input id="c_desc" class="in" placeholder="Short description">
      </label>
    </div>
    <div class="row mt8">
      <button class="btn" id="c_add">Raise</button>
      <button class="btn" id="c_export">Export My Complaints</button>
    </div>
    <div class="tablewrap">
      <table class="tbl">
        <thead><tr><th>#</th><th>When</th><th>Category</th><th>Priority</th><th>Status</th><th>Assignee</th><th>Details</th></tr></thead>
        <tbody id="c_tbody"></tbody>
      </table>
      <div id="c_empty" class="muted">No complaints yet.</div>
    </div>
  </section>

  <!-- NOTICES -->
  <section class="card hidden" id="t_not">
    <h2 class="h2" data-i18n="notices_title">Notices</h2>
    <div class="tablewrap">
      <table class="tbl">
        <thead><tr><th>#</th><th>Notice</th><th>Audience</th><th>Time</th><th>Action</th></tr></thead>
        <tbody id="n_tbody"></tbody>
      </table>
      <div id="n_empty" class="muted">No notices yet.</div>
    </div>
  </section>

  <!-- VISITOR LOG -->
  <section class="card hidden" id="t_log">
    <h2 class="h2">Visitor Log</h2>
    <div class="row space">
      <input id="v_search" class="in" placeholder="Search name/purpose" style="max-width:260px">
      <button class="btn" id="v_export">Export CSV</button>
    </div>
    <div class="tablewrap">
      <table class="tbl">
        <thead><tr><th>#</th><th>Name</th><th>Purpose</th><th>Time</th><th>Photo</th></tr></thead>
        <tbody id="v_tbody"></tbody>
      </table>
      <div id="v_empty" class="muted">No visitors yet.</div>
    </div>
  </section>

  <!-- PRE-APPROVALS -->
  <section class="card hidden" id="t_pre">
    <h2 class="h2">Pre-Approve a Visitor</h2>
    <div class="grid2">
      <label>Visitor Name <input id="pa_name" class="in" placeholder="e.g., Courier / Friend"></label>
      <label>Phone <input id="pa_phone" class="in" inputmode="numeric" maxlength="10" placeholder="10-digit (optional)"></label>
      <label>Date <input id="pa_date" class="in" type="date"></label>
      <label>Purpose <input id="pa_purpose" class="in" placeholder="e.g., Delivery, Guest"></label>
    </div>
    <div class="row mt8">
      <button class="btn" id="pa_add">Add</button>
      <button class="btn" id="pa_export">Export CSV</button>
      <button class="btn" id="pa_clear">Clear My Pre-Approvals</button>
    </div>
    <div class="tablewrap">
      <table class="tbl"><thead><tr><th>#</th><th>Name</th><th>Date</th><th>Purpose</th><th>Status</th><th>Action</th></tr></thead><tbody id="pa_tbody"></tbody></table>
      <div id="pa_empty" class="muted">No pre-approvals yet.</div>
    </div>
  </section>
</main>

<!-- ===== PAGE LOGIC (unchanged from your app) ===== -->
<script>
const K={profile:"apt_profile", preapprove:"apt_preapprove", visits:"apt_visits", deliveries:"apt_deliveries", complaints:"apt_complaints", notices:"apt_notices", bookings:"apt_bookings"};
const $=id=>document.getElementById(id);
const jget=k=>JSON.parse(localStorage.getItem(k)||"[]");
const jset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uid=()=>Math.random().toString(36).slice(2,9);
const csv=(rows,heads,name)=>{const out=[heads.join(",")];rows.forEach(r=>out.push(heads.map(h=>`"${String(r[h]??"").replace(/"/g,'""')}"`).join(",")));const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([out.join("\n")],{type:"text/csv"}));a.download=name;a.click();};
const today=()=>new Date().toISOString().slice(0,10);

// tab switching
document.querySelectorAll(".tab").forEach(t=>t.onclick=()=>{
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  document.querySelectorAll("section.card").forEach(s=>{ if(s.id.startsWith("t_")) s.classList.add("hidden"); });
  document.querySelector(t.dataset.t).classList.remove("hidden");
});

// profile
function loadProfile(){ const p=JSON.parse(localStorage.getItem(K.profile)||"{}"); p_flat.value=p.flat||""; p_name.value=p.name||""; p_phone.value=p.phone||""; p_block.value=p.block||""; }
p_save.onclick=()=>{ const data={flat:p_flat.value.trim(),name:p_name.value.trim(),phone:p_phone.value.trim(),block:p_block.value.trim()}; localStorage.setItem(K.profile,JSON.stringify(data)); p_msg.textContent="Saved locally."; setTimeout(()=>p_msg.textContent="",1800); renderAll(); };

// bookings
function renderBookings(){
  const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); const flat=me.flat||"";
  const arr=jget(K.bookings).filter(b=>b.flat===flat).sort((a,b)=>b.ts-a.ts);
  b_tbody.innerHTML=""; b_empty.style.display=arr.length?"none":"block";
  arr.forEach((r,i)=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${r.amen}</td><td>${r.date}</td><td>${r.time}</td><td>${r.flat}</td><td><button class="btn" onclick="delBooking('${r.id}')">Cancel</button></td>`; b_tbody.appendChild(tr); });
}
b_add.onclick=()=>{ const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); if(!me.flat){alert("Save your flat first.");return;} const row={id:uid(),amen:b_amen.value,date:b_date.value||today(),time:b_time.value.trim(),flat:me.flat,ts:Date.now()}; const arr=jget(K.bookings); arr.unshift(row); jset(K.bookings,arr); renderBookings(); };
b_export.onclick=()=>{ const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); const rows=jget(K.bookings).filter(b=>b.flat===(me.flat||"")); csv(rows,["id","amen","date","time","flat","ts"],"My_Bookings.csv"); };
b_clear.onclick=()=>{ const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); const arr=jget(K.bookings).filter(b=>b.flat!==me.flat); jset(K.bookings,arr); renderBookings(); };
window.delBooking=(id)=>{ let arr=jget(K.bookings); arr=arr.filter(x=>x.id!==id); jset(K.bookings,arr); renderBookings(); };

// complaints
function renderMyComplaints(){
  const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); const flat=me.flat||"";
  const arr=jget(K.complaints).filter(c=>c.flat===flat).sort((a,b)=>b.ts-a.ts);
  c_tbody.innerHTML=""; c_empty.style.display=arr.length?"none":"block";
  arr.forEach((r,i)=>{ const t=new Date(r.ts).toLocaleString([], {month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"}); const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${t}</td><td>${r.cat}</td><td>${r.priority}</td><td>${r.status}</td><td>${r.assign||"â€”"}</td><td>${r.desc||""}</td>`; c_tbody.appendChild(tr); });
}
c_add.onclick=()=>{ const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); if(!me.flat){alert("Save your flat first.");return;} const row={id:uid(),flat:me.flat,cat:c_cat.value,priority:c_pri.value,desc:c_desc.value.trim(),status:"Open",assign:"",ts:Date.now()}; const arr=jget(K.complaints); arr.unshift(row); jset(K.complaints,arr); c_desc.value=""; renderMyComplaints(); };
c_export.onclick=()=>{ const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); const rows=jget(K.complaints).filter(c=>c.flat===(me.flat||"")); csv(rows,["id","flat","cat","priority","desc","status","assign","ts"],"My_Complaints.csv"); };

// notices
function renderNotices(){
  const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); const block=me.block||"";
  const arr=jget(K.notices).slice().sort((a,b)=>b.ts-a.ts);
  n_tbody.innerHTML=""; n_empty.style.display=arr.length?"none":"block";
  arr.forEach((r,i)=>{
    const t=new Date(r.ts).toLocaleString([], {month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    const show = (r.aud==="All" || r.aud===block || r.aud===me.flat);
    if(!show) return;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td><b>${r.title||"Notice"}</b><br>${r.msg||""}</td><td>${r.aud||"All"}</td><td>${t}</td><td><button class="btn" onclick="rmNotice('${r.id}')">Mark Read</button></td>`;
    n_tbody.appendChild(tr);
  });
  if(!n_tbody.children.length) n_empty.style.display="block";
}
window.rmNotice=(id)=>{ const read=JSON.parse(localStorage.getItem("apt_notices_read")||"[]"); if(!read.includes(id)) read.push(id); localStorage.setItem("apt_notices_read",JSON.stringify(read)); renderNotices(); };

// visitor log
function renderVisitorLog(){
  const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); const flat=me.flat||"";
  const q=(v_search.value||"").toLowerCase();
  const rows=jget(K.visits).filter(v=>v.flat===flat).filter(v=>(v.name||"").toLowerCase().includes(q)||(v.purpose||"").toLowerCase().includes(q)).sort((a,b)=>b.ts-a.ts);
  v_tbody.innerHTML=""; v_empty.style.display=rows.length?"none":"block";
  rows.forEach((r,i)=>{
    const t=new Date(r.ts).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
    const img=r.photo?`<img src="${r.photo}" style="width:70px;height:50px;object-fit:cover;border-radius:8px">`:"â€”";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${r.name}</td><td>${r.purpose}</td><td>${t}</td><td>${img}</td>`;
    v_tbody.appendChild(tr);
  });
}
v_search.addEventListener("input",renderVisitorLog);
v_export.onclick=()=>{ const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); const rows=jget(K.visits).filter(v=>v.flat===(me.flat||"")).map(({photo,...x})=>x); csv(rows,["id","flat","name","phone","purpose","ts"],"My_Visitors.csv"); };

// pre-approvals
function renderPre(){ const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); const flat=me.flat||""; const arr=jget(K.preapprove).filter(p=>p.flat===flat).sort((a,b)=>b.ts-a.ts); pa_tbody.innerHTML=""; pa_empty.style.display=arr.length?"none":"block"; arr.forEach((r,i)=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${r.name}</td><td>${r.date||"â€”"}</td><td>${r.purpose||"â€”"}</td><td>${r.status||"Queued"}</td><td><button class="btn" onclick="delPA('${r.id}')">Delete</button></td>`; pa_tbody.appendChild(tr); }); }
pa_add.onclick=()=>{ const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); if(!me.flat){alert("Save your flat first.");return;} const row={id:uid(),flat:me.flat,name:pa_name.value.trim(),phone:pa_phone.value.trim(),date:pa_date.value||today(),purpose:pa_purpose.value.trim()||"guest",status:"Queued",ts:Date.now()}; if(!row.name){alert("Name required");return;} const arr=jget(K.preapprove); arr.unshift(row); jset(K.preapprove,arr); pa_name.value=pa_phone.value=pa_purpose.value=""; renderPre(); };
pa_export.onclick=()=>{ const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); const rows=jget(K.preapprove).filter(p=>p.flat===(me.flat||"")); csv(rows,["id","flat","name","phone","date","purpose","status","ts"],"My_PreApprovals.csv"); };
pa_clear.onclick=()=>{ const me=JSON.parse(localStorage.getItem(K.profile)||"{}"); const arr=jget(K.preapprove).filter(p=>p.flat!==me.flat); jset(K.preapprove,arr); renderPre(); };
window.delPA=(id)=>{ let arr=jget(K.preapprove); arr=arr.filter(x=>x.id!==id); jset(K.preapprove,arr); renderPre(); };

// render all
function renderAll(){ renderBookings(); renderMyComplaints(); renderNotices(); renderVisitorLog(); renderPre(); }
if("serviceWorker" in navigator){navigator.serviceWorker.register("./sw.js").catch(()=>{});}
loadProfile(); renderAll();
</script>

<!-- ===== THEME + LANG (same as index) ===== -->
<script>
(function initTheme(){
  const saved = localStorage.getItem("apt_theme") || "light";
  if(saved==="dark"){ document.documentElement.setAttribute("data-theme","dark"); }
  document.getElementById("themeBtn").textContent = saved==="dark" ? "â˜€ï¸" : "ðŸŒ™";
})();
document.getElementById("themeBtn").onclick = ()=>{
  const dark = document.documentElement.getAttribute("data-theme")==="dark";
  if(dark){ document.documentElement.removeAttribute("data-theme"); localStorage.setItem("apt_theme","light"); document.getElementById("themeBtn").textContent="ðŸŒ™";}
  else{ document.documentElement.setAttribute("data-theme","dark"); localStorage.setItem("apt_theme","dark"); document.getElementById("themeBtn").textContent="â˜€ï¸";}
};
function getLang(){ return localStorage.getItem("apt_lang") || "en"; }
function setLang(l){ localStorage.setItem("apt_lang", l); applyI18N && applyI18N(); }
document.getElementById("langEN").onclick = ()=> setLang("en");
document.getElementById("langTE").onclick = ()=> setLang("te");
// minimal keys if lang.js not present
if(typeof applyI18N!=="function"){
  const I18N = {
    en:{residents_title:"Residents",tab_dashboard:"Dashboard",tab_bookings:"Bookings",tab_complaints:"Complaints",tab_notices:"Notices",tab_log:"Visitor Log",tab_pre:"Pre-Approve a Visitor",flat_number:"Flat Number",name:"Name",phone:"Phone",block:"Block",save:"Save",welcome:"Welcome"},
    te:{residents_title:"à°°à±†à°¸à°¿à°¡à±†à°‚à°Ÿà±à°¸à±",tab_dashboard:"à°¡à°¾à°·à±â€Œà°¬à±‹à°°à±à°¡à±",tab_bookings:"à°¬à±à°•à°¿à°‚à°—à±à°¸à±",tab_complaints:"à°«à°¿à°°à±à°¯à°¾à°¦à±à°²à±",tab_notices:"à°¨à±‹à°Ÿà±€à°¸à±à°²à±",tab_log:"à°µà°¿à°œà°¿à°Ÿà°°à± à°²à°¾à°—à±",tab_pre:"à°ªà±à°°à±€-à°…à°ªà±à°°à±‚à°µà°²à±",flat_number:"à°«à±à°²à°¾à°Ÿà± à°¨à°‚à°¬à°°à±",name:"à°ªà±‡à°°à±",phone:"à°«à±‹à°¨à±",block:"à°¬à±à°²à°¾à°•à±",save:"à°¸à±‡à°µà±",welcome:"à°¸à±à°µà°¾à°—à°¤à°‚"}
  };
  window.applyI18N = function(){
    const L=I18N[getLang()]||I18N.en;
    document.querySelectorAll("[data-i18n]").forEach(el=>{const k=el.getAttribute("data-i18n"); if(L[k]) el.textContent=L[k];});
  };
}
applyI18N();
</script>
</body></html>
