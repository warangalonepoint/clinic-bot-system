<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manual Bookings – Onestop C-Demo</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <img src="assets/banner.png" alt="Banner" class="banner" />
  <div class="container">
    <h2>Manual Bookings – Onestop C-Demo</h2>
    <label for="date">Select Date</label>
    <input type="date" id="date" required /><label for="slot">Select Slot</label>
<select id="slot" required></select>

<label for="name">Patient Name</label>
<input type="text" id="name" required />

<label for="reason">Reason</label>
<input type="text" id="reason" required />

<label for="contact">Contact</label>
<input type="text" id="contact" required />

<button onclick="submitBooking()">Confirm Booking</button>
<p>Booked slots will be hidden automatically.</p>
<a href="index.html" class="back">&larr; Back to Dashboard</a>

  </div>  <script>
    const airtableToken = 'patLNwoJQKE3Tjb8J.c2a0db129111c610fae64a2c01e0a626f37bdb5992232ea6ebc644fa9073dfb3';
    const baseId = 'app1T8WiRqZIR4xY';
    const bookingsTable = 'BookingsLogs';
    const slotsTable = 'AvailableSlots';

    const slotDropdown = document.getElementById('slot');
    const dateInput = document.getElementById('date');

    dateInput.addEventListener('change', loadSlots);

    async function loadSlots() {
      slotDropdown.innerHTML = '';
      const date = dateInput.value;
      const url = `https://api.airtable.com/v0/${baseId}/${slotsTable}?filterByFormula=AND({Date}='${date}', {Status}='Available')`;
      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${airtableToken}` }
      });
      const data = await res.json();
      data.records.forEach(record => {
        const opt = document.createElement('option');
        opt.value = record.fields['Slot'];
        opt.textContent = record.fields['Slot'];
        opt.dataset.recordId = record.id;
        slotDropdown.appendChild(opt);
      });
    }

    async function submitBooking() {
      const date = dateInput.value;
      const slot = slotDropdown.value;
      const slotId = slotDropdown.options[slotDropdown.selectedIndex].dataset.recordId;
      const name = document.getElementById('name').value;
      const reason = document.getElementById('reason').value;
      const contact = document.getElementById('contact').value;

      // Fetch existing tokens for the date
      const bookingsURL = `https://api.airtable.com/v0/${baseId}/${bookingsTable}?filterByFormula=IS_SAME({Slot Time}, '${date} ${slot}', 'minute')`;
      const bookingsRes = await fetch(bookingsURL, {
        headers: { Authorization: `Bearer ${airtableToken}` }
      });
      const bookingsData = await bookingsRes.json();
      const token = bookingsData.records.length + 1;

      // Submit new booking
      await fetch(`https://api.airtable.com/v0/${baseId}/${bookingsTable}`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${airtableToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fields: {
            'Patient Name': name,
            'Slot Time': `${date} ${slot}`,
            'Reason': reason,
            'Contact': contact,
            'Token': token,
            'Reminder Sent': '❌'
          }
        })
      });

      // Mark slot as booked
      await fetch(`https://api.airtable.com/v0/${baseId}/${slotsTable}/${slotId}`, {
        method: 'PATCH',
        headers: {
          Authorization: `Bearer ${airtableToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ fields: { 'Status': 'Booked' } })
      });

      alert('Booking confirmed!');
      window.location.reload();
    }
  </script></body>
</html>
