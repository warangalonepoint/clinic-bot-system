<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="Cache-Control" content="no-store, must-revalidate"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>School PWA (PIN Mode)</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="manifest" href="./manifest.webmanifest"/>
  <meta name="theme-color" content="#0b0f19"/>
</head>
<body class="dark">
  <div class="wrapper">

    <!-- Header -->
    <section class="accent-violet">
      <div class="glass header">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div class="h1">School PWA</div>
            <div class="text-dim">Role-based demo (PIN login)</div>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn" onclick="toggleTheme()">Theme</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PIN -->
    <section class="accent-cyan">
      <div class="glass inner">
        <div class="h1">Enter PIN</div>
        <p class="text-dim">You’ll be routed to your role panel.</p>

        <form id="pin-form" class="form-grid mt-12">
          <input id="pin-input" class="input full" inputmode="numeric" maxlength="8"
                 placeholder="4–8 digit PIN" autocomplete="one-time-code"/>
          <button id="pin-go" class="btn btn-indigo" type="submit">Continue</button>
        </form>

        <div id="pin-msg" class="text-dim mt-12"></div>
        <div id="pin-info" class="mt-12 text-dim" style="font-size:12px"></div>
      </div>
    </section>

  </div>

  <script type="module">
    // Minimal helpers (theme toggle lives in ui.js)
    import { showLoadedPins } from './ui.js'; // optional helper; safe if present

    // Load pins.json; fallback to hard-coded map if not found.
    let pinMap = { "1111":"parents", "2222":"teacher", "3333":"coordinator", "4444":"admin" };

    try {
      const r = await fetch(new URL('pins.json', location.href), { cache:'no-store' });
      if (r.ok) {
        const j = await r.json();
        if (j && typeof j === 'object') pinMap = j;
      }
      showLoadedPins?.(Object.keys(pinMap)); // just prints small info if implemented
      document.getElementById('pin-info').textContent = 'PINs loaded.';
    } catch (e) {
      document.getElementById('pin-info').textContent = 'Using fallback PINs (pins.json not found).';
    }

    const $ = (id)=>document.getElementById(id);
    const input = $('pin-input');
    const msg   = $('pin-msg');
    const form  = $('pin-form');

    function route(e){
      e?.preventDefault();
      const pin = (input.value || '').trim();
      if (!pin) { msg.textContent = 'Enter a PIN.'; return; }
      const role = pinMap[pin];
      if (!role) { msg.textContent = 'Unknown PIN. Please try again.'; return; }
      const theme = localStorage.getItem('theme') || 'dark';
      location.replace(`${role}.html?theme=${theme}&t=${Date.now()}`);
    }

    form.addEventListener('submit', route);

    // Optional: submit on Enter from the input on some mobile keyboards
    input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') route(e); });

    // Register SW (non-blocking)
    if ('serviceWorker' in navigator) {
      try { navigator.serviceWorker.register('./sw.js'); } catch {}
    }
  </script>

  <script type="module" src="ui.js"></script>
</body>
</html>
