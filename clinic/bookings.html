<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clinic Appointment Booking | Dynamic Slots</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        input, select, button { display: block; width: 100%; padding: 12px; margin-top: 15px; border-radius: 10px; font-size: 16px; }
        button { background: black; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <h2>Clinic Appointment Booking (Live Slots)</h2>

    <input type="text" id="patientName" placeholder="Patient Name">

    <select id="slotDropdown">
        <option>Loading available slots...</option>
    </select>

    <input type="text" id="reason" placeholder="Reason for Visit">

    <button onclick="submitBooking()">Book Appointment</button>
    <div id="status" style="margin-top: 20px; color: green;"></div>

    <script>
        const API_KEY = 'patLNwoJQKE3Tjb8J.c2a0db129111c610fae64a2c01e0a626f37bdb5992232ea6ebc644fa9073dfb3';
        const BASE_ID = 'appgIT8WiqnZlR44Y';
        const SLOTS_TABLE = 'AvailableSlots';
        const BOOKINGS_TABLE = 'BookingsLogs';

        // Load Available Slots
        fetch(`https://api.airtable.com/v0/${BASE_ID}/${SLOTS_TABLE}?filterByFormula=Status='Available'`, {
            headers: { 'Authorization': `Bearer ${API_KEY}` }
        })
        .then(response => response.json())
        .then(data => {
            const dropdown = document.getElementById('slotDropdown');
            dropdown.innerHTML = "<option>Select Slot</option>";
            data.records.forEach(record => {
                const date = record.fields.Date;
                const time = record.fields['Time Slot'];
                const slotID = record.id;
                const option = document.createElement('option');
                option.value = slotID + "|" + date + " " + time;
                option.text = `${date} â€” ${time}`;
                dropdown.appendChild(option);
            });
        })
        .catch(err => {
            console.error(err);
            alert("Failed to load slots.");
        });

        function submitBooking() {
            const patientName = document.getElementById('patientName').value.trim();
            const selectedSlot = document.getElementById('slotDropdown').value;
            const reason = document.getElementById('reason').value.trim();

            if(patientName === "" || selectedSlot === "Select Slot" || reason === "") {
                alert("Please fill all fields.");
                return;
            }

            const [slotID, slotTime] = selectedSlot.split("|");

            const data = {
                records: [
                    {
                        fields: {
                            "Timestamp": new Date().toLocaleString(),
                            "Patient Name": patientName,
                            "Slot Time": slotTime,
                            "Reason": reason
                        }
                    }
                ]
            };

            // Log Booking
            fetch(`https://api.airtable.com/v0/${BASE_ID}/${BOOKINGS_TABLE}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                document.getElementById('status').innerText = "Booking Logged Successfully!";

                // Mark Slot as Booked in Airtable
                const updateData = {
                    records: [
                        {
                            id: slotID,
                            fields: { Status: 'Booked' }
                        }
                    ]
                };

                fetch(`https://api.airtable.com/v0/${BASE_ID}/${SLOTS_TABLE}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                }).then(() => {
                    alert("Slot Booked. Refreshing Available Slots.");
                    window.location.reload();
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Failed to log booking.");
            });
        }
    </script>

</body>
</html>
