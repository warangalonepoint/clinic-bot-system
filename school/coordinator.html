<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Coordinator</title>
<link rel="stylesheet" href="styles.css"/>
<style>
  .note{padding:10px;margin:10px 0;border:1px solid #2a344a;border-radius:10px;background:#101623;color:#cbd5e1}
  .muted{opacity:.7}
  .list-card{background:#121826;border:1px solid #232a3a;border-radius:14px;padding:12px;margin:8px 0}
  .row{display:flex;justify-content:space-between;gap:12px;align-items:center}
  .grid{display:grid;gap:10px}
  @media(min-width:700px){ .grid-2{grid-template-columns:1fr 1fr} }
</style>
</head>
<body class="dark">
<div class="wrapper">

  <section class="accent-cyan">
    <div class="glass header">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="eyebrow">Manage timetable and broadcast</div>
          <div class="h1">Coordinator Panel</div>
        </div>
        <div class="row" style="gap:8px">
          <a class="btn" href="./logout.html">Logout</a>
          <button class="btn" onclick="toggleTheme()">Theme</button>
        </div>
      </div>

      <div class="tab-row" id="tabs">
        <button class="chip chip-indigo" data-tab="setup">Class Setup</button>
        <button class="chip chip-blue"   data-tab="timetable">Timetable</button>
        <button class="chip chip-fuchsia"data-tab="broadcast">Broadcast</button>
        <button class="chip chip-violet" data-tab="events">Events</button>
        <button class="chip chip-amber"  data-tab="complaints">Complaints</button>
        <button class="chip chip-teal"   data-tab="data">Data</button>
      </div>
    </div>
  </section>

  <!-- SETUP -->
  <section id="panel-setup" class="glass inner panel">
    <div class="h1">Choose Class</div>
    <form id="scopeForm" class="form-grid mt-12">
      <input class="input full" placeholder="Class e.g., 5" name="class" required/>
      <input class="input full" placeholder="Section e.g., A" name="section" required/>
      <button class="btn btn-indigo" type="submit">Save Meta</button>
    </form>
    <div id="scopeInfo" class="muted mt-12"></div>
  </section>

  <!-- TIMETABLE -->
  <section id="panel-timetable" class="glass inner panel" hidden>
    <div class="h1">Add / Replace Period</div>
    <form id="ttForm" class="form-grid mt-12">
      <select class="input" name="day" required>
        <option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option><option>Fri</option>
      </select>
      <input class="input" name="period" placeholder="Period # 1–12" inputmode="numeric" required/>
      <input class="input full" name="subject" placeholder="Subject" required/>
      <input class="input" name="teacher" placeholder="Teacher name" required/>
      <input class="input" name="room" placeholder="Room (optional)"/>
      <button class="btn btn-blue full" type="submit">Add / Update</button>
    </form>
    <div id="ttStatus" class="note" hidden></div>

    <div class="h2 mt-12">Class Timetable</div>
    <div id="ttList" class="mt-8">
      <div class="note">No entries yet.</div>
    </div>
  </section>

  <!-- BROADCAST (Announcements) -->
  <section id="panel-broadcast" class="glass inner panel" hidden>
    <div class="h1">Broadcast to Parents</div>
    <form id="bcForm" class="form-grid mt-12">
      <textarea class="input full" name="msg" placeholder="Message..." required></textarea>
      <button class="btn btn-fuchsia" type="submit">Send</button>
    </form>
    <div id="bcStatus" class="note" hidden></div>

    <div class="h2 mt-12">Recent Announcements</div>
    <div id="bcList" class="mt-8">
      <div class="note">No announcements yet.</div>
    </div>
  </section>

  <!-- EVENTS -->
  <section id="panel-events" class="glass inner panel" hidden>
    <div class="h1">Events</div>
    <form id="evForm" class="form-grid mt-12 grid grid-2">
      <input class="input" name="title" placeholder="Event Title" required/>
      <input class="input" type="date" name="date" required/>
      <button class="btn btn-violet" type="submit">Add</button>
    </form>
    <div id="evStatus" class="note" hidden></div>

    <div class="h2 mt-12">Upcoming Events</div>
    <div id="evList" class="mt-8">
      <div class="note">No events yet.</div>
    </div>
  </section>

  <!-- COMPLAINTS (placeholder) -->
  <section id="panel-complaints" class="glass inner panel" hidden>
    <div class="h1">Complaints Inbox</div>
    <div class="list mt-12"><div class="item"><span>None</span></div></div>
  </section>

  <!-- DATA TOOLS (placeholder) -->
  <section id="panel-data" class="glass inner panel" hidden>
    <div class="h1">Data Tools</div>
    <div class="row mt-12">
      <button class="btn btn-amber" id="btnBackup">Backup (JSON)</button>
      <button class="btn btn-teal" id="btnRestore" disabled>Restore</button>
    </div>
  </section>

</div>
<div class="toast" aria-live="polite"></div>

<!-- Tabs/UI -->
<script type="module">
  import {initTabs, bindQueueForms} from './ui.js';
  initTabs(document); bindQueueForms(document);
</script>

<!-- Supabase wiring -->
<script type="module">
  import { requireLogin, sb } from "./js/supabase.js";

  // Require auth
  await requireLogin();

  // --- Scope helpers ---
  const SCOPE_KEY = "coord_scope";
  const getScope = () => {
    try { return JSON.parse(localStorage.getItem(SCOPE_KEY) || "{}"); } catch { return {}; }
  };
  const setScope = (obj) => localStorage.setItem(SCOPE_KEY, JSON.stringify(obj));
  const showScope = () => {
    const { klass, section } = normalizeScope(getScope());
    document.getElementById('scopeInfo').textContent = (klass && section)
      ? `Current scope: Class ${klass} - ${section}`
      : 'No scope saved. Set Class & Section.';
  };
  const normalizeScope = (s) => ({
    klass: (s.class || s.klass || "").toString().trim(),
    section: (s.section || "").toString().trim()
  });

  // Prefill scope form if exists
  const scopeForm = document.getElementById('scopeForm');
  const saved = getScope();
  if (saved.class) scopeForm.elements['class'].value = saved.class;
  if (saved.section) scopeForm.elements['section'].value = saved.section;
  showScope();

  scopeForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const fd = new FormData(scopeForm);
    setScope({ class: fd.get('class'), section: fd.get('section') });
    showScope();
    // refresh lists to current scope
    loadTimetable(); loadAnnouncements(); loadEvents();
  });

  // --- Timetable ---
  const ttForm = document.getElementById('ttForm');
  const ttStatus = document.getElementById('ttStatus');
  const ttList = document.getElementById('ttList');

  async function loadTimetable() {
    const { klass, section } = normalizeScope(getScope());
    if (!klass) { ttList.innerHTML = `<div class="note">Set class scope first.</div>`; return; }
    const { data, error } = await sb.from('timetable')
      .select('*').eq('class', klass).maybeSingle();
    // If table is not single-row per class, fetch many rows:
    const q = sb.from('timetable').select('*').eq('class', klass);
    if (section) q.eq('section', section);
    const res = await q.order('day', { ascending: true }).order('period', { ascending: true });
    if (res.error) { ttList.innerHTML = `<div class="note">Error loading timetable.</div>`; return; }
    const rows = res.data || [];
    if (!rows.length) { ttList.innerHTML = `<div class="note">No entries yet.</div>`; return; }
    ttList.innerHTML = rows.map(r => `
      <div class="list-card">
        <div class="row">
          <b>${r.day} · Period ${r.period}</b>
          <span class="muted">${r.room || ''}</span>
        </div>
        <div class="muted">${r.subject} — ${r.teacher}</div>
        <div class="muted">Class ${r.class}${r.section ? (' - ' + r.section) : ''}</div>
      </div>
    `).join('');
  }

  ttForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const { klass, section } = normalizeScope(getScope());
    if (!klass) { ttStatus.hidden=false; ttStatus.textContent='❌ Set class scope first.'; return; }
    const fd = new FormData(ttForm);
    const payload = {
      class: klass,
      section: section || null,
      day: fd.get('day'),
      period: parseInt(fd.get('period'), 10),
      subject: fd.get('subject'),
      teacher: fd.get('teacher'),
      room: fd.get('room') || null
    };
    // upsert by unique (class, section, day, period)
    const { error } = await sb.from('timetable').upsert(payload, {
      onConflict: 'class,section,day,period'
    });
    ttStatus.hidden = false;
    ttStatus.textContent = error ? ('❌ ' + error.message) : '✅ Timetable updated.';
    if (!error) { ttForm.reset(); loadTimetable(); }
  });

  // --- Broadcast / Announcements ---
  const bcForm = document.getElementById('bcForm');
  const bcStatus = document.getElementById('bcStatus');
  const bcList = document.getElementById('bcList');

  async function loadAnnouncements() {
    const { klass, section } = normalizeScope(getScope());
    const q = sb.from('announcements').select('*')
      .order('created_at', { ascending: false }).limit(20);
    // Show class-scoped first; if none, will still show global later if you add null scope logic
    if (klass) q.eq('class', klass);
    if (section) q.eq('section', section);
    const { data, error } = await q;
    if (error) { bcList.innerHTML = `<div class="note">Error loading announcements.</div>`; return; }
    if (!data.length) { bcList.innerHTML = `<div class="note">No announcements yet.</div>`; return; }
    bcList.innerHTML = data.map(a => `
      <div class="list-card">
        <div class="row">
          <b>Announcement</b>
          <span class="muted">${new Date(a.created_at).toLocaleString()}</span>
        </div>
        <div>${a.body}</div>
        <div class="muted">Class ${a.class || '—'} ${a.section ? ('- ' + a.section) : ''}</div>
      </div>
    `).join('');
  }

  bcForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const { klass, section } = normalizeScope(getScope());
    if (!klass) { bcStatus.hidden=false; bcStatus.textContent='❌ Set class scope first.'; return; }
    const fd = new FormData(bcForm);
    const user = (await sb.auth.getUser()).data.user;
    const { error } = await sb.from('announcements').insert({
      class: klass, section: section || null, body: fd.get('msg'), created_by: user?.id || null
    });
    bcStatus.hidden = false;
    bcStatus.textContent = error ? ('❌ ' + error.message) : '✅ Broadcast sent.';
    if (!error) { bcForm.reset(); loadAnnouncements(); }
  });

  // --- Events ---
  const evForm = document.getElementById('evForm');
  const evStatus = document.getElementById('evStatus');
  const evList = document.getElementById('evList');

  async function loadEvents() {
    const { klass, section } = normalizeScope(getScope());
    const q = sb.from('events').select('*');
    if (klass) q.eq('class', klass);
    if (section) q.eq('section', section);
    const { data, error } = await q.order('event_date', { ascending: true }).limit(50);
    if (error) { evList.innerHTML = `<div class="note">Error loading events.</div>`; return; }
    if (!data.length) { evList.innerHTML = `<div class="note">No events yet.</div>`; return; }
    evList.innerHTML = data.map(ev => `
      <div class="list-card">
        <div class="row">
          <b>${ev.title}</b>
          <span class="muted">${ev.event_date || ''}</span>
        </div>
        <div class="muted">Class ${ev.class || '—'} ${ev.section ? ('- ' + ev.section) : ''}</div>
      </div>
    `).join('');
  }

  evForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const { klass, section } = normalizeScope(getScope());
    if (!klass) { evStatus.hidden=false; evStatus.textContent='❌ Set class scope first.'; return; }
    const fd = new FormData(evForm);
    const user = (await sb.auth.getUser()).data.user;
    const { error } = await sb.from('events').insert({
      class: klass, section: section || null, title: fd.get('title'), event_date: fd.get('date') || null, created_by: user?.id || null
    });
    evStatus.hidden = false;
    evStatus.textContent = error ? ('❌ ' + error.message) : '✅ Event added.';
    if (!error) { evForm.reset(); loadEvents(); }
  });

  // Data tools: quick JSON backup for scope
  document.getElementById('btnBackup')?.addEventListener('click', async () => {
    const { klass, section } = normalizeScope(getScope());
    if (!klass) return alert('Set class scope first.');
    const [tt, anns, evs] = await Promise.all([
      sb.from('timetable').select('*').eq('class', klass).ilike('section', section || '%'),
      sb.from('announcements').select('*').eq('class', klass).ilike('section', section || '%'),
      sb.from('events').select('*').eq('class', klass).ilike('section', section || '%'),
    ]);
    const blob = new Blob([JSON.stringify({
      scope:{class:klass, section},
      timetable: tt.data || [],
      announcements: anns.data || [],
      events: evs.data || []
    }, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `backup_${klass}${section?'-'+section:''}.json`;
    a.click();
  });

  // Initial loads
  loadTimetable(); loadAnnouncements(); loadEvents();

  // Realtime refresh (optional)
  sb.channel('coord-rt')
    .on('postgres_changes', { event:'*', schema:'public', table:'timetable' }, loadTimetable)
    .on('postgres_changes', { event:'*', schema:'public', table:'announcements' }, loadAnnouncements)
    .on('postgres_changes', { event:'*', schema:'public', table:'events' }, loadEvents)
    .subscribe();
</script>

<script type="module" src="ui.js"></script>
</body>
</html>
