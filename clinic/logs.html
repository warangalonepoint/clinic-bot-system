<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Logs Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; color: #333; margin: 0; padding: 1rem; transition: background 0.3s, color 0.3s; }
    h1 { text-align: center; margin-bottom: 1rem; }
    .filters { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 1rem; }
    .filters input { padding: 5px; font-size: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    th, td { padding: 0.75rem; border: 1px solid #ccc; text-align: left; }
    th { background-color: #f0f0f0; }
    .export-buttons { display: flex; gap: 10px; justify-content: center; margin-bottom: 1rem; }
    canvas { max-width: 100%; margin-top: 2rem; }
    .theme-toggle { text-align: center; margin-bottom: 1rem; }
    .summary { text-align: center; margin-top: 2rem; font-weight: bold; }
    @media (max-width: 600px) {
      table, th, td { font-size: 0.8rem; }
      .filters { flex-direction: column; align-items: stretch; }
    }
    .dark-mode { background: #121212; color: #eee; }
    .dark-mode th { background-color: #333; }
    .dark-mode td, .dark-mode input { background-color: #222; color: #eee; }
  </style>
</head>
<body><h1>Patient List & Analytics</h1><div class="theme-toggle">
  <button onclick="toggleTheme()">Toggle Dark/Light Theme</button>
</div><div class="filters">
  <input type="text" id="searchName" placeholder="Search Name">
  <input type="text" id="searchReason" placeholder="Search Reason">
  <input type="date" id="filterDate">
</div><div class="export-buttons">
  <button onclick="exportTableToExcel('patientTable')">Export to Excel</button>
  <button onclick="exportToPDF()">Export to PDF</button>
</div><table id="patientTable">
  <thead>
    <tr>
      <th>Date</th><th>Time</th><th>Name</th><th>Reason</th><th>Contact</th><th>Token</th><th>Reminder Sent</th><th>Send Reminder</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table><div class="summary" id="summaryStats"></div><canvas id="bookingChart"></canvas> <canvas id="repeatChart" style="margin-top: 2rem;"></canvas>

<script>
let fullData = [];

function renderTable(filtered = fullData) {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  filtered.forEach((d, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${d.Date}</td>
      <td>${d.Time}</td>
      <td>${d.Name}</td>
      <td>${d.Reason}</td>
      <td><a href="tel:${d.Contact}">${d.Contact}</a></td>
      <td>${d.Token}</td>
      <td id="reminder-${i}">${d['Reminder Sent'] || ''}</td>
      <td><button onclick="sendReminder('${d.Name}', '${d.Date}', '${d.Time}', '${d.Token}', '${d.Contact}', ${i})">ðŸ“² Send</button></td>
    `;
    tbody.appendChild(row);
  });
  updateSummary(filtered);
}

function sendReminder(name, date, time, token, contact, index) {
  const message = `Hello ${name}, this is a reminder for your appointment on ${date} at ${time}.\nToken No: ${token}`;
  const link = `https://wa.me/91${contact}?text=${encodeURIComponent(message)}`;
  window.open(link, '_blank');
  document.getElementById(`reminder-${index}`).innerText = 'âœ…';
}

function updateSummary(entries) {
  const total = entries.length;
  const uniqueContacts = new Set(entries.map(e => e.Contact));
  const repeat = total - uniqueContacts.size;
  document.getElementById('summaryStats').innerText = `Total: ${total}, Repeat Patients: ${repeat}`;
}

function exportTableToExcel(id) {
  const table = document.getElementById(id);
  const wb = XLSX.utils.table_to_book(table);
  XLSX.writeFile(wb, 'Patient_Logs.xlsx');
}

function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text('Patient Logs', 10, 10);
  doc.autoTable({ html: '#patientTable' });
  doc.save('Patient_Logs.pdf');
}

function drawCharts(data) {
  const ctx1 = document.getElementById('bookingChart').getContext('2d');
  const ctx2 = document.getElementById('repeatChart').getContext('2d');
  const reasons = {};
  const times = {};
  data.forEach(d => {
    reasons[d.Reason] = (reasons[d.Reason] || 0) + 1;
    times[d.Time] = (times[d.Time] || 0) + 1;
  });
  new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: Object.keys(reasons),
      datasets: [{ label: 'Visit Reasons', data: Object.values(reasons), backgroundColor: 'teal' }]
    }
  });
  new Chart(ctx2, {
    type: 'line',
    data: {
      labels: Object.keys(times),
      datasets: [{ label: 'Peak Time Slots', data: Object.values(times), backgroundColor: 'orange', fill: false, borderColor: 'orange' }]
    }
  });
}

function applyFilters() {
  const name = document.getElementById('searchName').value.toLowerCase();
  const reason = document.getElementById('searchReason').value.toLowerCase();
  const date = document.getElementById('filterDate').value;
  const filtered = fullData.filter(d =>
    (!name || d.Name.toLowerCase().includes(name)) &&
    (!reason || d.Reason.toLowerCase().includes(reason)) &&
    (!date || d.Date === date)
  );
  renderTable(filtered);
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
}

document.getElementById('searchName').addEventListener('input', applyFilters);
document.getElementById('searchReason').addEventListener('input', applyFilters);
document.getElementById('filterDate').addEventListener('change', applyFilters);

Papa.parse("logs.csv", {
  download: true,
  header: true,
  complete: function(results) {
    fullData = results.data.filter(r => r.Date && r.Time);
    renderTable();
    drawCharts(fullData);
  }
});
</script></body>
</html>
