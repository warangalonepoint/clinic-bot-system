<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • School PWA</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <main>
    <div class="topbar">
      <span class="badge">Admin</span>
      <div style="display:flex; gap:8px; align-items:center">
        <label title="Dark / Light"><input id="themeToggle" class="theme-toggle" type="checkbox"/></label>
        <a class="btn ghost" href="./index.html">Logout</a>
      </div>
    </div>

    <header class="hero panel"><div class="title">Admin Console</div></header>

    <section class="panel" style="margin-top:14px">
      <div class="tabs">
        <button class="tab active" data-t="scope">Scope</button>
        <button class="tab" data-t="broadcast">Broadcast</button>
        <button class="tab" data-t="leaves">Leaves</button>
        <button class="tab" data-t="data">Data</button>
        <button class="tab" data-t="backup">Backup</button>
      </div>

      <!-- Scope -->
      <div id="sec-scope" class="section active">
        <div class="card gradient-1">
          <h2>Class Scope</h2>
          <div class="row">
            <div><label>Class</label><input id="a-class" placeholder="e.g., 8"/></div>
            <div><label>Section</label><input id="a-sec" placeholder="e.g., B"/></div>
          </div>
          <div class="spacer"></div>
          <button id="btnScope" class="btn">Save</button>
        </div>
      </div>

      <!-- Broadcast -->
      <div id="sec-broadcast" class="section">
        <div class="card gradient-3">
          <h2>Broadcast to Parents</h2>
          <label>Message</label><textarea id="a-bc" placeholder="Short message…"></textarea>
          <div class="spacer"></div>
          <button class="btn" id="btnBc">Send</button>
        </div>
      </div>

      <!-- Leaves -->
      <div id="sec-leaves" class="section">
        <div class="card gradient-2">
          <h2>All Leave Requests</h2>
          <table class="table" id="tblLeaves"><thead>
            <tr><th>Date</th><th>Reason</th><th>Status</th><th>Action</th></tr>
          </thead><tbody></tbody></table>
        </div>
      </div>

      <!-- Data -->
      <div id="sec-data" class="section">
        <div class="row">
          <div class="card gradient-1">
            <h2>Import CSV (Demo)</h2>
            <p class="muted">Hook here to your sheets / Airtable in live product.</p>
            <input type="file" id="csv" accept=".csv" />
          </div>
          <div class="card gradient-4">
            <h2>Stats (Local)</h2>
            <ul class="muted" id="stats"></ul>
          </div>
        </div>
      </div>

      <!-- Backup -->
      <div id="sec-backup" class="section">
        <div class="row">
          <div class="card gradient-3">
            <h2>Quick Backup</h2>
            <button id="btnExport" class="btn">Export JSON</button>
          </div>
          <div class="card gradient-2">
            <h2>Restore</h2>
            <input id="restoreFile" type="file" accept="application/json" />
            <div class="spacer"></div>
            <button id="btnRestore" class="btn warn">Restore</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Theme
    const root=document.documentElement;
    const tSaved=localStorage.getItem('theme')||'dark';
    root.setAttribute('data-theme',tSaved);
    document.getElementById('themeToggle').checked=(tSaved==='light');
    document.getElementById('themeToggle').addEventListener('change',e=>{
      const t=e.target.checked?'light':'dark'; root.setAttribute('data-theme',t); localStorage.setItem('theme',t);
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));
        document.getElementById('sec-'+b.dataset.t).classList.add('active');
      });
    });

    // Local helpers
    const L={get:k=>JSON.parse(localStorage.getItem(k)||"[]"), set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
    function renderLeaves(){
      const tb=document.querySelector('#tblLeaves tbody'); tb.innerHTML="";
      L.get('leaves').forEach((x,i)=>tb.insertAdjacentHTML('beforeend',
        `<tr><td>${x.date}</td><td>${x.reason}</td><td>${x.status||'Pending'}</td>
         <td>
           <button class="btn" data-a="Approve" data-i="${i}">Approve</button>
           <button class="btn warn" data-a="Reject" data-i="${i}">Reject</button>
         </td></tr>`));
      tb.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>{
        const arr=L.get('leaves'); arr[Number(b.dataset.i)].status=b.dataset.a; L.set('leaves',arr); renderLeaves();
      }));
    }
    renderLeaves();

    // Scope save
    document.getElementById('btnScope').addEventListener('click', ()=>{
      localStorage.setItem('scope_class', document.getElementById('a-class').value.trim());
      localStorage.setItem('scope_sec', document.getElementById('a-sec').value.trim());
      alert('Scope saved.');
    });

    // Broadcast
    document.getElementById('btnBc').addEventListener('click', ()=>{
      const text=(document.getElementById('a-bc').value||"").trim();
      if(!text) return alert('Type a message');
      const msgs=L.get('msgs'); msgs.push({time:Date.now(), text}); L.set('msgs',msgs);
      alert('Broadcasted (demo).'); document.getElementById('a-bc').value="";
    });

    // Stats
    function stats(){
      const s=document.getElementById('stats'); s.innerHTML="";
      const d=[['Diary posts','diary'],['Homework','hw'],['Messages','msgs'],['Leaves','leaves']];
      d.forEach(([t,k])=> s.insertAdjacentHTML('beforeend', `<li>${t}: ${L.get(k).length}</li>`));
    }
    stats();

    // Backup/Restore
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const dump=JSON.stringify(localStorage,null,2);
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([dump],{type:'application/json'}));
      a.download='school-local-backup.json'; a.click();
    });
    document.getElementById('btnRestore').addEventListener('click', ()=>{
      const f=document.getElementById('restoreFile').files[0]; if(!f) return alert('Pick a file');
      const reader=new FileReader(); reader.onload=()=>{
        try{
          const obj=JSON.parse(reader.result);
          Object.keys(obj).forEach(k=>localStorage.setItem(k, obj[k]));
          alert('Restored. Reloading…'); location.reload();
        }catch(e){ alert('Invalid file'); }
      }; reader.readAsText(f);
    });
  </script>
</body>
</html>
